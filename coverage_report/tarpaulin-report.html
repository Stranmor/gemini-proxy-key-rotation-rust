<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","admin.rs"],"content":"// src/admin.rs\n\nuse crate::{\n    config::{self, AppConfig},\n    error::{AppError, Result},\n    key_manager::{KeyState, KeyStatus as KmKeyStatus},\n    state::AppState,\n};\nuse axum::{\n    body::Body,\n    extract::{Path, Query, State},\n    http::{Request, StatusCode},\n    middleware::{self, Next},\n    response::{Html, IntoResponse, Json, Response},\n    routing::{delete, get, post, put},\n    Router,\n};\nuse axum_extra::{\n    headers::{authorization::Bearer, Authorization},\n    TypedHeader,\n};\nuse chrono::{DateTime, Utc};\nuse cookie::{time::Duration, SameSite};\nuse http::HeaderName;\nuse rand::{distributions::Alphanumeric, Rng};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse sysinfo::System;\nuse tokio::sync::Mutex;\nuse tower_cookies::{Cookie, Cookies};\nuse tracing::warn;\n\n// Define the custom header name for CSRF token\nstatic X_CSRF_TOKEN: HeaderName = HeaderName::from_static(\"x-csrf-token\");\n\n/// Collector for system information.\n/// Holds a single `System` instance to avoid repeated initialization\n/// and to allow for more accurate CPU readings over time.\n#[derive(Debug)]\npub struct SystemInfoCollector {\n    system: Mutex\u003cSystem\u003e,\n}\n\nimpl SystemInfoCollector {\n    /// Creates a new `SystemInfoCollector`.\n    pub fn new() -\u003e Self {\n        Self {\n            system: Mutex::new(System::new_all()),\n        }\n    }\n\n    /// Returns the current memory usage in MB.\n    pub async fn get_memory_usage(\u0026self) -\u003e u64 {\n        let mut sys = self.system.lock().await;\n        sys.refresh_memory();\n        sys.used_memory() / 1024 / 1024\n    }\n\n    /// Returns the current global CPU usage percentage.\n    /// This requires a short delay between refreshes to get an accurate reading.\n    pub async fn get_cpu_usage(\u0026self) -\u003e f64 {\n        let mut sys = self.system.lock().await;\n        sys.refresh_cpu();\n        // Drop the lock to allow other tasks to run during sleep\n        drop(sys);\n\n        tokio::time::sleep(std::time::Duration::from_millis(200)).await;\n\n        let mut sys = self.system.lock().await;\n        sys.refresh_cpu();\n        sys.global_cpu_info().cpu_usage() as f64\n    }\n\n    /// Returns the disk usage in MB.\n    /// Placeholder for now.\n    pub fn get_disk_usage(\u0026self) -\u003e u64 {\n        // TODO: Implement actual disk usage detection using sysinfo\n        0\n    }\n}\n\nimpl Default for SystemInfoCollector {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Administrative API routes\npub fn admin_routes() -\u003e Router\u003cArc\u003cAppState\u003e\u003e {\n    // Routes that require CSRF protection\n    let protected_routes = Router::new()\n        .route(\"/admin/keys\", post(add_keys))\n        .route(\"/admin/keys\", delete(delete_keys))\n        .route(\"/admin/keys/:key_id/verify\", post(verify_key))\n        .route(\"/admin/keys/:key_id/reset\", post(reset_key))\n        .route(\"/admin/config\", put(update_config))\n        .route_layer(middleware::from_fn(csrf_middleware));\n\n    // Combine all admin routes\n    Router::new()\n        .route(\"/admin\", get(serve_dashboard))\n        .route(\"/admin/health\", get(detailed_health))\n        .route(\"/admin/keys\", get(list_keys))\n        .route(\"/admin/config\", get(get_config))\n        .route(\"/admin/metrics\", get(get_metrics_summary))\n        .route(\"/admin/csrf-token\", get(get_csrf_token))\n        .route(\"/admin/login\", post(login)) // Moved here, outside of CSRF protection\n        .merge(protected_routes)\n}\n\n/// Detailed health check response\n#[derive(Debug, Serialize)]\npub struct DetailedHealthStatus {\n    pub status: String,\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub version: String,\n    pub uptime_seconds: u64,\n    pub server_info: ServerInfo,\n    pub key_status: KeyStatus,\n    pub proxy_status: HashMap\u003cString, ProxyStatus\u003e,\n    pub system_info: SystemInfo,\n}\n\n#[derive(Debug, Serialize)]\npub struct ServerInfo {\n    pub host: String,\n    pub port: u16,\n    pub rust_version: String,\n    pub build_info: BuildInfo,\n}\n\n#[derive(Debug, Serialize)]\npub struct BuildInfo {\n    pub version: String,\n    pub git_hash: String,\n    pub build_date: String,\n    pub target: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct KeyStatus {\n    pub total_keys: usize,\n    pub active_keys: usize,\n    pub limited_keys: usize,\n    pub invalid_keys: usize,\n    pub temporarily_unavailable_keys: usize,\n    pub groups: Vec\u003cGroupStatus\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct GroupStatus {\n    pub name: String,\n    pub total_keys: usize,\n    pub active_keys: usize,\n    pub proxy_url: Option\u003cString\u003e,\n    pub target_url: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct ProxyStatus {\n    pub url: String,\n    pub status: String,\n    pub last_check: DateTime\u003cUtc\u003e,\n    pub groups_using: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct SystemInfo {\n    pub memory_usage_mb: u64,\n    pub cpu_usage_percent: f64,\n    pub disk_usage_mb: u64,\n}\n\n/// Key management request/response types\n#[derive(Debug, Deserialize, Serialize)]\npub struct KeysUpdateRequest {\n    pub group_name: String,\n    pub api_keys: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct KeyInfo {\n    pub id: String,\n    pub group_name: String,\n    pub key_preview: String,\n    pub status: String,\n    pub last_used: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub reset_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ListKeysQuery {\n    pub group: Option\u003cString\u003e,\n    pub status: Option\u003cString\u003e,\n}\n\n/// Configuration update request\n#[derive(Debug, Deserialize)]\npub struct ConfigUpdateRequest {\n    pub config: AppConfig,\n    pub restart_required: Option\u003cbool\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct LoginRequest {\n    token: String,\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct CsrfTokenResponse {\n    pub csrf_token: String,\n}\n\n/// Detailed health check endpoint\n///\n/// # Errors\n///\n/// This function currently does not return any errors, but is declared as `Result`\n/// for future compatibility where I/O or other operations might fail.\n#[axum::debug_handler]\npub async fn detailed_health(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n) -\u003e Result\u003cJson\u003cDetailedHealthStatus\u003e\u003e {\n    let key_manager_guard = state.key_manager.read().await;\n    let all_key_info = key_manager_guard.get_all_key_info();\n    let _key_states = key_manager_guard.get_key_states();\n    let now = Utc::now();\n    let mut active_keys = 0;\n    let mut limited_keys = 0;\n    let mut invalid_keys = 0;\n    let mut temp_unavailable_keys = 0;\n\n    for key_info in \u0026all_key_info {\n        let (status_str, _) = get_key_status_str(key_manager_guard.get_key_states().get(\u0026key_info.key), now);\n        match status_str {\n            \"available\" =\u003e active_keys += 1,\n            \"limited\" =\u003e limited_keys += 1,\n            \"invalid\" =\u003e invalid_keys += 1,\n            \"unavailable\" =\u003e temp_unavailable_keys += 1,\n            _ =\u003e warn!(\n                \"Unknown key status '{}' encountered during health check\",\n                status_str\n            ),\n        }\n    }\n\n    // Build group status\n    let mut groups_map: HashMap\u003cString, GroupStatus\u003e = HashMap::new();\n    for key_info in \u0026all_key_info {\n        let entry = groups_map\n            .entry(key_info.group_name.clone())\n            .or_insert_with(|| GroupStatus {\n                name: key_info.group_name.clone(),\n                total_keys: 0,\n                active_keys: 0,\n                proxy_url: key_info.proxy_url.clone(),\n                target_url: key_info.target_url.clone(),\n            });\n        entry.total_keys += 1;\n\n        let (status_str, _) = get_key_status_str(key_manager_guard.get_key_states().get(\u0026key_info.key), now);\n        if status_str == \"available\" {\n            entry.active_keys += 1;\n        }\n    }\n    let group_statuses = groups_map.into_values().collect();\n\n    // Build proxy status\n    let proxy_status = HashMap::new();\n    // TODO: Implement proxy health checks\n\n    let uptime = state.start_time.elapsed().as_secs();\n    let config_guard = state.config.read().await;\n\n    let health_status = DetailedHealthStatus {\n        status: \"healthy\".to_string(),\n        timestamp: now,\n        version: option_env!(\"CARGO_PKG_VERSION\")\n            .unwrap_or(\"N/A\")\n            .to_string(),\n        uptime_seconds: uptime,\n        server_info: ServerInfo {\n            host: \"0.0.0.0\".to_string(),\n            port: config_guard.server.port,\n            rust_version: \"N/A\".to_string(), // sysinfo doesn't provide this\n            build_info: BuildInfo {\n                version: option_env!(\"CARGO_PKG_VERSION\")\n                    .unwrap_or(\"N/A\")\n                    .to_string(),\n                git_hash: \"N/A\".to_string(),\n                build_date: \"N/A\".to_string(),\n                target: \"N/A\".to_string(),\n            },\n        },\n        key_status: KeyStatus {\n            total_keys: all_key_info.len(),\n            active_keys,\n            limited_keys,\n            invalid_keys,\n            temporarily_unavailable_keys: temp_unavailable_keys,\n            groups: group_statuses,\n        },\n        proxy_status,\n        system_info: SystemInfo {\n            memory_usage_mb: state.system_info.get_memory_usage().await,\n            cpu_usage_percent: state.system_info.get_cpu_usage().await,\n            disk_usage_mb: state.system_info.get_disk_usage(),\n        },\n    };\n\n    Ok(Json(health_status))\n}\n\n/// List API keys\n///\n/// # Errors\n///\n/// This function currently does not return errors but is declared as `Result`\n/// for future compatibility.\n#[axum::debug_handler]\n#[allow(clippy::significant_drop_tightening)]\npub async fn list_keys(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    Query(query): Query\u003cListKeysQuery\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cKeyInfo\u003e\u003e\u003e {\n    let key_manager_guard = state.key_manager.read().await;\n    let key_states = key_manager_guard.get_key_states();\n    let all_key_info = key_manager_guard.get_all_key_info();\n    let now = Utc::now();\n\n    let mut keys = Vec::new();\n\n    for key_info in \u0026all_key_info {\n        // Filter by group if specified\n        if let Some(ref group_filter) = query.group {\n            if \u0026key_info.group_name != group_filter {\n                continue;\n            }\n        }\n\n        let (status_str, reset_time) = get_key_status_str(key_states.get(\u0026key_info.key), now);\n\n        // Filter by status if specified\n        if let Some(ref status_filter) = query.status {\n            if status_str != status_filter {\n                continue;\n            }\n        }\n\n        keys.push(KeyInfo {\n            id: format!(\"{:x}\", md5::compute(\u0026key_info.key)),\n            group_name: key_info.group_name.clone(),\n            key_preview: format!(\n                \"{}...{}\",\n                \u0026key_info.key[..6.min(key_info.key.len())],\n                if key_info.key.len() \u003e 10 {\n                    \u0026key_info.key[key_info.key.len() - 4..]\n                } else {\n                    \"\"\n                }\n            ),\n            status: status_str.to_string(),\n            last_used: None, // TODO: Track last usage\n            reset_time,\n        });\n    }\n    Ok(Json(keys))\n}\n\n/// Verify a single API key by making a test request.\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized.\n#[axum::debug_handler]\npub async fn verify_key(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Path(key_id): Path\u003cString\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"verify_key\").await?;\n\n    let mut key_manager_guard = state.key_manager.write().await;\n\n    // 1. Get key info under the write lock\n    let (key_to_verify, proxy_url, target_url) =\n        match key_manager_guard.get_key_info_by_id(\u0026key_id) {\n            Some(info) =\u003e (\n                info.key.clone(),\n                info.proxy_url.clone(),\n                info.target_url.clone(),\n            ),\n            None =\u003e {\n                return Err(AppError::NotFound(format!(\n                    \"Key with ID '{}' not found\",\n                    key_id\n                )));\n            }\n        };\n\n    // 2. Perform verification and update status within the single write lock\n    let client = state.get_client(proxy_url.as_deref()).await?;\n    let verification_result = key_manager_guard\n        .perform_key_verification(\u0026key_to_verify, \u0026target_url, \u0026client)\n        .await;\n\n    if key_manager_guard.update_key_status_from_verification(\u0026key_to_verify, verification_result) {\n        key_manager_guard.save_states().await?;\n    }\n\n    Ok(StatusCode::OK)\n}\n\n/// Reset the status of a single API key.\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized.\n#[axum::debug_handler]\npub async fn reset_key(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Path(key_id): Path\u003cString\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"reset_key\").await?;\n\n    let mut key_manager_guard = state.key_manager.write().await;\n    if key_manager_guard.reset_key_status(\u0026key_id) {\n        key_manager_guard.save_states().await?;\n    }\n\n    Ok(StatusCode::OK)\n}\n///\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized, 404 if group not found, 500 on other errors.\n#[axum::debug_handler]\npub async fn add_keys(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Json(request): Json\u003cKeysUpdateRequest\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    // 1. Authentication\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"add_keys\").await?;\n\n    // Hold write lock for the entire operation to ensure atomicity\n    let mut config_write_guard = state.config.write().await;\n\n    // 2. Modify in-memory config\n    let group_name = request.group_name;\n    let keys_to_add = request.api_keys;\n\n    let group = config_write_guard\n        .groups\n        .iter_mut()\n        .find(|g| g.name == group_name)\n        .ok_or_else(|| AppError::NotFound(format!(\"Group '{group_name}' not found\")))?;\n\n    for key in keys_to_add {\n        if !key.trim().is_empty() \u0026\u0026 !group.api_keys.contains(\u0026key) {\n            group.api_keys.push(key);\n        }\n    }\n\n    // 3. Validate before saving\n    if !config::validate_config(\u0026mut config_write_guard, \"admin_add_keys\") {\n        return Err(AppError::Config(\n            \"Validation failed after adding keys; changes not saved.\".to_string(),\n        ));\n    }\n\n    // 4. Persist to file\n    config::save_config(\u0026config_write_guard, \u0026state.config_path).await?;\n\n    // Release lock before reloading to avoid deadlock\n    drop(config_write_guard);\n\n    // 5. Reload State\n    state.reload_state_from_config().await?;\n\n    Ok(StatusCode::OK)\n}\n\n/// Remove API keys from a group\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized, 404 if group not found, 500 on other errors.\n#[axum::debug_handler]\npub async fn delete_keys(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Json(request): Json\u003cKeysUpdateRequest\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    // 1. Authentication\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"delete_keys\").await?;\n\n    // Hold write lock for the entire operation to ensure atomicity\n    let mut config_write_guard = state.config.write().await;\n\n    // 2. Modify in-memory config\n    let group_name = request.group_name;\n    let keys_to_delete: std::collections::HashSet\u003c_\u003e = request.api_keys.into_iter().collect();\n\n    let group = config_write_guard\n        .groups\n        .iter_mut()\n        .find(|g| g.name == group_name)\n        .ok_or_else(|| AppError::NotFound(format!(\"Group '{group_name}' not found\")))?;\n\n    group.api_keys.retain(|k| !keys_to_delete.contains(k));\n\n    // 3. Validate before saving\n    if !config::validate_config(\u0026mut config_write_guard, \"admin_delete_keys\") {\n        return Err(AppError::Config(\n            \"Validation failed after deleting keys; changes not saved.\".to_string(),\n        ));\n    }\n\n    // 4. Persist to file\n    config::save_config(\u0026config_write_guard, \u0026state.config_path).await?;\n\n    // Release lock before reloading to avoid deadlock\n    drop(config_write_guard);\n\n    // 5. Reload State\n    state.reload_state_from_config().await?;\n\n    Ok(StatusCode::OK)\n}\n\n/// Get current configuration\n///\n/// # Errors\n///\n/// Returns an error as this feature is not yet implemented.\n#[axum::debug_handler]\npub async fn get_config(State(state): State\u003cArc\u003cAppState\u003e\u003e) -\u003e Result\u003cJson\u003cAppConfig\u003e\u003e {\n    let config = state.config.read().await;\n    Ok(Json(config.clone()))\n}\n\n/// Update configuration\n///\n/// # Errors\n///\n/// Returns an error as this feature is not yet implemented.\n#[axum::debug_handler]\npub async fn update_config(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Json(mut new_config): Json\u003cAppConfig\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    // 1. Authentication\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"update_config\").await?;\n\n    // 2. Validation\n    if !config::validate_config(\u0026mut new_config, \"admin_update\") {\n        return Err(AppError::Config(\n            \"Validation failed for the new configuration\".to_string(),\n        ));\n    }\n\n    // 3. Persist to file\n    config::save_config(\u0026new_config, \u0026state.config_path).await?;\n\n    // 4. Update in-memory config\n    let mut config_write_guard = state.config.write().await;\n    *config_write_guard = new_config;\n    drop(config_write_guard);\n\n    // 5. Reload State\n    state.reload_state_from_config().await?;\n\n    Ok(StatusCode::OK)\n}\n\n/// Get metrics summary\n///\n/// # Errors\n///\n/// This function currently does not return errors but is declared as `Result`\n/// for future compatibility.\n#[axum::debug_handler]\npub async fn get_metrics_summary(State(_state): State\u003cArc\u003cAppState\u003e\u003e) -\u003e Result\u003cJson\u003c()\u003e\u003e {\n    // TODO: Collect actual metrics\n    Ok(Json(()))\n}\n\n/// Returns a string representation of the key's status.\nfn get_key_status_str(\n    key_state: Option\u003c\u0026KeyState\u003e,\n    now: DateTime\u003cUtc\u003e,\n) -\u003e (\u0026'static str, Option\u003cDateTime\u003cUtc\u003e\u003e) {\n    match key_state {\n        Some(state) =\u003e {\n            let is_expired = state.reset_time.is_some_and(|rt| now \u003e= rt);\n            let status = match state.status {\n                KmKeyStatus::Available =\u003e \"available\",\n                KmKeyStatus::RateLimited if is_expired =\u003e \"available\",\n                KmKeyStatus::RateLimited =\u003e \"limited\",\n                KmKeyStatus::Invalid =\u003e \"invalid\",\n                KmKeyStatus::TemporarilyUnavailable if is_expired =\u003e \"available\",\n                KmKeyStatus::TemporarilyUnavailable =\u003e \"unavailable\",\n            };\n            (status, state.reset_time)\n        }\n        None =\u003e (\"available\", None), // Default to active if no state\n    }\n}\n/// Serve the admin dashboard\n#[axum::debug_handler]\npub async fn serve_dashboard(State(state): State\u003cArc\u003cAppState\u003e\u003e) -\u003e Html\u003cString\u003e {\n    let content = include_str!(\"../static/dashboard.html\").to_string();\n\n    // Inject system info\n    let mem_usage = state.system_info.get_memory_usage().await;\n    let cpu_usage = state.system_info.get_cpu_usage().await;\n\n    let system_info_html = format!(\n        \"\u003cdiv class=\\\"p-4 bg-gray-800 rounded-lg shadow-md\\\"\u003e\n\u003ch2 class=\\\"text-xl font-bold mb-2\\\"\u003eSystem Info\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eMemory Usage:\u003c/strong\u003e {mem_usage} MB\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCPU Usage:\u003c/strong\u003e {cpu_usage:.2} %\u003c/p\u003e\n\u003c/div\u003e\"\n    );\n\n    // A bit of a hacky way to inject the info.\n    // A proper templating engine would be better.\n    let final_content = content.replace(\"\u003c!-- SYSINFO_PLACEHOLDER --\u003e\", \u0026system_info_html);\n\n    Html(final_content)\n}\n\n/// Generates a CSRF token, sets it as a cookie, and returns it in the response body.\n#[axum::debug_handler]\npub async fn get_csrf_token(jar: Cookies) -\u003e Result\u003cimpl IntoResponse\u003e {\n    let token: String = rand::thread_rng()\n        .sample_iter(\u0026Alphanumeric)\n        .take(32)\n        .map(char::from)\n        .collect();\n\n    let cookie = Cookie::build((\"csrf_token\", token.clone()))\n        .path(\"/\")\n        .secure(true)\n        .same_site(SameSite::Strict)\n        .build();\n\n    Ok((\n        jar.add(cookie),\n        Json(CsrfTokenResponse { csrf_token: token }),\n    ))\n}\n\n/// CSRF protection middleware.\nasync fn csrf_middleware(\n    cookies: Cookies,\n    req: Request\u003cBody\u003e,\n    next: Next,\n) -\u003e std::result::Result\u003cResponse, AppError\u003e {\n    // Extract the CSRF token from the cookie\n    let cookie_token = cookies\n        .get(\"csrf_token\")\n        .map(|cookie| cookie.value().to_string());\n\n    // Extract the CSRF token from the header\n    let header_token = req\n        .headers()\n        .get(\u0026X_CSRF_TOKEN)\n        .and_then(|value| value.to_str().ok())\n        .map(String::from);\n\n    match (cookie_token, header_token) {\n        (Some(c_token), Some(h_token)) if !c_token.is_empty() \u0026\u0026 c_token == h_token =\u003e {\n            // Tokens match, proceed with the request\n            Ok(next.run(req).await)\n        }\n        _ =\u003e {\n            // Tokens do not match or are missing\n            warn!(\"CSRF token mismatch or missing\");\n            Err(AppError::Csrf)\n        }\n    }\n}\n\n/// New login endpoint to set HttpOnly cookie\n#[axum::debug_handler]\npub async fn login(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    Json(request): Json\u003cLoginRequest\u003e,\n) -\u003e Result\u003cimpl IntoResponse\u003e {\n    let config = state.config.read().await;\n    let expected_token = config.server.admin_token.as_deref();\n\n    match expected_token {\n        Some(token) if !token.is_empty() \u0026\u0026 request.token == token =\u003e {\n            let cookie = Cookie::build((\"admin_token\", token.to_string()))\n                .path(\"/\")\n                .http_only(true)\n                .secure(true)\n                .same_site(SameSite::Strict)\n                .max_age(Duration::days(7)) // Uses time::Duration\n                .build();\n            Ok((jar.add(cookie), StatusCode::OK))\n        }\n        _ =\u003e {\n            warn!(\"Failed login attempt\");\n            Err(AppError::Unauthorized)\n        }\n    }\n}\n\n/// Middleware to verify admin token from Cookie or Bearer token.\nasync fn require_admin_token(\n    state: \u0026Arc\u003cAppState\u003e,\n    jar: \u0026Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    endpoint_name: \u0026str,\n) -\u003e Result\u003c()\u003e {\n    let config = state.config.read().await;\n    let expected_token = config.server.admin_token.as_deref();\n\n    let token_from_cookie = jar.get(\"admin_token\").map(|c| c.value().to_string());\n\n    let token_from_header = auth_header.map(|h| h.token().to_string());\n\n    let provided_token = token_from_cookie.or(token_from_header);\n\n    match (expected_token, provided_token) {\n        (Some(expected), Some(provided)) if !expected.is_empty() \u0026\u0026 provided == expected =\u003e Ok(()),\n        (Some(\"\"), _) =\u003e {\n            warn!(\n                \"Admin endpoint ({}) accessed but no admin_token is configured\",\n                endpoint_name\n            );\n            Err(AppError::Unauthorized)\n        }\n        _ =\u003e {\n            warn!(\n                \"Unauthorized admin access attempt for endpoint: {}\",\n                endpoint_name\n            );\n            Err(AppError::Unauthorized)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::ServerConfig;\n    use crate::key_manager::{KeyState, KeyStatus as KmKeyStatus};\n    use axum::{\n        body::Body,\n        http::{header, Request, StatusCode},\n        middleware::from_fn_with_state,\n        routing::get,\n        Router,\n    };\n    use axum_extra::headers::Authorization;\n    use chrono::{Duration, Utc};\n    use std::sync::Arc;\nuse tower::util::ServiceExt;\n    use tower_cookies::CookieManagerLayer;\n    use tempfile::TempDir;\n \n     // Handler that will be protected by the middleware\n     async fn protected_handler() -\u003e StatusCode {\n        StatusCode::OK\n    }\n\n    // Middleware test wrapper\n    async fn auth_middleware_wrapper(\n        State(state): State\u003cArc\u003cAppState\u003e\u003e,\n        jar: Cookies,\n        auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n        req: Request\u003cBody\u003e,\n        next: Next,\n    ) -\u003e Response {\n        match require_admin_token(\u0026state, \u0026jar, auth_header, \"test\").await {\n            Ok(_) =\u003e next.run(req).await,\n            Err(e) =\u003e e.into_response(),\n        }\n    }\n\n    #[test]\n    fn test_get_key_status_str() {\n        let now = Utc::now();\n        let past = now - Duration::seconds(10);\n        let future = now + Duration::seconds(10);\n\n        // 1. No state (None) -\u003e should be \"available\"\n        let (status, reset_time) = get_key_status_str(None, now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, None);\n\n        // 2. Available state\n        let state_available = KeyState {\n            status: KmKeyStatus::Available,\n            reset_time: None,\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_available), now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, None);\n\n        // 3. RateLimited, not expired\n        let state_limited_pending = KeyState {\n            status: KmKeyStatus::RateLimited,\n            reset_time: Some(future),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_limited_pending), now);\n        assert_eq!(status, \"limited\");\n        assert_eq!(reset_time, Some(future));\n\n        // 4. RateLimited, expired\n        let state_limited_expired = KeyState {\n            status: KmKeyStatus::RateLimited,\n            reset_time: Some(past),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_limited_expired), now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, Some(past));\n\n        // 5. Invalid\n        let state_invalid = KeyState {\n            status: KmKeyStatus::Invalid,\n            reset_time: None,\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_invalid), now);\n        assert_eq!(status, \"invalid\");\n        assert_eq!(reset_time, None);\n\n        // 6. TemporarilyUnavailable, not expired\n        let state_unavailable_pending = KeyState {\n            status: KmKeyStatus::TemporarilyUnavailable,\n            reset_time: Some(future),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_unavailable_pending), now);\n        assert_eq!(status, \"unavailable\");\n        assert_eq!(reset_time, Some(future));\n\n        // 7. TemporarilyUnavailable, expired\n        let state_unavailable_expired = KeyState {\n            status: KmKeyStatus::TemporarilyUnavailable,\n            reset_time: Some(past),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_unavailable_expired), now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, Some(past));\n    }\n\n    // --- Tests for require_admin_token ---\n \n    async fn setup_state(admin_token: Option\u003cString\u003e) -\u003e (Arc\u003cAppState\u003e, TempDir) {\n        let temp_dir = tempfile::tempdir().unwrap();\n        let config_path = temp_dir.path().to_path_buf();\n        let mut config = AppConfig {\n            server: ServerConfig {\n                admin_token,\n                ..Default::default()\n            },\n            ..Default::default()\n        };\n        let app_state = Arc::new(\n            AppState::new(\u0026mut config, \u0026config_path)\n                .await\n                .unwrap(),\n        );\n        (app_state, temp_dir)\n    }\n \n     fn app(state: Arc\u003cAppState\u003e) -\u003e Router {\n        Router::new()\n            .route(\"/\", get(protected_handler))\n            .route_layer(from_fn_with_state(state.clone(), auth_middleware_wrapper))\n            .layer(CookieManagerLayer::new())\n            .with_state(state)\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_no_token_provided() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n             .oneshot(Request::builder().uri(\"/\").body(Body::empty()).unwrap())\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_bearer_valid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::AUTHORIZATION, \"Bearer secret_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_cookie_valid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::COOKIE, \"admin_token=secret_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_bearer_invalid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::AUTHORIZATION, \"Bearer wrong_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_cookie_invalid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::COOKIE, \"admin_token=wrong_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_no_token_configured() {\n        let (state, _temp_dir) = setup_state(Some(\"\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .uri(\"/\")\n                     .header(header::AUTHORIZATION, \"Bearer any_token\")\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n     }\n \n     // --- Tests for csrf_middleware ---\n \n     async fn csrf_protected_handler() -\u003e StatusCode {\n         StatusCode::OK\n     }\n \n     fn csrf_app() -\u003e Router {\n         Router::new()\n             .route(\"/\", post(csrf_protected_handler))\n             .route_layer(middleware::from_fn(csrf_middleware))\n             .layer(CookieManagerLayer::new())\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_success() {\n         let app = csrf_app();\n         let token = \"correct_csrf_token\";\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, format!(\"csrf_token={}\", token))\n                     .header(\u0026X_CSRF_TOKEN, token)\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::OK);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_no_header() {\n         let app = csrf_app();\n         let token = \"correct_csrf_token\";\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, format!(\"csrf_token={}\", token))\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_no_cookie() {\n         let app = csrf_app();\n         let token = \"correct_csrf_token\";\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(\u0026X_CSRF_TOKEN, token)\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_mismatch() {\n         let app = csrf_app();\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, \"csrf_token=token_in_cookie\")\n                     .header(\u0026X_CSRF_TOKEN, \"token_in_header\")\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_empty_tokens() {\n         let app = csrf_app();\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, \"csrf_token=\")\n                     .header(\u0026X_CSRF_TOKEN, \"\")\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n }","traces":[{"line":47,"address":[11330624],"length":1,"stats":{"Line":5},"fn_name":null},{"line":49,"address":[13729792],"length":1,"stats":{"Line":5},"fn_name":null},{"line":54,"address":[11593264,11593272],"length":1,"stats":{"Line":4},"fn_name":null},{"line":55,"address":[5505479],"length":1,"stats":{"Line":2},"fn_name":null},{"line":56,"address":[6528945,6528878],"length":1,"stats":{"Line":2},"fn_name":null},{"line":57,"address":[10877068,10877135],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[13266338,13267702,13266000,13266028,13266138,13266862],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":63,"address":[5504337],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[10877861,10877939],"length":1,"stats":{"Line":2},"fn_name":null},{"line":66,"address":[11066638],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[5038355,5039012,5038870],"length":1,"stats":{"Line":2},"fn_name":null},{"line":70,"address":[11066153,11066985,11067100],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[10878629,10878702],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[10878713,10878783],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[11330784],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[11330800],"length":1,"stats":{"Line":0},"fn_name":"default"},{"line":85,"address":[11606600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[11608812,11608950,11606624],"length":1,"stats":{"Line":2},"fn_name":"admin_routes"},{"line":92,"address":[13730203,13730499,13730647,13730795,13730006,13730351,13730935],"length":1,"stats":{"Line":14},"fn_name":null},{"line":93,"address":[11331010,11333282,11330991,11331123],"length":1,"stats":{"Line":4},"fn_name":null},{"line":94,"address":[11595807,11593702,11593815,11593683],"length":1,"stats":{"Line":4},"fn_name":null},{"line":95,"address":[11607211,11607098,11607079,11609036],"length":1,"stats":{"Line":4},"fn_name":null},{"line":96,"address":[13730719,13730587,13732377,13730606],"length":1,"stats":{"Line":4},"fn_name":null},{"line":97,"address":[11594127,11595750,11594146,11594259],"length":1,"stats":{"Line":4},"fn_name":null},{"line":98,"address":[11607534,11608979,11607523,11607624],"length":1,"stats":{"Line":4},"fn_name":null},{"line":101,"address":[4907262,4908031,4908252,4907471,4908171,4907204,4907611,4907331,4907751,4907891],"length":1,"stats":{"Line":20},"fn_name":null},{"line":102,"address":[11607710,11607737,11608928,11607847],"length":1,"stats":{"Line":4},"fn_name":null},{"line":103,"address":[5234699,5234567,5234586,5235610],"length":1,"stats":{"Line":4},"fn_name":null},{"line":104,"address":[5234847,5234715,5234734,5235588],"length":1,"stats":{"Line":4},"fn_name":null},{"line":105,"address":[5234882,5234995,5234863,5235566],"length":1,"stats":{"Line":4},"fn_name":null},{"line":106,"address":[13731686,13731799,13731667,13732200],"length":1,"stats":{"Line":4},"fn_name":null},{"line":107,"address":[4907983,4907990,4908099,4908322],"length":1,"stats":{"Line":4},"fn_name":null},{"line":108,"address":[13732150,13731982,13731963,13732087],"length":1,"stats":{"Line":4},"fn_name":null},{"line":109,"address":[11595487],"length":1,"stats":{"Line":2},"fn_name":null},{"line":222,"address":[11113856,11113754,11114149,11113930],"length":1,"stats":{"Line":1},"fn_name":null},{"line":225,"address":[5496003],"length":1,"stats":{"Line":2},"fn_name":null},{"line":226,"address":[13304001,13304088,13315656,13315569],"length":1,"stats":{"Line":2},"fn_name":null},{"line":227,"address":[11104156,11104066,11115634,11115724],"length":1,"stats":{"Line":2},"fn_name":null},{"line":228,"address":[13315807,13304239],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[11115785,11104217],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[5075645,5086861],"length":1,"stats":{"Line":1},"fn_name":null},{"line":231,"address":[11104255,11115823],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[11115842,11104274],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[5086918,5075702],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[11116033,11104465,11117569,11106001],"length":1,"stats":{"Line":2},"fn_name":null},{"line":237,"address":[10917470,10917567,10931524,10919956,10929038,10929135],"length":1,"stats":{"Line":3},"fn_name":null},{"line":238,"address":[10929233,10929185,10917617,10929093,10917525,10919907,10917665,10931475],"length":1,"stats":{"Line":0},"fn_name":null},{"line":239,"address":[13306499,13308594,13317927,13318019,13306359,13306451,13318067,13320162],"length":1,"stats":{"Line":0},"fn_name":null},{"line":240,"address":[11119657,11119749,11131317,11133313,11131225,11121745,11119783,11131351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":241,"address":[11118153,11125439,11118075,11125935,11126297,11106585,11126431,11125801,11125305,11106507],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[11129315,11117747],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[11104564,11116132,11116250,11104682],"length":1,"stats":{"Line":2},"fn_name":null},{"line":251,"address":[13317150,13304844,13305582,13316412],"length":1,"stats":{"Line":2},"fn_name":null},{"line":252,"address":[5087417,5076201],"length":1,"stats":{"Line":1},"fn_name":null},{"line":253,"address":[10925924,10924704,10924980,10936272,10924974,10925918,10936542,10924873,10936441,10925817,10936548,10925648],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":254,"address":[10924723,10925667,10936291],"length":1,"stats":{"Line":1},"fn_name":null},{"line":257,"address":[6577578,6588202,6576634],"length":1,"stats":{"Line":1},"fn_name":null},{"line":258,"address":[6576694,6577638,6588262],"length":1,"stats":{"Line":1},"fn_name":null},{"line":260,"address":[11117180,11105612,11105684,11117252],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[5088210,5077049,5088265,5076994],"length":1,"stats":{"Line":2},"fn_name":null},{"line":263,"address":[11119215,11130783,11130685,11119117],"length":1,"stats":{"Line":2},"fn_name":null},{"line":264,"address":[11117540,11117494,11105972,11105926],"length":1,"stats":{"Line":1},"fn_name":null},{"line":267,"address":[13304890,13316458,13305018,13316586],"length":1,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[11118267,11129835],"length":1,"stats":{"Line":1},"fn_name":null},{"line":273,"address":[11116781,11105108,11105213,11116676],"length":1,"stats":{"Line":2},"fn_name":null},{"line":274,"address":[11884073],"length":1,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[10931860,10920292],"length":1,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[11109249,11120668,11109100,11120817],"length":1,"stats":{"Line":2},"fn_name":null},{"line":283,"address":[5081360,5092576],"length":1,"stats":{"Line":1},"fn_name":null},{"line":296,"address":[11110418,11121986],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[10923787,10935355],"length":1,"stats":{"Line":1},"fn_name":null},{"line":312,"address":[6587598,6576030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":323,"address":[5100674,5100604,5100506,5100858],"length":1,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[14101013],"length":1,"stats":{"Line":2},"fn_name":null},{"line":328,"address":[13331425,13331346,13327665,13327586],"length":1,"stats":{"Line":2},"fn_name":null},{"line":329,"address":[5101996,5098396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[11140954,11144714],"length":1,"stats":{"Line":1},"fn_name":null},{"line":332,"address":[5098501,5102101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":334,"address":[5098516,5102186,5102116,5098586],"length":1,"stats":{"Line":2},"fn_name":null},{"line":336,"address":[11141227,11144987,11141632,11145392],"length":1,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[5102692,5102764,5099164,5099092],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[13332268,13328508,13328543,13332303],"length":1,"stats":{"Line":2},"fn_name":null},{"line":345,"address":[6595574,6591814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[10943747,10943806,10939987,10940046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":351,"address":[11142783,11146543],"length":1,"stats":{"Line":1},"fn_name":null},{"line":352,"address":[11145719,11141959,11145752,11141992],"length":1,"stats":{"Line":2},"fn_name":null},{"line":353,"address":[5099544,5103144],"length":1,"stats":{"Line":1},"fn_name":null},{"line":354,"address":[10940502,10940403,10944262,10944401,10940641,10944163],"length":1,"stats":{"Line":3},"fn_name":null},{"line":356,"address":[11128948,11132766,11132708,11129006],"length":1,"stats":{"Line":2},"fn_name":null},{"line":357,"address":[11142419,11146332,11142371,11142572,11146131,11146179],"length":1,"stats":{"Line":2},"fn_name":null},{"line":358,"address":[13329226,13329270,13332986,13333030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":360,"address":[10940458,10944218],"length":1,"stats":{"Line":1},"fn_name":null},{"line":363,"address":[11142693,11146453],"length":1,"stats":{"Line":1},"fn_name":null},{"line":364,"address":[5103792,5100192],"length":1,"stats":{"Line":1},"fn_name":null},{"line":368,"address":[13331837,13328077],"length":1,"stats":{"Line":1},"fn_name":null},{"line":377,"address":[11138986,11139088,11139162,11139358],"length":1,"stats":{"Line":1},"fn_name":null},{"line":383,"address":[7218530],"length":1,"stats":{"Line":2},"fn_name":null},{"line":385,"address":[5110908,5111105,5110262,5105281,5104438,5105084],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[11141195,11135099,11141274,11135178],"length":1,"stats":{"Line":2},"fn_name":null},{"line":390,"address":[11135745,11141399,11135303,11141841],"length":1,"stats":{"Line":2},"fn_name":null},{"line":391,"address":[11141423,11135327],"length":1,"stats":{"Line":1},"fn_name":null},{"line":392,"address":[11148854,11154950],"length":1,"stats":{"Line":1},"fn_name":null},{"line":393,"address":[10953089,10946993],"length":1,"stats":{"Line":1},"fn_name":null},{"line":396,"address":[6604645,6598549],"length":1,"stats":{"Line":0},"fn_name":null},{"line":404,"address":[14102314],"length":1,"stats":{"Line":2},"fn_name":null},{"line":405,"address":[6600148,6606244,6606296,6605973,6606554,6599877,6600200,6600458],"length":1,"stats":{"Line":4},"fn_name":null},{"line":406,"address":[5107146,5112970],"length":1,"stats":{"Line":1},"fn_name":null},{"line":407,"address":[11962100],"length":1,"stats":{"Line":4},"fn_name":null},{"line":409,"address":[13337519,13343615,13338304,13343539,13344400,13337443],"length":1,"stats":{"Line":3},"fn_name":null},{"line":410,"address":[14102366],"length":1,"stats":{"Line":2},"fn_name":null},{"line":413,"address":[13337662,13343758],"length":1,"stats":{"Line":1},"fn_name":null},{"line":422,"address":[11160832,11161102,11160906,11160730],"length":1,"stats":{"Line":1},"fn_name":null},{"line":428,"address":[5118453,5115233,5115509,5115422,5118177,5118366,5115312,5116040,5118984,5118256],"length":1,"stats":{"Line":2},"fn_name":null},{"line":430,"address":[11698861],"length":1,"stats":{"Line":1},"fn_name":null},{"line":431,"address":[10960866,10960796,10957746,10957676,10961529,10958409],"length":1,"stats":{"Line":3},"fn_name":null},{"line":432,"address":[5573095],"length":1,"stats":{"Line":2},"fn_name":null},{"line":435,"address":[11149620,11146500],"length":1,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[13356496,13356570,13356766,13356394],"length":1,"stats":{"Line":1},"fn_name":null},{"line":450,"address":[10962586,10969154,10969274,10969030,10962466,10968938,10969929,10962342,10962250,10963241],"length":1,"stats":{"Line":2},"fn_name":null},{"line":453,"address":[5127175,5127800,5127877,5120743,5121368,5121445,5128039,5121607],"length":1,"stats":{"Line":2},"fn_name":null},{"line":456,"address":[5121875,5128307],"length":1,"stats":{"Line":1},"fn_name":null},{"line":457,"address":[13359027,13352339],"length":1,"stats":{"Line":1},"fn_name":null},{"line":459,"address":[10963761,10965272,10970359,10964075,10970566,10970763,10970449,10963928,10963671,10963878,10971960,10970616],"length":1,"stats":{"Line":4},"fn_name":null},{"line":462,"address":[6620177,6619249,6620160,6619232,6625920,6625937,6615751,6622439],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":463,"address":[5126448,5128739,5132000,5125589,5126469,5125568,5122307,5132021,5122217,5128649],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":465,"address":[11172760,11173818,11166281,11166072,11172969,11167130],"length":1,"stats":{"Line":3},"fn_name":null},{"line":466,"address":[13353806,13360387,13353166,13360494,13359854,13353699],"length":1,"stats":{"Line":3},"fn_name":null},{"line":467,"address":[5123371,5129803],"length":1,"stats":{"Line":1},"fn_name":null},{"line":472,"address":[11153163,11159851],"length":1,"stats":{"Line":1},"fn_name":null},{"line":473,"address":[5122886,5129318],"length":1,"stats":{"Line":0},"fn_name":null},{"line":474,"address":[13353284,13359972],"length":1,"stats":{"Line":0},"fn_name":null},{"line":479,"address":[5571514],"length":1,"stats":{"Line":2},"fn_name":null},{"line":482,"address":[11167640,11174328],"length":1,"stats":{"Line":1},"fn_name":null},{"line":485,"address":[5127217,5130576,5120785,5130444,5124012,5124144,5124903,5131335],"length":1,"stats":{"Line":2},"fn_name":null},{"line":487,"address":[5124551,5130983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[11615552,11615840,11615825],"length":1,"stats":{"Line":1},"fn_name":"delete_keys"},{"line":503,"address":[11893126],"length":1,"stats":{"Line":2},"fn_name":null},{"line":506,"address":[11893152],"length":1,"stats":{"Line":2},"fn_name":null},{"line":509,"address":[13370678,13364694],"length":1,"stats":{"Line":1},"fn_name":null},{"line":510,"address":[13370726,13364873,13370857,13364742],"length":1,"stats":{"Line":2},"fn_name":null},{"line":512,"address":[13371071,13370978,13364994,13371115,13365278,13365087,13371262,13365792,13370891,13371776,13364907,13365131],"length":1,"stats":{"Line":4},"fn_name":null},{"line":515,"address":[13367761,13368704,13367744,13373745,13371056,13368721,13373728,13365072],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":516,"address":[13373776,13367792,13371198,13367813,13368752,13373797,13365116,13371100,13365214,13368773],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":518,"address":[6637120,6628483,6631150,6634467,6632110,6637134,6631136,6632096],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":521,"address":[13371345,13365361],"length":1,"stats":{"Line":1},"fn_name":null},{"line":522,"address":[6628648,6634632],"length":1,"stats":{"Line":0},"fn_name":null},{"line":523,"address":[6634570,6628586],"length":1,"stats":{"Line":0},"fn_name":null},{"line":528,"address":[13365465,13366438,13372422,13365797,13363529,13369513,13365617,13371449,13371781,13371601],"length":1,"stats":{"Line":3},"fn_name":null},{"line":531,"address":[11166176,11172160],"length":1,"stats":{"Line":1},"fn_name":null},{"line":534,"address":[11893204],"length":1,"stats":{"Line":2},"fn_name":null},{"line":536,"address":[6636005,6630021],"length":1,"stats":{"Line":1},"fn_name":null},{"line":545,"address":[11188321,11187335,11188897,11188173,11188798,11188963,11187200,11188928,11188217,11188192,11188896,11189812,11189063,11189901,11188829,11188084,11188837,11188912,11189270,11188503,11188784,11187542,11187235],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":546,"address":[13374110,13374162,13374225,13375953,13375838,13374368,13375890,13376096],"length":1,"stats":{"Line":2},"fn_name":null},{"line":547,"address":[6637833,6639561,6639486,6637758],"length":1,"stats":{"Line":2},"fn_name":null},{"line":556,"address":[4915648,4915936,4915921],"length":1,"stats":{"Line":1},"fn_name":"update_config"},{"line":563,"address":[11881750],"length":1,"stats":{"Line":2},"fn_name":null},{"line":566,"address":[10993887,10989151],"length":1,"stats":{"Line":1},"fn_name":null},{"line":567,"address":[6641167,6645903],"length":1,"stats":{"Line":0},"fn_name":null},{"line":568,"address":[13382675,13377939],"length":1,"stats":{"Line":0},"fn_name":null},{"line":573,"address":[14022016],"length":1,"stats":{"Line":3},"fn_name":null},{"line":576,"address":[7125499],"length":1,"stats":{"Line":2},"fn_name":null},{"line":577,"address":[11184483,11179153,11183889,11179352,11179290,11184088,11184026,11179747],"length":1,"stats":{"Line":1},"fn_name":null},{"line":578,"address":[11192730,11197466],"length":1,"stats":{"Line":1},"fn_name":null},{"line":581,"address":[5493780],"length":1,"stats":{"Line":2},"fn_name":null},{"line":583,"address":[11180199,11184935],"length":1,"stats":{"Line":1},"fn_name":null},{"line":593,"address":[4916192,4916224,4916264,4916176,4916241,4916208,4916184,4916256,4916225],"length":1,"stats":{"Line":0},"fn_name":"get_metrics_summary"},{"line":595,"address":[10996841,10997801],"length":1,"stats":{"Line":0},"fn_name":null},{"line":599,"address":[4908544],"length":1,"stats":{"Line":2},"fn_name":"get_key_status_str"},{"line":603,"address":[5235835],"length":1,"stats":{"Line":2},"fn_name":null},{"line":604,"address":[13732524],"length":1,"stats":{"Line":2},"fn_name":null},{"line":605,"address":[5039856,5039861],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":606,"address":[11609228],"length":1,"stats":{"Line":2},"fn_name":null},{"line":607,"address":[4908756],"length":1,"stats":{"Line":2},"fn_name":null},{"line":608,"address":[11609347,11609476],"length":1,"stats":{"Line":2},"fn_name":null},{"line":609,"address":[4908889],"length":1,"stats":{"Line":1},"fn_name":null},{"line":610,"address":[4908789],"length":1,"stats":{"Line":2},"fn_name":null},{"line":611,"address":[13732740,13732885],"length":1,"stats":{"Line":2},"fn_name":null},{"line":612,"address":[11596251],"length":1,"stats":{"Line":1},"fn_name":null},{"line":614,"address":[13732760],"length":1,"stats":{"Line":2},"fn_name":null},{"line":616,"address":[5235967],"length":1,"stats":{"Line":1},"fn_name":null},{"line":621,"address":[11203118,11201704,11201606,11203826,11201584,11202126,11202225,11202240,11202303,11202729,11202157,11201887,11202256,11200063,11200361,11202224,11201458,11202431,11202112,11199888,11200750,11202165,11199935],"length":1,"stats":{"Line":0},"fn_name":"{async_fn#0}"},{"line":622,"address":[5157228,5154956],"length":1,"stats":{"Line":0},"fn_name":null},{"line":625,"address":[11898681],"length":1,"stats":{"Line":0},"fn_name":null},{"line":626,"address":[13387409,13389282,13389777,13386914,13389924,13387556],"length":1,"stats":{"Line":0},"fn_name":null},{"line":628,"address":[13390148,13387780],"length":1,"stats":{"Line":0},"fn_name":null},{"line":638,"address":[6651137,6653606,6651238,6653505],"length":1,"stats":{"Line":0},"fn_name":null},{"line":640,"address":[5158501,5156229],"length":1,"stats":{"Line":0},"fn_name":null},{"line":645,"address":[11003584,11003517,11003525,11002016,11002109,11003646,11004455,11002855,11003585,11003208,11003709,11003616,11002766,11002896,11003600,11004366,11003486,11002921,11003025,11003472,11002046],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":646,"address":[13392513,13390913,13390829,13392429],"length":1,"stats":{"Line":2},"fn_name":null},{"line":652,"address":[11003874,11004100,11002339,11002274,11003939,11002500],"length":1,"stats":{"Line":3},"fn_name":null},{"line":655,"address":[11002492,11004092],"length":1,"stats":{"Line":1},"fn_name":null},{"line":658,"address":[5160884,5159348],"length":1,"stats":{"Line":1},"fn_name":null},{"line":659,"address":[5159234,5160770],"length":1,"stats":{"Line":1},"fn_name":null},{"line":660,"address":[11002578,11004178],"length":1,"stats":{"Line":1},"fn_name":null},{"line":665,"address":[5236256],"length":1,"stats":{"Line":2},"fn_name":"csrf_middleware"},{"line":671,"address":[6531238,6531375],"length":1,"stats":{"Line":4},"fn_name":null},{"line":673,"address":[11085883,11085856],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":676,"address":[10879514,10879597],"length":1,"stats":{"Line":4},"fn_name":null},{"line":679,"address":[5044864,5044873],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":682,"address":[10879693],"length":1,"stats":{"Line":2},"fn_name":null},{"line":683,"address":[5040963,5040808],"length":1,"stats":{"Line":4},"fn_name":null},{"line":685,"address":[5041338,5043273,5040258,5041121],"length":1,"stats":{"Line":5},"fn_name":null},{"line":689,"address":[13269886,13269342,13393289,13268693,13393423],"length":1,"stats":{"Line":6},"fn_name":null},{"line":690,"address":[6532966],"length":1,"stats":{"Line":2},"fn_name":null},{"line":697,"address":[5244032,5243824,5244017],"length":1,"stats":{"Line":1},"fn_name":"login"},{"line":702,"address":[5162101,5161831,5161953,5166135,5166192,5166257,5166405,5161888],"length":1,"stats":{"Line":2},"fn_name":null},{"line":703,"address":[13394530,13394609,13398946,13399025],"length":1,"stats":{"Line":2},"fn_name":null},{"line":705,"address":[11199040,11194624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":706,"address":[11207911,11212327,11212403,11207987],"length":1,"stats":{"Line":2},"fn_name":null},{"line":707,"address":[11006190,11010552,11010606,11006379,11010795,11010962,11010899,11006136,11006546,11006483],"length":1,"stats":{"Line":5},"fn_name":null},{"line":711,"address":[11010787,11006410,11010826,11006371],"length":1,"stats":{"Line":2},"fn_name":null},{"line":712,"address":[11208091,11212874,11208354,11212507,11208570,11212986,11208378,11212770,11212794,11208458],"length":1,"stats":{"Line":2},"fn_name":null},{"line":714,"address":[5167413,5163109],"length":1,"stats":{"Line":1},"fn_name":null},{"line":717,"address":[11202857,11194701,11202991,11201999,11200301,11195357,11199117,11195885,11199773,11201865,11202361,11202495],"length":1,"stats":{"Line":0},"fn_name":null},{"line":718,"address":[6659029,6663445],"length":1,"stats":{"Line":0},"fn_name":null},{"line":724,"address":[5236384],"length":1,"stats":{"Line":2},"fn_name":"require_admin_token"},{"line":730,"address":[11888072],"length":1,"stats":{"Line":4},"fn_name":null},{"line":731,"address":[5045708,5045771],"length":1,"stats":{"Line":4},"fn_name":null},{"line":733,"address":[13273913,13278987,13278960,13273832],"length":1,"stats":{"Line":8},"fn_name":"{closure#0}"},{"line":735,"address":[11087148,11092304,11092331],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":737,"address":[11087284],"length":1,"stats":{"Line":2},"fn_name":null},{"line":739,"address":[10885439],"length":1,"stats":{"Line":2},"fn_name":null},{"line":740,"address":[5046527,5046368],"length":1,"stats":{"Line":4},"fn_name":null},{"line":741,"address":[11087618,11087917],"length":1,"stats":{"Line":2},"fn_name":null},{"line":742,"address":[11088489,11216601,11216735,11087926],"length":1,"stats":{"Line":2},"fn_name":null},{"line":746,"address":[11088433],"length":1,"stats":{"Line":1},"fn_name":null},{"line":749,"address":[6539875,6540403,6667183,6537469,6667049],"length":1,"stats":{"Line":3},"fn_name":null},{"line":753,"address":[6540347],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":201,"coverable":228},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","config.rs"],"content":"// src/config.rs\nuse serde::{Deserialize, Serialize};\nuse std::{collections::HashSet, fs, io, path::Path};\nuse tracing::{debug, error, info, warn};\nuse url::Url;\nuse uuid::Uuid;\n\nuse crate::error::{AppError, Result};\n\n// --- Data Structures ---\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Serialize)]\n#[serde(deny_unknown_fields)]\npub struct KeyGroup {\n    pub name: String,\n    #[serde(default)]\n    pub api_keys: Vec\u003cString\u003e,\n    #[serde(default)]\n    pub proxy_url: Option\u003cString\u003e,\n    #[serde(default = \"default_target_url\")]\n    pub target_url: String,\n    #[serde(default)]\n    pub top_p: Option\u003cf32\u003e,\n}\n\nimpl Default for KeyGroup {\n    fn default() -\u003e Self {\n        Self {\n            name: String::new(),\n            api_keys: Vec::new(),\n            proxy_url: None,\n            target_url: default_target_url(),\n            top_p: None,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Eq, Default, Serialize)]\n#[serde(rename_all = \"camelCase\")]\npub enum RateLimitBehavior {\n    BlockUntilMidnight,\n    #[default]\n    RetryNextKey,\n}\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Default, Serialize)]\n#[serde(deny_unknown_fields)]\npub struct AppConfig {\n    #[serde(default)]\n    pub server: ServerConfig,\n    #[serde(default)]\n    pub groups: Vec\u003cKeyGroup\u003e,\n    #[serde(default)]\n    pub rate_limit_behavior: RateLimitBehavior,\n    #[serde(default = \"default_internal_retries\")]\n    pub internal_retries: u32,\n    #[serde(default = \"default_temporary_block_minutes\")]\n    pub temporary_block_minutes: i64,\n}\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Serialize)]\n#[serde(deny_unknown_fields)]\npub struct ServerConfig {\n    #[serde(default = \"default_server_port\")]\n    pub port: u16,\n    #[serde(default)]\n    pub top_p: Option\u003cf32\u003e,\n    #[serde(default)]\n    pub admin_token: Option\u003cString\u003e,\n}\n\n// --- Default Implementations ---\n\nimpl Default for ServerConfig {\n    fn default() -\u003e Self {\n        Self {\n            port: default_server_port(),\n            top_p: None,\n            admin_token: None,\n        }\n    }\n}\nconst fn default_server_port() -\u003e u16 {\n    8080\n}\n\nconst fn default_internal_retries() -\u003e u32 {\n    2\n}\n\nconst fn default_temporary_block_minutes() -\u003e i64 {\n    5\n}\n\nfn default_target_url() -\u003e String {\n    \"https://generativelanguage.googleapis.com/\".to_string()\n}\n\n// --- Helper Functions ---\n\nfn clean_target_url(url_str: \u0026str) -\u003e String {\n    url_str.strip_suffix('/').unwrap_or(url_str).to_string()\n}\n\n// --- Configuration Validation Functions ---\nfn validate_server_config(server: \u0026ServerConfig) -\u003e bool {\n    let mut errors = 0;\n    // Port 0 is valid, it means the OS will assign a random available port.\n    if server.port != 0 \u0026\u0026 (server.port \u003c 1024) {\n        warn!(p = server.port, w = \"low server port warning\");\n    }\n    if let Some(tp) = server.top_p {\n        if !(0.0..=1.0).contains(\u0026tp) {\n            error!(err = \"server top_p out of range\", top_p = tp);\n            errors += 1;\n        }\n    }\n    errors == 0\n}\nfn validate_target_url(g: \u0026str, url: \u0026str) -\u003e bool {\n    match Url::parse(url) {\n        Ok(p) =\u003e {\n            if !p.has_host()\n                || p.host_str().is_none_or(str::is_empty)\n                || p.cannot_be_a_base()\n            {\n                error!(group = g, err = \"invalid/base\", url = %url);\n                false\n            } else {\n                true\n            }\n        }\n        Err(e) =\u003e {\n            error!(group = g, err = %e, url = %url, \"target parse err\");\n            false\n        }\n    }\n}\nfn validate_proxy_url(g: \u0026str, url: \u0026str) -\u003e bool {\n    match Url::parse(url) {\n        Ok(p) =\u003e {\n            if !p.has_host() || p.host_str().is_none_or(str::is_empty) {\n                error!(group = g, err = \"no_host\", url = %url);\n                return false;\n            }\n            let s = p.scheme().to_lowercase();\n            if [\"http\", \"https\", \"socks5\"].contains(\u0026s.as_str()) {\n                true\n            } else {\n                error!(group = g, err = \"bad_scheme\", url = %url, scheme = %s);\n                false\n            }\n        }\n        Err(e) =\u003e {\n            error!(group = g, err = %e, url = %url, \"proxy parse err\");\n            false\n        }\n    }\n}\n\n#[tracing::instrument(level = \"debug\", skip(cfg, source), fields(cfg.source = %source))]\npub fn validate_config(cfg: \u0026mut AppConfig, source: \u0026str) -\u003e bool {\n    let mut errors = 0;\n    if !validate_server_config(\u0026cfg.server) {\n        errors += 1;\n    }\n\n    if cfg.groups.is_empty() {\n        error!(source = source, err = \"no_groups\");\n        errors += 1;\n    } else {\n        let mut names = HashSet::new();\n        let mut keys_total = 0;\n        for group in \u0026mut cfg.groups {\n            let name = group.name.trim();\n            if name.is_empty() {\n                // Check for empty name first\n                error!(err = \"empty_name\");\n                errors += 1;\n            } else {\n                // Only check for duplicates if name is not empty\n                let upper_name = group.name.to_uppercase(); // Use uppercase for HashSet check\n                debug!(group.name = %group.name, group.upper = %upper_name, ?names, \"Attempting to insert into HashSet\"); // Added debug before insert\n                let insert_result = names.insert(upper_name.clone());\n                debug!(group.name = %group.name, group.upper = %upper_name, set.insert_result = insert_result, set.current_size = names.len(), \"Checking group name for duplicates\");\n                if !insert_result {\n                    // Check duplicate result\n                    error!(group = %group.name, err = \"duplicate\");\n                    errors += 1;\n                }\n            }\n            // Check for empty keys independently\n            if group.api_keys.is_empty() {\n                warn!(group = %group.name, warn = \"no_keys\"); /* Group without keys is warned, but not instant error */\n            }\n            keys_total += group.api_keys.len();\n\n            // Clean the target URL in-place\n            group.target_url = clean_target_url(\u0026group.target_url);\n\n            if !validate_target_url(\u0026group.name, \u0026group.target_url) {\n                errors += 1;\n            }\n            if let Some(p) = \u0026group.proxy_url {\n                if !validate_proxy_url(\u0026group.name, p) {\n                    errors += 1;\n                }\n            }\n            if let Some(tp) = group.top_p {\n                if !(0.0..=1.0).contains(\u0026tp) {\n                    error!(group = %group.name, err = \"top_p_out_of_range\", top_p = tp);\n                    errors += 1;\n                }\n            }\n        }\n        // Error only if total keys across all groups is zero (ignoring groups that might have been defined but had no keys)\n        if keys_total == 0 {\n            error!(err = \"no_usable_keys\");\n            errors += 1;\n        }\n    }\n    if errors \u003e 0 {\n        error!(count = errors, \"Validation finished: ERRORS.\");\n        false\n    } else {\n        debug!(\"Validation OK.\");\n        true\n    }\n}\n\n// --- Main Loading Function ---\n#[tracing::instrument(level = \"info\", skip(path), fields(config.path = %path.display()))]\n/// Loads the application configuration from a YAML file.\n///\n/// # Arguments\n/// * `path` - The path to the configuration YAML file.\n///\n/// # Errors\n/// Returns an `AppError::Config` if:\n/// - The YAML file cannot be read or parsed.\n/// - Validation of the final configuration fails.\n/// - Any I/O error occurs during file reading.\npub fn load_config(path: \u0026Path) -\u003e Result\u003cAppConfig\u003e {\n    let path_str = path.display().to_string();\n    let contents = match fs::read_to_string(path) {\n        Ok(c) =\u003e c,\n        Err(e) if e.kind() == io::ErrorKind::NotFound =\u003e {\n            error!(src = \"yaml\", path = %path_str, \"Config file not found.\");\n            return Err(AppError::Config(format!(\n                \"Config file not found: {path_str}\"\n            )));\n        }\n        Err(e) =\u003e {\n            error!(src = \"yaml\", e = %e, \"Read error\");\n            return Err(AppError::Io(io::Error::new(\n                e.kind(),\n                format!(\"Read error {path_str}: {e}\"),\n            )));\n        }\n    };\n\n    if contents.trim().is_empty() {\n        warn!(src = \"yaml\", \"Config file is empty.\");\n        return Err(AppError::Config(format!(\n            \"Config file is empty: {path_str}\"\n        )));\n    }\n\n    let mut config: AppConfig = match serde_yaml::from_str(\u0026contents) {\n        Ok(cfg) =\u003e cfg,\n        Err(e) =\u003e {\n            error!(src = \"yaml\", e = %e, \"Parse error\");\n            return Err(AppError::Config(format!(\n                \"Failed to parse config file {path_str}: {e}\"\n            )));\n        }\n    };\n\n    if !validate_config(\u0026mut config, \u0026path_str) {\n        error!(config.source = %path_str, \"Validation failed.\");\n        return Err(AppError::Config(\"Validation failed\".to_string()));\n    }\n\n    info!(\n        groups = config.groups.len(),\n        keys_total = config\n            .groups\n            .iter()\n            .map(|g| g.api_keys.len())\n            .sum::\u003cusize\u003e(),\n        \"Config loaded OK.\"\n    );\n    Ok(config)\n}\n\n/// Asynchronously saves the application configuration to a YAML file atomically.\n///\n/// # Arguments\n/// * `config` - A reference to the `AppConfig` to be saved.\n/// * `path` - The path to the target configuration YAML file.\n///\n/// # Errors\n/// Returns an `AppError` if:\n/// - The configuration cannot be serialized to YAML.\n/// - The parent directory of the path does not exist.\n/// - The temporary file cannot be written.\n/// - The temporary file cannot be renamed to the final path.\n#[tracing::instrument(level = \"info\", skip(config, path), fields(config.path = %path.display()))]\npub async fn save_config(config: \u0026AppConfig, path: \u0026Path) -\u003e Result\u003c()\u003e {\n    let yaml_data = serde_yaml::to_string(config).map_err(|e| {\n        error!(error = %e, \"Failed to serialize AppConfig to YAML\");\n        AppError::Config(format!(\"Failed to serialize config: {e}\"))\n    })?;\n\n    let parent_dir = path.parent().ok_or_else(|| {\n        error!(\"Config file path has no parent directory\");\n        AppError::Io(io::Error::new(\n            io::ErrorKind::InvalidInput,\n            \"Config file path has no parent directory\",\n        ))\n    })?;\n\n    tokio::fs::create_dir_all(parent_dir).await?;\n\n    let base_filename = path.file_name().unwrap_or_default().to_string_lossy();\n    let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n    let temp_path = parent_dir.join(\u0026temp_filename);\n\n    tokio::fs::write(\u0026temp_path, yaml_data).await?;\n\n    if let Err(e) = tokio::fs::rename(\u0026temp_path, path).await {\n        error!(\n            from = %temp_path.display(),\n            to = %path.display(),\n            error = ?e,\n            \"Failed to atomically rename temporary config file\"\n        );\n        // Attempt to clean up the temp file on rename failure\n        if let Err(rm_err) = tokio::fs::remove_file(\u0026temp_path).await {\n            warn!(\n                temp_file.path = %temp_path.display(),\n                error = ?rm_err,\n                \"Failed to remove temporary file after rename failure\"\n            );\n        }\n        return Err(e.into());\n    }\n\n    info!(\"Successfully saved configuration.\");\n    Ok(())\n}\n\n// --- Tests ---\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs::File;\n    use std::io::Write;\n    use std::path::PathBuf;\n    use tempfile::tempdir;\n    fn create_temp_config_file(d: \u0026tempfile::TempDir, c: \u0026str) -\u003e PathBuf {\n        let p = d.path().join(\"t.yaml\");\n        File::create(\u0026p)\n            .unwrap()\n            .write_all(c.as_bytes())\n            .unwrap();\n        p\n    }\n    #[test]\n    fn test_clean_url() {\n        assert_eq!(clean_target_url(\"h://a/p/\"), \"h://a/p\");\n        assert_eq!(clean_target_url(\"h://a/p\"), \"h://a/p\");\n    }\n    #[test]\n    fn test_val_srv() {\n        // Default config should be valid\n        assert!(validate_server_config(\u0026ServerConfig::default()));\n        // Port 0 is now considered valid for testing purposes (OS assigns a random port)\n        assert!(validate_server_config(\u0026ServerConfig {\n            port: 0,\n            top_p: None,\n            admin_token: None,\n        }));\n    }\n    #[test]\n    fn test_val_target_ok() {\n        assert!(validate_target_url(\"g\", \"https://e.com\"));\n    }\n    #[test]\n    fn test_val_target_bad() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        assert!(!validate_target_url(\"g\", \":b\"));\n        assert!(!validate_target_url(\"g\", \"e.com\"));\n        assert!(!validate_target_url(\"g\", \"https://\"));\n        assert!(!validate_target_url(\"g\", \"\"));\n        assert!(!validate_target_url(\"g\", \"http://\"));\n    }\n    #[test]\n    fn test_val_proxy_ok() {\n        assert!(validate_proxy_url(\"g\", \"http://p\"));\n        assert!(validate_proxy_url(\"g\", \"socks5://p\"));\n    }\n    #[test]\n    fn test_val_proxy_bad() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        assert!(!validate_proxy_url(\"g\", \":b\"));\n        assert!(!validate_proxy_url(\"g\", \"ftp://p\"));\n        assert!(!validate_proxy_url(\"g\", \"http://\"));\n        assert!(!validate_proxy_url(\"g\", \"socks5://\"));\n        assert!(!validate_proxy_url(\"g\", \"\"));\n    }\n    #[test]\n    fn test_val_cfg_ok() {\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"G\".into(),\n                api_keys: vec![\"k\".into()],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_bad_name() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"\".into(),\n                api_keys: vec![\"k\".into()],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_dupe_name() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![\n                KeyGroup {\n                    name: \"N\".into(),\n                    api_keys: vec![\"k\".into()],\n                    proxy_url: None,\n                    target_url: default_target_url(),\n                    top_p: None,\n                },\n                KeyGroup {\n                    name: \"n\".into(),\n                    api_keys: vec![\"k\".into()],\n                    proxy_url: None,\n                    target_url: default_target_url(),\n                    top_p: None,\n                },\n            ],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_empty_keys_ok() {\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"G\".into(),\n                api_keys: vec![\"k1\".to_string(), \"k3\".to_string()],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_no_keys() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"G\".into(),\n                api_keys: vec![],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    } // Should fail validation as total keys = 0\n    #[test]\n    fn test_val_cfg_no_groups() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    }\n\n    #[test]\n    fn test_load_no_groups_from_file() {\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, \"server:\\n  port: 1\\n\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Validation failed\"))\n        );\n    }\n\n    #[test]\n    fn test_load_config_from_file_ok() {\n        let yaml_content = r#\"\nserver:\n  port: 8081\ngroups:\n  - name: \"Group1\"\n    api_keys: [\"key1\", \"key2\"]\n    target_url: \"https://api.example.com/\"\n    proxy_url: \"http://proxy.example.com\"\n    top_p: 0.9\n\"#;\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, yaml_content);\n        let cfg = load_config(\u0026p).expect(\"Should load config successfully\");\n\n        assert_eq!(cfg.server.port, 8081);\n        assert_eq!(cfg.groups.len(), 1);\n        let group = \u0026cfg.groups[0];\n        assert_eq!(group.name, \"Group1\");\n        assert_eq!(group.api_keys, vec![\"key1\", \"key2\"]);\n        assert_eq!(group.target_url, \"https://api.example.com\"); // Note trailing slash is removed\n        assert_eq!(group.proxy_url, Some(\"http://proxy.example.com\".to_string()));\n        assert_eq!(group.top_p, Some(0.9));\n    }\n\n    #[test]\n    fn test_load_config_file_not_found() {\n        let d = tempdir().unwrap();\n        let p = d.path().join(\"non_existent_config.yaml\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Config file not found\"))\n        );\n    }\n\n    #[test]\n    fn test_load_empty_config_file() {\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, \"\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Config file is empty\"))\n        );\n    }\n\n    #[test]\n    fn test_load_bad_yaml() {\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, \"server: { port: 123,\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Failed to parse config file\"))\n        );\n    }\n} // end tests module\n","traces":[{"line":27,"address":[13658912,13659236,13659211],"length":1,"stats":{"Line":1},"fn_name":"default"},{"line":29,"address":[13338396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[13822240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[11535647],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[11522640],"length":1,"stats":{"Line":2},"fn_name":"default"},{"line":77,"address":[6940766],"length":1,"stats":{"Line":2},"fn_name":null},{"line":83,"address":[25739237,25739264,25739273],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}\u003creqwest::config::RequestTimeout\u003e"},{"line":84,"address":[13230081,13230183,13229120],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[27507536],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[25739305],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[11536048],"length":1,"stats":{"Line":3},"fn_name":"default_target_url"},{"line":96,"address":[6611784],"length":1,"stats":{"Line":3},"fn_name":null},{"line":101,"address":[6940944],"length":1,"stats":{"Line":3},"fn_name":"clean_target_url"},{"line":102,"address":[11536130],"length":1,"stats":{"Line":3},"fn_name":null},{"line":106,"address":[11522944,11523793],"length":1,"stats":{"Line":3},"fn_name":"validate_server_config"},{"line":107,"address":[6611943],"length":1,"stats":{"Line":3},"fn_name":null},{"line":109,"address":[11522978,11523021],"length":1,"stats":{"Line":6},"fn_name":null},{"line":110,"address":[13660403,13659637],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[11536241,11537990],"length":1,"stats":{"Line":3},"fn_name":null},{"line":113,"address":[6615492,6613732],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[12883279,12883145],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[6943760,6944622,6944634],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[6942895],"length":1,"stats":{"Line":3},"fn_name":null},{"line":120,"address":[6944656,6947698,6947704],"length":1,"stats":{"Line":3},"fn_name":"validate_target_url"},{"line":121,"address":[11539831,11540650],"length":1,"stats":{"Line":3},"fn_name":null},{"line":122,"address":[11539943],"length":1,"stats":{"Line":3},"fn_name":null},{"line":123,"address":[11264951,11265686,11265028],"length":1,"stats":{"Line":6},"fn_name":null},{"line":124,"address":[11540153],"length":1,"stats":{"Line":3},"fn_name":null},{"line":125,"address":[6615967],"length":1,"stats":{"Line":3},"fn_name":null},{"line":127,"address":[11265564,11265034,11265220,11265691],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[11527518],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[11527026],"length":1,"stats":{"Line":3},"fn_name":null},{"line":133,"address":[11539897],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[13231040,13230372,13230304,13230933,13231012],"length":1,"stats":{"Line":2},"fn_name":null},{"line":135,"address":[11269030],"length":1,"stats":{"Line":1},"fn_name":null},{"line":139,"address":[6956583,6950272,6954049],"length":1,"stats":{"Line":1},"fn_name":"validate_proxy_url"},{"line":140,"address":[6951344,6950326],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[11270486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":142,"address":[13231197,13231281,13232107],"length":1,"stats":{"Line":3},"fn_name":null},{"line":143,"address":[13672558,13673041,13669113],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[6625370],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[13354766,13354980],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[6621747,6622328,6621850,6621664],"length":1,"stats":{"Line":4},"fn_name":null},{"line":148,"address":[13669478],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[13341826],"length":1,"stats":{"Line":3},"fn_name":null},{"line":151,"address":[13825910,13825933,13825072,13825971,13825470,13825997],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[13355256],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[13668902,13676370,13675092],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[11277909],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[11282560,11310082,11284201],"length":1,"stats":{"Line":3},"fn_name":"validate_config"},{"line":163,"address":[13342475,13342621,13342057,13342564],"length":1,"stats":{"Line":3},"fn_name":null},{"line":164,"address":[6633863,6635467,6635402],"length":1,"stats":{"Line":6},"fn_name":null},{"line":165,"address":[11546520,11546529,11546464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[6964668,6985919,6964607],"length":1,"stats":{"Line":7},"fn_name":null},{"line":169,"address":[11578921,11579407,11559829],"length":1,"stats":{"Line":3},"fn_name":null},{"line":170,"address":[6656664,6656676,6654993],"length":1,"stats":{"Line":2},"fn_name":null},{"line":172,"address":[13826848],"length":1,"stats":{"Line":3},"fn_name":null},{"line":173,"address":[8271234],"length":1,"stats":{"Line":3},"fn_name":null},{"line":174,"address":[13683327,13681332,13683240],"length":1,"stats":{"Line":6},"fn_name":null},{"line":175,"address":[13826928],"length":1,"stats":{"Line":6},"fn_name":null},{"line":176,"address":[6648759,6637749],"length":1,"stats":{"Line":4},"fn_name":null},{"line":178,"address":[13827122],"length":1,"stats":{"Line":3},"fn_name":null},{"line":179,"address":[6977992,6976669,6977980],"length":1,"stats":{"Line":2},"fn_name":null},{"line":182,"address":[15645984],"length":1,"stats":{"Line":6},"fn_name":null},{"line":183,"address":[11549020,11549506,11548941],"length":1,"stats":{"Line":9},"fn_name":null},{"line":184,"address":[6641080,6638408],"length":1,"stats":{"Line":6},"fn_name":null},{"line":185,"address":[11290382,11290892],"length":1,"stats":{"Line":6},"fn_name":null},{"line":186,"address":[11565961,11571283],"length":1,"stats":{"Line":4},"fn_name":null},{"line":188,"address":[15646258],"length":1,"stats":{"Line":3},"fn_name":null},{"line":189,"address":[13233904,13233824,13233857,13233932],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":193,"address":[6978020,6976181],"length":1,"stats":{"Line":6},"fn_name":null},{"line":194,"address":[13828012,13827937,13827984,13827904],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":196,"address":[11562174,11559922,11562246],"length":1,"stats":{"Line":6},"fn_name":null},{"line":199,"address":[6980331,6980403,6980441],"length":1,"stats":{"Line":6},"fn_name":null},{"line":201,"address":[13699276,13699032],"length":1,"stats":{"Line":3},"fn_name":null},{"line":202,"address":[6980782,6980685,6980773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[11300867,11300764],"length":1,"stats":{"Line":4},"fn_name":null},{"line":205,"address":[11300875,11301087,11300966],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[11576180,11576140],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[11562961,11562746],"length":1,"stats":{"Line":4},"fn_name":null},{"line":210,"address":[13702248,13699583],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[11563546,11563025],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[11303805,11303793,11301676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[11285019,11286861],"length":1,"stats":{"Line":4},"fn_name":null},{"line":218,"address":[12161423,12161289],"length":1,"stats":{"Line":3},"fn_name":null},{"line":219,"address":[6637638,6637626,6636315],"length":1,"stats":{"Line":2},"fn_name":null},{"line":222,"address":[6637659,6657227,6659050],"length":1,"stats":{"Line":7},"fn_name":null},{"line":223,"address":[11569722,11570191,11567861],"length":1,"stats":{"Line":4},"fn_name":null},{"line":224,"address":[13706786],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[13234530],"length":1,"stats":{"Line":9},"fn_name":null},{"line":227,"address":[13704963],"length":1,"stats":{"Line":3},"fn_name":null},{"line":243,"address":[11310128,11311851,11330536],"length":1,"stats":{"Line":3},"fn_name":"load_config"},{"line":244,"address":[11587436,11585741],"length":1,"stats":{"Line":6},"fn_name":null},{"line":245,"address":[11312470,11312407],"length":1,"stats":{"Line":6},"fn_name":null},{"line":246,"address":[13710996],"length":1,"stats":{"Line":3},"fn_name":null},{"line":247,"address":[7004388,6992467,7004489],"length":1,"stats":{"Line":6},"fn_name":null},{"line":248,"address":[5949769,5949903],"length":1,"stats":{"Line":6},"fn_name":null},{"line":249,"address":[7008057,7010121],"length":1,"stats":{"Line":4},"fn_name":null},{"line":253,"address":[11324485],"length":1,"stats":{"Line":0},"fn_name":null},{"line":254,"address":[10588719,10588585],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[11602521],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[11325107],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[6677860],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[11574468,11574551],"length":1,"stats":{"Line":6},"fn_name":null},{"line":263,"address":[6663496,6672559,6673045],"length":1,"stats":{"Line":3},"fn_name":null},{"line":264,"address":[11324119,11322403],"length":1,"stats":{"Line":2},"fn_name":null},{"line":269,"address":[11587873,11587943],"length":1,"stats":{"Line":6},"fn_name":null},{"line":270,"address":[11588046],"length":1,"stats":{"Line":3},"fn_name":null},{"line":271,"address":[13711359],"length":1,"stats":{"Line":2},"fn_name":null},{"line":272,"address":[11580888,11574767,11581374],"length":1,"stats":{"Line":6},"fn_name":null},{"line":273,"address":[11594592,11596754],"length":1,"stats":{"Line":4},"fn_name":null},{"line":279,"address":[11588297,11588214],"length":1,"stats":{"Line":6},"fn_name":null},{"line":280,"address":[12893065,12893199],"length":1,"stats":{"Line":3},"fn_name":null},{"line":281,"address":[6995538,6993722],"length":1,"stats":{"Line":2},"fn_name":null},{"line":284,"address":[12893695,12893561],"length":1,"stats":{"Line":11},"fn_name":null},{"line":285,"address":[11579093,11580056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[6998359,6997396],"length":1,"stats":{"Line":1},"fn_name":null},{"line":289,"address":[12165696,12165744,12165769,12165721],"length":1,"stats":{"Line":2},"fn_name":"{closure#6}"},{"line":293,"address":[11578043],"length":1,"stats":{"Line":3},"fn_name":null},{"line":309,"address":[11605682,11605664],"length":1,"stats":{"Line":5},"fn_name":"save_config"},{"line":310,"address":[10609105,10609111,10595450,10594492,10606640,10607092,10594846,10594691],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":311,"address":[12913593,12910086,12913727,12909663,12910230,12909742],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[12183606,12181896],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[12898208,12897957,12898061,12898420,12912128,12912691],"length":1,"stats":{"Line":2},"fn_name":"{closure#1}"},{"line":316,"address":[5372585,5373817,5373951,5371873,5372420],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[5971482],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[5372513],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[12897548,12898292,12899519,12898487],"length":1,"stats":{"Line":2},"fn_name":null},{"line":325,"address":[10595853],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[12170741,12170662],"length":1,"stats":{"Line":2},"fn_name":null},{"line":327,"address":[12899211],"length":1,"stats":{"Line":1},"fn_name":null},{"line":329,"address":[14034981],"length":1,"stats":{"Line":3},"fn_name":null},{"line":331,"address":[12899882,12897590,12900043],"length":1,"stats":{"Line":2},"fn_name":null},{"line":332,"address":[12174875,12173899,12172042,12175137,12186281,12186415,12172661,12173637,12172148],"length":1,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[5960523,5961761],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[5960820,5962058],"length":1,"stats":{"Line":0},"fn_name":null},{"line":339,"address":[5964789,5956299,5962705,5959612],"length":1,"stats":{"Line":0},"fn_name":null},{"line":340,"address":[12179668,12186911,12186777,12178099,12178218,12178719,12180554],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[10619032,10618146],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[10606372,10606444],"length":1,"stats":{"Line":0},"fn_name":null},{"line":349,"address":[5974399,5963360,5974265,5962802],"length":1,"stats":{"Line":2},"fn_name":null},{"line":350,"address":[5963319],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":111,"coverable":142},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","config_watcher.rs"],"content":"// src/config_watcher.rs\n\nuse crate::config::{load_config, AppConfig};\nuse crate::error::{AppError, Result};\nuse notify::{Config, Event, RecommendedWatcher, RecursiveMode, Watcher};\nuse std::path::{Path, PathBuf};\nuse std::sync::Arc;\nuse tokio::sync::{mpsc, RwLock};\nuse tracing::{debug, error, info, warn};\n\n/// Configuration watcher that monitors config file changes\npub struct ConfigWatcher {\n    config_path: PathBuf,\n    current_config: Arc\u003cRwLock\u003cAppConfig\u003e\u003e,\n    _watcher: RecommendedWatcher,\n    receiver: mpsc::Receiver\u003cResult\u003cAppConfig\u003e\u003e,\n}\n\nimpl ConfigWatcher {\n    /// Create a new config watcher\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if the initial configuration cannot be loaded or if the\n    /// file watcher cannot be created.\n    pub fn new(config_path: PathBuf) -\u003e Result\u003cSelf\u003e {\n        let (tx, receiver) = mpsc::channel(10);\n        let config_path_clone = config_path.clone();\n\n        let mut watcher = RecommendedWatcher::new(\n            #[allow(clippy::cognitive_complexity)]\n            move |res: notify::Result\u003cEvent\u003e| {\n                if let Ok(event) = res {\n                    debug!(\"Config file event: {event:?}\");\n\n                    // Only react to write events\n                    if matches!(event.kind, notify::EventKind::Modify(_)) {\n                        info!(\"Config file modified, reloading...\");\n\n                        match load_config(\u0026config_path_clone) {\n                            Ok(new_config) =\u003e {\n                                if let Err(e) = tx.try_send(Ok(new_config)) {\n                                    warn!(\"Failed to send config update: {e}\");\n                                }\n                            }\n                            Err(e) =\u003e {\n                                error!(\"Failed to reload config: {e:?}\");\n                                if let Err(send_err) = tx.try_send(Err(e)) {\n                                    warn!(\"Failed to send config error: {send_err}\");\n                                }\n                            }\n                        }\n                    }\n                } else if let Err(e) = res {\n                    error!(\"Config watcher error: {e:?}\");\n                }\n            },\n            Config::default(),\n        )\n        .map_err(|e| AppError::Internal(format!(\"Failed to create file watcher: {e}\")))?;\n\n        // Watch the config file\n        watcher\n            .watch(\u0026config_path, RecursiveMode::NonRecursive)\n            .map_err(|e| AppError::Internal(format!(\"Failed to watch config file: {e}\")))?;\n\n        // Load initial config\n        let initial_config = load_config(\u0026config_path)?;\n        let current_config = Arc::new(RwLock::new(initial_config));\n\n        info!(\"Config watcher initialized for: {}\", config_path.display());\n\n        Ok(Self {\n            config_path,\n            current_config,\n            _watcher: watcher,\n            receiver,\n        })\n    }\n\n    /// Get the current configuration\n    pub async fn get_config(\u0026self) -\u003e AppConfig {\n        self.current_config.read().await.clone()\n    }\n\n    /// Wait for the next configuration change\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if the configuration cannot be reloaded or if the\n    /// watcher channel has been closed.\n    pub async fn wait_for_change(\u0026mut self) -\u003e Result\u003cAppConfig\u003e {\n        if let Some(config_result) = self.receiver.recv().await {\n            match config_result {\n                Ok(new_config) =\u003e {\n                    info!(\"Configuration reloaded successfully\");\n                    *self.current_config.write().await = new_config.clone();\n                    Ok(new_config)\n                }\n                Err(e) =\u003e {\n                    warn!(\"Configuration reload failed, keeping current config: {e:?}\");\n                    Err(e)\n                }\n            }\n        } else {\n            error!(\"Config watcher channel closed\");\n            Err(AppError::Internal(\n                \"Config watcher channel closed\".to_string(),\n            ))\n        }\n    }\n\n    /// Force reload the configuration\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if the configuration file cannot be read or parsed.\n    pub async fn force_reload(\u0026self) -\u003e Result\u003cAppConfig\u003e {\n        info!(\"Force reloading configuration from: {}\", self.config_path.display());\n        \n        match load_config(\u0026self.config_path) {\n            Ok(new_config) =\u003e {\n                *self.current_config.write().await = new_config.clone();\n                info!(\"Configuration force reloaded successfully\");\n                Ok(new_config)\n            }\n            Err(e) =\u003e {\n                error!(\"Failed to force reload config: {e:?}\");\n                Err(e)\n            }\n        }\n    }\n\n    /// Get configuration file path\n    #[must_use]\n    #[allow(clippy::missing_const_for_fn)]\n    pub fn config_path(\u0026self) -\u003e \u0026Path {\n        \u0026self.config_path\n    }\n}\n\n/// Configuration change notification\n#[derive(Debug, Clone)]\npub struct ConfigChange {\n    pub old_config: AppConfig,\n    pub new_config: AppConfig,\n    pub timestamp: chrono::DateTime\u003cchrono::Utc\u003e,\n}\n\nimpl ConfigChange {\n    #[must_use]\n    pub fn new(old_config: AppConfig, new_config: AppConfig) -\u003e Self {\n        Self {\n            old_config,\n            new_config,\n            timestamp: chrono::Utc::now(),\n        }\n    }\n\n    /// Check if API keys have changed\n    #[must_use]\n    pub fn keys_changed(\u0026self) -\u003e bool {\n        self.old_config.groups != self.new_config.groups\n    }\n\n    /// Check if server configuration has changed\n    #[must_use]\n    pub fn server_changed(\u0026self) -\u003e bool {\n        self.old_config.server != self.new_config.server\n    }\n\n    /// Get summary of changes\n    #[must_use]\n    pub fn change_summary(\u0026self) -\u003e String {\n        let mut changes = Vec::new();\n        \n        if self.server_changed() {\n            changes.push(\"server configuration\");\n        }\n        \n        if self.keys_changed() {\n            changes.push(\"API key groups\");\n        }\n\n        if changes.is_empty() {\n            \"no significant changes detected\".to_string()\n        } else {\n            format!(\"changed: {}\", changes.join(\", \"))\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::{KeyGroup, ServerConfig};\n    use std::fs;\n    use tempfile::tempdir;\n\n    #[tokio::test]\n    async fn test_config_watcher_creation() {\n        let temp_dir = tempdir().unwrap();\n        let config_path = temp_dir.path().join(\"test_config.yaml\");\n        use std::io::Write;\n\n        // Create an empty config file to ensure the watcher can be created.\n        // The watcher needs to be able to read the file on initialization.\n        let initial_config = AppConfig {\n            server: ServerConfig {\n                host: \"127.0.0.1\".to_string(),\n                port: 8080,\n            },\n            groups: vec![KeyGroup {\n                name: \"test-group\".to_string(),\n                api_keys: vec![\"test-key\".to_string()],\n                target_url: \"http://localhost:1234\".to_string(),\n                proxy_url: None,\n            }],\n        };\n        let yaml = serde_yaml::to_string(\u0026initial_config).unwrap();\n        \n        // Use File::create and sync_all to ensure the file is written to disk\n        let mut temp_file = fs::File::create(\u0026config_path).unwrap();\n        temp_file.write_all(yaml.as_bytes()).unwrap();\n        temp_file.sync_all().unwrap(); // This is the fix\n\n        // Give the filesystem and notify crate a moment to catch up.\n        // This is the definitive fix for the race condition.\n        std::thread::sleep(std::time::Duration::from_millis(50));\n\n        let watcher_result = ConfigWatcher::new(config_path);\n        assert!(watcher_result.is_ok(), \"Watcher creation failed: {:?}\", watcher_result.err());\n    }\n\n    #[tokio::test]\n    async fn test_config_change_detection() {\n        let change = ConfigChange::new(\n            AppConfig {\n                server: ServerConfig {\n                    host: \"127.0.0.1\".to_string(),\n                    port: 8080,\n                },\n                groups: vec![],\n            },\n            AppConfig {\n                server: ServerConfig {\n                    host: \"0.0.0.0\".to_string(),\n                    port: 8081,\n                },\n                groups: vec![KeyGroup {\n                    name: \"test\".to_string(),\n                    api_keys: vec![\"key1\".to_string()],\n                    proxy_url: None,\n                    target_url: \"http://test.com\".to_string(),\n                }],\n            },\n        );\n\n        assert!(change.server_changed());\n        assert!(change.keys_changed());\n        assert!(change.change_summary().contains(\"server configuration\"));\n        assert!(change.change_summary().contains(\"API key groups\"));\n    }\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","error.rs"],"content":"// src/error.rs\nuse axum::{\n    http::StatusCode,\n    response::{IntoResponse, Response},\n    Json,\n};\nuse serde::Serialize;\nuse thiserror::Error;\nuse tracing::error; // Import error for logging\n\n/// Represents the structured error response body.\n#[derive(Serialize, Debug)]\nstruct ErrorResponse {\n    error: ErrorDetails,\n}\n\n/// Contains the details of an error for the response body.\n#[derive(Serialize, Debug)]\nstruct ErrorDetails {\n    #[serde(rename = \"type\")]\n    error_type: String,\n    message: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    details: Option\u003cString\u003e,\n}\n\n/// Specific kinds of proxy configuration errors.\n#[derive(Error, Debug)]\npub enum ProxyConfigErrorKind {\n    #[error(\"Invalid URL format: {0}\")]\n    UrlParse(#[from] url::ParseError),\n    #[error(\"Unsupported scheme: {0}\")]\n    UnsupportedScheme(String),\n    #[error(\"Invalid proxy definition: {0}\")]\n    InvalidDefinition(String), // For errors from reqwest::Proxy constructors\n}\n\n/// Detailed error information for proxy configuration issues.\n#[derive(Error, Debug)]\n#[error(\"Proxy configuration error for URL '{url}': {kind}\")]\n// Make struct and fields public\npub struct ProxyConfigErrorData {\n    pub url: String,\n    pub kind: ProxyConfigErrorKind,\n}\n\n\n/// Represents the possible errors that can occur within the application.\n///\n/// Implements `IntoResponse` to automatically convert errors into appropriate\n/// HTTP error responses with a standardized JSON body.\n#[derive(Error, Debug)]\npub enum AppError {\n    #[error(\"Configuration error: {0}\")]\n    Config(String), // Keep as String for general config issues, be specific elsewhere\n\n    #[error(\"Reqwest HTTP client error: {0}\")]\n    Reqwest(#[from] reqwest::Error), // RESTORED #[from] here\n\n    #[error(\"IO error: {0}\")]\n    Io(#[from] std::io::Error),\n\n    #[error(\"YAML parsing error: {0}\")]\n    YamlParsing(#[from] serde_yaml::Error),\n\n    // UrlParse error is now typically wrapped in ProxyConfigError or handled elsewhere\n    // #[error(\"URL parsing error: {0}\")]\n    // UrlParse(#[from] url::ParseError),\n    #[error(\"No available API keys\")]\n    NoAvailableKeys,\n\n    #[error(\"Upstream service error: {status} - {body}\")]\n    UpstreamServiceError { status: StatusCode, body: String },\n\n    #[error(\"Request body processing error: {0}\")]\n    RequestBodyError(String), // Keep as String for diverse sources\n\n    #[error(\"JSON processing error: {0}\")]\n    JsonProcessing(String, #[source] serde_json::Error),\n\n    #[error(\"Response body processing error: {0}\")]\n    ResponseBodyError(String), // Keep as String for diverse sources\n\n    #[error(\"Invalid API key provided by client\")]\n    InvalidClientApiKey, // If client-side key validation is added\n\n    #[error(\"Unauthorized\")]\n    Unauthorized,\n\n    #[error(\"Not Found: {0}\")]\n    NotFound(String),\n\n    #[error(\"Internal server error: {0}\")]\n    Internal(String), // Catch-all for unexpected errors\n\n    #[error(transparent)] // Use transparent to delegate display/source\n    ProxyConfigError(#[from] ProxyConfigErrorData),\n\n    #[error(\"HTTP client build error: {source}\")] // Reference source directly\n    HttpClientBuildError {\n        source: reqwest::Error,    // #[from] is definitely removed here\n        proxy_url: Option\u003cString\u003e, // Add context\n    },\n\n    #[error(\"Failed to join URL components: {0}\")]\n    UrlJoinError(String),\n\n    #[error(\"CSRF token invalid\")]\n    Csrf,\n\n    #[error(\"Axum error: {0}\")]\n    Axum(#[from] axum::Error),\n\n    #[error(\"URL parsing error: {0}\")]\n    UrlParse(#[from] url::ParseError),\n}\n\n// Removed manual `impl From\u003creqwest::Error\u003e for AppError` to resolve conflict\n// with the restored `#[from]` on `AppError::Reqwest`.\n// HttpClientBuildError MUST be constructed explicitly where it occurs.\n\n// Implement IntoResponse for AppError to automatically convert errors into HTTP responses\nimpl IntoResponse for AppError {\n    fn into_response(self) -\u003e Response {\n        let (status, error_details) = match self {\n            // --- 5xx Server Errors (Internal details logged, generic message to client) ---\n            Self::Config(msg) =\u003e {\n                error!(\"Configuration error: {}\", msg); // Log the specific error\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"CONFIG_ERROR\".to_string(),\n                        message: \"Internal server configuration error\".to_string(),\n                        details: None, // Don't expose details\n                    },\n                )\n            }\n            Self::Io(e) =\u003e {\n                error!(\"IO error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"IO_ERROR\".to_string(),\n                        message: \"Internal server error during IO operation\".to_string(),\n                        details: None,\n                    },\n                )\n            }\n            Self::YamlParsing(e) =\u003e {\n                error!(\"YAML parsing error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"CONFIG_PARSE_ERROR\".to_string(),\n                        message: \"Failed to parse configuration file\".to_string(),\n                        details: None,\n                    },\n                )\n            }\n            Self::ProxyConfigError(data) =\u003e {\n                error!(\"Proxy configuration error: {}\", data); // Log detailed error\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR, // Config issue is internal\n                    ErrorDetails {\n                        error_type: \"PROXY_CONFIG_ERROR\".to_string(),\n                        message: \"Internal server error related to proxy configuration\".to_string(),\n                        // Optionally expose the problematic URL, but not the internal kind\n                        details: Some(format!(\"Affected proxy URL: {}\", data.url)),\n                        // details: None, // Stricter approach: hide URL too\n                    },\n                )\n            }\n            Self::HttpClientBuildError { source, proxy_url } =\u003e {\n                error!(proxy_url = ?proxy_url, \"HTTP client build error: {}\", source);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"HTTP_CLIENT_BUILD_ERROR\".to_string(),\n                        message: \"Internal server error building HTTP client\".to_string(),\n                        details: proxy_url.map(|u| format!(\"Related proxy: {u}\")),\n                    },\n                )\n            }\n            Self::Internal(msg) =\u003e {\n                error!(\"Internal server error: {}\", msg);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"INTERNAL_SERVER_ERROR\".to_string(),\n                        message: \"An unexpected internal server error occurred\".to_string(),\n                        details: None,\n                    },\n                )\n            }\n            Self::UrlJoinError(msg) =\u003e {\n                error!(\"URL join error: {}\", msg);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"URL_CONSTRUCTION_ERROR\".to_string(),\n                        message: \"Internal error during URL construction\".to_string(),\n                        details: None, // Do not expose internal path details\n                    },\n                )\n            }\n\n            // --- 5xx Errors related to upstream/proxying ---\n            Self::Reqwest(e) =\u003e {\n                error!(\"Upstream reqwest error: {}\", e);\n                // More robust error classification\n                let (status_code, msg_key) = if e.is_timeout() {\n                    (StatusCode::GATEWAY_TIMEOUT, \"timeout\")\n                } else if e.is_connect() {\n                    (StatusCode::BAD_GATEWAY, \"connect\")\n                } else if e.is_request() {\n                    (StatusCode::BAD_GATEWAY, \"request_setup\") // Error building the request itself (e.g., DNS issue)\n                } else if e.is_body() || e.is_decode() {\n                    (StatusCode::BAD_GATEWAY, \"body_or_decode\") // Error processing response body\n                } else {\n                    (StatusCode::BAD_GATEWAY, \"generic\") // Other communication errors\n                };\n\n                let message = match msg_key {\n                    \"timeout\" =\u003e \"Upstream request timed out\".to_string(),\n                    \"connect\" =\u003e \"Could not connect to upstream service\".to_string(),\n                    \"request_setup\" =\u003e \"Internal error setting up upstream request\".to_string(),\n                    \"body_or_decode\" =\u003e {\n                        \"Error processing response body from upstream service\".to_string()\n                    }\n                    _ =\u003e \"Error communicating with upstream service\".to_string(),\n                };\n\n                (\n                    status_code,\n                    ErrorDetails {\n                        error_type: \"UPSTREAM_ERROR\".to_string(),\n                        message,\n                        details: Some(e.to_string()), // Provide reqwest error string as detail\n                    },\n                )\n            }\n            Self::UpstreamServiceError { status, body } =\u003e {\n                error!(\n                    \"Upstream service returned error: Status={}, Body='{}'\",\n                    status, body\n                );\n                (\n                    status, // Use the status code from the upstream service\n                    ErrorDetails {\n                        error_type: \"UPSTREAM_SERVICE_ERROR\".to_string(),\n                        message: \"Upstream service returned an error\".to_string(),\n                        details: Some(body), // Include upstream body if needed\n                    },\n                )\n            }\n            Self::ResponseBodyError(msg) =\u003e {\n                error!(\"Response body processing error: {}\", msg);\n                (\n                    StatusCode::BAD_GATEWAY, // Error processing upstream response\n                    ErrorDetails {\n                        error_type: \"RESPONSE_PROCESSING_ERROR\".to_string(),\n                        message: \"Failed to process response from upstream service\".to_string(),\n                        details: Some(msg),\n                    },\n                )\n            }\n            Self::NoAvailableKeys =\u003e (\n                StatusCode::SERVICE_UNAVAILABLE,\n                ErrorDetails {\n                    error_type: \"NO_AVAILABLE_KEYS\".to_string(),\n                    message: \"No available API keys to process the request at this time\"\n                        .to_string(),\n                    details: None,\n                },\n            ),\n\n            // --- 4xx Client Errors ---\n            Self::RequestBodyError(msg) =\u003e (\n                StatusCode::BAD_REQUEST,\n                ErrorDetails {\n                    error_type: \"REQUEST_BODY_ERROR\".to_string(),\n                    message: \"Failed to process request body\".to_string(),\n                    details: Some(msg),\n                },\n            ),\n            Self::JsonProcessing(msg, source) =\u003e {\n                error!(\"JSON processing error: {} - Source: {}\", msg, source);\n                (\n                    StatusCode::BAD_REQUEST, // JSON error is a client-side malformed request\n                    ErrorDetails {\n                        error_type: \"JSON_PROCESSING_ERROR\".to_string(),\n                        message: msg,\n                        details: Some(source.to_string()),\n                    },\n                )\n            }\n            Self::InvalidClientApiKey =\u003e (\n                StatusCode::UNAUTHORIZED, // Or FORBIDDEN depending on semantics\n                ErrorDetails {\n                    error_type: \"INVALID_API_KEY\".to_string(),\n                    message: \"Invalid or unauthorized API key provided\".to_string(),\n                    details: None,\n                },\n            ),\n            Self::Unauthorized =\u003e (\n                StatusCode::UNAUTHORIZED,\n                ErrorDetails {\n                    error_type: \"UNAUTHORIZED\".to_string(),\n                    message: \"Authentication token is missing or invalid\".to_string(),\n                    details: None,\n                },\n            ),\n            Self::NotFound(resource) =\u003e (\n                StatusCode::NOT_FOUND,\n                ErrorDetails {\n                    error_type: \"NOT_FOUND\".to_string(),\n                    message: format!(\"Resource not found: {resource}\"),\n                    details: None,\n                },\n            ),\n            Self::Csrf =\u003e (\n                StatusCode::FORBIDDEN,\n                ErrorDetails {\n                    error_type: \"CSRF_TOKEN_INVALID\".to_string(),\n                    message: \"CSRF token is missing or invalid.\".to_string(),\n                    details: None,\n                },\n            ),\n            Self::Axum(e) =\u003e {\n                error!(\"Internal Axum error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"AXUM_INTERNAL_ERROR\".to_string(),\n                        message: \"An internal server error occurred\".to_string(),\n                        details: Some(e.to_string()),\n                    },\n                )\n            }\n            Self::UrlParse(e) =\u003e {\n                error!(\"Internal URL parsing error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"URL_PARSE_ERROR\".to_string(),\n                        message: \"An internal error occurred while parsing a URL\".to_string(),\n                        details: Some(e.to_string()),\n                    },\n                )\n            }\n        };\n\n        let body = Json(ErrorResponse {\n            error: error_details,\n        });\n\n        (status, body).into_response()\n    }\n}\n\n// Optional: Define a type alias for Result using the AppError\npub type Result\u003cT\u003e = std::result::Result\u003cT, AppError\u003e;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::body::to_bytes;\n    use serde_json::Value;\n    use std::io;\n\n    // Helper to check the structured response\n    async fn check_response(\n        error: AppError,\n        expected_status: StatusCode,\n        expected_type: \u0026str,\n        expected_message_substring: \u0026str,\n        expect_details: bool, // Whether to assert that details field exists (doesn't check content)\n    ) {\n        let response = error.into_response();\n        assert_eq!(response.status(), expected_status, \"Status code mismatch\");\n\n        let body = response.into_body();\n        let bytes = to_bytes(body, usize::MAX)\n            .await\n            .expect(\"Failed to read response body\");\n        let body_json: Value = serde_json::from_slice(\u0026bytes).unwrap_or_else(|e| {\n            panic!(\n                \"Response body is not valid JSON: {}. Body: {}\",\n                e,\n                String::from_utf8_lossy(\u0026bytes)\n            )\n        });\n\n        let error_obj = \u0026body_json[\"error\"];\n        assert!(!error_obj.is_null(), \"JSON 'error' field is missing\");\n\n        let error_type = error_obj[\"type\"]\n            .as_str()\n            .expect(\"JSON 'error.type' field is not a string or missing\");\n        assert_eq!(error_type, expected_type, \"Error type mismatch\");\n\n        let error_msg = error_obj[\"message\"]\n            .as_str()\n            .expect(\"JSON 'error.message' field is not a string or missing\");\n        assert!(\n            error_msg.contains(expected_message_substring),\n            \"Expected error message '{}' to contain '{}'\",\n            error_msg,\n            expected_message_substring\n        );\n\n        if expect_details {\n            assert!(\n                !error_obj[\"details\"].is_null(),\n                \"Expected 'error.details' field to exist but it was null or missing\"\n            );\n            assert!(\n                error_obj[\"details\"].is_string(),\n                \"Expected 'error.details' field to be a string\"\n            );\n        } else {\n            assert!(\n                error_obj[\"details\"].is_null() || !error_obj[\"details\"].is_string(),\n                \"Expected 'error.details' field to be null or non-existent/non-string\"\n            );\n        }\n    }\n\n    #[tokio::test]\n    async fn test_into_response_config() {\n        check_response(\n            AppError::Config(\"Test config issue\".to_string()),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"CONFIG_ERROR\",\n            \"Internal server configuration error\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_io() {\n        let io_error = io::Error::new(io::ErrorKind::NotFound, \"File not found\");\n        check_response(\n            AppError::Io(io_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"IO_ERROR\",\n            \"Internal server error during IO operation\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_yaml() {\n        let yaml_error: serde_yaml::Error =\n            serde_yaml::from_str::\u003c()\u003e(\"invalid: yaml:\").unwrap_err();\n        check_response(\n            AppError::YamlParsing(yaml_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"CONFIG_PARSE_ERROR\",\n            \"Failed to parse configuration file\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_proxy_config_url_parse() {\n        let url_error = url::Url::parse(\"::invalid url\").unwrap_err();\n        let proxy_error = ProxyConfigErrorData {\n            url: \"::invalid url\".to_string(),\n            kind: ProxyConfigErrorKind::UrlParse(url_error),\n        };\n        check_response(\n            AppError::ProxyConfigError(proxy_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"PROXY_CONFIG_ERROR\",\n            \"Internal server error related to proxy configuration\",\n            true,\n        )\n        .await; // Expect details (URL)\n    }\n\n    #[tokio::test]\n    async fn test_into_response_proxy_config_unsupported_scheme() {\n        let proxy_error = ProxyConfigErrorData {\n            url: \"ftp://bad\".to_string(),\n            kind: ProxyConfigErrorKind::UnsupportedScheme(\"ftp\".to_string()),\n        };\n        check_response(\n            AppError::ProxyConfigError(proxy_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"PROXY_CONFIG_ERROR\",\n            \"Internal server error related to proxy configuration\",\n            true,\n        )\n        .await; // Expect details (URL)\n    }\n\n    #[tokio::test]\n    async fn test_into_response_no_keys() {\n        check_response(\n            AppError::NoAvailableKeys,\n            StatusCode::SERVICE_UNAVAILABLE,\n            \"NO_AVAILABLE_KEYS\",\n            \"No available API keys\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_upstream_service_error() {\n        check_response(\n            AppError::UpstreamServiceError {\n                status: StatusCode::BAD_GATEWAY,\n                body: \"Upstream failed\".to_string(),\n            },\n            StatusCode::BAD_GATEWAY,\n            \"UPSTREAM_SERVICE_ERROR\",\n            \"Upstream service returned an error\",\n            true, // Expect details (body)\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_request_body_error() {\n        check_response(\n            AppError::RequestBodyError(\"Bad body\".to_string()),\n            StatusCode::BAD_REQUEST,\n            \"REQUEST_BODY_ERROR\",\n            \"Failed to process request body\",\n            true,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_response_body_error() {\n        check_response(\n            AppError::ResponseBodyError(\"Bad response body\".to_string()),\n            StatusCode::BAD_GATEWAY,\n            \"RESPONSE_PROCESSING_ERROR\",\n            \"Failed to process response\",\n            true,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    // Removed ignore from this test\n    async fn test_into_response_invalid_client_key() {\n        check_response(\n            AppError::InvalidClientApiKey,\n            StatusCode::UNAUTHORIZED,\n            \"INVALID_API_KEY\",\n            \"Invalid or unauthorized API key\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_internal() {\n        check_response(\n            AppError::Internal(\"Something went wrong\".to_string()),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"INTERNAL_SERVER_ERROR\",\n            \"unexpected internal server error\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_http_client_build_error() {\n        // Simulate a reqwest build error by providing an impossible TLS version range.\n        // This is a reliable way to make the client build fail.\n        let build_error = reqwest::Client::builder()\n            .min_tls_version(reqwest::tls::Version::TLS_1_3)\n            .max_tls_version(reqwest::tls::Version::TLS_1_2)\n            .build()\n            .expect_err(\"Client build should fail with an impossible TLS version range\");\n\n        check_response(\n            // Manually construct the error variant now\n            AppError::HttpClientBuildError {\n                source: build_error,\n                proxy_url: None, // No proxy was involved in this specific build failure\n            },\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"HTTP_CLIENT_BUILD_ERROR\",\n            \"Internal server error building HTTP client\",\n            false, // No details to expect in this case\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_reqwest_timeout() {\n        // Simulate a timeout error - need a way to create reqwest::Error directly or mock\n        // For now, test the logic path using a placeholder error that is_timeout() == true\n        // This requires mocking or a feature flag for testing, skipping for now.\n        // let e = create_mock_reqwest_timeout_error();\n        // check_response(AppError::Reqwest(e), StatusCode::GATEWAY_TIMEOUT, \"UPSTREAM_ERROR\", \"Upstream request timed out\", true).await;\n        assert!(true); // Placeholder\n    }\n\n    #[tokio::test]\n    async fn test_into_response_reqwest_connect() {\n        // Simulate a connect error\n        // Skipping for now due to complexity of creating reqwest::Error\n        assert!(true); // Placeholder\n    }\n\n    #[tokio::test]\n    async fn test_into_response_reqwest_generic() {\n        // Simulate a generic reqwest error\n        let e = reqwest::get(\"http://invalid-url-that-does-not-exist-and-causes-error\")\n            .await\n            .unwrap_err();\n        // Check based on the new logic: request setup errors (like DNS) are now BAD_GATEWAY\n        check_response(\n            AppError::Reqwest(e),\n            StatusCode::BAD_GATEWAY,\n            \"UPSTREAM_ERROR\",\n            \"Internal error setting up upstream request\", // This is the correct message for a DNS/request setup error\n            true,\n        )\n        .await;\n    }\n}\n","traces":[{"line":123,"address":[28995103],"length":1,"stats":{"Line":2},"fn_name":null},{"line":124,"address":[13783680,13787866],"length":1,"stats":{"Line":4},"fn_name":"into_response"},{"line":125,"address":[31844442,31844307],"length":1,"stats":{"Line":5},"fn_name":null},{"line":127,"address":[35957391],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[11647289,11647423],"length":1,"stats":{"Line":3},"fn_name":null},{"line":130,"address":[15399264],"length":1,"stats":{"Line":2},"fn_name":null},{"line":131,"address":[33505400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[13281620],"length":1,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[32707296],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[8320069,8320115,8320205],"length":1,"stats":{"Line":2},"fn_name":null},{"line":138,"address":[5261815],"length":1,"stats":{"Line":4},"fn_name":null},{"line":139,"address":[28664248],"length":1,"stats":{"Line":3},"fn_name":null},{"line":141,"address":[14606800],"length":1,"stats":{"Line":1},"fn_name":null},{"line":142,"address":[25633333],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[33505531],"length":1,"stats":{"Line":2},"fn_name":null},{"line":144,"address":[12757319],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[13877340],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[14928918,14929112,14928973],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[33021648],"length":1,"stats":{"Line":5},"fn_name":null},{"line":152,"address":[25241901],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[33924994],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[9051451],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[32411536],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[26835922],"length":1,"stats":{"Line":1},"fn_name":null},{"line":160,"address":[32729328],"length":1,"stats":{"Line":2},"fn_name":"internal_desc"},{"line":161,"address":[32729334],"length":1,"stats":{"Line":5},"fn_name":null},{"line":163,"address":[35957872],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":164,"address":[33925145],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[32729464],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[33035129],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[26836136],"length":1,"stats":{"Line":2},"fn_name":null},{"line":173,"address":[9445448,9444664],"length":1,"stats":{"Line":5},"fn_name":null},{"line":174,"address":[6048735,6048601],"length":1,"stats":{"Line":7},"fn_name":null},{"line":176,"address":[14015408],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[33022053],"length":1,"stats":{"Line":3},"fn_name":null},{"line":178,"address":[9053837,9053949],"length":1,"stats":{"Line":5},"fn_name":null},{"line":179,"address":[26836398],"length":1,"stats":{"Line":3},"fn_name":null},{"line":180,"address":[25633683],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[35398696],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[12197811],"length":1,"stats":{"Line":3},"fn_name":null},{"line":187,"address":[12757984],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[12634990],"length":1,"stats":{"Line":1},"fn_name":null},{"line":189,"address":[13228905],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[13394380],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[16428339],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[11659502],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[15696991],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[12745185],"length":1,"stats":{"Line":1},"fn_name":null},{"line":199,"address":[28996608,28996617,28996483],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":200,"address":[11687269],"length":1,"stats":{"Line":1},"fn_name":null},{"line":201,"address":[6797153],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[7673586],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[6767044],"length":1,"stats":{"Line":2},"fn_name":null},{"line":209,"address":[11663026,11658560,11662541],"length":1,"stats":{"Line":3},"fn_name":null},{"line":211,"address":[11651215,11649749,11651284,11651579],"length":1,"stats":{"Line":4},"fn_name":null},{"line":212,"address":[12746123],"length":1,"stats":{"Line":1},"fn_name":null},{"line":213,"address":[6772953,6773097,6773028],"length":1,"stats":{"Line":2},"fn_name":null},{"line":214,"address":[12636336],"length":1,"stats":{"Line":1},"fn_name":null},{"line":215,"address":[14126286,14124035],"length":1,"stats":{"Line":3},"fn_name":null},{"line":216,"address":[6773141],"length":1,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[36231639,36231072,36231608],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":218,"address":[14016607,14016929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":220,"address":[13394544,13395204],"length":1,"stats":{"Line":0},"fn_name":null},{"line":223,"address":[13395418,13395279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":224,"address":[27112299,27112233],"length":1,"stats":{"Line":2},"fn_name":null},{"line":225,"address":[5268237,5268170,5268285,5268539],"length":1,"stats":{"Line":2},"fn_name":null},{"line":226,"address":[13879488],"length":1,"stats":{"Line":5},"fn_name":null},{"line":227,"address":[25114869,25113677],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[20028921,20030077],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[12635978],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[9055221],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[7278623,7277488,7278629],"length":1,"stats":{"Line":1},"fn_name":null},{"line":236,"address":[9448156,9447983],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[26694035,26694046],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[8874707],"length":1,"stats":{"Line":2},"fn_name":null},{"line":242,"address":[9055451],"length":1,"stats":{"Line":2},"fn_name":null},{"line":243,"address":[27403615,27403681],"length":1,"stats":{"Line":3},"fn_name":null},{"line":245,"address":[35399019],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[12746256],"length":1,"stats":{"Line":3},"fn_name":null},{"line":249,"address":[26694096],"length":1,"stats":{"Line":3},"fn_name":null},{"line":250,"address":[6779568],"length":1,"stats":{"Line":6},"fn_name":null},{"line":251,"address":[7278536,7278363],"length":1,"stats":{"Line":2},"fn_name":null},{"line":252,"address":[5275937],"length":1,"stats":{"Line":5},"fn_name":null},{"line":256,"address":[15049318],"length":1,"stats":{"Line":3},"fn_name":null},{"line":257,"address":[6051081,6051215],"length":1,"stats":{"Line":5},"fn_name":null},{"line":259,"address":[14153812],"length":1,"stats":{"Line":2},"fn_name":null},{"line":260,"address":[9448718,9448765,9448702],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[16769568,16782063,16778688,16772431,16779344,16775091,16782239,16781024,16772000,16778464,16773664,16777535,16782335,16770483,16769919,16771471,16775599,16779135,16779615,16781248,16781119,16776771,16779743,16769987,16769535,16770528,16771107,16773712,16774720,16778127,16777168,16779683,16772944,16771411,16770032,16771727,16781200,16780624,16773679,16780256,16774499,16773024,16777744,16780451,16780863,16774339,16774755,16780160,16771795,16771619,16779891,16769776,16771328,16775887,16780031,16773792,16775296,16775471,16779856,16781104,16771343,16782483,16772815,16776608,16772687,16779263,16775632,16772979,16770976,16778067,16780112,16770771,16770736,16774800,16782287,16771280,16779024,16769728,16776256,16780016,16780064,16770816,16772015,16780576,16781376,16771232,16770095,16770931,16772256,16777391,16778416,16776163,16774143,16777759,16771840,16773631,16775872,16776560,16778575,16776575,16778851,16774672,16779248,16777827,16778479,16770128,16780687,16773232,16780371,16770080,16776959,16772544,16773955,16773280,16775504,16780223,16780336,16776400,16774544,16780848,16773363,16780531,16775411,16778768,16778723,16770563,16769952,16773747,16769603,16772416,16772755,16774419,16780976,16772336,16780896,16781215,16771504,16781587,16780755,16773328,16777487,16773247,16781763,16782176,16773488,16770243,16778112,16780672,16774035,16773920,16776271,16774464,16779472,16776304,16780127,16776643,16777040,16779936,16775171,16770896,16774304,16771679,16776703,16778175,16779439,16774211,16772499,16771712,16775376,16770643,16773443,16775331,16776515,16777376,16770703,16778512,16780079,16774384,16775456,16773152,16770608,16776223,16775584,16780720,16771539,16776944,16780800,16778243,16776480,16771152,16774095,16778527,16772800,16777792,16777651,16775136,16776864,16774928,16777472,16780931,16770368,16776319,16770403,16771664,16778911,16779072,16780815,16777711,16776128,16779552,16781152,16774271,16775056,16773875,16779311,16776083,16778288,16771920,16778383,16771875,16781808,16774256,16777952,16772624,16775667,16777331,16771187,16772720,16775955,16770851,16776208,16776899,16778816,16773408,16781424,16773807,16777568,16771456,16776000,16770047,16779424,16772639,16773187,16778560,16770323,16777424,16771072,16773523,16775792,16771760,16773119,16773616,16773295,16781968,16780991,16781552,16780175,16772896,16772579,16782131,16782048,16776352,16777248,16775011,16781504,16782448,16774592,16781459,16774627,16770688,16774815,16774128,16780416,16781167,16772291,16781695,16782096,16778323,16772848,16775251,16778368,16781263,16781728,16782191,16781519,16776015,16772176,16772211,16776992,16779120,16781888,16772863,16773059,16781331,16778783,16771039,16769683,16771955,16776816,16776831,16778944,16780639,16769859,16782368,16777088,16777907,16782320,16777296,16772371,16774883,16779567,16779776,16774687,16779296,16780496,16771584,16772911,16777696,16779648,16769743,16781296,16770208,16777263,16773568,16773840,16775827,16775216,16775539,16778032,16779039,16781391,16782403,16781923,16772063,16775920,16778643,16777123,16778208,16772131,16774848,16779203,16781059,16772096,16776048,16781647,16781680,16772048,16777055,16777520,16778431,16774176,16770163,16771024,16777439,16778979,16770288,16779087,16773583,16778160,16779379,16779811,16779971,16780208,16777872,16782003,16771247,16773104,16774559,16774976,16777583,16777616,16779507,16771295,16769648,16777203,16779168,16778608,16776736,16777987,16769904,16779728,16770991,16776435,16781632,16769520,16769824,16782224,16782272,16770448,16781843,16778896,16776367,16769791,16771376,16780591,16780291,16772464,16776688,16775747,16775712,16772672,16777007,16774080,16774943,16779600,16774000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[34930208],"length":1,"stats":{"Line":5},"fn_name":null},{"line":263,"address":[34930217,34930294],"length":1,"stats":{"Line":2},"fn_name":null},{"line":267,"address":[37219865,37220057],"length":1,"stats":{"Line":4},"fn_name":null},{"line":268,"address":[12200736],"length":1,"stats":{"Line":2},"fn_name":"repeat_char"},{"line":269,"address":[28997040],"length":1,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[26707557],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[25636480],"length":1,"stats":{"Line":2},"fn_name":"source"},{"line":272,"address":[25102112,25102117,25101993,25102091],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":273,"address":[25102086],"length":1,"stats":{"Line":2},"fn_name":null},{"line":278,"address":[12760403],"length":1,"stats":{"Line":2},"fn_name":null},{"line":279,"address":[26707600],"length":1,"stats":{"Line":0},"fn_name":null},{"line":280,"address":[5276440],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[6767368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[5276272],"length":1,"stats":{"Line":1},"fn_name":null},{"line":283,"address":[13231430,13231501],"length":1,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[14140672],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[13231687,13231713,13231114],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[14140922,14140688],"length":1,"stats":{"Line":0},"fn_name":"invalid_value"},{"line":290,"address":[25118128,25118152,25118316],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":291,"address":[26694432],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":292,"address":[13800862],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[27178566],"length":1,"stats":{"Line":3},"fn_name":null},{"line":297,"address":[14611843],"length":1,"stats":{"Line":1},"fn_name":null},{"line":298,"address":[14018101],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[11665057],"length":1,"stats":{"Line":1},"fn_name":null},{"line":300,"address":[11659052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":301,"address":[21623238],"length":1,"stats":{"Line":1},"fn_name":null},{"line":302,"address":[11678287],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[11678700],"length":1,"stats":{"Line":1},"fn_name":null},{"line":306,"address":[26695049],"length":1,"stats":{"Line":1},"fn_name":null},{"line":307,"address":[13803948],"length":1,"stats":{"Line":2},"fn_name":null},{"line":308,"address":[16431494],"length":1,"stats":{"Line":2},"fn_name":null},{"line":309,"address":[14142056],"length":1,"stats":{"Line":1},"fn_name":null},{"line":310,"address":[34930968],"length":1,"stats":{"Line":1},"fn_name":null},{"line":313,"address":[5262420,5282335],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[25245440,25245376,25245488],"length":1,"stats":{"Line":0},"fn_name":"decode\u003calloc::boxed::Box\u003c(dyn core::error::Error + core::marker::Send + core::marker::Sync), alloc::alloc::Global\u003e\u003e"},{"line":315,"address":[9057537],"length":1,"stats":{"Line":1},"fn_name":null},{"line":316,"address":[33287936,33288052,33288078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[33287945,33288016],"length":1,"stats":{"Line":3},"fn_name":null},{"line":318,"address":[21623755],"length":1,"stats":{"Line":2},"fn_name":null},{"line":321,"address":[14017846],"length":1,"stats":{"Line":2},"fn_name":null},{"line":322,"address":[14127501],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[25637268,25637373,25637663,25637548],"length":1,"stats":{"Line":2},"fn_name":null},{"line":324,"address":[14017798],"length":1,"stats":{"Line":2},"fn_name":null},{"line":325,"address":[33288097],"length":1,"stats":{"Line":2},"fn_name":null},{"line":326,"address":[13814465],"length":1,"stats":{"Line":2},"fn_name":null},{"line":329,"address":[11383141],"length":1,"stats":{"Line":0},"fn_name":null},{"line":330,"address":[14019514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":332,"address":[27406087],"length":1,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[14613417],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[5293003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":335,"address":[27180759],"length":1,"stats":{"Line":0},"fn_name":null},{"line":336,"address":[9057776],"length":1,"stats":{"Line":0},"fn_name":"unknown_variant"},{"line":340,"address":[20031994,20032020,20031847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[34463414,34463568],"length":1,"stats":{"Line":2},"fn_name":null},{"line":343,"address":[20032060,20032165],"length":1,"stats":{"Line":0},"fn_name":null},{"line":344,"address":[27406591,27406565,27406418],"length":1,"stats":{"Line":1},"fn_name":null},{"line":345,"address":[14613600],"length":1,"stats":{"Line":0},"fn_name":"unknown_field"},{"line":346,"address":[25247008,25246768,25247037],"length":1,"stats":{"Line":1},"fn_name":"url_invalid_uri"},{"line":347,"address":[20032316,20032442],"length":1,"stats":{"Line":0},"fn_name":null},{"line":353,"address":[21642976],"length":1,"stats":{"Line":2},"fn_name":null},{"line":354,"address":[28108883],"length":1,"stats":{"Line":2},"fn_name":null},{"line":357,"address":[25638665],"length":1,"stats":{"Line":2},"fn_name":null},{"line":362,"address":[33923967],"length":1,"stats":{"Line":0},"fn_name":null},{"line":364,"address":[28108929],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":114,"coverable":153},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","handler.rs"],"content":"// src/handler.rs\n\nuse crate::{\n    error::{AppError, Result},\n    proxy,\n    state::AppState,\n};\nuse axum::{\n    body::{to_bytes, Bytes},\n    extract::{Request, State},\n    http::{HeaderMap, StatusCode},\n    response::Response,\n};\nuse std::sync::Arc;\nuse tracing::{debug, error, info, instrument, warn};\nuse url::Url;\n\n/// Enum to control the flow of the retry loop in the proxy handler.\nenum NextAction {\n    /// Return the response to the client immediately.\n    ReturnResponse(Response),\n    /// Break the inner loop (internal retries) and try the next key.\n    BreakLoop,\n    /// Continue the inner loop to retry with the same key.\n    ContinueLoop,\n}\n\n/// Simple health check handler. Returns HTTP 200 OK.\n#[instrument(name = \"health_check\", level = \"debug\", skip_all)]\npub async fn health_check() -\u003e StatusCode {\n    debug!(\"Responding to health check\");\n    StatusCode::OK\n}\n\n\n/// Helper to apply an action to a key and save the state.\n/// This function centralizes the logic of acquiring a write lock,\n/// performing an action, and then saving the state if the action was successful.\nasync fn apply_key_action\u003cF\u003e(\n    state: \u0026Arc\u003cAppState\u003e,\n    api_key: \u0026str,\n    action: F,\n) -\u003e Result\u003cNextAction\u003e\nwhere\n    F: FnOnce(\u0026mut crate::key_manager::KeyManager, \u0026str) -\u003e bool,\n{\n    let mut km = state.key_manager.write().await;\n    if action(\u0026mut km, api_key) {\n        km.save_states().await?;\n    }\n    Ok(NextAction::BreakLoop)\n}\n\n/// Handles the response from the upstream service and determines the next action.\n#[instrument(skip_all, fields(status = response.status().as_u16()))]\nasync fn handle_upstream_response(\n    response: Response,\n    state: \u0026Arc\u003cAppState\u003e,\n    api_key_to_mark: \u0026str,\n    internal_retry_count: u32,\n    last_error: \u0026mut Option\u003c(StatusCode, HeaderMap, Bytes)\u003e,\n) -\u003e Result\u003cNextAction\u003e {\n    let status = response.status();\n\n    match status {\n        s if s.is_success() =\u003e {\n            info!(\"Request successful.\");\n            Ok(NextAction::ReturnResponse(response))\n        }\n        StatusCode::NOT_FOUND | StatusCode::GATEWAY_TIMEOUT =\u003e {\n            warn!(\"Received terminal client error, not retrying.\");\n            Ok(NextAction::ReturnResponse(response))\n        }\n        s if s.is_client_error() =\u003e {\n            let (parts, body) = response.into_parts();\n            let body_bytes = to_bytes(body, usize::MAX).await?;\n            *last_error = Some((parts.status, parts.headers, body_bytes));\n\n            if s == StatusCode::TOO_MANY_REQUESTS {\n                warn!(\"Marking key as rate-limited and retrying with next key.\");\n                apply_key_action(state, api_key_to_mark, |km, key| {\n                    km.mark_key_as_limited(key)\n                })\n                .await\n            } else {\n                warn!(\n                    \"Client error {}. Marking key as invalid and retrying with next key.\",\n                    s\n                );\n                apply_key_action(state, api_key_to_mark, |km, key| {\n                    km.mark_key_as_invalid(key)\n                })\n                .await\n            }\n        }\n        s if s.is_server_error() =\u003e {\n            let (parts, body) = response.into_parts();\n            let body_bytes = to_bytes(body, usize::MAX).await?;\n            *last_error = Some((parts.status, parts.headers, body_bytes));\n\n            warn!(\"Received retriable server error {}.\", s);\n            let config = state.config.read().await;\n            if internal_retry_count \u003e= config.internal_retries {\n                error!(\"Internal retries exhausted. Marking key as temporarily unavailable.\");\n                let temporary_block_minutes = config.temporary_block_minutes;\n                apply_key_action(state, api_key_to_mark, |km, key| {\n                    km.mark_key_as_temporarily_unavailable(\n                        key,\n                        chrono::Duration::minutes(temporary_block_minutes),\n                    )\n                })\n                .await\n            } else {\n                tokio::time::sleep(std::time::Duration::from_secs(1)).await;\n                Ok(NextAction::ContinueLoop)\n            }\n        }\n        _ =\u003e {\n            warn!(\"Received unexpected status code {}. Not retrying.\", status);\n            Ok(NextAction::ReturnResponse(response))\n        }\n    }\n}\n\n/// The main Axum handler for proxying requests.\n#[instrument(name=\"proxy_handler\", skip(state, req), fields(uri = %req.uri(), method = %req.method()))]\npub async fn proxy_handler(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    req: Request,\n) -\u003e Result\u003cResponse\u003e {\n    let method = req.method().clone();\n    let uri = req.uri().clone();\n    let headers = req.headers().clone();\n    let body_bytes = match to_bytes(req.into_body(), usize::MAX).await {\n        Ok(bytes) =\u003e bytes,\n        Err(e) =\u003e {\n            error!(error = ?e, \"Failed to buffer request body\");\n            return Err(AppError::RequestBodyError(e.to_string()));\n        }\n    };\n\n    let mut last_error: Option\u003c(StatusCode, HeaderMap, Bytes)\u003e = None;\n    let mut attempt_count = 0;\n\n    loop {\n        attempt_count += 1;\n        debug!(attempt = attempt_count, \"Looking for next available API key\");\n\n        let key_info = state.key_manager.read().await.get_next_available_key_info();\n\n        let Some(key_info) = key_info else {\n            warn!(attempts = attempt_count, \"No available API keys remaining.\");\n            return if let Some((status, headers, body)) = last_error {\n                let mut response = Response::new(axum::body::Body::from(body));\n                *response.status_mut() = status;\n                *response.headers_mut() = headers;\n                Ok(response)\n            } else {\n                Err(AppError::NoAvailableKeys)\n            };\n        };\n\n        let api_key_to_mark = key_info.key.clone();\n        let mut internal_retry_count = 0;\n\n        loop {\n            internal_retry_count += 1;\n            debug!(attempt = attempt_count, internal_attempt = internal_retry_count, \"Attempting request with key\");\n\n            let translated_path = if uri.path() == \"/health/detailed\" {\n                \"/v1beta/models\".to_string()\n            } else if let Some(stripped) = uri.path().strip_prefix(\"/v1/\") {\n                match stripped {\n                    s if s.starts_with(\"chat/completions\") =\u003e format!(\"/v1beta/openai/{s}\"),\n                    s if s.starts_with(\"embeddings\") =\u003e format!(\"/v1beta/{s}\"),\n                    s if s.starts_with(\"audio/speech\") =\u003e format!(\"/v1beta/{s}\"),\n                    _ =\u003e format!(\"/v1beta/openai/{stripped}\"),\n                }\n            } else {\n                uri.path().to_string()\n            };\n\n            let base_url = Url::parse(\u0026key_info.target_url)?;\n            let mut final_target_url = base_url.join(\u0026translated_path)?;\n            final_target_url.set_query(uri.query());\n            final_target_url.query_pairs_mut().append_pair(\"key\", \u0026key_info.key);\n\n            let response_result = proxy::forward_request(\n                \u0026state, \u0026key_info, method.clone(), final_target_url, headers.clone(), body_bytes.clone(),\n            ).await;\n\n            let response = match response_result {\n                Ok(res) =\u003e res,\n                Err(e) =\u003e {\n                    error!(error = ?e, \"Failed to forward request\");\n                    // Treat request forwarding errors as temporary unavailability of the key/service\n                    let mut km = state.key_manager.write().await;\n                    let temporary_block_minutes = state.config.read().await.temporary_block_minutes;\n                    if km.mark_key_as_temporarily_unavailable(\n                        \u0026api_key_to_mark,\n                        chrono::Duration::minutes(temporary_block_minutes),\n                    ) {\n                        km.save_states().await?;\n                    }\n                    break;\n                }\n            };\n\n            match handle_upstream_response(response, \u0026state, \u0026api_key_to_mark, internal_retry_count, \u0026mut last_error).await? {\n                NextAction::ReturnResponse(r) =\u003e return Ok(r),\n                NextAction::BreakLoop =\u003e break,\n                NextAction::ContinueLoop =\u003e {\n                    // Clear last_error on successful internal retry\n                    last_error.take();\n                    continue;\n                }\n            }\n        }\n    }\n}\n","traces":[{"line":30,"address":[14481344,14481347],"length":1,"stats":{"Line":0},"fn_name":"health_check"},{"line":31,"address":[6107505,6108124,6109433,6107608,6109567],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[6100016,6100112,6100064],"length":1,"stats":{"Line":3},"fn_name":"apply_key_action\u003cgemini_proxy_key_rotation_rust::handler::handle_upstream_response::{async_fn#0}::{async_block#0}::{closure_env#1}\u003e"},{"line":47,"address":[14366380,14367884,14367962,14368105,14366116,14366237,14366159,14367841,14369572,14369615,14369693,14369836],"length":1,"stats":{"Line":6},"fn_name":null},{"line":48,"address":[14370597,14368879,14368328,14366603,14366645,14370059,14368379,14370101,14367141,14367556,14371012,14369293],"length":1,"stats":{"Line":6},"fn_name":null},{"line":49,"address":[14064386,14064658,14064930],"length":1,"stats":{"Line":9},"fn_name":null},{"line":51,"address":[6101022,6102761,6104478],"length":1,"stats":{"Line":3},"fn_name":null},{"line":56,"address":[10816128],"length":1,"stats":{"Line":2},"fn_name":"handle_upstream_response"},{"line":63,"address":[14380221,14379941],"length":1,"stats":{"Line":4},"fn_name":null},{"line":65,"address":[6517890],"length":1,"stats":{"Line":2},"fn_name":null},{"line":66,"address":[12346041,12345936],"length":1,"stats":{"Line":4},"fn_name":null},{"line":67,"address":[14385676,14380352,14386253,14400697,14400831],"length":1,"stats":{"Line":6},"fn_name":null},{"line":68,"address":[10683572],"length":1,"stats":{"Line":2},"fn_name":null},{"line":71,"address":[10678459,10698617,10698751,10677847],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[10678354],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[14380383,14382465,14382419],"length":1,"stats":{"Line":5},"fn_name":null},{"line":75,"address":[10693159,10695949],"length":1,"stats":{"Line":2},"fn_name":null},{"line":76,"address":[11640306],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[10699032,10698673],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[10699217,10699126],"length":1,"stats":{"Line":2},"fn_name":null},{"line":80,"address":[10699251,10701356,10712361,10701886,10712495],"length":1,"stats":{"Line":3},"fn_name":null},{"line":81,"address":[10703230,10703584,10701828,10711152],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":82,"address":[14400499],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[14393168,14380039,14392531,14392591,14392752],"length":1,"stats":{"Line":4},"fn_name":null},{"line":86,"address":[6526103,6526169,6539561,6539695,6526695],"length":1,"stats":{"Line":3},"fn_name":null},{"line":90,"address":[6528139,6537888,6530905,6526641],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":91,"address":[12366243],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[11902614],"length":1,"stats":{"Line":4},"fn_name":null},{"line":96,"address":[6116617,6116842,6116879],"length":1,"stats":{"Line":3},"fn_name":null},{"line":97,"address":[14384885,14382709],"length":1,"stats":{"Line":2},"fn_name":null},{"line":98,"address":[14042880],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[10704922,10705281],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[6532171,6540057,6532254,6540191,6532766],"length":1,"stats":{"Line":3},"fn_name":null},{"line":102,"address":[14380102,14395258,14396743,14397008],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[14397404,14400217,14397291],"length":1,"stats":{"Line":3},"fn_name":null},{"line":104,"address":[6137503,6131628,6131804,6132320,6137369],"length":1,"stats":{"Line":3},"fn_name":null},{"line":105,"address":[12363796,12365087],"length":1,"stats":{"Line":2},"fn_name":null},{"line":106,"address":[12365106,12365188,12365409,12366256],"length":1,"stats":{"Line":4},"fn_name":"{closure#2}"},{"line":107,"address":[14400615],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[14400582],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[14042932],"length":1,"stats":{"Line":4},"fn_name":null},{"line":114,"address":[14042958],"length":1,"stats":{"Line":3},"fn_name":null},{"line":115,"address":[10697603],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[10714479,10694121,10693544,10693328,10714345],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[10694016],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[6580880],"length":1,"stats":{"Line":2},"fn_name":"proxy_handler"},{"line":131,"address":[6143229,6142974],"length":1,"stats":{"Line":4},"fn_name":null},{"line":132,"address":[12374857,12374771],"length":1,"stats":{"Line":4},"fn_name":null},{"line":133,"address":[12374965,12374879],"length":1,"stats":{"Line":4},"fn_name":null},{"line":134,"address":[12375146,12374991,12375292,12374554],"length":1,"stats":{"Line":4},"fn_name":null},{"line":135,"address":[6144070],"length":1,"stats":{"Line":2},"fn_name":null},{"line":136,"address":[6547077],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[10744143,10720519,10744009,10720839,10721348],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[14410639,14412439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[10720682],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[14410059],"length":1,"stats":{"Line":2},"fn_name":null},{"line":145,"address":[14425740],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[10723218,10707501,10723176],"length":1,"stats":{"Line":4},"fn_name":null},{"line":147,"address":[12392114,12399679,12391478,12391598,12399545],"length":1,"stats":{"Line":6},"fn_name":null},{"line":149,"address":[11896984],"length":1,"stats":{"Line":6},"fn_name":null},{"line":151,"address":[10739344],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[14434463,14428885,14428943,14429466,14434329],"length":1,"stats":{"Line":6},"fn_name":null},{"line":153,"address":[10740087,10742058,10741767],"length":1,"stats":{"Line":4},"fn_name":null},{"line":154,"address":[6568236,6568381],"length":1,"stats":{"Line":4},"fn_name":null},{"line":155,"address":[14431536,14431461],"length":1,"stats":{"Line":4},"fn_name":null},{"line":156,"address":[10742611,10742347,10742211,10742409],"length":1,"stats":{"Line":2},"fn_name":null},{"line":157,"address":[10729250],"length":1,"stats":{"Line":2},"fn_name":null},{"line":159,"address":[10728750],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[14428849],"length":1,"stats":{"Line":2},"fn_name":null},{"line":164,"address":[10739585],"length":1,"stats":{"Line":2},"fn_name":null},{"line":166,"address":[10726355],"length":1,"stats":{"Line":2},"fn_name":null},{"line":167,"address":[12380025,12380105],"length":1,"stats":{"Line":2},"fn_name":null},{"line":168,"address":[12380077,12400537,12380132,12400671,12380652],"length":1,"stats":{"Line":6},"fn_name":null},{"line":170,"address":[6149084,6151209],"length":1,"stats":{"Line":4},"fn_name":null},{"line":171,"address":[10727789,10728992],"length":1,"stats":{"Line":2},"fn_name":null},{"line":172,"address":[10714598,10714503],"length":1,"stats":{"Line":4},"fn_name":null},{"line":174,"address":[12383130,12383198,12383028,12383873],"length":1,"stats":{"Line":6},"fn_name":null},{"line":175,"address":[6151815,6151624,6151747,6152241],"length":1,"stats":{"Line":4},"fn_name":null},{"line":176,"address":[6152129,6151917,6151884,6151761],"length":1,"stats":{"Line":4},"fn_name":null},{"line":177,"address":[10728370,10728459],"length":1,"stats":{"Line":4},"fn_name":null},{"line":180,"address":[6554557,6555476],"length":1,"stats":{"Line":2},"fn_name":null},{"line":183,"address":[12383608,12397957,12384112],"length":1,"stats":{"Line":4},"fn_name":null},{"line":184,"address":[14432211,14418711,14418864],"length":1,"stats":{"Line":4},"fn_name":null},{"line":185,"address":[12385029,12384902],"length":1,"stats":{"Line":4},"fn_name":null},{"line":186,"address":[12385040],"length":1,"stats":{"Line":2},"fn_name":null},{"line":189,"address":[6557001,6556789,6556677],"length":1,"stats":{"Line":6},"fn_name":null},{"line":192,"address":[6557693],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[12386400],"length":1,"stats":{"Line":2},"fn_name":null},{"line":194,"address":[14420585],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[6154849,6156123,6169513,6155607,6169647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[12389428,12378405,12387599,12389543,12374617],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[10706350,10721607,10721722,10721514,10710154],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[10735365,10735539,10736149],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[10735399],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[6561848],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[10722351,10722477,10706371,10710191],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[11910357],"length":1,"stats":{"Line":10},"fn_name":null},{"line":210,"address":[6550773],"length":1,"stats":{"Line":2},"fn_name":null},{"line":214,"address":[6148107,6148419],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":81,"coverable":99},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","key_manager.rs"],"content":"// src/key_manager.rs\n\nuse crate::config::{AppConfig, RateLimitBehavior};\nuse crate::error::{AppError, Result as AppResult}; // Use AppResult alias where appropriate\nuse axum::http::StatusCode;\nuse chrono::{DateTime, Duration as ChronoDuration, NaiveDateTime, TimeZone, Utc}; // ENSURED TimeZone is imported\nuse chrono_tz::America::Los_Angeles; // Use Los_Angeles timezone (PST/PDT)\nuse chrono_tz::Tz; // Import Tz trait\nuse reqwest::{header::CONTENT_TYPE, Client};\nuse serde::{Deserialize, Serialize};\nuse std::{\n    collections::HashMap,\n    io as std_io, // Import standard io for Error kind\n    path::{Path, PathBuf},\n    sync::{\n        atomic::{AtomicUsize, Ordering},\n        Arc,\n    }, // Added Arc for mutex cloning\n};\nuse tokio::fs::{self as async_fs};\nuse tokio::sync::Mutex;\nuse tracing::{debug, error, info, warn};\nuse uuid::Uuid; // For unique temporary file names\n\n// --- Structures ---\n\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Default)]\npub enum KeyStatus {\n    #[default]\n    Available,\n    RateLimited,\n    Invalid,\n    TemporarilyUnavailable,\n}\n\n#[derive(Debug, Clone, Default, Serialize, Deserialize, PartialEq)]\npub struct KeyState {\n    pub status: KeyStatus,\n    pub reset_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct FlattenedKeyInfo {\n    pub key: String,\n    pub proxy_url: Option\u003cString\u003e,\n    pub target_url: String,\n    pub group_name: String,\n    pub top_p: Option\u003cf32\u003e,\n}\n// --- KeyManager ---\n\n#[derive(Debug)]\npub struct KeyManager {\n    // Store keys grouped by their original group name.\n    // The outer Vec represents groups, the tuple holds (group_name, keys_in_group).\n    // Order of groups is preserved based on config processing order.\n    grouped_keys: Vec\u003c(String, Vec\u003cFlattenedKeyInfo\u003e)\u003e,\n    // Map for O(1) lookup of key info by its MD5 hash ID.\n    key_id_map: HashMap\u003cString, FlattenedKeyInfo\u003e,\n    // Index of the group to try next.\n    current_group_index: AtomicUsize,\n    // Index of the key to try next *within each group*. The order matches `grouped_keys`.\n    key_indices_per_group: Vec\u003cAtomicUsize\u003e,\n    // REMOVED Arc\u003cRwLock\u003c...\u003e\u003e. State is now managed directly here.\n    // The entire KeyManager will be wrapped in an RwLock in AppState.\n    key_states: HashMap\u003cString, KeyState\u003e,\n    state_file_path: PathBuf,\n    // This mutex is for controlling writes to the state *file*, not in-memory state.\n    save_mutex: Arc\u003cMutex\u003c()\u003e\u003e,\n    rate_limit_behavior: crate::config::RateLimitBehavior, // Add the new field\n}\n\nimpl KeyManager {\n    #[tracing::instrument(level = \"info\", skip(config, config_path))]\n    pub async fn new(config: \u0026AppConfig, config_path: \u0026Path) -\u003e Self {\n        info!(\"Initializing KeyManager...\");\n        let state_file_path = config_path\n            .parent()\n            .unwrap_or_else(|| Path::new(\".\"))\n            .join(\"key_states.json\");\n        let state_file_path_display = state_file_path.display().to_string(); // Capture for logs\n        info!(key_state.path = %state_file_path_display, \"Key state persistence file\");\n\n        let persisted_states = load_key_states_from_file(\u0026state_file_path).await;\n        let mut grouped_keys_map: HashMap\u003cString, Vec\u003cFlattenedKeyInfo\u003e\u003e = HashMap::new();\n        // This HashMap now correctly implements  2\n        let mut key_id_map: HashMap\u003cString, FlattenedKeyInfo\u003e = HashMap::new();\n        let mut initial_key_states = HashMap::new();\n        let mut processed_keys_count = 0;\n        let now = Utc::now();\n\n        // First pass: Collect keys into a map grouped by name to preserve group structure\n        for group in \u0026config.groups {\n            if group.api_keys.is_empty() {\n                warn!(group.name = %group.name, \"Skipping group with no API keys.\");\n                continue;\n            }\n            info!(\n               group.name = %group.name,\n               group.key_count = group.api_keys.len(),\n               group.proxy_url = group.proxy_url.as_deref().unwrap_or(\"None\"),\n               group.target_url = %group.target_url,\n               \"Processing group for KeyManager\"\n            );\n            let group_entry = grouped_keys_map.entry(group.name.clone()).or_default();\n            for key in \u0026group.api_keys {\n                if key.trim().is_empty() {\n                    warn!(group.name = %group.name, \"Skipping empty API key string in group.\");\n                    continue;\n                }\n                let key_info = FlattenedKeyInfo {\n                    key: key.clone(),\n                    proxy_url: group.proxy_url.clone(),\n                    target_url: group.target_url.clone(),\n                    group_name: group.name.clone(),\n                    top_p: group.top_p,\n                };\n                group_entry.push(key_info.clone()); // Add key to its group in the map\n\n                // Calculate MD5 hash for O(1) lookup\n                let key_id = format!(\"{:x}\", md5::compute(key.as_bytes()));\n                key_id_map.insert(key_id, key_info.clone()); // Add to the ID map\n\n                // Process state (this part remains largely the same)\n                let state_to_insert =\n                    persisted_states\n                        .get(key)\n                        .map_or_else(KeyState::default, |persisted| {\n                            let is_expired = persisted.reset_time.is_some_and(|rt| now \u003e= rt);\n                            match persisted.status {\n                                KeyStatus::RateLimited | KeyStatus::TemporarilyUnavailable\n                                    if is_expired =\u003e\n                                {\n                                    info!(api_key.preview = %Self::preview(key), group.name = %group.name, \"Persisted limit for key has expired. Initializing as available.\");\n                                    KeyState::default()\n                                }\n                                KeyStatus::Invalid =\u003e {\n                                    info!(api_key.preview = %Self::preview(key), group.name = %group.name, \"Loaded persisted invalid state for key.\");\n                                    persisted.clone()\n                                }\n                                KeyStatus::RateLimited | KeyStatus::TemporarilyUnavailable =\u003e {\n                                    info!(api_key.preview = %Self::preview(key), group.name = %group.name, key.status = ?persisted.status, key.reset_time = ?persisted.reset_time, \"Loaded persisted limited state for key.\");\n                                    persisted.clone()\n                                }\n                                KeyStatus::Available =\u003e persisted.clone(),\n                            }\n                        });\n                initial_key_states\n                    .entry(key.clone())\n                    .or_insert(state_to_insert);\n                processed_keys_count += 1;\n            }\n        }\n\n        let mut grouped_keys: Vec\u003c(String, Vec\u003cFlattenedKeyInfo\u003e)\u003e =\n            Vec::with_capacity(config.groups.len());\n        let mut key_indices_per_group: Vec\u003cAtomicUsize\u003e =\n            Vec::with_capacity(config.groups.len());\n\n        // Iterate through config.groups again to maintain the original order\n        let mut active_group_count = 0;\n        for group_config in \u0026config.groups {\n            if let Some(keys) = grouped_keys_map.remove(\u0026group_config.name) {\n                if !keys.is_empty() {\n                    grouped_keys.push((group_config.name.clone(), keys));\n                    key_indices_per_group.push(AtomicUsize::new(0));\n                    active_group_count += 1;\n                }\n            }\n        }\n\n        let all_keys_in_config: std::collections::HashSet\u003cString\u003e = grouped_keys\n            .iter()\n            .flat_map(|(_, keys)| keys.iter().map(|ki| ki.key.clone()))\n            .collect();\n\n        initial_key_states.retain(|key, _| {\n            let key_in_config = all_keys_in_config.contains(key);\n            if !key_in_config {\n                warn!(api_key.preview = %Self::preview(key), \"Removing state for key no longer present in configuration.\");\n            }\n            key_in_config\n        });\n\n        if processed_keys_count == 0 {\n            error!(\"KeyManager Initialization Error: No usable API keys found after processing configuration. Application might not function correctly.\");\n        } else if active_group_count == 0 {\n            error!(\"KeyManager Initialization Error: Keys were processed, but no active groups were formed. Check group definitions.\");\n        }\n\n        info!(\n            key_manager.total_keys = processed_keys_count,\n            key_manager.total_groups = active_group_count,\n            \"KeyManager: Grouped keys into rotation list.\"\n        );\n        info!(\n            key_manager.state_count = initial_key_states.len(),\n            key_manager.persisted_count = persisted_states.len(),\n            \"KeyManager: Initialized key states.\"\n        );\n\n        let manager = Self {\n            grouped_keys,\n            key_id_map,\n            current_group_index: AtomicUsize::new(0),\n            key_indices_per_group,\n            key_states: initial_key_states,\n            state_file_path: state_file_path.clone(),\n            save_mutex: Arc::new(Mutex::new(())),\n            rate_limit_behavior: config.rate_limit_behavior.clone(),\n        };\n\n        debug!(key_state.path = %state_file_path_display, \"Performing initial state save/sync after KeyManager initialization.\");\n        if let Err(e) = manager.save_states().await {\n            error!(key_state.path = %state_file_path_display, error = ?e, \"Failed to perform initial save of key states. The state file might be outdated or missing.\");\n        } else {\n            debug!(key_state.path = %state_file_path_display, \"Initial state save completed successfully.\");\n        }\n        manager\n    }\n\n    #[tracing::instrument(level = \"debug\", skip(self))]\n    pub fn get_next_available_key_info(\u0026self) -\u003e Option\u003cFlattenedKeyInfo\u003e {\n        if self.grouped_keys.is_empty() {\n            warn!(\n                key_manager.status = \"empty\",\n                \"No key groups configured or available. Cannot provide a key.\"\n            );\n            return None;\n        }\n\n        let num_groups = self.grouped_keys.len();\n        let initial_group_index = self.current_group_index.load(Ordering::Relaxed);\n\n        for group_offset in 0..num_groups {\n            let current_group_idx = (initial_group_index + group_offset) % num_groups;\n            let Some((group_name, keys_in_group)) = self.grouped_keys.get(current_group_idx) else {\n                error!(group.index = current_group_idx, \"Internal inconsistency: Group index out of bounds. Skipping.\");\n                continue;\n            };\n\n            if keys_in_group.is_empty() {\n                debug!(group.index = current_group_idx, group.name = %group_name, \"Skipping empty group\");\n                continue;\n            }\n\n            let num_keys_in_group = keys_in_group.len();\n            let Some(group_key_index_atomic) = self.key_indices_per_group.get(current_group_idx) else {\n                error!(group.index = current_group_idx, group.name=%group_name, \"Internal inconsistency: Missing key index for group. Skipping.\");\n                continue;\n            };\n            let initial_key_index_in_group = group_key_index_atomic.load(Ordering::Relaxed);\n\n            debug!(group.index = current_group_idx, group.name = %group_name, group.key_count = num_keys_in_group, group.start_key_index = initial_key_index_in_group, \"Searching within group\");\n\n            for key_offset in 0..num_keys_in_group {\n                let current_key_idx_in_group =\n                    (initial_key_index_in_group + key_offset) % num_keys_in_group;\n                let Some(key_info) = keys_in_group.get(current_key_idx_in_group) else {\n                    error!(group.index = current_group_idx, group.name=%group_name, key.index=current_key_idx_in_group, \"Internal inconsistency: Key index out of bounds within group. Skipping key.\");\n                    continue;\n                };\n\n                let Some(key_state) = self.key_states.get(\u0026key_info.key) else {\n                    error!(api_key.preview = %Self::preview(\u0026key_info.key), group.name = %group_name, \"Internal inconsistency: Key found in group but missing from state map! Skipping.\");\n                    continue;\n                };\n\n                let now = Utc::now();\n                let is_expired = key_state.reset_time.is_some_and(|rt| now \u003e= rt);\n\n                let is_available = match key_state.status {\n                    KeyStatus::Available =\u003e true,\n                    KeyStatus::RateLimited | KeyStatus::TemporarilyUnavailable if is_expired =\u003e true,\n                    _ =\u003e false,\n                };\n\n                if is_available {\n                    if key_state.status != KeyStatus::Available {\n                         debug!(api_key.preview = %Self::preview(\u0026key_info.key), group.name = %group_name, \"Limit previously set but now expired\");\n                    }\n\n                    let next_key_idx_in_group = (current_key_idx_in_group + 1) % num_keys_in_group;\n                    group_key_index_atomic.store(next_key_idx_in_group, Ordering::Relaxed);\n                    let next_group_idx = (current_group_idx + 1) % num_groups;\n                    self.current_group_index.store(next_group_idx, Ordering::Relaxed);\n\n                    debug!(\n                       api_key.preview = %Self::preview(\u0026key_info.key),\n                       group.name = %group_name,\n                       \"Selected available API key using group round-robin\"\n                    );\n                    return Some(key_info.clone());\n                }\n            }\n            group_key_index_atomic.store(0, Ordering::Relaxed);\n        }\n\n        warn!(\n            key_manager.status = \"all_limited\",\n            \"All API keys checked are currently rate-limited or unavailable.\"\n        );\n        None\n    }\n\n    #[tracing::instrument(level = \"warn\", skip(self, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn mark_key_as_limited(\u0026mut self, api_key: \u0026str) -\u003e bool {\n        let mut group_name_for_log = \"unknown\".to_string();\n\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            if let Some(found_key_info) = self.grouped_keys.iter().flat_map(|(_, keys)| keys.iter()).find(|k| k.key == api_key) {\n                group_name_for_log.clone_from(\u0026found_key_info.group_name);\n            }\n\n            let now_utc = Utc::now();\n            let is_expired = key_state.reset_time.is_some_and(|rt| now_utc \u003e= rt);\n            if key_state.status != KeyStatus::Available \u0026\u0026 !is_expired {\n                debug!(key.status = ?key_state.status, \"Key already marked as limited. Ignoring.\");\n                return false;\n            }\n\n            warn!(group.name=%group_name_for_log, behavior = ?self.rate_limit_behavior, \"Marking key as rate-limited\");\n            match self.rate_limit_behavior {\n                RateLimitBehavior::BlockUntilMidnight =\u003e {\n                    let target_tz: Tz = Los_Angeles;\n                    let now_in_target_tz = now_utc.with_timezone(\u0026target_tz);\n                    let tomorrow_naive_target = (now_in_target_tz + ChronoDuration::days(1)).date_naive();\n                    let reset_time_naive_target: NaiveDateTime = tomorrow_naive_target.and_hms_opt(0, 0, 0).expect(\"Failed to calculate next midnight\");\n                    let reset_time_utc = target_tz.from_local_datetime(\u0026reset_time_naive_target).single().expect(\"Timezone conversion failed\").with_timezone(\u0026Utc);\n                    key_state.status = KeyStatus::RateLimited;\n                    key_state.reset_time = Some(reset_time_utc);\n                }\n                RateLimitBehavior::RetryNextKey =\u003e {\n                    key_state.status = KeyStatus::RateLimited;\n                    key_state.reset_time = Some(Utc::now() + ChronoDuration::seconds(1));\n                }\n            }\n            true\n        } else {\n            error!(\"Attempted to mark an unknown API key as limited!\");\n            false\n        }\n    }\n\n    #[tracing::instrument(level = \"warn\", skip(self, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn mark_key_as_invalid(\u0026mut self, api_key: \u0026str) -\u003e bool {\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            if key_state.status != KeyStatus::Invalid {\n                warn!(\"Marking key as permanently invalid\");\n                key_state.status = KeyStatus::Invalid;\n                key_state.reset_time = None;\n                return true;\n            }\n        } else {\n            error!(\"Attempted to mark an unknown API key as invalid!\");\n        }\n        false\n    }\n\n    #[tracing::instrument(level = \"warn\", skip(self, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn mark_key_as_temporarily_unavailable(\u0026mut self, api_key: \u0026str, duration: ChronoDuration) -\u003e bool {\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            let reset_time = Utc::now() + duration;\n            warn!(?duration, %reset_time, \"Marking key as temporarily unavailable\");\n            key_state.status = KeyStatus::TemporarilyUnavailable;\n            key_state.reset_time = Some(reset_time);\n            true\n        } else {\n            error!(\"Attempted to mark an unknown API key as temporarily unavailable!\");\n            false\n        }\n    }\n\n    /// Asynchronously saves the current state of the KeyManager.\n    #[tracing::instrument(level = \"debug\", skip(self))]\n    pub async fn save_states(\u0026self) -\u003e AppResult\u003c()\u003e {\n        let _save_guard = self.save_mutex.lock().await;\n        debug!(key_state.path = %self.state_file_path.display(), \"Acquired save mutex lock for save\");\n\n        Self::save_states_to_file_impl(\u0026self.state_file_path, \u0026self.key_states)\n            .await\n            .map_err(|io_err| {\n                error!(key_state.path = %self.state_file_path.display(), error = ?io_err, \"Save states failed\");\n                AppError::Io(io_err)\n            })\n    }\n\n    /// Implementation detail: Performs the atomic save operation.\n    #[tracing::instrument(level = \"debug\", skip(final_path, states), fields(key_state.path = %final_path.display(), state.count = states.len()))]\n    async fn save_states_to_file_impl(\n        final_path: \u0026Path,\n        states: \u0026HashMap\u003cString, KeyState\u003e,\n    ) -\u003e std_io::Result\u003c()\u003e {\n        debug!(\"Attempting atomic save\");\n        let parent_dir = final_path.parent().ok_or_else(|| {\n            std_io::Error::new(std_io::ErrorKind::InvalidInput, \"State file path has no parent directory\")\n        })?;\n        async_fs::create_dir_all(parent_dir).await?;\n\n        let base_filename = final_path.file_name().unwrap_or_default().to_string_lossy();\n        let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n        let temp_path = parent_dir.join(\u0026temp_filename);\n\n        let json_data = serde_json::to_string_pretty(states).map_err(|e| {\n            std_io::Error::new(std_io::ErrorKind::InvalidData, format!(\"Failed to serialize key states: {e}\"))\n        })?;\n\n        async_fs::write(\u0026temp_path, json_data.as_bytes()).await?;\n        async_fs::copy(\u0026temp_path, final_path).await?;\n        async_fs::remove_file(\u0026temp_path).await?;\n\n        info!(\"Successfully saved key states atomically\");\n        Ok(())\n    }\n\n    /// Generates a shortened preview of an API key for logging.\n    #[inline]\n    fn preview(key: \u0026str) -\u003e String {\n        let len = key.chars().count();\n        let end = std::cmp::min(6, len);\n        let start = if len \u003e 10 { len - 4 } else { len };\n        if len \u003e 10 {\n            format!(\"{}...{}\", key.chars().take(end).collect::\u003cString\u003e(), key.chars().skip(start).collect::\u003cString\u003e())\n        } else {\n            format!(\"{}...\", key.chars().take(end).collect::\u003cString\u003e())\n        }\n    }\n\n    pub fn get_key_states(\u0026self) -\u003e \u0026HashMap\u003cString, KeyState\u003e {\n        \u0026self.key_states\n    }\n\n    /// Provides a flattened list of all key info for admin/debug purposes.\n    pub fn get_all_key_info(\u0026self) -\u003e Vec\u003cFlattenedKeyInfo\u003e {\n        self.key_id_map.values().cloned().collect()\n    }\n\n    pub fn is_key_invalid(\u0026self, api_key: \u0026str) -\u003e bool {\n        self.key_states.get(api_key).map_or(false, |s| s.status == KeyStatus::Invalid)\n    }\n\n    fn reset_key_state_to_available(\u0026mut self, api_key: \u0026str) -\u003e bool {\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            if key_state.status != KeyStatus::Available || key_state.reset_time.is_some() {\n                info!(api_key.preview = %Self::preview(api_key), \"Resetting key status to Available\");\n                key_state.status = KeyStatus::Available;\n                key_state.reset_time = None;\n                return true;\n            }\n        }\n        false\n    }\n\n    #[tracing::instrument(level = \"info\", skip(self), fields(key.id = %key_id))]\n    pub fn reset_key_status(\u0026mut self, key_id: \u0026str) -\u003e bool {\n        if let Some(key_info) = self.key_id_map.get(key_id) {\n            let key_to_reset = key_info.key.clone();\n            self.reset_key_state_to_available(\u0026key_to_reset)\n        } else {\n            warn!(\"Could not find key with ID '{}' to reset\", key_id);\n            false\n        }\n    }\n\n    /// Finds key info by its MD5 hash ID. Used to fetch data under a read lock.\n    pub fn get_key_info_by_id(\u0026self, key_id: \u0026str) -\u003e Option\u003c\u0026FlattenedKeyInfo\u003e {\n        self.key_id_map.get(key_id)\n    }\n\n    #[tracing::instrument(level = \"info\", skip(self, client, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub async fn perform_key_verification(\n        \u0026self,\n        api_key: \u0026str,\n        target_url_base: \u0026str,\n        client: \u0026Client,\n    ) -\u003e std::result::Result\u003cString, (StatusCode, String)\u003e {\n        info!(\"Verifying key with Gemini API\");\n\n        // Construct the full URL for verification\n        let target_url = format!(\n            \"{}/v1beta/models/gemini-pro:generateContent?key={}\",\n            target_url_base, api_key\n        );\n\n        let request_body = serde_json::json!({\n            \"contents\": [{\"parts\":[ {\"text\": \"Hi\"}]}]\n        });\n\n        match client\n            .post(\u0026target_url)\n            .header(CONTENT_TYPE, \"application/json\")\n            .json(\u0026request_body)\n            .send()\n            .await {\n                Ok(response) =\u003e {\n                    let status = response.status();\n                    let text = response.text().await.unwrap_or_else(|_| \"Could not read response body\".to_string());\n                    if status.is_success() {\n                        info!(api_key.preview = %Self::preview(api_key), \"Key verification successful\");\n                        Ok(text)\n                    } else {\n                        warn!(\n                            api_key.preview = %Self::preview(api_key),\n                            %status,\n                            error.body = %text,\n                            \"Key verification failed with non-success status\"\n                        );\n                        Err((status, text))\n                    }\n                }\n                Err(e) =\u003e {\n                     error!(api_key.preview = %Self::preview(api_key), error = ?e, \"Network or other error during key verification\");\n                     Err((StatusCode::INTERNAL_SERVER_ERROR, e.to_string()))\n                }\n            }\n    }\n\n    #[tracing::instrument(level = \"info\", skip(self, verification_result), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn update_key_status_from_verification(\n        \u0026mut self,\n        api_key: \u0026str,\n        verification_result: std::result::Result\u003cString, (StatusCode, String)\u003e,\n    ) -\u003e bool {\n        match verification_result {\n            Ok(_) =\u003e self.reset_key_state_to_available(api_key),\n            Err((status, _)) =\u003e {\n                if status.is_server_error() || status == StatusCode::REQUEST_TIMEOUT {\n                    self.mark_key_as_temporarily_unavailable(api_key, ChronoDuration::minutes(5))\n                } else {\n                    self.mark_key_as_invalid(api_key)\n                }\n            }\n        }\n    }\n}\n/// Helper function to load key states from the JSON file, with recovery attempt from temp file.\n#[tracing::instrument(level = \"info\", skip(path), fields(key_state.path = %path.display()))]\nasync fn load_key_states_from_file(path: \u0026Path) -\u003e HashMap\u003cString, KeyState\u003e {\n    let base_filename = path.file_name().unwrap_or_default().to_string_lossy();\n    let parent_dir = path.parent().unwrap_or_else(|| Path::new(\".\"));\n    let path_display = path.display().to_string(); // Capture display string\n\n    let mut recovered_from_temp = false;\n    let mut recovered_states = HashMap::new();\n\n    match async_fs::read_to_string(path).await {\n        Ok(json_data) =\u003e {\n            // Attempt to clean up any old temp files on successful load\n            cleanup_temp_files(parent_dir, \u0026base_filename).await;\n            match serde_json::from_str::\u003cHashMap\u003cString, KeyState\u003e\u003e(\u0026json_data) {\n                Ok(states) =\u003e {\n                    info!(state.count = states.len(), \"Successfully loaded key states\");\n                    return states;\n                }\n                Err(e) =\u003e {\n                    error!(error = %e, \"Failed to parse key state file (JSON invalid). Attempting recovery.\");\n                }\n            }\n        }\n        Err(ref e) if e.kind() == std_io::ErrorKind::NotFound =\u003e {\n            // This is not an error, just information\n            info!(\"Key state file not found. Checking for temporary recovery file.\");\n        }\n        Err(e) =\u003e {\n            // Log actual IO errors\n            error!(error = %e, \"Failed to read key state file due to IO error. Attempting recovery.\");\n        }\n    }\n\n    // Attempt recovery from temp file if main file failed or not found\n    if let Some(temp_path) = find_latest_temp_file(parent_dir, \u0026base_filename).await {\n        let temp_path_display = temp_path.display().to_string(); // Capture display string\n        warn!(temp_file.path = %temp_path_display, \"Attempting recovery from temporary state file.\");\n        match async_fs::read_to_string(\u0026temp_path).await {\n            Ok(temp_json_data) =\u003e {\n                match serde_json::from_str::\u003cHashMap\u003cString, KeyState\u003e\u003e(\u0026temp_json_data) {\n                    Ok(states) =\u003e {\n                        info!(state.count = states.len(), temp_file.path = %temp_path_display, \"Successfully recovered key states from temporary file\");\n                        // Attempt to copy recovered file to main path\n                        if let Err(copy_err) = async_fs::copy(\u0026temp_path, path).await {\n                            error!(\n                                temp_file.path = %temp_path_display,\n                                final_file.path = %path_display,\n                                error = ?copy_err,\n                                \"Failed to copy recovered temp state file to main path. State recovered in memory, but file system may be inconsistent.\"\n                            );\n                        } else {\n                            info!(final_file.path = %path_display, \"Successfully copied recovered temp state file to main path.\");\n                            if let Err(rm_err) = async_fs::remove_file(\u0026temp_path).await {\n                                warn!(temp_file.path = %temp_path_display, error = ?rm_err, \"Failed to remove temporary file after successful recovery.\");\n                            }\n                            // Clean up potentially other old temp files after successful copy\n                            cleanup_temp_files(parent_dir, \u0026base_filename).await;\n                        }\n                        recovered_from_temp = true;\n                        recovered_states = states; // Store recovered states\n                    }\n                    Err(parse_e) =\u003e {\n                        error!(temp_file.path = %temp_path_display, error = %parse_e, \"Failed to parse temporary key state file (JSON invalid). Recovery failed.\");\n                        // Attempt to remove corrupt temp file\n                        if let Err(rm_err) = async_fs::remove_file(\u0026temp_path).await {\n                            warn!(temp_file.path = %temp_path_display, error = ?rm_err, \"Failed to remove corrupt temporary file after parse failure\");\n                        }\n                        recovered_states = HashMap::new(); // Ensure empty map on parse failure\n                    }\n                }\n            }\n            Err(read_e) =\u003e {\n                error!(temp_file.path = %temp_path_display, error = %read_e, \"Failed to read temporary key state file. Recovery failed.\");\n                // Attempt to remove unreadable temp file\n                if let Err(rm_err) = async_fs::remove_file(\u0026temp_path).await {\n                    warn!(temp_file.path = %temp_path_display, error = ?rm_err, \"Failed to remove unreadable temporary file\");\n                }\n                recovered_states = HashMap::new(); // Ensure empty map on read failure\n            }\n        }\n    } else {\n        info!(\"No temporary state file found for recovery.\");\n    }\n\n    // Return recovered states if successful, otherwise empty map\n    if recovered_from_temp {\n        recovered_states\n    } else {\n        warn!(\"Recovery failed or no file found. Starting with empty key states.\");\n        HashMap::new()\n    }\n}\n\n/// Finds the most recently modified temporary state file matching the pattern.\n#[tracing::instrument(level = \"debug\", skip(temp_dir, base_filename))]\nasync fn find_latest_temp_file(temp_dir: \u0026Path, base_filename: \u0026str) -\u003e Option\u003cPathBuf\u003e {\n    let mut latest_mod_time: Option\u003cstd::time::SystemTime\u003e = None;\n    let mut latest_temp_file: Option\u003cPathBuf\u003e = None;\n    let temp_prefix = format!(\".{base_filename}.\");\n    let temp_suffix = \".tmp\";\n    debug!(temp_file.prefix = %temp_prefix, temp_file.suffix = %temp_suffix, directory = %temp_dir.display(), \"Searching for latest temporary file\");\n\n    if let Ok(mut read_dir) = async_fs::read_dir(temp_dir).await {\n        while let Ok(Some(entry)) = read_dir.next_entry().await {\n            let path = entry.path();\n            if path.is_file() {\n                if let Some(filename) = path.file_name().map(|n| n.to_string_lossy()) {\n                    if filename.starts_with(\u0026temp_prefix) \u0026\u0026 filename.ends_with(temp_suffix) {\n                        debug!(temp_file.path = %path.display(), \"Found potential temporary file\");\n                        if let Ok(metadata) = entry.metadata().await {\n                            if let Ok(modified) = metadata.modified() {\n                                if latest_mod_time.is_none() || modified \u003e latest_mod_time.unwrap()\n                                {\n                                    debug!(temp_file.path = %path.display(), ?modified, \"Updating latest temporary file\");\n                                    latest_mod_time = Some(modified);\n                                    latest_temp_file = Some(path.clone());\n                                }\n                            } else {\n                                warn!(temp_file.path = %path.display(), \"Could not get modified time for temp file\");\n                            }\n                        } else {\n                            warn!(temp_file.path = %path.display(), \"Could not get metadata for temp file\");\n                        }\n                    }\n                }\n            }\n        }\n    } else {\n        warn!(directory = %temp_dir.display(), \"Could not read directory to find temp files\");\n    }\n\n    if let Some(ref p) = latest_temp_file {\n        debug!(temp_file.path = %p.display(), \"Found latest temporary file\");\n    } else {\n        debug!(\"No suitable temporary file found\");\n    }\n    latest_temp_file\n}\n\n/// Cleans up all temporary state files matching the pattern in a directory.\n#[tracing::instrument(level = \"debug\", skip(temp_dir, base_filename))]\nasync fn cleanup_temp_files(temp_dir: \u0026Path, base_filename: \u0026str) {\n    let temp_prefix = format!(\".{base_filename}.\");\n    let temp_suffix = \".tmp\";\n\n    debug!(temp_file.prefix = %temp_prefix, temp_file.suffix = %temp_suffix, directory = %temp_dir.display(), \"Cleaning up temporary files\");\n    let mut cleaned_count = 0;\n\n    if let Ok(mut read_dir) = async_fs::read_dir(temp_dir).await {\n        while let Ok(Some(entry)) = read_dir.next_entry().await {\n            let path = entry.path();\n            if path.is_file() {\n                if let Some(filename) = path.file_name().map(|n| n.to_string_lossy()) {\n                    if filename.starts_with(\u0026temp_prefix) \u0026\u0026 filename.ends_with(temp_suffix) {\n                        warn!(temp_file.path = %path.display(), \"Cleaning up leftover temporary state file.\");\n                        if let Err(e) = async_fs::remove_file(\u0026path).await {\n                            error!(temp_file.path = %path.display(), error = ?e, \"Failed during cleanup of temporary state file.\");\n                        } else {\n                            cleaned_count += 1;\n                            debug!(temp_file.path = %path.display(), \"Successfully cleaned up temporary file.\");\n                        }\n                    }\n                }\n            }\n        }\n    } else {\n        warn!(directory = %temp_dir.display(), \"Could not read directory to clean temp files\");\n    }\n    debug!(cleaned_count, \"Temporary file cleanup finished\");\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::{KeyGroup, RateLimitBehavior, ServerConfig};\n    use std::fs::{self as sync_fs, File};\n    use std::io::Write;\n    use std::path::PathBuf;\n    use std::time::Duration;\n    use tempfile::tempdir;\n    use tokio::time::sleep;\n\n    fn create_test_config(groups: Vec\u003cKeyGroup\u003e) -\u003e AppConfig {\n        AppConfig {\n            server: ServerConfig {\n                port: 8080,\n                top_p: None,\n                admin_token: None,\n            },\n            groups,\n            rate_limit_behavior: RateLimitBehavior::default(),\n            internal_retries: 2,\n            temporary_block_minutes: 5,\n        }\n    }\n\n    fn create_temp_yaml_config(dir: \u0026tempfile::TempDir) -\u003e PathBuf {\n        let file_path = dir.path().join(\"test_config.yaml\");\n        let content = r#\"\n server:\n   port: 8080\n # No groups needed here, KeyManager uses AppConfig directly\n \"#;\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, \"{}\", content).unwrap();\n        file_path\n    }\n\n    // Helper to get the internal state for verification\n    // async fn get_manager_indices(manager: \u0026KeyManager) -\u003e (usize, Vec\u003cusize\u003e) {\n    //    let group_idx = manager.current_group_index.load(Ordering::Relaxed);\n    //    let key_indices = manager.key_indices_per_group.iter().map(|a| a.load(Ordering::Relaxed)).collect();\n    //    (group_idx, key_indices)\n    // }\n\n    #[tokio::test]\n    async fn test_key_manager_initialization_loads_persisted_state() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n\n        let future_reset = Utc::now() + ChronoDuration::hours(1);\n        let past_reset = Utc::now() - ChronoDuration::hours(1);\n        let persisted_states: HashMap\u003cString, KeyState\u003e = [\n            (\n                \"key_limited\".to_string(),\n                KeyState {\n                    status: KeyStatus::RateLimited,\n                    reset_time: Some(future_reset),\n                },\n            ),\n            (\n                \"key_expired\".to_string(),\n                KeyState {\n                    status: KeyStatus::RateLimited,\n                    reset_time: Some(past_reset),\n                },\n            ),\n            (\n                \"key_nolimit\".to_string(),\n                KeyState {\n                    status: KeyStatus::Available,\n                    reset_time: None,\n                },\n            ),\n            (\n                \"key_not_in_config\".to_string(),\n                KeyState {\n                    status: KeyStatus::Invalid,\n                    reset_time: None,\n                },\n            ),\n        ]\n        .iter()\n        .cloned()\n        .collect();\n        let json_data = serde_json::to_string(\u0026persisted_states).unwrap();\n        sync_fs::write(\u0026state_path, json_data).unwrap();\n\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\n                \"key_limited\".to_string(),\n                \"key_expired\".to_string(),\n                \"key_nolimit\".to_string(),\n                \"key_new\".to_string(),\n            ],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n        let manager = KeyManager::new(\u0026config, \u0026config_path).await;\n        let final_states = \u0026manager.key_states;\n\n        assert_eq!(final_states.len(), 4);\n        assert_eq!(final_states[\"key_limited\"].status, KeyStatus::RateLimited);\n        assert_eq!(final_states[\"key_limited\"].reset_time, Some(future_reset));\n        assert_eq!(final_states[\"key_expired\"].status, KeyStatus::Available);\n        assert!(final_states[\"key_expired\"].reset_time.is_none());\n        assert_eq!(final_states[\"key_nolimit\"].status, KeyStatus::Available);\n        assert!(final_states[\"key_nolimit\"].reset_time.is_none());\n        assert!(final_states.contains_key(\"key_new\"));\n        assert_eq!(final_states[\"key_new\"].status, KeyStatus::Available);\n        assert!(final_states[\"key_new\"].reset_time.is_none());\n        assert!(!final_states.contains_key(\"key_not_in_config\"));\n        assert_eq!(manager.state_file_path, state_path);\n    }\n\n    #[tokio::test]\n    async fn test_mark_key_as_limited_saves_state_atomically() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n        File::create(\u0026state_path)\n            .unwrap()\n            .write_all(b\"initial_content\")\n            .unwrap();\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"k1\".to_string(), \"k2\".to_string()],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        sleep(Duration::from_millis(50)).await;\n        let initial_saved_json =\n            sync_fs::read_to_string(\u0026state_path).expect(\"State file should exist after init\");\n        let initial_saved_states: HashMap\u003cString, KeyState\u003e =\n            serde_json::from_str(\u0026initial_saved_json).expect(\"Should parse initial JSON\");\n        assert_eq!(initial_saved_states.len(), 2);\n\n        manager.mark_key_as_limited(\"k1\");\n        manager.save_states().await.unwrap(); // Explicitly save for test\n\n        let saved_json =\n            sync_fs::read_to_string(\u0026state_path).expect(\"State file should exist after save\");\n        let saved_states: HashMap\u003cString, KeyState\u003e =\n            serde_json::from_str(\u0026saved_json).expect(\"Should parse saved JSON\");\n\n        assert_eq!(saved_states.len(), 2);\n        assert_eq!(saved_states[\"k1\"].status, KeyStatus::RateLimited);\n        assert!(saved_states[\"k1\"].reset_time.is_some());\n        assert!(saved_states[\"k1\"].reset_time.unwrap() \u003e Utc::now() - ChronoDuration::seconds(1)); // Check it's recent\n        assert_eq!(saved_states[\"k2\"].status, KeyStatus::Available);\n\n        let base_filename = state_path.file_name().unwrap().to_string_lossy();\n        let mut found_temp = false;\n        for entry in sync_fs::read_dir(dir.path()).unwrap() {\n            let path = entry.unwrap().path();\n            if path.is_file() {\n                if let Some(filename) = path.file_name().map(|n| n.to_string_lossy()) {\n                    if filename.starts_with(\u0026format!(\".{}.\", base_filename))\n                        \u0026\u0026 filename.ends_with(\".tmp\")\n                    {\n                        error!(\"Found unexpected temp file: {}\", path.display());\n                        found_temp = true;\n                    }\n                }\n            }\n        }\n        assert!(\n            !found_temp,\n            \"Temporary state file should not exist after successful save\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_skips_persisted_limited_key() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n        let future_reset = Utc::now() + ChronoDuration::hours(1);\n        let persisted: HashMap\u003cString, KeyState\u003e = [(\n            \"k1\".to_string(),\n            KeyState {\n                status: KeyStatus::RateLimited,\n                reset_time: Some(future_reset),\n            },\n        )]\n        .iter()\n        .cloned()\n        .collect();\n        sync_fs::write(\u0026state_path, serde_json::to_string(\u0026persisted).unwrap()).unwrap();\n\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"k1\".to_string(), \"k2\".to_string()],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n        let manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        let key_info1 = manager.get_next_available_key_info().unwrap();\n        assert_eq!(key_info1.key, \"k2\"); // Should skip k1\n        let key_info2 = manager.get_next_available_key_info().unwrap();\n        assert_eq!(key_info2.key, \"k2\"); // Should loop back to k2 as k1 is still limited\n    }\n\n    #[tokio::test]\n    async fn test_initial_save_syncs_state_after_loading() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n\n        // State file with an expired key and a key not in the new config\n        let past_reset = Utc::now() - ChronoDuration::hours(1);\n        let persisted: HashMap\u003cString, KeyState\u003e = [\n            (\n                \"k1_expired\".to_string(),\n                KeyState {\n                    status: KeyStatus::RateLimited,\n                    reset_time: Some(past_reset),\n                },\n            ),\n            (\n                \"k2_stale\".to_string(),\n                KeyState {\n                    status: KeyStatus::Available,\n                    reset_time: None,\n                },\n            ),\n        ]\n        .iter()\n        .cloned()\n        .collect();\n        sync_fs::write(\u0026state_path, serde_json::to_string(\u0026persisted).unwrap()).unwrap();\n\n        // New config only has k1_expired and a new key k3\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"k1_expired\".to_string(), \"k3_new\".to_string()],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n\n        // Init manager - this should trigger an initial save\n        let _manager = KeyManager::new(\u0026config, \u0026config_path).await;\n        sleep(Duration::from_millis(250)).await; // Wait for async save\n\n        // Read the file back and check its contents\n        let final_json = sync_fs::read_to_string(\u0026state_path).unwrap();\n        let final_states: HashMap\u003cString, KeyState\u003e = serde_json::from_str(\u0026final_json).unwrap();\n\n        // The final saved state should reflect the cleanup:\n        // - k1_expired should be Available because its timer expired on load.\n        // - k2_stale should be removed because it's not in the new config.\n        // - k3_new should be added as Available.\n        assert_eq!(final_states.len(), 2);\n        assert!(final_states.contains_key(\"k1_expired\"));\n        assert!(final_states.contains_key(\"k3_new\"));\n        assert!(!final_states.contains_key(\"k2_stale\"));\n        assert_eq!(final_states[\"k1_expired\"].status, KeyStatus::Available);\n        assert!(final_states[\"k1_expired\"].reset_time.is_none());\n        assert_eq!(final_states[\"k3_new\"].status, KeyStatus::Available);\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_group_round_robin() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![\n            KeyGroup {\n                name: \"g1\".to_string(),\n                api_keys: vec![\"g1k1\".to_string(), \"g1k2\".to_string()],\n                proxy_url: None,\n                target_url: \"t1\".to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g2\".to_string(),\n                api_keys: vec![\"g2k1\".to_string()],\n                proxy_url: None,\n                target_url: \"t2\".to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g3\".to_string(),\n                api_keys: vec![\"g3k1\".to_string(), \"g3k2\".to_string(), \"g3k3\".to_string()],\n                proxy_url: None,\n                target_url: \"t3\".to_string(),\n                top_p: None,\n            },\n        ];\n        let config = create_test_config(groups);\n        let manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        // Expected sequence: g1k1, g2k1, g3k1, g1k2, g2k1 (loops), g3k2, g1k1 (loops), ...\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g2k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k2\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g2k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k2\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g2k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k3\");\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_skips_limited_keys_and_groups() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![\n            KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"g1k1\".to_string(), \"g1k2\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None },\n            KeyGroup { name: \"g2\".to_string(), api_keys: vec![\"g2k1\".to_string()], proxy_url: None, target_url: \"t2\".to_string(), top_p: None },\n            KeyGroup { name: \"g3\".to_string(), api_keys: vec![\"g3k1\".to_string()], proxy_url: None, target_url: \"t3\".to_string(), top_p: None },\n        ];\n        let mut config = create_test_config(groups);\n        // Use BlockUntilMidnight to make test deterministic\n        config.rate_limit_behavior = RateLimitBehavior::BlockUntilMidnight;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        // Limit g1k1 and all of g2\n        manager.mark_key_as_limited(\"g1k1\");\n        manager.mark_key_as_limited(\"g2k1\");\n        sleep(Duration::from_millis(50)).await; // allow state to be saved\n\n        // Expected sequence: g1k2 (starts at g1, skips g1k1), g3k1 (skips g2), g1k2 (wraps around)\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k2\", \"Should select g1k2 first\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k1\", \"Should select g3k1 after skipping g2\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k2\", \"Should wrap around and select g1k2 again\");\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_returns_none_when_all_limited() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![\n            KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"g1k1\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None },\n            KeyGroup { name: \"g2\".to_string(), api_keys: vec![\"g2k1\".to_string()], proxy_url: None, target_url: \"t2\".to_string(), top_p: None },\n        ];\n        let mut config = create_test_config(groups);\n        // Use BlockUntilMidnight to make test deterministic\n        config.rate_limit_behavior = RateLimitBehavior::BlockUntilMidnight;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        manager.mark_key_as_limited(\"g1k1\");\n        manager.mark_key_as_limited(\"g2k1\");\n        sleep(Duration::from_millis(250)).await;\n\n        assert!(manager.get_next_available_key_info().is_none(), \"Should return None when all keys are limited\");\n    }\n\n    #[tokio::test]\n    async fn test_load_recovers_from_temp_file() {\n        let dir = tempdir().unwrap();\n        let final_path = dir.path().join(\"key_states.json\");\n        let base_filename = final_path.file_name().unwrap().to_string_lossy();\n        let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n        let temp_path = dir.path().join(temp_filename);\n\n        let expected_states: HashMap\u003cString, KeyState\u003e =\n            [(\"recovered_key\".to_string(), KeyState::default())]\n                .iter()\n                .cloned()\n                .collect();\n        let json_data = serde_json::to_string(\u0026expected_states).unwrap();\n        sync_fs::write(\u0026temp_path, json_data).unwrap();\n\n        // Ensure final file does not exist\n        let _ = sync_fs::remove_file(\u0026final_path);\n\n        let loaded_states = load_key_states_from_file(\u0026final_path).await;\n\n        assert_eq!(loaded_states, expected_states);\n        assert!(\n            final_path.exists(),\n            \"Final file should be created from temp file\"\n        );\n        assert!(\n            !temp_path.exists(),\n            \"Temp file should be removed after successful recovery\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_load_does_not_recover_from_corrupted_temp_file() {\n        let dir = tempdir().unwrap();\n        let final_path = dir.path().join(\"key_states.json\");\n        let base_filename = final_path.file_name().unwrap().to_string_lossy();\n        let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n        let temp_path = dir.path().join(temp_filename);\n\n        // Write corrupted JSON\n        sync_fs::write(\u0026temp_path, \"{ not json }\").unwrap();\n\n        // Ensure final file does not exist\n        let _ = sync_fs::remove_file(\u0026final_path);\n\n        let loaded_states = load_key_states_from_file(\u0026final_path).await;\n\n        assert!(\n            loaded_states.is_empty(),\n            \"Should return empty map on recovery failure\"\n        );\n        assert!(\n            !final_path.exists(),\n            \"Final file should not be created on recovery failure\"\n        );\n        assert!(\n            !temp_path.exists(),\n            \"Corrupted temp file should be removed after failed recovery attempt\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_mark_key_as_limited_block_until_midnight() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"k1\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None }];\n        let mut config = create_test_config(groups);\n        config.rate_limit_behavior = RateLimitBehavior::BlockUntilMidnight;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        manager.mark_key_as_limited(\"k1\");\n\n        let states = \u0026manager.key_states;\n        let key_state = states.get(\"k1\").unwrap();\n\n        assert_eq!(key_state.status, KeyStatus::RateLimited);\n        assert!(key_state.reset_time.is_some());\n        let reset_time = key_state.reset_time.unwrap();\n        assert!(reset_time \u003e Utc::now());\n        // Check that it's roughly 24h from now (could be less depending on time of day)\n        assert!(reset_time \u003c Utc::now() + ChronoDuration::hours(25));\n    }\n\n    #[tokio::test]\n    async fn test_mark_key_as_limited_retry_next_key() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"k1\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None }];\n        let mut config = create_test_config(groups);\n        config.rate_limit_behavior = RateLimitBehavior::RetryNextKey;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        manager.mark_key_as_limited(\"k1\");\n\n        let states = \u0026manager.key_states;\n        let key_state = states.get(\"k1\").unwrap();\n\n        assert_eq!(key_state.status, KeyStatus::RateLimited);\n        assert!(key_state.reset_time.is_some());\n        let reset_time = key_state.reset_time.unwrap();\n        // Should be very close to now\n        assert!(reset_time \u003e Utc::now());\n        assert!(reset_time \u003c Utc::now() + ChronoDuration::seconds(1));\n    }\n}\n","traces":[{"line":75,"address":[10302256,10302330,10302581,10304904,10302505,10303969,10303436],"length":1,"stats":{"Line":25},"fn_name":"{async_fn#0}"},{"line":76,"address":[6173321,6127303,6126632,6126778,6173455],"length":1,"stats":{"Line":15},"fn_name":null},{"line":77,"address":[5668668,5667282],"length":1,"stats":{"Line":10},"fn_name":null},{"line":79,"address":[10340625,10340624],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":81,"address":[6128714,6128813],"length":1,"stats":{"Line":10},"fn_name":null},{"line":82,"address":[10321107,10320507,10320590,10365929,10366063],"length":1,"stats":{"Line":15},"fn_name":null},{"line":84,"address":[11879330,11883934,11882102,11884070],"length":1,"stats":{"Line":15},"fn_name":null},{"line":85,"address":[5671739],"length":1,"stats":{"Line":5},"fn_name":null},{"line":87,"address":[10310129],"length":1,"stats":{"Line":5},"fn_name":null},{"line":88,"address":[6131799],"length":1,"stats":{"Line":5},"fn_name":null},{"line":89,"address":[12613302],"length":1,"stats":{"Line":5},"fn_name":null},{"line":90,"address":[6131917],"length":1,"stats":{"Line":5},"fn_name":null},{"line":93,"address":[12613403],"length":1,"stats":{"Line":5},"fn_name":null},{"line":94,"address":[12627576,12613572],"length":1,"stats":{"Line":10},"fn_name":null},{"line":95,"address":[11927599,11906669,11898906,11927465],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[6146593,6146062,6149342,6174809,6147979,6149068,6147705,6145996,6174943],"length":1,"stats":{"Line":17},"fn_name":null},{"line":100,"address":[6147658,6149021],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[10339699,10341070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":105,"address":[10341726,10338384],"length":1,"stats":{"Line":10},"fn_name":null},{"line":106,"address":[10341804],"length":1,"stats":{"Line":5},"fn_name":null},{"line":107,"address":[5690401],"length":1,"stats":{"Line":5},"fn_name":null},{"line":108,"address":[12631845,12657161,12657295,12633118],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[10342082],"length":1,"stats":{"Line":5},"fn_name":null},{"line":113,"address":[12631884],"length":1,"stats":{"Line":5},"fn_name":null},{"line":114,"address":[5690647],"length":1,"stats":{"Line":5},"fn_name":null},{"line":115,"address":[11903327],"length":1,"stats":{"Line":5},"fn_name":null},{"line":116,"address":[10329107],"length":1,"stats":{"Line":5},"fn_name":null},{"line":118,"address":[5690955,5691014],"length":1,"stats":{"Line":10},"fn_name":null},{"line":121,"address":[10342616],"length":1,"stats":{"Line":5},"fn_name":null},{"line":122,"address":[11904375,11903926,11903841],"length":1,"stats":{"Line":5},"fn_name":null},{"line":125,"address":[10329855,10329765],"length":1,"stats":{"Line":10},"fn_name":null},{"line":128,"address":[10356335,10343064,10353904],"length":1,"stats":{"Line":7},"fn_name":"{closure#1}"},{"line":129,"address":[12643710,12652736,12652741],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":130,"address":[11915071],"length":1,"stats":{"Line":2},"fn_name":null},{"line":132,"address":[10354099,10354137],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[5708875,5702623,5716345,5716479,5709642],"length":1,"stats":{"Line":3},"fn_name":null},{"line":135,"address":[10347952],"length":1,"stats":{"Line":1},"fn_name":null},{"line":138,"address":[10355161,10340975,10341750,10343106,10355295,10340857],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[12644732],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[12658649,12646635,12658783,12647410,12643903],"length":1,"stats":{"Line":3},"fn_name":null},{"line":143,"address":[6165612],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[11915125],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[11904227,11904178],"length":1,"stats":{"Line":10},"fn_name":null},{"line":149,"address":[10343160],"length":1,"stats":{"Line":5},"fn_name":null},{"line":151,"address":[6151400,6151331],"length":1,"stats":{"Line":5},"fn_name":null},{"line":155,"address":[10310683,10310605],"length":1,"stats":{"Line":10},"fn_name":null},{"line":157,"address":[6132289,6132381],"length":1,"stats":{"Line":10},"fn_name":null},{"line":161,"address":[10324117],"length":1,"stats":{"Line":5},"fn_name":null},{"line":162,"address":[11885275,11885175,11898841],"length":1,"stats":{"Line":15},"fn_name":null},{"line":163,"address":[11885389,11898113,11898745],"length":1,"stats":{"Line":15},"fn_name":null},{"line":164,"address":[10337166,10337672,10337286],"length":1,"stats":{"Line":15},"fn_name":null},{"line":165,"address":[5685800,5685732],"length":1,"stats":{"Line":10},"fn_name":null},{"line":166,"address":[11898538],"length":1,"stats":{"Line":5},"fn_name":null},{"line":167,"address":[5686053,5686109],"length":1,"stats":{"Line":5},"fn_name":null},{"line":172,"address":[10324386],"length":1,"stats":{"Line":5},"fn_name":null},{"line":174,"address":[10349776,10349891,10349803,10349856],"length":1,"stats":{"Line":20},"fn_name":"{closure#2}"},{"line":177,"address":[10311292,10351797,10349920,10350685,10351791],"length":1,"stats":{"Line":10},"fn_name":"{closure#3}"},{"line":178,"address":[10349959],"length":1,"stats":{"Line":5},"fn_name":null},{"line":179,"address":[10349987],"length":1,"stats":{"Line":5},"fn_name":null},{"line":180,"address":[11924279,11924321,11930575,11930441,11924975,11926098],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[11885667],"length":1,"stats":{"Line":5},"fn_name":null},{"line":186,"address":[11885684,11931071,11886255,11930937,11885745],"length":1,"stats":{"Line":3},"fn_name":null},{"line":187,"address":[12614416],"length":1,"stats":{"Line":5},"fn_name":null},{"line":188,"address":[10370393,10370527,10326532],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[6136641,6178777,6178911,6133450,6137151],"length":1,"stats":{"Line":15},"fn_name":null},{"line":196,"address":[12620694,12623284,12622443,12618592,12661129,12621313,12622244,12623085,12661263],"length":1,"stats":{"Line":17},"fn_name":null},{"line":197,"address":[10319194,10320035],"length":1,"stats":{"Line":1},"fn_name":null},{"line":198,"address":[5681913,5681072],"length":1,"stats":{"Line":1},"fn_name":null},{"line":205,"address":[5679976,5682279],"length":1,"stats":{"Line":10},"fn_name":null},{"line":208,"address":[10333986],"length":1,"stats":{"Line":5},"fn_name":null},{"line":209,"address":[12623868,12623801],"length":1,"stats":{"Line":10},"fn_name":null},{"line":210,"address":[6142392],"length":1,"stats":{"Line":5},"fn_name":null},{"line":213,"address":[10334569,10335085,10334483,10371881,10372015],"length":1,"stats":{"Line":15},"fn_name":null},{"line":214,"address":[11636946],"length":1,"stats":{"Line":15},"fn_name":null},{"line":215,"address":[10372377,10372511,10348430,10348931,10348320],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[5696780,5721305,5721439,5699699],"length":1,"stats":{"Line":10},"fn_name":null},{"line":219,"address":[10340195],"length":1,"stats":{"Line":5},"fn_name":null},{"line":223,"address":[11444000,11474776,11445348],"length":1,"stats":{"Line":3},"fn_name":null},{"line":224,"address":[11444523,11445493],"length":1,"stats":{"Line":6},"fn_name":null},{"line":225,"address":[11473098,11445526,11472616],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[11486328],"length":1,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[11183733,11183667],"length":1,"stats":{"Line":6},"fn_name":null},{"line":233,"address":[11445581],"length":1,"stats":{"Line":3},"fn_name":null},{"line":235,"address":[11183803],"length":1,"stats":{"Line":3},"fn_name":null},{"line":236,"address":[11186343,11183971,11186435],"length":1,"stats":{"Line":6},"fn_name":null},{"line":237,"address":[11448309,11448248],"length":1,"stats":{"Line":6},"fn_name":null},{"line":238,"address":[11470458,11448445],"length":1,"stats":{"Line":0},"fn_name":null},{"line":242,"address":[11461731,11461675],"length":1,"stats":{"Line":6},"fn_name":null},{"line":243,"address":[11467854,11448516],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[11186723,11186657],"length":1,"stats":{"Line":6},"fn_name":null},{"line":248,"address":[6866139],"length":1,"stats":{"Line":3},"fn_name":null},{"line":249,"address":[12664633,12664767],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[11448786,11448716],"length":1,"stats":{"Line":6},"fn_name":null},{"line":254,"address":[6183273,6183407],"length":1,"stats":{"Line":6},"fn_name":null},{"line":256,"address":[7033061,7035965],"length":1,"stats":{"Line":6},"fn_name":null},{"line":257,"address":[11452310,11452373,11452471],"length":1,"stats":{"Line":6},"fn_name":null},{"line":259,"address":[13588572,13588508],"length":1,"stats":{"Line":6},"fn_name":null},{"line":260,"address":[13588701,13598350],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[11452676,11452614],"length":1,"stats":{"Line":6},"fn_name":null},{"line":265,"address":[10363263,10363129],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[6870307],"length":1,"stats":{"Line":3},"fn_name":null},{"line":270,"address":[12663056,12663061],"length":1,"stats":{"Line":9},"fn_name":"{closure#0}"},{"line":272,"address":[6870445],"length":1,"stats":{"Line":3},"fn_name":null},{"line":273,"address":[6870506],"length":1,"stats":{"Line":3},"fn_name":null},{"line":274,"address":[7036707,7036725],"length":1,"stats":{"Line":3},"fn_name":null},{"line":275,"address":[6870496],"length":1,"stats":{"Line":0},"fn_name":null},{"line":278,"address":[11466230],"length":1,"stats":{"Line":3},"fn_name":null},{"line":279,"address":[11191164],"length":1,"stats":{"Line":3},"fn_name":null},{"line":280,"address":[10377007,10376873],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[11194301,11194204,11191206],"length":1,"stats":{"Line":6},"fn_name":null},{"line":284,"address":[13592182],"length":1,"stats":{"Line":3},"fn_name":null},{"line":285,"address":[6873730,6873862],"length":1,"stats":{"Line":3},"fn_name":null},{"line":286,"address":[6873832],"length":1,"stats":{"Line":3},"fn_name":null},{"line":288,"address":[10364121,10364255],"length":1,"stats":{"Line":6},"fn_name":null},{"line":289,"address":[7042406,7041457],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[7040554,7043022],"length":1,"stats":{"Line":6},"fn_name":null},{"line":296,"address":[7036109],"length":1,"stats":{"Line":3},"fn_name":null},{"line":299,"address":[10377999,10377865],"length":1,"stats":{"Line":6},"fn_name":null},{"line":303,"address":[11184495],"length":1,"stats":{"Line":3},"fn_name":null},{"line":307,"address":[6893999,6902900,6892384],"length":1,"stats":{"Line":2},"fn_name":null},{"line":308,"address":[11488534],"length":1,"stats":{"Line":2},"fn_name":null},{"line":310,"address":[11496606,11490271,11497237,11490362],"length":1,"stats":{"Line":6},"fn_name":null},{"line":311,"address":[6894827,6894753],"length":1,"stats":{"Line":12},"fn_name":null},{"line":312,"address":[13613525,13613483],"length":1,"stats":{"Line":4},"fn_name":null},{"line":315,"address":[11490690],"length":1,"stats":{"Line":2},"fn_name":null},{"line":316,"address":[11939472,11939477],"length":1,"stats":{"Line":2},"fn_name":"{closure#2}"},{"line":317,"address":[11490878,11490798],"length":1,"stats":{"Line":2},"fn_name":null},{"line":318,"address":[12668399,12668265],"length":1,"stats":{"Line":0},"fn_name":null},{"line":319,"address":[7061771],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[11940191,11940057],"length":1,"stats":{"Line":6},"fn_name":null},{"line":323,"address":[13611174,13616607],"length":1,"stats":{"Line":2},"fn_name":null},{"line":325,"address":[11221013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[7066507],"length":1,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[6900471],"length":1,"stats":{"Line":1},"fn_name":null},{"line":328,"address":[11483074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":329,"address":[11483133],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[11496529],"length":1,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[11221459],"length":1,"stats":{"Line":1},"fn_name":null},{"line":333,"address":[7067083],"length":1,"stats":{"Line":2},"fn_name":null},{"line":334,"address":[11482813],"length":1,"stats":{"Line":2},"fn_name":null},{"line":335,"address":[11483368,11482831],"length":1,"stats":{"Line":4},"fn_name":null},{"line":338,"address":[6900918],"length":1,"stats":{"Line":2},"fn_name":null},{"line":340,"address":[7060876,7067117,7067586],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[6901549],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[11223536,11223831,11229748,11225168],"length":1,"stats":{"Line":2},"fn_name":null},{"line":347,"address":[11487600,11485871],"length":1,"stats":{"Line":4},"fn_name":null},{"line":348,"address":[13623727,13623794],"length":1,"stats":{"Line":4},"fn_name":null},{"line":349,"address":[7071331,7071907],"length":1,"stats":{"Line":4},"fn_name":null},{"line":350,"address":[6905830],"length":1,"stats":{"Line":2},"fn_name":null},{"line":351,"address":[7071848],"length":1,"stats":{"Line":2},"fn_name":null},{"line":352,"address":[11226472],"length":1,"stats":{"Line":2},"fn_name":null},{"line":355,"address":[13623756,13625861],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[13623800],"length":1,"stats":{"Line":0},"fn_name":null},{"line":361,"address":[6911071,6909511,6909200,6916708],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[13628207,13631113,13630382,13633828],"length":1,"stats":{"Line":3},"fn_name":null},{"line":363,"address":[13630495,13630445],"length":1,"stats":{"Line":2},"fn_name":null},{"line":364,"address":[11942175,11942041],"length":1,"stats":{"Line":2},"fn_name":null},{"line":365,"address":[11494972],"length":1,"stats":{"Line":1},"fn_name":null},{"line":366,"address":[7078534],"length":1,"stats":{"Line":1},"fn_name":null},{"line":367,"address":[11495041],"length":1,"stats":{"Line":1},"fn_name":null},{"line":369,"address":[6189369,6189503],"length":1,"stats":{"Line":0},"fn_name":null},{"line":370,"address":[11235916],"length":1,"stats":{"Line":0},"fn_name":null},{"line":376,"address":[11942976,11943023,11943151,11943227,11943997,11944519],"length":1,"stats":{"Line":20},"fn_name":"{async_fn#0}"},{"line":377,"address":[6192542,6192429,6192332,6192269],"length":1,"stats":{"Line":10},"fn_name":null},{"line":378,"address":[6192839,6198991,6193359,6192760,6198857],"length":1,"stats":{"Line":15},"fn_name":null},{"line":380,"address":[10387649,10385519,10387884,10387990,10387540],"length":1,"stats":{"Line":25},"fn_name":null},{"line":381,"address":[10384533,10387622,10387679,10387713,10387904],"length":1,"stats":{"Line":20},"fn_name":null},{"line":382,"address":[10375308,10377819,10377825,10374731,10374848],"length":1,"stats":{"Line":5},"fn_name":"{closure#0}"},{"line":383,"address":[10375473,10374966,10375310,10374887,10378527,10378393],"length":1,"stats":{"Line":0},"fn_name":null},{"line":384,"address":[10388688],"length":1,"stats":{"Line":0},"fn_name":null},{"line":390,"address":[11512464],"length":1,"stats":{"Line":5},"fn_name":null},{"line":394,"address":[11964297,11964431,11956704,11956898,11957422],"length":1,"stats":{"Line":15},"fn_name":null},{"line":395,"address":[12686074,12692672,12687459,12687769,12687552],"length":1,"stats":{"Line":10},"fn_name":"{closure#0}"},{"line":396,"address":[10402929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":398,"address":[11910404],"length":1,"stats":{"Line":9},"fn_name":null},{"line":400,"address":[5746918],"length":1,"stats":{"Line":5},"fn_name":null},{"line":401,"address":[11959725,11959646],"length":1,"stats":{"Line":10},"fn_name":null},{"line":402,"address":[10398851],"length":1,"stats":{"Line":5},"fn_name":null},{"line":404,"address":[5747552,5747891,5751609,5751392,5751615,5747369,5747445],"length":1,"stats":{"Line":10},"fn_name":"{closure#1}"},{"line":405,"address":[12692716,12692786],"length":1,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[10382498,10386090,10386775,10385968,10386272],"length":1,"stats":{"Line":15},"fn_name":null},{"line":409,"address":[5522402],"length":1,"stats":{"Line":10},"fn_name":null},{"line":410,"address":[12690376,12685532,12690230,12692595],"length":1,"stats":{"Line":10},"fn_name":null},{"line":412,"address":[11962032,11962584,11964927,11964793],"length":1,"stats":{"Line":10},"fn_name":null},{"line":413,"address":[10401499],"length":1,"stats":{"Line":5},"fn_name":null},{"line":418,"address":[13574955,13574384,13574949],"length":1,"stats":{"Line":3},"fn_name":null},{"line":419,"address":[11438379],"length":1,"stats":{"Line":3},"fn_name":null},{"line":420,"address":[13574475],"length":1,"stats":{"Line":3},"fn_name":null},{"line":421,"address":[6856011,6856072],"length":1,"stats":{"Line":4},"fn_name":null},{"line":422,"address":[13574555],"length":1,"stats":{"Line":3},"fn_name":null},{"line":423,"address":[11177064,11176793],"length":1,"stats":{"Line":1},"fn_name":null},{"line":425,"address":[13574786,13574598],"length":1,"stats":{"Line":3},"fn_name":null},{"line":429,"address":[11452496],"length":1,"stats":{"Line":1},"fn_name":null},{"line":430,"address":[11177416],"length":1,"stats":{"Line":1},"fn_name":null},{"line":434,"address":[6856832],"length":1,"stats":{"Line":1},"fn_name":null},{"line":435,"address":[13575346],"length":1,"stats":{"Line":1},"fn_name":null},{"line":438,"address":[11177504],"length":1,"stats":{"Line":1},"fn_name":null},{"line":439,"address":[10309833,10309824],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":442,"address":[7025246,7023232,7024076,7025240],"length":1,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[7023279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":444,"address":[7023394,7023351],"length":1,"stats":{"Line":2},"fn_name":null},{"line":445,"address":[12694127,12693993],"length":1,"stats":{"Line":2},"fn_name":null},{"line":446,"address":[13576410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":447,"address":[7024197],"length":1,"stats":{"Line":1},"fn_name":null},{"line":448,"address":[13576460],"length":1,"stats":{"Line":1},"fn_name":null},{"line":451,"address":[11439535],"length":1,"stats":{"Line":1},"fn_name":null},{"line":455,"address":[6916832,6917111,6918618,6921429],"length":1,"stats":{"Line":1},"fn_name":null},{"line":456,"address":[11502391,11499727,11501648],"length":1,"stats":{"Line":2},"fn_name":null},{"line":457,"address":[11501703],"length":1,"stats":{"Line":1},"fn_name":null},{"line":458,"address":[11240012,11239921],"length":1,"stats":{"Line":2},"fn_name":null},{"line":460,"address":[12694489,12694623],"length":1,"stats":{"Line":0},"fn_name":null},{"line":461,"address":[13638447],"length":1,"stats":{"Line":0},"fn_name":null},{"line":466,"address":[11455008],"length":1,"stats":{"Line":1},"fn_name":null},{"line":467,"address":[11179938],"length":1,"stats":{"Line":1},"fn_name":null},{"line":471,"address":[11503904],"length":1,"stats":{"Line":1},"fn_name":null},{"line":477,"address":[6216586,6216437,6231369,6231503,6217099],"length":1,"stats":{"Line":3},"fn_name":null},{"line":480,"address":[12699362,12700720],"length":1,"stats":{"Line":2},"fn_name":null},{"line":485,"address":[5759728,5760098,5759947,5759660,5759567,5759879,5761707,5759622,5760167],"length":1,"stats":{"Line":2},"fn_name":null},{"line":489,"address":[12703453,12702569,12702588,12702737,12702902,12702808,12702651,12703343],"length":1,"stats":{"Line":8},"fn_name":null},{"line":490,"address":[12702584],"length":1,"stats":{"Line":1},"fn_name":null},{"line":492,"address":[11974025],"length":1,"stats":{"Line":1},"fn_name":null},{"line":494,"address":[7164866],"length":1,"stats":{"Line":4},"fn_name":null},{"line":495,"address":[12703536],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[11974994,11974883],"length":1,"stats":{"Line":2},"fn_name":null},{"line":497,"address":[11970116,11984928,11974997,11978331,11984944],"length":1,"stats":{"Line":1},"fn_name":"{closure#0}"},{"line":498,"address":[12711593,12707376,12708118,12707296],"length":1,"stats":{"Line":4},"fn_name":null},{"line":499,"address":[5772985,5769701,5766098,5770293,5773119],"length":1,"stats":{"Line":3},"fn_name":null},{"line":500,"address":[11982781],"length":1,"stats":{"Line":1},"fn_name":null},{"line":502,"address":[11986089,11980330,11981486,11986223,11978744,11978678,11979426],"length":1,"stats":{"Line":4},"fn_name":null},{"line":503,"address":[12710159,12709003],"length":1,"stats":{"Line":1},"fn_name":null},{"line":508,"address":[10418179],"length":1,"stats":{"Line":1},"fn_name":null},{"line":511,"address":[10400493],"length":1,"stats":{"Line":0},"fn_name":null},{"line":512,"address":[12704445,12703936,12715289,12703505,12715423],"length":1,"stats":{"Line":0},"fn_name":null},{"line":513,"address":[12706838,12704408],"length":1,"stats":{"Line":0},"fn_name":null},{"line":519,"address":[11520222,11517248,11518977],"length":1,"stats":{"Line":1},"fn_name":null},{"line":524,"address":[11504287,11504471],"length":1,"stats":{"Line":1},"fn_name":null},{"line":525,"address":[11244667],"length":1,"stats":{"Line":1},"fn_name":null},{"line":526,"address":[11519716],"length":1,"stats":{"Line":1},"fn_name":null},{"line":527,"address":[6924056,6924195,6924138],"length":1,"stats":{"Line":3},"fn_name":null},{"line":528,"address":[13642772,13642671],"length":1,"stats":{"Line":0},"fn_name":null},{"line":530,"address":[13642705],"length":1,"stats":{"Line":1},"fn_name":null},{"line":538,"address":[13643056,13643069],"length":1,"stats":{"Line":25},"fn_name":"load_key_states_from_file"},{"line":539,"address":[6236982,6236653],"length":1,"stats":{"Line":10},"fn_name":null},{"line":540,"address":[12719543,12719659,12764672,12764673],"length":1,"stats":{"Line":10},"fn_name":"{closure#0}"},{"line":541,"address":[6237236],"length":1,"stats":{"Line":5},"fn_name":null},{"line":543,"address":[10430107],"length":1,"stats":{"Line":5},"fn_name":null},{"line":544,"address":[10416874],"length":1,"stats":{"Line":5},"fn_name":null},{"line":546,"address":[11991349,11990527,11991251,11991469],"length":1,"stats":{"Line":15},"fn_name":null},{"line":547,"address":[12720560],"length":1,"stats":{"Line":2},"fn_name":null},{"line":549,"address":[7158730],"length":1,"stats":{"Line":6},"fn_name":null},{"line":550,"address":[5784134],"length":1,"stats":{"Line":2},"fn_name":null},{"line":551,"address":[6243017],"length":1,"stats":{"Line":2},"fn_name":null},{"line":552,"address":[12764895,12726280,12764761,12725645,12725724],"length":1,"stats":{"Line":6},"fn_name":null},{"line":553,"address":[6243612],"length":1,"stats":{"Line":2},"fn_name":null},{"line":555,"address":[10435806],"length":1,"stats":{"Line":1},"fn_name":null},{"line":556,"address":[10475647,10475513,10435822,10438515,10439016],"length":1,"stats":{"Line":3},"fn_name":null},{"line":560,"address":[11991793,11992236],"length":1,"stats":{"Line":8},"fn_name":null},{"line":562,"address":[10431311,10433723,10476143,10476009],"length":1,"stats":{"Line":8},"fn_name":null},{"line":564,"address":[11992285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":566,"address":[10431393,10476505,10431283,10476639,10431894],"length":1,"stats":{"Line":0},"fn_name":null},{"line":571,"address":[14046024],"length":1,"stats":{"Line":12},"fn_name":null},{"line":572,"address":[10441569,10441705],"length":1,"stats":{"Line":2},"fn_name":null},{"line":573,"address":[5790828,5790226,5825567,5825433,5790312],"length":1,"stats":{"Line":3},"fn_name":null},{"line":574,"address":[10430976,10416302,10429104,10433002,10433318],"length":1,"stats":{"Line":4},"fn_name":null},{"line":575,"address":[10446663],"length":1,"stats":{"Line":1},"fn_name":null},{"line":576,"address":[12007739,12007844],"length":1,"stats":{"Line":2},"fn_name":null},{"line":577,"address":[12736656],"length":1,"stats":{"Line":1},"fn_name":null},{"line":578,"address":[10433717,10433800,10464249,10434333,10464383],"length":1,"stats":{"Line":3},"fn_name":null},{"line":580,"address":[5517788],"length":1,"stats":{"Line":3},"fn_name":null},{"line":581,"address":[12746546,12767871,12767737,12745935,12746045],"length":1,"stats":{"Line":0},"fn_name":null},{"line":588,"address":[10456219,10478489,10478623,10460087,10459571],"length":1,"stats":{"Line":3},"fn_name":null},{"line":589,"address":[5517814],"length":1,"stats":{"Line":3},"fn_name":null},{"line":590,"address":[5827551,5810724,5810843,5811344,5827417],"length":1,"stats":{"Line":0},"fn_name":null},{"line":593,"address":[7158840],"length":1,"stats":{"Line":3},"fn_name":null},{"line":595,"address":[5814026],"length":1,"stats":{"Line":1},"fn_name":null},{"line":596,"address":[5814158,5814041],"length":1,"stats":{"Line":1},"fn_name":null},{"line":598,"address":[12736606],"length":1,"stats":{"Line":1},"fn_name":null},{"line":599,"address":[5798957,5827913,5795313,5798441,5828047],"length":1,"stats":{"Line":3},"fn_name":null},{"line":601,"address":[14046154],"length":1,"stats":{"Line":2},"fn_name":null},{"line":602,"address":[12756142,12769721,12756023,12769855,12756643],"length":1,"stats":{"Line":0},"fn_name":null},{"line":604,"address":[12030218,12030241,12030180],"length":1,"stats":{"Line":2},"fn_name":null},{"line":608,"address":[10433362],"length":1,"stats":{"Line":0},"fn_name":null},{"line":609,"address":[5801900,5795064,5829039,5801384,5828905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":611,"address":[7158884],"length":1,"stats":{"Line":0},"fn_name":null},{"line":612,"address":[10481103,10469740,10470360,10469859,10480969],"length":1,"stats":{"Line":0},"fn_name":null},{"line":614,"address":[6279395,6279414,6279369],"length":1,"stats":{"Line":0},"fn_name":null},{"line":618,"address":[10468217,10428359,10431153,10468351,10431685],"length":1,"stats":{"Line":12},"fn_name":null},{"line":622,"address":[10473001,10472883],"length":1,"stats":{"Line":5},"fn_name":null},{"line":623,"address":[10472956],"length":1,"stats":{"Line":1},"fn_name":null},{"line":625,"address":[12762672,12762782,12771705,12763283,12771839],"length":1,"stats":{"Line":12},"fn_name":null},{"line":626,"address":[6281510,6280270],"length":1,"stats":{"Line":8},"fn_name":null},{"line":632,"address":[11245207,11245184],"length":1,"stats":{"Line":20},"fn_name":"find_latest_temp_file"},{"line":633,"address":[6291722],"length":1,"stats":{"Line":4},"fn_name":null},{"line":634,"address":[10485033],"length":1,"stats":{"Line":4},"fn_name":null},{"line":635,"address":[12046110,12046277],"length":1,"stats":{"Line":8},"fn_name":null},{"line":636,"address":[5833773],"length":1,"stats":{"Line":4},"fn_name":null},{"line":637,"address":[10485968,10485368,10510143,10510009,10485451],"length":1,"stats":{"Line":12},"fn_name":null},{"line":639,"address":[7154930],"length":1,"stats":{"Line":16},"fn_name":null},{"line":640,"address":[14044008],"length":1,"stats":{"Line":16},"fn_name":null},{"line":641,"address":[12791683],"length":1,"stats":{"Line":4},"fn_name":null},{"line":642,"address":[12791719,12791824,12790968],"length":1,"stats":{"Line":12},"fn_name":null},{"line":643,"address":[12799648,12799670,12791858],"length":1,"stats":{"Line":12},"fn_name":"{closure#0}"},{"line":644,"address":[10489103],"length":1,"stats":{"Line":4},"fn_name":null},{"line":645,"address":[5850995,5851546,5859071,5858937],"length":1,"stats":{"Line":2},"fn_name":null},{"line":646,"address":[12046216,12053092,12053423,12053058,12053518,12064110,12066135],"length":1,"stats":{"Line":6},"fn_name":null},{"line":647,"address":[12782356,12782295,12782232],"length":1,"stats":{"Line":3},"fn_name":null},{"line":648,"address":[10496107,10492642,10492719,10492815],"length":1,"stats":{"Line":3},"fn_name":null},{"line":650,"address":[12783221,12782650,12800879,12782516,12800745],"length":1,"stats":{"Line":3},"fn_name":null},{"line":651,"address":[10493378],"length":1,"stats":{"Line":1},"fn_name":null},{"line":652,"address":[12783181,12785651,12785706],"length":1,"stats":{"Line":2},"fn_name":null},{"line":655,"address":[12782325,12785863,12801241,12801375],"length":1,"stats":{"Line":0},"fn_name":null},{"line":658,"address":[5860425,5860559,5840843,5847046],"length":1,"stats":{"Line":0},"fn_name":null},{"line":665,"address":[5837767,5838502,5860921,5837970,5861055],"length":1,"stats":{"Line":0},"fn_name":null},{"line":668,"address":[10505244,10505310],"length":1,"stats":{"Line":5},"fn_name":null},{"line":669,"address":[12074025,12066996,12074159,12066444,12066378],"length":1,"stats":{"Line":3},"fn_name":null},{"line":671,"address":[5853798,5862047,5861913,5856365],"length":1,"stats":{"Line":8},"fn_name":null},{"line":673,"address":[12795620],"length":1,"stats":{"Line":4},"fn_name":null},{"line":678,"address":[6320658,6320432,6321566,6322070,6322686,6320734,6320463],"length":1,"stats":{"Line":10},"fn_name":"{async_fn#0}"},{"line":679,"address":[12806189,12806020],"length":1,"stats":{"Line":4},"fn_name":null},{"line":680,"address":[5864981],"length":1,"stats":{"Line":2},"fn_name":null},{"line":682,"address":[5884495,5865625,5865007,5865090,5884361],"length":1,"stats":{"Line":6},"fn_name":null},{"line":683,"address":[12806874],"length":1,"stats":{"Line":2},"fn_name":null},{"line":685,"address":[10520160,10516340,10517148,10520040,10520559],"length":1,"stats":{"Line":8},"fn_name":null},{"line":686,"address":[10529731,10529816,10523165,10530088,10516361,10520611],"length":1,"stats":{"Line":9},"fn_name":null},{"line":687,"address":[12819882],"length":1,"stats":{"Line":2},"fn_name":null},{"line":688,"address":[6336599,6336494,6335775],"length":1,"stats":{"Line":6},"fn_name":null},{"line":689,"address":[6336633,6342112,6342134],"length":1,"stats":{"Line":6},"fn_name":"{closure#0}"},{"line":690,"address":[12091699,12091590,12090310],"length":1,"stats":{"Line":4},"fn_name":null},{"line":691,"address":[10536425,10530812,10531363,10536559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":692,"address":[10520096,10509954,10509988,10510261,10518071,10503134],"length":1,"stats":{"Line":0},"fn_name":null},{"line":693,"address":[10537055,10524183,10523682,10536921,10523564],"length":1,"stats":{"Line":0},"fn_name":null},{"line":695,"address":[5872024,5875191,5875149],"length":1,"stats":{"Line":0},"fn_name":null},{"line":696,"address":[10513483,10513538,10524169,10524303],"length":1,"stats":{"Line":0},"fn_name":null},{"line":703,"address":[5869686,5869157,5886345,5886479,5868960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":705,"address":[5882488,5886841,5881925,5886975,5881983],"length":1,"stats":{"Line":6},"fn_name":null}],"covered":280,"coverable":335},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","lib.rs"],"content":"// src/lib.rs\n\n// Declare modules that constitute the library's public API or internal structure\npub mod config;\npub mod error;\npub mod handler;\npub mod key_manager;\npub mod proxy;\npub mod state;\npub mod admin;\n\n// Re-export key types for easier use by the binary or tests\nuse axum::{\n    body::Body,\n    http::Request as AxumRequest,\n    middleware::{self, Next},\n    response::Response as AxumResponse,\n    routing::{any, get},\n    Router,\n};\nuse std::{path::PathBuf, sync::Arc, time::Instant};\nuse tower_cookies::CookieManagerLayer;\nuse tracing::{error, info, span, Instrument, Level};\nuse uuid::Uuid;\n\n\npub use config::AppConfig;\npub use error::{AppError, Result};\npub use state::AppState;\n\n/// Creates the main Axum router for the application.\npub fn create_router(state: Arc\u003cAppState\u003e) -\u003e Router {\n    Router::new()\n        .route(\"/health\", get(handler::health_check))\n        .merge(admin::admin_routes())\n        .route(\"/*path\", any(handler::proxy_handler))\n        .layer(CookieManagerLayer::new())\n        .with_state(state)\n}\n\n/// Middleware to add Request ID and trace requests.\nasync fn trace_requests(req: AxumRequest\u003cBody\u003e, next: Next) -\u003e AxumResponse {\n    let request_id = Uuid::new_v4();\n    let start_time = Instant::now();\n    let method = req.method().clone();\n    let path = req.uri().path().to_string();\n\n    let span = span!(\n        Level::INFO,\n        \"request\",\n        request_id = %request_id,\n        http.method = %method,\n        url.path = %path,\n    );\n\n    let response = next.run(req).instrument(span).await;\n    let elapsed = start_time.elapsed();\n\n    info!(\n        http.response.duration = ?elapsed,\n        http.status_code = response.status().as_u16(),\n        \"Finished processing request\"\n    );\n\n    response\n}\n\n/// The main application setup function, responsible for configuration, state initialization,\n/// and router creation.\n///\n/// # Errors\n///\n/// This function will return an error if:\n/// - Configuration loading or validation fails.\n/// - The application state (e.g., HTTP clients) cannot be initialized.\npub async fn run(\n    config_path_override: Option\u003cPathBuf\u003e,\n) -\u003e std::result::Result\u003c(Router, AppConfig), AppError\u003e {\n    // --- Configuration Path ---\n    let config_path = config_path_override.unwrap_or_else(|| {\n        std::env::var(\"CONFIG_PATH\").map_or_else(|_| PathBuf::from(\"config.yaml\"), PathBuf::from)\n    });\n\n    info!(\"Starting Gemini API Key Rotation Proxy...\");\n\n    let config_path_display = config_path.display().to_string();\n    if config_path.exists() {\n        info!(config.path = %config_path_display, \"Using configuration file\");\n    } else {\n        info!(config.path = %config_path_display, \"Optional configuration file not found. Using defaults and environment variables.\");\n    }\n\n    // --- Configuration Loading \u0026 Validation ---\n    let app_config = config::load_config(\u0026config_path).map_err(|e| {\n        error!(\n            config.path = %config_path_display,\n            error = ?e,\n            \"Failed to load or validate configuration. Exiting.\"\n        );\n        e\n    })?;\n\n    let total_keys: usize = app_config.groups.iter().map(|g| g.api_keys.len()).sum();\n    let group_names: Vec\u003cString\u003e = app_config.groups.iter().map(|g| g.name.clone()).collect();\n    info!(\n         config.groups.count = app_config.groups.len(),\n         config.groups.names = ?group_names,\n         config.total_keys = total_keys,\n         server.port = app_config.server.port,\n         \"Configuration loaded and validated successfully.\"\n    );\n\n    // --- Application State Initialization ---\n    let app_state = AppState::new(\u0026app_config, \u0026config_path).await.map_err(|e| {\n        error!(\n            error = ?e,\n            \"Failed to initialize application state. Exiting.\"\n        );\n        e\n    })?;\n    let app_state = Arc::new(app_state);\n// --- Router Setup ---\nlet app = create_router(app_state.clone()).layer(middleware::from_fn(trace_requests));\n\nOk((app, app_config))\n}\n","traces":[{"line":32,"address":[13255984,13256730,13256667],"length":1,"stats":{"Line":2},"fn_name":"create_router"},{"line":33,"address":[32395401],"length":1,"stats":{"Line":14},"fn_name":null},{"line":34,"address":[13256236,13256135,13256711,13256111],"length":1,"stats":{"Line":4},"fn_name":null},{"line":35,"address":[5179048,5178956,5179380,5178940],"length":1,"stats":{"Line":4},"fn_name":null},{"line":36,"address":[5434700,5434974,5434707,5434810],"length":1,"stats":{"Line":4},"fn_name":null},{"line":37,"address":[29304176],"length":1,"stats":{"Line":4},"fn_name":"fmt"},{"line":38,"address":[15955022,15955086,15954960,15954968,15955054],"length":1,"stats":{"Line":2},"fn_name":"{constructor#0}"},{"line":42,"address":[29521872,29521951,29522056],"length":1,"stats":{"Line":4},"fn_name":"clone"},{"line":43,"address":[16077367],"length":1,"stats":{"Line":1},"fn_name":null},{"line":44,"address":[12441808,12441816,12441845,12441840,12441876,12441856],"length":1,"stats":{"Line":1},"fn_name":"clone"},{"line":45,"address":[7277378],"length":1,"stats":{"Line":1},"fn_name":null},{"line":46,"address":[6221885],"length":1,"stats":{"Line":2},"fn_name":null},{"line":48,"address":[32408672],"length":1,"stats":{"Line":3},"fn_name":"bidi_class_to_mask"},{"line":49,"address":[12902656],"length":1,"stats":{"Line":0},"fn_name":"from"},{"line":51,"address":[15954377,15954414],"length":1,"stats":{"Line":2},"fn_name":null},{"line":52,"address":[16548249],"length":1,"stats":{"Line":0},"fn_name":null},{"line":53,"address":[36394667,36394732],"length":1,"stats":{"Line":12},"fn_name":null},{"line":56,"address":[11696641],"length":1,"stats":{"Line":6},"fn_name":null},{"line":57,"address":[23062656,23062694],"length":1,"stats":{"Line":5},"fn_name":"clone"},{"line":59,"address":[31534311,31534375,31534386],"length":1,"stats":{"Line":4},"fn_name":null},{"line":60,"address":[31050285],"length":1,"stats":{"Line":0},"fn_name":null},{"line":61,"address":[20224928],"length":1,"stats":{"Line":1},"fn_name":"fmt"},{"line":65,"address":[16419994,16420037,16419731,16419984,16419712,16420032],"length":1,"stats":{"Line":2},"fn_name":"fmt"},{"line":76,"address":[35548602],"length":1,"stats":{"Line":6},"fn_name":null},{"line":80,"address":[31649658],"length":1,"stats":{"Line":10},"fn_name":null},{"line":81,"address":[34156710],"length":1,"stats":{"Line":14},"fn_name":null},{"line":84,"address":[15687514],"length":1,"stats":{"Line":19},"fn_name":null},{"line":86,"address":[36387989],"length":1,"stats":{"Line":16},"fn_name":null},{"line":87,"address":[34157125],"length":1,"stats":{"Line":14},"fn_name":null},{"line":88,"address":[31541767,31541880],"length":1,"stats":{"Line":11},"fn_name":null},{"line":90,"address":[40289133],"length":1,"stats":{"Line":9},"fn_name":null},{"line":94,"address":[40289198,40289347],"length":1,"stats":{"Line":12},"fn_name":null},{"line":95,"address":[28365097,28302533,28292019,28302976,28301832,28294143,28334129,28327186,28334593,28305731,28342473,28285277,28363743,28372175,28294889,28364735,28336499,28287690,28345803,28363609,28288176,28285547,28306863,28326981,28291546,28342536,28375017,28305243,28333547,28286814,28371545,28288922,28292531,28332315,28374655,28301344,28293657,28286068,28366089,28346328,28363247,28287287,28290279,28365727,28343063,28334221,28335079,28333639,28366223,28290800,28304769,28363113,28365593,28374521,28365231,28364601,28336407,28301283,28306420,28289395,28335825,28371679,28305587,28295362,28332801,28372041,28375151,28335917],"length":1,"stats":{"Line":6},"fn_name":null},{"line":96,"address":[34418841],"length":1,"stats":{"Line":9},"fn_name":null},{"line":97,"address":[16401376],"length":1,"stats":{"Line":6},"fn_name":null},{"line":98,"address":[7357704],"length":1,"stats":{"Line":11},"fn_name":null},{"line":100,"address":[34497608,34497454],"length":1,"stats":{"Line":7},"fn_name":null},{"line":103,"address":[14476217,14477252,14478432,14476336,14478306,14477378],"length":1,"stats":{"Line":19},"fn_name":null},{"line":104,"address":[7291817,7300080,7300115],"length":1,"stats":{"Line":6},"fn_name":"{closure#3}"},{"line":105,"address":[39138768],"length":1,"stats":{"Line":14},"fn_name":"domain_to_ascii_cow"},{"line":106,"address":[17377076],"length":1,"stats":{"Line":20},"fn_name":null},{"line":107,"address":[14091568,14091621],"length":1,"stats":{"Line":17},"fn_name":null},{"line":108,"address":[20902091,20902148,20902235,20902292],"length":1,"stats":{"Line":15},"fn_name":null},{"line":109,"address":[14753144,14752784,14753016,14752924,14753074,14752855,14752992,14752808],"length":1,"stats":{"Line":10},"fn_name":"fmt"},{"line":114,"address":[5029377],"length":1,"stats":{"Line":9},"fn_name":null},{"line":115,"address":[19721312],"length":1,"stats":{"Line":10},"fn_name":null},{"line":116,"address":[15917400],"length":1,"stats":{"Line":0},"fn_name":null},{"line":117,"address":[33719879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[20808304,20808352,20808309,20808320],"length":1,"stats":{"Line":0},"fn_name":"clone"},{"line":121,"address":[17243851],"length":1,"stats":{"Line":6},"fn_name":null},{"line":123,"address":[39163385],"length":1,"stats":{"Line":13},"fn_name":null},{"line":125,"address":[6312435],"length":1,"stats":{"Line":4},"fn_name":null}],"covered":46,"coverable":52},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","main.rs"],"content":"// src/main.rs\n\nuse axum::serve;\nuse gemini_proxy_key_rotation_rust::{run, AppError};\nuse std::net::SocketAddr;\nuse tokio::net::TcpListener;\nuse tokio::signal;\nuse tracing::{error, info};\n\nasync fn shutdown_signal() {\n    let ctrl_c = async {\n        signal::ctrl_c()\n            .await\n            .expect(\"Failed to install Ctrl+C handler\");\n    };\n\n    #[cfg(unix)]\n    let terminate = async {\n        signal::unix::signal(signal::unix::SignalKind::terminate())\n            .expect(\"Failed to install signal handler\")\n            .recv()\n            .await;\n    };\n\n    #[cfg(not(unix))]\n    let terminate = std::future::pending::\u003c()\u003e();\n\n    tokio::select! {\n        () = ctrl_c =\u003e { info!(signal = \"Ctrl+C\", \"Received signal. Initiating graceful shutdown...\") },\n        () = terminate =\u003e { info!(signal = \"Terminate\", \"Received signal. Initiating graceful shutdown...\") },\n    }\n}\n\nuse tracing_subscriber::{fmt, layer::SubscriberExt, util::SubscriberInitExt, EnvFilter};\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), AppError\u003e {\n    // --- Initialize Tracing (JSON format) ---\n    let env_filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\"));\n    let json_layer = fmt::layer()\n        .json()\n        .with_current_span(true)\n        .with_span_list(true);\n    tracing_subscriber::registry()\n        .with(env_filter)\n        .with(json_layer)\n        .init();\n\n    // The `run` function now configures the app and returns both the router and the config.\n    let (app, config) = run(None).await.map_err(|e| {\n        eprintln!(\"Application setup error: {:?}\", e);\n        e\n    })?;\n\n    let addr = SocketAddr::from(([0, 0, 0, 0], config.server.port));\n    let listener = TcpListener::bind(addr).await.map_err(|e| {\n        error!(server.address = %addr, error = ?e, \"Failed to bind to address. Exiting.\");\n        AppError::from(e)\n    })?;\n    info!(server.address = %addr, \"Server listening\");\n\n    // --- Run with Graceful Shutdown ---\n    info!(\"Starting server run loop...\");\n    serve(listener, app.into_make_service())\n        .with_graceful_shutdown(shutdown_signal())\n        .await\n        .map_err(|e| {\n            error!(error = ?e, \"Server run loop encountered an error. Exiting.\");\n            AppError::from(e)\n        })?;\n\n    info!(\"Server shut down gracefully.\");\n    Ok(())\n}\n","traces":[{"line":10,"address":[5061568,5061571],"length":1,"stats":{"Line":0},"fn_name":"shutdown_signal"},{"line":11,"address":[5361296,5367472,5367573,5367369,5367438,5367832,5367344],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":12,"address":[5367738,5367419,5367536,5367774],"length":1,"stats":{"Line":0},"fn_name":null},{"line":13,"address":[5367599,5367462,5367529,5367556,5367758],"length":1,"stats":{"Line":0},"fn_name":null},{"line":18,"address":[5367865,5367930,5367970,5368258,5367840,5368501,5361357],"length":1,"stats":{"Line":0},"fn_name":"{async_block#1}"},{"line":19,"address":[5367915,5368209,5368018,5368423],"length":1,"stats":{"Line":0},"fn_name":null},{"line":22,"address":[5367957,5368144,5368233,5368284,5368437],"length":1,"stats":{"Line":0},"fn_name":null},{"line":28,"address":[5030935,5030950,5030999],"length":1,"stats":{"Line":0},"fn_name":null},{"line":29,"address":[5369375,5362810,5362905,5361524,5364570,5369241],"length":1,"stats":{"Line":0},"fn_name":null},{"line":30,"address":[5361635,5369871,5362838,5365137,5369737],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[5062003,5062009,5061584],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":39,"address":[5370563,5379760,5379776,5370345],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":40,"address":[5370613,5370681],"length":1,"stats":{"Line":0},"fn_name":null},{"line":44,"address":[5370744,5370837],"length":1,"stats":{"Line":0},"fn_name":null},{"line":45,"address":[5370763],"length":1,"stats":{"Line":0},"fn_name":null},{"line":50,"address":[5029921],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[5379941,5379899],"length":1,"stats":{"Line":0},"fn_name":null},{"line":52,"address":[5380005],"length":1,"stats":{"Line":0},"fn_name":null},{"line":55,"address":[5371701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[5029937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":57,"address":[5385407,5385273,5380523,5380179,5380675,5380087],"length":1,"stats":{"Line":0},"fn_name":null},{"line":58,"address":[5380645],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[5372680,5385769,5373190,5372600,5385903],"length":1,"stats":{"Line":0},"fn_name":null},{"line":63,"address":[5373152,5386399,5386265,5374948,5375541],"length":1,"stats":{"Line":0},"fn_name":null},{"line":64,"address":[5377494,5377431,5377009,5376857,5375420,5377103,5377629,5377180,5379582],"length":1,"stats":{"Line":0},"fn_name":null},{"line":65,"address":[5377048,5376968,5376961,5377152],"length":1,"stats":{"Line":0},"fn_name":null},{"line":66,"address":[5029953],"length":1,"stats":{"Line":0},"fn_name":null},{"line":67,"address":[5385207,5383329,5382864,5385175],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":68,"address":[5382987,5383331,5383483,5386895,5386761,5382895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":69,"address":[5383453],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[5377666,5387391,5387257,5378236],"length":1,"stats":{"Line":0},"fn_name":null},{"line":73,"address":[5061637,5061697,5061878],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":32},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","metrics.rs"],"content":"// src/metrics.rs\n\nuse metrics::{counter, gauge, histogram};\nuse metrics_exporter_prometheus::{PrometheusBuilder, PrometheusHandle};\nuse std::time::Instant;\n\npub fn initialize_metrics() -\u003e PrometheusHandle {\n    let builder = PrometheusBuilder::new();\n    builder\n        .install_recorder()\n        .expect(\"failed to install Prometheus recorder\")\n}\n\npub fn record_request_start() {\n    gauge!(\"proxy_requests_in_flight\").increment(1.0);\n}\n\npub fn record_request_end(start_time: Instant, status_code: u16, group_name: \u0026str) {\n    let duration = start_time.elapsed().as_secs_f64();\n    gauge!(\"proxy_requests_in_flight\").decrement(1.0);\n    counter!(\"proxy_requests_total\", \"status\" =\u003e status_code.to_string(), \"group\" =\u003e group_name.to_string()).increment(1);\n    histogram!(\"proxy_request_duration_seconds\", \"status\" =\u003e status_code.to_string(), \"group\" =\u003e group_name.to_string()).record(duration);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","proxy.rs"],"content":"// src/proxy.rs\n\nuse crate::{\n    error::{AppError, Result},\n    key_manager::FlattenedKeyInfo,\n    state::AppState, // Import AppState\n};\nuse axum::{\n    body::{Body, Bytes},\n    http::{header, HeaderMap, HeaderValue, Method}, // Removed unused StatusCode\n    response::Response,\n};\n\nuse futures_util::TryStreamExt;\nuse std::error::Error; // Import Error trait for source()\nuse std::time::Instant; // Added Instant\nuse tracing::{debug, error, info, trace, warn};\nuse url::Url; // Keep Url\n\n// Hop-by-hop headers that should not be forwarded\nconst HOP_BY_HOP_HEADERS: \u0026[\u0026str] = \u0026[\n    \"connection\",\n    \"keep-alive\",\n    \"proxy-authenticate\",\n    \"proxy-authorization\",\n    \"te\",\n    \"trailers\",\n    \"transfer-encoding\",\n    \"upgrade\",\n    \"host\",           // Explicitly include host as it's often added by clients\n    \"authorization\",  // Original authorization should be replaced\n    \"x-goog-api-key\", // Original key (if any) should be replaced\n];\n/// Takes incoming request components and forwards them to the appropriate upstream target.\n///\n/// Orchestrates the core proxying logic. Rate limit handling (429) is delegated to the calling handler.\n/// Assumes this function is called within a tracing span that includes `request_id`.\n///\n/// # Errors\n///\n/// This function will return an error if:\n/// - The base URL from configuration is invalid.\n/// - The final target URL cannot be constructed.\n/// - The HTTP client for the required proxy cannot be retrieved.\n/// - The request to the target fails (e.g., network error, timeout).\n/// - The response body stream from the target has an error.\n/// - The final response to the client cannot be constructed.\npub async fn forward_request(\n    state: \u0026AppState,\n    key_info: \u0026FlattenedKeyInfo,\n    method: Method,\n    target_url: Url,\n    headers: HeaderMap,\n    body_bytes: Bytes,\n) -\u003e Result\u003cResponse\u003e {\n    let api_key = \u0026key_info.key;\n    let proxy_url_option = key_info.proxy_url.as_deref();\n    let group_name = \u0026key_info.group_name;\n    let request_key_preview = format!(\"{}...\", api_key.chars().take(4).collect::\u003cString\u003e());\n\n    let final_target_url = target_url;\n    let outgoing_method = method;\n    let mut outgoing_headers = build_forward_headers(\u0026headers, api_key)?;\n\n    // --- Body Modification ---\n    let body_to_send = {\n        let config_guard = state.config.read().await;\n        if let Some(top_p_value) = config_guard.server.top_p {\n            // Drop the read lock as soon as we have the value\n            drop(config_guard);\n            // The logic is wrapped in a closure to easily return the original bytes on any failure.\n            let modified_body_bytes = (|| {\n                if let Ok(mut json_body) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026body_bytes) {\n                    if let Some(obj) = json_body.as_object_mut() {\n                        obj.insert(\"top_p\".to_string(), serde_json::json!(top_p_value));\n                        if let Ok(modified_bytes) = serde_json::to_vec(\u0026json_body) {\n                            info!(top_p = top_p_value, \"Successfully injected top_p into request body\");\n                            return Bytes::from(modified_bytes);\n                        } else {\n                            warn!(\"Failed to re-serialize JSON body after injecting top_p, forwarding original body.\");\n                        }\n                    } else {\n                        debug!(\"Request body is valid JSON but not an object, cannot inject top_p.\");\n                    }\n                } else {\n                    debug!(\"Request body is not valid JSON, cannot inject top_p.\");\n                }\n                body_bytes.clone() // Return original on any failure\n            })();\n\n            // If the body was modified, update the Content-Length header.\n            if modified_body_bytes.len() != body_bytes.len() {\n                let new_length = modified_body_bytes.len();\n                debug!(old_len = body_bytes.len(), new_len = new_length, \"Updating Content-Length due to body modification\");\n                outgoing_headers.insert(header::CONTENT_LENGTH, HeaderValue::from(new_length));\n            }\nmodified_body_bytes\n} else {\nbody_bytes\n}\n};\n\n    let outgoing_reqwest_body = reqwest::Body::from(body_to_send);\n    // --- End Body Modification ---\n    // --- Get Client ---\n    let http_client = state.get_client(proxy_url_option).await?; // Error handled within\n                                                                 // ---\n\n    // Log before sending the request\n    info!(\n        http.method = %outgoing_method,\n        target.url = %final_target_url,\n        http.headers = ?outgoing_headers,\n        api_key.preview = %request_key_preview,\n        group.name = %group_name,\n        proxy.url = ?proxy_url_option, // Use debug formatting for Option\u003c\u0026str\u003e\n        \"Forwarding raw request to target\"\n    );\n\n    // --- Send request ---\n    let start_time = Instant::now();\n\n    let target_response_result = http_client\n        .request(outgoing_method.clone(), final_target_url.clone()) // Clone Url for request\n        .headers(outgoing_headers)\n        .body(outgoing_reqwest_body)\n        .send()\n        .await;\n\n    let elapsed_time = start_time.elapsed(); // Calculate duration immediately after await\n\n    let target_response = match target_response_result {\n        Ok(resp) =\u003e {\n            let status = resp.status();\n            // Structured success log\n            info!(\n                // Use standard semantic convention fields where possible\n                http.status_code = status.as_u16(),\n                http.response.duration = ?elapsed_time, // Use standard field name if available in log aggregator\n                target.url = %final_target_url,\n                api_key.preview = %request_key_preview,\n                group.name = %group_name,\n                proxy.url = ?proxy_url_option,\n                \"Received response from target\"\n            );\n            resp // Return the response\n        }\n        Err(e) =\u003e {\n            // Structured error log, trying to extract more detail from reqwest::Error\n            let error_kind = if e.is_timeout() {\n                \"timeout\"\n            } else if e.is_connect() {\n                \"connect\"\n            } else if e.is_redirect() {\n                \"redirect_policy\"\n            } else if e.is_request() {\n                \"request_error\"\n            } else if e.is_body() || e.is_decode() {\n                \"body/decode\"\n            } else if e.is_builder() {\n                \"builder\"\n            } else {\n                \"unknown\"\n            };\n            // Use the imported Error trait to call source()\n            let underlying_source = e.source().map(ToString::to_string); // Get underlying error if available\n\n            error!(\n                error = %e, // Display format for top-level error\n                error.kind = error_kind,\n                error.source = ?underlying_source, // Debug format for underlying source\n                http.response.duration = ?elapsed_time,\n                target.url = %final_target_url, // Log target URL on error too\n                api_key.preview = %request_key_preview,\n                group.name = %group_name,\n                proxy.url = ?proxy_url_option,\n                \"Error received while sending request to target\"\n            );\n            // Return the error wrapped in AppError\n            return Err(AppError::Reqwest(e));\n        }\n    };\n    // --- End Send Request ---\n\n    let response_status = target_response.status();\n    let response_headers = build_response_headers(target_response.headers());\n\n    // Stream response body back\n    let captured_response_status = response_status; // Capture status for closure\n    let response_body_stream = target_response.bytes_stream().map_err(move |e| {\n        // Log error during stream reading\n        warn!(\n            status = captured_response_status.as_u16(),\n            error = %e,\n            \"Error reading upstream response body stream\"\n        );\n        AppError::ResponseBodyError(format!(\n            \"Upstream body stream error (status {captured_response_status}): {e}\"\n        ))\n    });\n    let axum_response_body = Body::from_stream(response_body_stream);\n\n    // Build final response to client\n    let mut client_response = Response::builder()\n        .status(response_status)\n        .body(axum_response_body)\n        .map_err(|e| {\n            error!(error = %e, \"Failed to build final client response\");\n            AppError::Internal(format!(\"Failed to construct client response: {e}\"))\n        })?;\n\n    *client_response.headers_mut() = response_headers;\n\n    Ok(client_response)\n}\n\n/// Creates the `HeaderMap` for the outgoing request to the target service.\n/// Now returns a Result to handle potential errors from add_auth_headers.\n#[tracing::instrument(level=\"debug\", skip(original_headers, api_key), fields(header_count = original_headers.len()))]\nfn build_forward_headers(original_headers: \u0026HeaderMap, api_key: \u0026str) -\u003e Result\u003cHeaderMap\u003e {\n    let mut filtered = HeaderMap::with_capacity(original_headers.len() + 3);\n    copy_non_hop_by_hop_headers(original_headers, \u0026mut filtered, true);\n    add_auth_headers(\u0026mut filtered, api_key)?;\n    Ok(filtered)\n}\n\n\n/// Creates the `HeaderMap` for the response sent back to the original client.\n#[tracing::instrument(level=\"debug\", skip(original_headers), fields(header_count = original_headers.len()))]\nfn build_response_headers(original_headers: \u0026HeaderMap) -\u003e HeaderMap {\n    let mut filtered = HeaderMap::with_capacity(original_headers.len());\n    copy_non_hop_by_hop_headers(original_headers, \u0026mut filtered, false);\n    filtered\n}\n\n/// Copies headers from `source` to `dest`, excluding hop-by-hop headers.\nfn copy_non_hop_by_hop_headers(source: \u0026HeaderMap, dest: \u0026mut HeaderMap, is_request: bool) {\n    for (name, value) in source {\n        let name_str = name.as_str().to_lowercase();\n        // Check against the HOP_BY_HOP_HEADERS list using lowercase comparison\n        if HOP_BY_HOP_HEADERS.contains(\u0026name_str.as_str()) {\n            trace!(header.name=%name, header.action=\"skip\", context=if is_request {\"request\"} else {\"response\"}, \"Skipping hop-by-hop or auth header\");\n        } else {\n            dest.insert(name.clone(), value.clone());\n            trace!(header.name=%name, header.action=\"forward\", context=if is_request {\"request\"} else {\"response\"}, \"Forwarding header\");\n        }\n    }\n}\n\n/// Adds the necessary authentication headers (`x-goog-api-key` and `Authorization: Bearer`).\n/// Returns a Result to indicate potential failures.\n#[tracing::instrument(level=\"debug\")] // Removed skip attribute\n// Now takes api_key to add the Bearer token\nfn add_auth_headers(headers: \u0026mut HeaderMap, api_key: \u0026str) -\u003e Result\u003c()\u003e {\n    let auth_value_str = format!(\"Bearer {api_key}\");\n    match HeaderValue::from_str(\u0026auth_value_str) {\n        Ok(auth_value) =\u003e {\n            headers.insert(header::AUTHORIZATION, auth_value);\n            trace!(header.name=\"Authorization\", header.action=\"add\", \"Added Bearer token\");\n            Ok(())\n        }\n        Err(e) =\u003e {\n            error!(error = %e, \"Failed to create Authorization header value\");\n            Err(AppError::Internal(\n                \"Failed to construct Authorization header\".to_string(),\n            ))\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::http::{header, HeaderName, HeaderValue,};\n     // Import Error trait for source()\n\n    #[test]\n    fn test_build_forward_headers_basic() {\n        let mut original_headers = HeaderMap::new();\n        original_headers.insert(\"content-type\", HeaderValue::from_static(\"application/json\"));\n        original_headers.insert(\"x-custom-header\", HeaderValue::from_static(\"value1\"));\n        original_headers.insert(\"host\", HeaderValue::from_static(\"original.host.com\")); // Hop-by-hop\n        original_headers.insert(\"connection\", HeaderValue::from_static(\"keep-alive\")); // Hop-by-hop\n        original_headers.insert(\n            \"authorization\",\n            HeaderValue::from_static(\"Bearer old_token\"),\n        ); // Auth, should be removed\n        original_headers.insert(\"x-goog-api-key\", HeaderValue::from_static(\"old_key\")); // Auth, should be removed\n\n        // api_key is no longer passed as it's handled in URL construction\n        let result_headers = build_forward_headers(\u0026original_headers, \"test_key\").unwrap();\n\n        // Check standard headers are present\n        assert_eq!(\n            result_headers.get(\"content-type\").unwrap(),\n            \"application/json\"\n        );\n        assert_eq!(result_headers.get(\"x-custom-header\").unwrap(), \"value1\");\n\n        // Check hop-by-hop are absent\n        assert!(result_headers.get(\"host\").is_none());\n        assert!(result_headers.get(\"connection\").is_none());\n\n        // Check that x-goog-api-key is absent, but the new Authorization header is present.\n        assert!(result_headers.get(\"x-goog-api-key\").is_none());\n        let auth_header = result_headers.get(header::AUTHORIZATION).unwrap();\n        assert_eq!(auth_header, \"Bearer test_key\");\n    }\n\n    #[test]\n    fn test_build_forward_headers_removes_auth_headers() {\n        let mut original_headers = HeaderMap::new();\n        original_headers.insert(\n            header::AUTHORIZATION,\n            HeaderValue::from_static(\"Bearer client_token\"),\n        );\n        original_headers.insert(\"x-goog-api-key\", HeaderValue::from_static(\"client_key\"));\n        original_headers.insert(\"x-custom-header\", HeaderValue::from_static(\"custom_value\"));\n\n        let result_headers = build_forward_headers(\u0026original_headers, \"some_key\").unwrap();\n\n        assert!(result_headers.get(\"x-goog-api-key\").is_none());\n        assert_eq!(\n            result_headers.get(\"x-custom-header\").unwrap(),\n            \"custom_value\"\n        );\n        assert_eq!(result_headers.len(), 2);\n    }\n\n    // Removed test: test_build_forward_headers_invalid_key_chars\n\n    #[test]\n    fn test_build_response_headers_filters_hop_by_hop() {\n\n\n\n\n\n\n\n\n\n\n\n        let mut upstream_headers = HeaderMap::new();\n        upstream_headers.insert(\"content-type\", HeaderValue::from_static(\"text/plain\"));\n        upstream_headers.insert(\"x-upstream-specific\", HeaderValue::from_static(\"value2\"));\n        upstream_headers.insert(\"transfer-encoding\", HeaderValue::from_static(\"chunked\")); // Hop-by-hop\n        upstream_headers.insert(\"connection\", HeaderValue::from_static(\"close\")); // Hop-by-hop\n        upstream_headers.insert(\n            HeaderName::from_static(\"keep-alive\"),\n            HeaderValue::from_static(\"timeout=15\"),\n        ); // Hop-by-hop (case insensitive check needed)\n\n        let result_headers = build_response_headers(\u0026upstream_headers);\n\n        // Check standard headers are present\n        assert_eq!(result_headers.get(\"content-type\").unwrap(), \"text/plain\");\n        assert_eq!(result_headers.get(\"x-upstream-specific\").unwrap(), \"value2\");\n\n        // Check hop-by-hop are absent\n        assert!(result_headers.get(\"transfer-encoding\").is_none());\n        assert!(result_headers.get(\"connection\").is_none());\n        assert!(result_headers.get(\"keep-alive\").is_none());\n    }\n\n    #[test]\n    fn test_copy_non_hop_by_hop_headers_request() {\n        let mut source = HeaderMap::new();\n        source.insert(\"content-type\", HeaderValue::from_static(\"application/json\"));\n        source.insert(\"host\", HeaderValue::from_static(\"example.com\")); // Hop-by-hop\n        source.insert(\"authorization\", HeaderValue::from_static(\"Bearer old\")); // Hop-by-hop (for request)\n        source.insert(\"x-custom\", HeaderValue::from_static(\"custom\"));\n\n        let mut dest = HeaderMap::new();\n        copy_non_hop_by_hop_headers(\u0026source, \u0026mut dest, true); // is_request = true\n\n        assert!(dest.contains_key(\"content-type\"));\n        assert!(dest.contains_key(\"x-custom\"));\n        assert!(!dest.contains_key(\"host\"));\n        assert!(!dest.contains_key(\"authorization\")); // Should be filtered for request\n        assert_eq!(dest.len(), 2);\n    }\n\n    #[test]\n    fn test_copy_non_hop_by_hop_headers_response() {\n        let mut source = HeaderMap::new();\n        source.insert(\"content-type\", HeaderValue::from_static(\"application/json\"));\n        source.insert(\"transfer-encoding\", HeaderValue::from_static(\"chunked\")); // Hop-by-hop\n        source.insert(\"connection\", HeaderValue::from_static(\"close\")); // Hop-by-hop\n        source.insert(\"x-custom\", HeaderValue::from_static(\"custom\"));\n\n        let mut dest = HeaderMap::new();\n        copy_non_hop_by_hop_headers(\u0026source, \u0026mut dest, false); // is_request = false\n\n        assert!(dest.contains_key(\"content-type\"));\n        assert!(dest.contains_key(\"x-custom\"));\n        assert!(!dest.contains_key(\"transfer-encoding\"));\n        assert!(!dest.contains_key(\"connection\"));\n        assert_eq!(dest.len(), 2);\n    }\n}\n","traces":[{"line":48,"address":[11404816],"length":1,"stats":{"Line":2},"fn_name":"forward_request"},{"line":56,"address":[24602115],"length":1,"stats":{"Line":2},"fn_name":null},{"line":57,"address":[12652629,12652408],"length":1,"stats":{"Line":4},"fn_name":null},{"line":58,"address":[5863132],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[6701826],"length":1,"stats":{"Line":2},"fn_name":null},{"line":61,"address":[6702160],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[24745504,24745376,24745472,24745296,24745336,24745408],"length":1,"stats":{"Line":2},"fn_name":"clone"},{"line":63,"address":[14541485,14542066,14541350],"length":1,"stats":{"Line":4},"fn_name":null},{"line":67,"address":[14541869,14541950,14540686,14542144],"length":1,"stats":{"Line":4},"fn_name":null},{"line":68,"address":[11235101,11235177,11235580,11235328],"length":1,"stats":{"Line":7},"fn_name":null},{"line":70,"address":[24602692],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[11273690,11281467,11275851,11248581,11272512],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":73,"address":[11272566,11272689],"length":1,"stats":{"Line":2},"fn_name":null},{"line":74,"address":[11259560,11259481],"length":1,"stats":{"Line":2},"fn_name":null},{"line":75,"address":[6727997,6727927,6728028,6732841],"length":1,"stats":{"Line":2},"fn_name":null},{"line":76,"address":[11273121,11273224],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[6728328,6728404,6741695,6728932,6728748,6741561],"length":1,"stats":{"Line":3},"fn_name":null},{"line":78,"address":[11273814],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[14567273,14569966,14570444,14581081,14581215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[11259654,11274383,11274249,11264566],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[6727714,6743049,6734708,6743183],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[11281407],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[6703710,6703769],"length":1,"stats":{"Line":2},"fn_name":null},{"line":93,"address":[12654729],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[11249476,11288623,11248872,11288489],"length":1,"stats":{"Line":2},"fn_name":null},{"line":95,"address":[14543459,14545819,14545688],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[12654652],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[11235245],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[6706993,6706835],"length":1,"stats":{"Line":4},"fn_name":null},{"line":106,"address":[11623936],"length":1,"stats":{"Line":4},"fn_name":null},{"line":110,"address":[11275737,11239480,11275871,11239394,11240010],"length":1,"stats":{"Line":6},"fn_name":null},{"line":121,"address":[5873583,5869477],"length":1,"stats":{"Line":4},"fn_name":null},{"line":123,"address":[14551831,14551667,14551919,14552366,14552048,14551444],"length":1,"stats":{"Line":12},"fn_name":null},{"line":124,"address":[11257630,11257441,11257541,11257471,11258024],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[11244390],"length":1,"stats":{"Line":2},"fn_name":null},{"line":126,"address":[11244538],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[11623962],"length":1,"stats":{"Line":8},"fn_name":null},{"line":130,"address":[11245116,11245229],"length":1,"stats":{"Line":4},"fn_name":null},{"line":132,"address":[11258492],"length":1,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[14552661],"length":1,"stats":{"Line":2},"fn_name":null},{"line":134,"address":[14552782,14552715],"length":1,"stats":{"Line":4},"fn_name":null},{"line":136,"address":[12666104,12695369,12667854,12665184,12664598,12695503],"length":1,"stats":{"Line":4},"fn_name":null},{"line":138,"address":[12666065,12667815],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[12665105],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[11258520],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[11258552,11265832,11265773],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[6720861],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[11253109,11252596,11252655,11252531],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[12671764],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[6720971,6721381,6720906,6721030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[6721003],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[11252738,11252673,11252797,11253045],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[11252770],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[11252744,11252809,11252868,11253013],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[11266089],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[6721285,6721190,6721256],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[12672090],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[12672061],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[6721445],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[11290111,11266538,11267160,11266459,11289977],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[12672901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[12665159,12669277],"length":1,"stats":{"Line":4},"fn_name":null},{"line":186,"address":[11263405,11263460],"length":1,"stats":{"Line":4},"fn_name":null},{"line":190,"address":[5897536,5900486,5900492,5879644,5879790,5898004],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":192,"address":[12689687,12696361,12687518,12688893,12696495,12687862,12687439,12688006],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[6738028,6738822],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[5900276,5898136],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[6718797,6718711],"length":1,"stats":{"Line":4},"fn_name":null},{"line":204,"address":[11250578,11250632,11250805,11250525],"length":1,"stats":{"Line":6},"fn_name":null},{"line":206,"address":[11263856],"length":1,"stats":{"Line":2},"fn_name":null},{"line":207,"address":[12691168,12690384],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":208,"address":[11272034,11272321,11271278,11277721,11277855],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[14579459],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[14559622,14558426,14558633,14559592,14558565],"length":1,"stats":{"Line":2},"fn_name":null},{"line":214,"address":[11251450],"length":1,"stats":{"Line":2},"fn_name":null},{"line":220,"address":[12711696,12714270,12713248],"length":1,"stats":{"Line":3},"fn_name":"build_forward_headers"},{"line":221,"address":[5470004,5468559],"length":1,"stats":{"Line":6},"fn_name":null},{"line":222,"address":[12713715],"length":1,"stats":{"Line":3},"fn_name":null},{"line":223,"address":[14598470,14596679],"length":1,"stats":{"Line":3},"fn_name":null},{"line":224,"address":[11400882],"length":1,"stats":{"Line":3},"fn_name":null},{"line":230,"address":[5470672,5472168,5472810,5470951],"length":1,"stats":{"Line":3},"fn_name":"build_response_headers"},{"line":231,"address":[6821023,6822442],"length":1,"stats":{"Line":6},"fn_name":null},{"line":232,"address":[12716223],"length":1,"stats":{"Line":3},"fn_name":null},{"line":233,"address":[6822538],"length":1,"stats":{"Line":3},"fn_name":null},{"line":237,"address":[6811120,6814929,6817937],"length":1,"stats":{"Line":3},"fn_name":"copy_non_hop_by_hop_headers"},{"line":238,"address":[11392798,11391831,11391917],"length":1,"stats":{"Line":6},"fn_name":null},{"line":239,"address":[12705106],"length":1,"stats":{"Line":3},"fn_name":null},{"line":241,"address":[12705246,12705155],"length":1,"stats":{"Line":6},"fn_name":null},{"line":242,"address":[12708686,12705336],"length":1,"stats":{"Line":2},"fn_name":null},{"line":244,"address":[6814907,6811569,6811627,6811650],"length":1,"stats":{"Line":6},"fn_name":null},{"line":245,"address":[11278713,11278847],"length":1,"stats":{"Line":6},"fn_name":null},{"line":254,"address":[12718269,12724344,12716480],"length":1,"stats":{"Line":3},"fn_name":"add_auth_headers"},{"line":255,"address":[11417118,11419019],"length":1,"stats":{"Line":6},"fn_name":null},{"line":256,"address":[5475418,5475327,5473150],"length":1,"stats":{"Line":7},"fn_name":null},{"line":257,"address":[5475483],"length":1,"stats":{"Line":4},"fn_name":null},{"line":258,"address":[26894890],"length":1,"stats":{"Line":7},"fn_name":null},{"line":259,"address":[12719307,12719820],"length":1,"stats":{"Line":7},"fn_name":null},{"line":260,"address":[24592142],"length":1,"stats":{"Line":4},"fn_name":null},{"line":263,"address":[26894945],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[11410987],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[6828605],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":72,"coverable":101},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","state.rs"],"content":"// src/state.rs\n\nuse crate::config::AppConfig;\nuse crate::error::{AppError, ProxyConfigErrorData, ProxyConfigErrorKind, Result}; // Ensured Proxy types are imported\nuse crate::key_manager::KeyManager;\nuse reqwest::{Client, ClientBuilder, Proxy};\nuse std::collections::{HashMap, HashSet};\nuse std::path::{Path, PathBuf};\nuse std::sync::Arc;\nuse crate::admin::SystemInfoCollector;\nuse std::time::{Duration, Instant};\nuse tokio::sync::RwLock;\nuse tracing::Instrument;\nuse tracing::{debug, error, info, instrument, warn}; // Base tracing macros // Explicitly import the Instrument trait\n\nuse url::Url;\n/// Represents the shared application state that is accessible by all Axum handlers.\n#[derive(Debug)]\npub struct AppState {\n    pub key_manager: Arc\u003cRwLock\u003cKeyManager\u003e\u003e,\n    http_clients: Arc\u003cRwLock\u003cHashMap\u003cOption\u003cString\u003e, Arc\u003cClient\u003e\u003e\u003e\u003e,\n    pub start_time: Instant,\n    pub config: Arc\u003cRwLock\u003cAppConfig\u003e\u003e,\n    pub system_info: SystemInfoCollector,\n    pub config_path: PathBuf,\n}\n\nimpl AppState {\n    /// Creates a new `AppState`. Initializes KeyManager and pre-builds HTTP clients.\n    ///\n    /// # Errors\n    ///\n    /// Returns `Err` if:\n    /// - The base HTTP client (no proxy) fails to build, which is a fatal error.\n    /// - A proxy URL has a syntactically invalid format or an unsupported scheme.\n    /// - An unexpected I/O or other error occurs during client initialization.\n    #[instrument(level = \"info\", skip(config, config_path), fields(config.path = %config_path.display()))]\n    pub async fn new(config: \u0026AppConfig, config_path: \u0026Path) -\u003e Result\u003cSelf\u003e {\n        info!(\"Creating shared AppState: Initializing KeyManager and HTTP clients...\");\n        let key_manager = KeyManager::new(config, config_path).await; // KeyManager init logs its progress\n        let mut http_clients = HashMap::new();\n\n        // Determine connection pool size based on key count, with a minimum floor\n        let total_key_count: usize = config\n            .groups\n            .iter()\n            .flat_map(|g| \u0026g.api_keys)\n            .filter(|k| !k.trim().is_empty())\n            .count()\n            .max(10); // Ensure at least 10 connections possible even with few keys\n        debug!(\n            pool.max_idle_per_host = total_key_count,\n            \"Calculated max idle connections per host\"\n        );\n\n        // Centralized client configuration function\n        let configure_builder = |builder: ClientBuilder| -\u003e ClientBuilder {\n            builder\n                .connect_timeout(Duration::from_secs(10))\n                .timeout(Duration::from_secs(300)) // Overall request timeout\n                .pool_idle_timeout(Duration::from_secs(90)) // Keep idle connections open for 90s\n                .pool_max_idle_per_host(total_key_count) // Adjust pool size based on keys\n                .tcp_keepalive(Some(Duration::from_secs(60))) // Enable TCP keepalive\n                                                              // Add user-agent?\n                                                              // .user_agent(format!(\"gemini-proxy/{}\", env!(\"CARGO_PKG_VERSION\")))\n        };\n\n        // 1. Create the base client (no proxy) - this MUST succeed\n        let base_client_result = configure_builder(Client::builder()).build();\n        let base_client = match base_client_result {\n            Ok(client) =\u003e client,\n            Err(e) =\u003e {\n                // Structured error for base client failure - this is fatal\n                error!(error = ?e, \"Failed to build base HTTP client (no proxy). This is required. Exiting.\");\n                // Map error explicitly, including None proxy context\n                return Err(AppError::HttpClientBuildError {\n                    source: e,\n                    proxy_url: None,\n                });\n            }\n        };\n        http_clients.insert(None, Arc::new(base_client));\n        info!(client.type = \"base\", \"Base HTTP client (no proxy) created successfully.\");\n\n        // 2. Collect unique proxy URLs from the configuration\n        let unique_proxy_urls: HashSet\u003cString\u003e = config\n            .groups\n            .iter()\n            .filter_map(|g| g.proxy_url.as_ref()) // Get Option\u003c\u0026String\u003e\n            .filter(|url_str| !url_str.trim().is_empty()) // Filter out empty strings\n            .cloned() // Clone the String\n            .collect();\n        debug!(\n            proxy.count = unique_proxy_urls.len(),\n            ?unique_proxy_urls,\n            \"Found unique proxy URLs for client creation\"\n        );\n\n        // 3. Create clients for each unique proxy URL\n        for proxy_url_str in unique_proxy_urls {\n            // Create a span for each proxy client creation attempt\n            let proxy_span = tracing::info_span!(\"create_proxy_client\", proxy.url = %proxy_url_str);\n            let client_result: Result\u003cClient\u003e = async {\n                 // Parse URL first, map error to specific ProxyConfigErrorKind\n                 let parsed_proxy_url = Url::parse(\u0026proxy_url_str).map_err(|e| {\n                     // Structured error log for URL parsing\n                     error!(error = %e, \"Failed to parse proxy URL string.\");\n                     AppError::ProxyConfigError(ProxyConfigErrorData {\n                         url: proxy_url_str.clone(),\n                         kind: ProxyConfigErrorKind::UrlParse(e),\n                     })\n                 })?;\n\n                let scheme = parsed_proxy_url.scheme().to_lowercase();\n                debug!(proxy.scheme = %scheme, \"Parsed proxy scheme\");\n\n                 // Create proxy object, map errors to specific ProxyConfigErrorKind\n                 let proxy = match scheme.as_str() {\n                     \"http\" =\u003e Proxy::http(\u0026proxy_url_str).map_err(|e| {\n                         // Log error detail\n                         error!(error = %e, proxy.scheme = %scheme, \"Invalid HTTP proxy definition\");\n                         AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                         })\n                     }),\n                     \"https\" =\u003e Proxy::https(\u0026proxy_url_str).map_err(|e| {\n                          // Log error detail\n                          error!(error = %e, proxy.scheme = %scheme, \"Invalid HTTPS proxy definition\");\n                          AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                         })\n                     }),\n                     \"socks5\" =\u003e Proxy::all(\u0026proxy_url_str).map_err(|e| {\n                          // Log error detail\n                          error!(error = %e, proxy.scheme = %scheme, \"Invalid SOCKS5 proxy definition\");\n                          AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                         })\n                     }),\n                     _ =\u003e {\n                          // Log unsupported scheme error\n                          error!(proxy.scheme = %scheme, \"Unsupported proxy scheme\");\n                          Err(AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::UnsupportedScheme(scheme.to_string()),\n                         }))\n                     },\n                 }?;\n                 debug!(\"Proxy object created successfully\");\n\n                 // Build the client with the proxy\n                 configure_builder(Client::builder())\n                    .proxy(proxy)\n                    .build()\n                     // Map build error with proxy context\n                     .map_err(|e| {\n                         // Structured error log for client build failure\n                         error!(proxy.scheme = %scheme, error = ?e, \"Failed to build reqwest client for proxy.\");\n                         AppError::HttpClientBuildError { source: e, proxy_url: Some(proxy_url_str.clone()) }\n                     })\n            }.instrument(proxy_span).await; // Instrument the async block\n\n            // Handle the result of client creation\n            match client_result {\n                Ok(proxy_client) =\u003e {\n                    // Structured success log\n                    info!(proxy.url = %proxy_url_str, \"HTTP client created successfully for proxy.\");\n                    http_clients.insert(Some(proxy_url_str.clone()), Arc::new(proxy_client));\n                }\n                Err(e) =\u003e {\n                    // Log errors based on their type, ensuring proxy_url is included\n                    match e {\n                        AppError::ProxyConfigError(_) =\u003e {\n                            // Already logged within the async block, re-log as critical error for AppState\n                            error!(proxy.url = %proxy_url_str, error = ?e, \"Critical proxy configuration error. Aborting AppState creation.\");\n                            return Err(e); // Fail fast on config errors\n                        }\n                        AppError::HttpClientBuildError {\n                            ref source,\n                            proxy_url: Some(ref url),\n                        } =\u003e {\n                            // Match specific error\n                            // Already logged within the async block, re-log as warning for skipping\n                            warn!(proxy.url = %url, error = ?source, \"Skipping client creation for this proxy due to build error. Groups using this proxy might fail.\");\n                            // Log and continue for build errors\n                        }\n                        _ =\u003e {\n                            // Catch-all for unexpected errors during creation for this proxy\n                            error!(proxy.url = %proxy_url_str, error = ?e, \"Unexpected error during proxy client creation. Aborting AppState creation.\");\n                            return Err(e); // Fail on other unexpected errors\n                        }\n                    }\n                }\n            }\n        }\n\n        // Log final client count\n        info!(\n            client.count = http_clients.len(),\n            \"Finished initializing HTTP clients.\"\n        );\n\n        Ok(Self {\n            key_manager: Arc::new(RwLock::new(key_manager)),\n            http_clients: Arc::new(RwLock::new(http_clients)),\n            start_time: Instant::now(),\n            config: Arc::new(RwLock::new(config.clone())),\n            system_info: SystemInfoCollector::new(),\n            config_path: config_path.to_path_buf(),\n        })\n    }\n/// Reloads the `KeyManager` from the current configuration within `AppState`.\n    /// Reloads the `KeyManager` and `http_clients` from the current configuration.\n    /// This allows for hot-reloading of API keys and proxy configurations without restarting the server.\n    ///\n    /// # Errors\n    ///\n    /// Returns `Err` if any part of the state reconstruction fails.\n    #[instrument(level = \"info\", skip(self))]\n    pub async fn reload_state_from_config(\u0026self) -\u003e Result\u003c()\u003e {\n        info!(\"Attempting to reload full application state (KeyManager, HttpClients) from configuration...\");\n        let config_guard = self.config.read().await;\n    \n        // --- Create new KeyManager ---\n        let new_key_manager = KeyManager::new(\u0026config_guard, \u0026self.config_path).await;\n    \n        // --- Create new HttpClients (logic identical to AppState::new) ---\n        let mut new_http_clients = HashMap::new();\n        let total_key_count: usize = config_guard.groups.iter().flat_map(|g| \u0026g.api_keys).filter(|k| !k.trim().is_empty()).count().max(10);\n    \n        let configure_builder = |builder: ClientBuilder| -\u003e ClientBuilder {\n            builder\n                .connect_timeout(Duration::from_secs(10))\n                .timeout(Duration::from_secs(300))\n                .pool_idle_timeout(Duration::from_secs(90))\n                .pool_max_idle_per_host(total_key_count)\n                .tcp_keepalive(Some(Duration::from_secs(60)))\n        };\n    \n        let base_client = configure_builder(Client::builder()).build().map_err(|e| {\n            error!(error = ?e, \"Failed to build base HTTP client during reload. This is a critical error.\");\n            AppError::HttpClientBuildError { source: e, proxy_url: None }\n        })?;\n        new_http_clients.insert(None, Arc::new(base_client));\n    \n        let unique_proxy_urls: HashSet\u003cString\u003e = config_guard.groups.iter().filter_map(|g| g.proxy_url.as_ref()).filter(|url_str| !url_str.trim().is_empty()).cloned().collect();\n    \n        for proxy_url_str in unique_proxy_urls {\n            let proxy_span = tracing::info_span!(\"create_proxy_client_reload\", proxy.url = %proxy_url_str);\n            let client_result: Result\u003cClient\u003e = async {\n                let parsed_proxy_url = Url::parse(\u0026proxy_url_str).map_err(|e| {\n                    AppError::ProxyConfigError(ProxyConfigErrorData {\n                        url: proxy_url_str.clone(),\n                        kind: ProxyConfigErrorKind::UrlParse(e),\n                    })\n                })?;\n                let scheme = parsed_proxy_url.scheme().to_lowercase();\n                let proxy = match scheme.as_str() {\n                    \"http\" =\u003e Proxy::http(\u0026proxy_url_str),\n                    \"https\" =\u003e Proxy::https(\u0026proxy_url_str),\n                    \"socks5\" =\u003e Proxy::all(\u0026proxy_url_str),\n                    _ =\u003e return Err(AppError::ProxyConfigError(ProxyConfigErrorData {\n                        url: proxy_url_str.clone(),\n                        kind: ProxyConfigErrorKind::UnsupportedScheme(scheme),\n                    })),\n                }.map_err(|e| AppError::ProxyConfigError(ProxyConfigErrorData {\n                    url: proxy_url_str.clone(),\n                    kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                }))?;\n    \n                configure_builder(Client::builder())\n                    .proxy(proxy)\n                    .build()\n                    .map_err(|e| AppError::HttpClientBuildError {\n                        source: e,\n                        proxy_url: Some(proxy_url_str.clone()),\n                    })\n            }.instrument(proxy_span).await;\n    \n            match client_result {\n                Ok(proxy_client) =\u003e {\n                    info!(proxy.url = %proxy_url_str, \"HTTP client recreated successfully during reload.\");\n                    new_http_clients.insert(Some(proxy_url_str.clone()), Arc::new(proxy_client));\n                }\n                Err(e) =\u003e {\n                    warn!(proxy.url = %proxy_url_str, error = ?e, \"Failed to recreate client for proxy during reload. Groups using this proxy may fail.\");\n                }\n            }\n        }\n    \n        drop(config_guard);\n    \n        *self.key_manager.write().await = new_key_manager;\n        *self.http_clients.write().await = new_http_clients;\n    \n        info!(\"Application state (KeyManager, HttpClients) reloaded successfully.\");\n        Ok(())\n    }\n\n    /// Returns a reference to the appropriate HTTP client.\n    ///\n    /// # Errors\n    ///\n    /// Returns an `AppError::Internal` if the requested client (identified by the `proxy_url` Option)\n    /// was not found in the pre-built client map. This indicates a logic error, as all required\n    /// clients should have been initialized at startup.\n    #[instrument(level = \"debug\", skip(self), fields(proxy.url = ?proxy_url))]\n    pub async fn get_client(\u0026self, proxy_url: Option\u003c\u0026str\u003e) -\u003e Result\u003cArc\u003cClient\u003e\u003e {\n        let clients_guard = self.http_clients.read().await;\n        let key = proxy_url.map(String::from);\n        \n        clients_guard.get(\u0026key).cloned().ok_or_else(|| {\n            let msg = proxy_url.map_or_else(\n                || \"Requested base HTTP client (None proxy) was unexpectedly missing.\".to_string(),\n                |p_url| format!(\"Requested HTTP client for proxy '{p_url}' was not found/initialized in AppState.\"),\n            );\n            error!(proxy.url = ?proxy_url, error.message = %msg, \"HTTP client lookup failed\");\n            AppError::Internal(msg)\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::{KeyGroup, ServerConfig};\n    use crate::error::ProxyConfigErrorKind; // Import the kind enum for tests\n    use std::fs::File;\n    use tempfile::tempdir;\n    use tracing::warn; // Import warn for logging in tests specifically\n\n    const DEFAULT_TARGET_URL_STR: \u0026str = \"https://generativelanguage.googleapis.com\";\n\n    fn create_test_state_config(groups: Vec\u003cKeyGroup\u003e) -\u003e AppConfig {\n        AppConfig {\n            server: ServerConfig {\n                port: 8080,\n                top_p: None,\n                admin_token: None,\n            },\n            groups,\n            rate_limit_behavior: Default::default(),\n            internal_retries: 2,\n            temporary_block_minutes: 5,\n        }\n    }\n\n    fn create_dummy_config_path(dir: \u0026tempfile::TempDir) -\u003e std::path::PathBuf {\n        let file_path = dir.path().join(\"dummy_config.yaml\");\n        File::create(\u0026file_path).expect(\"Failed to create dummy config file\");\n        file_path\n    }\n\n        #[tokio::test]\n        async fn test_appstate_new_no_proxies() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"key1\".to_string()],\n            proxy_url: None,\n            target_url: DEFAULT_TARGET_URL_STR.to_string(),\n            top_p: None,\n        }];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        assert!(state_result.is_ok());\n        let state = state_result.unwrap();\n        let clients_guard = state.http_clients.read().await;\n        assert_eq!(clients_guard.len(), 1);\n        assert!(clients_guard.contains_key(\u0026None)); // Base client only\n        drop(clients_guard);\n\n        assert!(state.get_client(None).await.is_ok());\n        assert!(state\n            .get_client(Some(\"http://nonexistent.proxy\"))\n            .await\n            .is_err());\n    }\n    #[tokio::test]\n    async fn test_appstate_new_with_valid_proxies() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        // Mock server or use potentially invalid ports to test resilience\n        let http_proxy_url = \"http://127.0.0.1:34567\"; // Use a likely free port\n        let socks_proxy_url = \"socks5://127.0.0.1:34568\"; // Use a likely free port\n\n        let groups = vec![\n            KeyGroup {\n                name: \"g_http\".to_string(),\n                api_keys: vec![\"key_http\".to_string()],\n                proxy_url: Some(http_proxy_url.to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g_socks\".to_string(),\n                api_keys: vec![\"key_socks\".to_string()],\n                proxy_url: Some(socks_proxy_url.to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                // Same HTTP proxy, should reuse client map entry\n                name: \"g_http_dup\".to_string(),\n                api_keys: vec![\"key_http2\".to_string()],\n                proxy_url: Some(http_proxy_url.to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g_no_proxy\".to_string(),\n                api_keys: vec![\"key_none\".to_string()],\n                proxy_url: None,\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n        ];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        // AppState::new should succeed even if proxy servers aren't actually running\n        assert!(\n            state_result.is_ok(),\n            \"AppState::new failed unexpectedly: {:?}\",\n            state_result.err()\n        );\n        let state = state_result.unwrap();\n        let clients_guard = state.http_clients.read().await;\n\n        assert!(clients_guard.contains_key(\u0026None)); // Base client must exist\n\n        let http_key = Some(http_proxy_url.to_string());\n        let socks_key = Some(socks_proxy_url.to_string());\n\n        let http_created = clients_guard.contains_key(\u0026http_key);\n        let socks_created = clients_guard.contains_key(\u0026socks_key);\n\n        // We expect all clients to be created successfully if URLs are valid syntactically\n        assert!(http_created, \"HTTP proxy client was not created\");\n        assert!(socks_created, \"SOCKS5 proxy client was not created\");\n        assert_eq!(\n            clients_guard.len(),\n            3,\n            \"Expected Base + HTTP + SOCKS clients\"\n        ); // 1 base + 2 unique proxies\n        drop(clients_guard);\n\n        // Verify get_client behavior\n        assert!(\n            state.get_client(http_key.as_deref()).await.is_ok(),\n            \"get_client failed for created HTTP proxy\"\n        );\n        assert!(\n            state.get_client(socks_key.as_deref()).await.is_ok(),\n            \"get_client failed for created SOCKS5 proxy\"\n        );\n        assert!(state.get_client(None).await.is_ok()); // Check base client retrieval\n        assert!(state.get_client(Some(\"http://other.proxy\")).await.is_err()); // Check non-existent proxy\n    }\n\n    #[tokio::test]\n    async fn test_appstate_new_returns_err_on_invalid_url_syntax() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![KeyGroup {\n            name: \"g_invalid_url\".to_string(),\n            api_keys: vec![\"key_invalid\".to_string()],\n            proxy_url: Some(\"::not a proxy url::\".to_string()), // Invalid syntax\n            target_url: DEFAULT_TARGET_URL_STR.to_string(),\n            top_p: None,\n        }];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        assert!(\n            state_result.is_err(),\n            \"AppState::new should return Err for invalid proxy URL syntax\"\n        );\n        // Check for the correct error variant and kind\n        assert!(\n            matches!(state_result.as_ref().err().unwrap(), AppError::ProxyConfigError(data) if matches!(data.kind, ProxyConfigErrorKind::UrlParse(_))),\n            \"Expected ProxyConfigError with UrlParse kind\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_appstate_new_returns_err_on_unsupported_scheme() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![KeyGroup {\n            name: \"g_unsupported\".to_string(),\n            api_keys: vec![\"key_unsupported\".to_string()],\n            proxy_url: Some(\"ftp://unsupported.proxy\".to_string()), // Unsupported scheme\n            target_url: DEFAULT_TARGET_URL_STR.to_string(),\n            top_p: None,\n        }];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        assert!(\n            state_result.is_err(),\n            \"AppState::new should return Err for unsupported proxy scheme\"\n        );\n        // Check for the correct error variant and kind\n        assert!(\n            matches!(state_result.as_ref().err().unwrap(), AppError::ProxyConfigError(data) if matches!(data.kind, ProxyConfigErrorKind::UnsupportedScheme(_))),\n            \"Expected ProxyConfigError with UnsupportedScheme kind\"\n        );\n    }\n\n    // Test where Client::build() itself might fail (less common, requires specific setup or invalid proxy def)\n    // This test might be flaky depending on environment/reqwest version behavior\n    #[tokio::test]\n    async fn test_appstate_new_skips_client_on_build_error() {\n        // This test simulates a reqwest build failure for one proxy,\n        // but AppState creation should still succeed with other valid clients.\n        // We use a syntactically valid but likely non-functional SOCKS5 URL.\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![\n            KeyGroup {\n                // Valid HTTP\n                name: \"g_http_ok\".to_string(),\n                api_keys: vec![\"k1\".to_string()],\n                proxy_url: Some(\"http://127.0.0.1:34569\".to_string()), // Likely free port\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            // Use a socks URL that might cause build issues or is hard to resolve\n            KeyGroup {\n                name: \"g_socks_fail_build\".to_string(),\n                api_keys: vec![\"k2\".to_string()],\n                // Provide a URL that might fail build if socks feature isn't compiled correctly or has issues\n                proxy_url: Some(\"socks5://invalid-host-that-causes-build-error:1080\".to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n        ];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        // Check the result: AppState::new should either succeed (skipping the build error)\n        // or return a ProxyConfigError if the test URL caused a definition error.\n        match state_result {\n            Ok(state) =\u003e {\n                let clients_guard = state.http_clients.read().await;\n                assert!(clients_guard.contains_key(\u0026None)); // Base client\n                let http_key = Some(\"http://127.0.0.1:34569\".to_string());\n                let socks_key = Some(\"socks5://invalid-host-that-causes-build-error:1080\".to_string());\n                let http_created = clients_guard.contains_key(\u0026http_key);\n                let socks_created = clients_guard.contains_key(\u0026socks_key);\n                assert!(http_created, \"Valid HTTP client should have been created\");\n                \n                let expected_clients = 1 + (if http_created { 1 } else { 0 }) + (if socks_created { 1 } else { 0 });\n                assert_eq!(clients_guard.len(), expected_clients, \"Unexpected number of clients created\");\n                drop(clients_guard);\n\n                assert!(state.get_client(http_key.as_deref()).await.is_ok());\n                if socks_created {\n                    assert!(state.get_client(socks_key.as_deref()).await.is_ok());\n                    warn!(\"SOCKS client build succeeded unexpectedly in test - test might not cover build failure path\");\n                } else {\n                    assert!(state.get_client(socks_key.as_deref()).await.is_err());\n                }\n            }\n            Err(AppError::ProxyConfigError(data)) =\u003e {\n                // If the \"invalid\" URL actually caused a config error (likely InvalidDefinition), this is an acceptable outcome.\n                warn!(error=?data, \"Test URL caused ProxyConfigError instead of HttpClientBuildError. Treating as acceptable test outcome.\");\n                assert_eq!(data.url, \"socks5://invalid-host-that-causes-build-error:1080\");\n            }\n            Err(e) =\u003e {\n                // Any other error type is unexpected and should fail the test\n                panic!(\"AppState::new failed with unexpected error type: {:?}\", e);\n            }\n        }\n\n\n    }\n} // end tests module\n","traces":[{"line":38,"address":[13904746,13902396,13905691,13902304,13902571,13902647,13903894],"length":1,"stats":{"Line":25},"fn_name":"{async_fn#0}"},{"line":39,"address":[11765520,11766199,11819913,11765669,11820047],"length":1,"stats":{"Line":15},"fn_name":null},{"line":40,"address":[5583918,5581930,5584014,5582493],"length":1,"stats":{"Line":15},"fn_name":null},{"line":41,"address":[5380542],"length":1,"stats":{"Line":5},"fn_name":null},{"line":44,"address":[5380752,5380631],"length":1,"stats":{"Line":10},"fn_name":null},{"line":47,"address":[5408621,5408608],"length":1,"stats":{"Line":10},"fn_name":"{closure#0}"},{"line":48,"address":[11534432,11534446],"length":1,"stats":{"Line":10},"fn_name":"{closure#1}"},{"line":51,"address":[5636249,5584681,5636383,5585264],"length":1,"stats":{"Line":10},"fn_name":null},{"line":57,"address":[5408704,5409381,5381448,5409352],"length":1,"stats":{"Line":10},"fn_name":"{closure#2}"},{"line":58,"address":[11796732,11796187,11796564,11796320,11796442,11796618],"length":1,"stats":{"Line":30},"fn_name":null},{"line":59,"address":[11809603,11809502,11810113],"length":1,"stats":{"Line":10},"fn_name":null},{"line":60,"address":[11796477,11796376,11796846],"length":1,"stats":{"Line":10},"fn_name":null},{"line":61,"address":[5612514,5612616,5612835],"length":1,"stats":{"Line":10},"fn_name":null},{"line":62,"address":[11796612,11796640],"length":1,"stats":{"Line":10},"fn_name":null},{"line":63,"address":[11535157,11535005,11535128],"length":1,"stats":{"Line":10},"fn_name":null},{"line":69,"address":[11782161,11783940],"length":1,"stats":{"Line":10},"fn_name":null},{"line":70,"address":[5587109],"length":1,"stats":{"Line":5},"fn_name":null},{"line":71,"address":[11509244],"length":1,"stats":{"Line":5},"fn_name":null},{"line":72,"address":[5587130],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[11821039,11777318,11776683,11770861,11820905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[11790432],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[11790406],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[11790414],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[13916834,13911155,13911222],"length":1,"stats":{"Line":5},"fn_name":null},{"line":83,"address":[11559753,11510028,11559887,11509469],"length":1,"stats":{"Line":10},"fn_name":null},{"line":86,"address":[5589681,5587904],"length":1,"stats":{"Line":10},"fn_name":null},{"line":89,"address":[11796896,11796921],"length":1,"stats":{"Line":10},"fn_name":"{closure#3}"},{"line":90,"address":[5409504,5409518],"length":1,"stats":{"Line":2},"fn_name":"{closure#4}"},{"line":93,"address":[5637737,5637871,5589957,5592305,5589874,5590530,5591461],"length":1,"stats":{"Line":15},"fn_name":null},{"line":94,"address":[5387715,5388563],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[13916762,13914417,13928425,13916795],"length":1,"stats":{"Line":20},"fn_name":null},{"line":102,"address":[11805976,11801513,11804815],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[11797008,11797077,11793129,11805705,11797184,11797162,11779322,11792586,11792682,11803087],"length":1,"stats":{"Line":6},"fn_name":"{async_block#5}"},{"line":105,"address":[11535780,11535607,11544881,11544096,11535472,11544055],"length":1,"stats":{"Line":5},"fn_name":"{closure#0}"},{"line":107,"address":[5621676,5622716,5638233,5622433,5638367],"length":1,"stats":{"Line":2},"fn_name":null},{"line":108,"address":[5419231],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[11544980],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[13946892],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[13937988,13937905],"length":1,"stats":{"Line":2},"fn_name":null},{"line":115,"address":[13963263,13938007,13938596,13938083,13963129],"length":1,"stats":{"Line":3},"fn_name":null},{"line":118,"address":[5410883,5415617,5415803,5415895,5412730],"length":1,"stats":{"Line":5},"fn_name":null},{"line":119,"address":[11538544,11549083,11541544,11546048,11549089,11538625,11546516],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":121,"address":[11807743,11807822,11808310,11808166,11823519,11823385],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[11548923],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[11546632],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[5422996,5423075],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[11813609,11824000,11824468,11827035,11816389,11827041,11813495,11813561],"length":1,"stats":{"Line":2},"fn_name":"{closure#2}"},{"line":129,"address":[11549230,11549574,11549151,11562233,11549718,11562367],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[13953867],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[11549688],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[11813492,11813571],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[5632691,5616307,5632697,5616403,5619041,5629680,5630148,5616369],"length":1,"stats":{"Line":4},"fn_name":"{closure#3}"},{"line":137,"address":[5630150,5640217,5640351,5630294,5629727,5629806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[11555035],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[11827640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[11554900,11554979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[11813655,11814235,11838121,11838255,11813723],"length":1,"stats":{"Line":3},"fn_name":null},{"line":146,"address":[11541229],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[13941187],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[13943061,13942990],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[11563855,11541896,11541820,11563721,11542417],"length":1,"stats":{"Line":3},"fn_name":null},{"line":155,"address":[11542368,11543783,11543701,11543860],"length":1,"stats":{"Line":4},"fn_name":null},{"line":156,"address":[11543735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[5429424,5432378,5429905,5418057,5432384],"length":1,"stats":{"Line":1},"fn_name":"{closure#4}"},{"line":161,"address":[5429471,5429563,5430075,5438425,5429907,5438559],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[11555813,11557993],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[7142980],"length":1,"stats":{"Line":8},"fn_name":null},{"line":167,"address":[11792711],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[11518000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[11779748,11780281,11826495,11779672,11826361],"length":1,"stats":{"Line":3},"fn_name":null},{"line":171,"address":[11520689,11520410,11520520,11518572],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[5595704],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[13919808,13922690],"length":1,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[11826857,11782544,11782422,11783102,11826991],"length":1,"stats":{"Line":3},"fn_name":null},{"line":179,"address":[11796264],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[11798605],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[11827353,11785389,11785925,11827487],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[11806980,11795639,11806422,11841097,11841231],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[11531998],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[11788912,11790469,11828479,11788308,11789851,11828345],"length":1,"stats":{"Line":11},"fn_name":null},{"line":202,"address":[5605901,5606515],"length":1,"stats":{"Line":1},"fn_name":null},{"line":206,"address":[5607352],"length":1,"stats":{"Line":5},"fn_name":null},{"line":207,"address":[11790692,11788815],"length":1,"stats":{"Line":10},"fn_name":null},{"line":208,"address":[11803983,11804129],"length":1,"stats":{"Line":10},"fn_name":null},{"line":209,"address":[13931164],"length":1,"stats":{"Line":5},"fn_name":null},{"line":210,"address":[11804272],"length":1,"stats":{"Line":5},"fn_name":null},{"line":211,"address":[11791131],"length":1,"stats":{"Line":5},"fn_name":null},{"line":212,"address":[11804442],"length":1,"stats":{"Line":5},"fn_name":null},{"line":223,"address":[10250576,10250584],"length":1,"stats":{"Line":5},"fn_name":null},{"line":224,"address":[5669791,5647264,5647995,5669657,5647479],"length":1,"stats":{"Line":3},"fn_name":null},{"line":225,"address":[11571926,11569885,11572065,11570511],"length":1,"stats":{"Line":2},"fn_name":null},{"line":228,"address":[5446674,5446577,5444114,5446855],"length":1,"stats":{"Line":3},"fn_name":null},{"line":231,"address":[11572951],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[13988256,13975033,13988269,13974928,13988288,13988302],"length":1,"stats":{"Line":6},"fn_name":"{closure#0}"},{"line":234,"address":[11587112,11587141,11573377,11586464],"length":1,"stats":{"Line":2},"fn_name":"{closure#2}"},{"line":235,"address":[11861834,11861780,11861403,11861536,11861948,11861658],"length":1,"stats":{"Line":6},"fn_name":null},{"line":236,"address":[13988462,13988563,13989073],"length":1,"stats":{"Line":2},"fn_name":null},{"line":237,"address":[11848814,11848344,11848445],"length":1,"stats":{"Line":2},"fn_name":null},{"line":238,"address":[13988812,13989035,13988706],"length":1,"stats":{"Line":2},"fn_name":null},{"line":239,"address":[13988848,13988820],"length":1,"stats":{"Line":2},"fn_name":null},{"line":240,"address":[11861992,11861869,11862021],"length":1,"stats":{"Line":2},"fn_name":null},{"line":243,"address":[5650754,5651096,5650873,5666601,5664256,5664708,5666595],"length":1,"stats":{"Line":2},"fn_name":"{closure#3}"},{"line":244,"address":[11849535,11854825,11849318,11854959,11848974,11848895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[13989688],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[11835570,11836128,11835480],"length":1,"stats":{"Line":1},"fn_name":null},{"line":249,"address":[11589625,11589662,11574105,11589600,11589648],"length":1,"stats":{"Line":3},"fn_name":"{closure#4}"},{"line":251,"address":[13976329,13982639,13976269],"length":1,"stats":{"Line":3},"fn_name":null},{"line":252,"address":[5455432,5456593,5455039],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[5666736,5666905,5668855,5666790,5668793,5659946,5659415,5666883,5652173,5659535],"length":1,"stats":{"Line":0},"fn_name":"{async_block#6}"},{"line":254,"address":[11589809,11591870,11590125,11591904,11589952],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":255,"address":[11853621],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[5668931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[11866860],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[5464649,5464570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[11590555,11591166,11591819,11590476,11591285,11591135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[11590571,11591164,11590637],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[11590713,11590614,11590674,11591162],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[5464994,5464898,5464958,5465330],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[11590931],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[5464964],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[5667819],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[11867295,11867180,11867301,11866976,11866020],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":270,"address":[13993994],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[11867130,11867064],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[11591510,11591400,11591664,11591589],"length":1,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[5465749],"length":1,"stats":{"Line":0},"fn_name":null},{"line":277,"address":[5669582,5669588,5668637,5669408,5669528],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":278,"address":[11592455],"length":1,"stats":{"Line":0},"fn_name":null},{"line":279,"address":[5669436,5669498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[11569927,11590379,11590493,11574734,11591095,11591436,11574973,11591683,11591824,11582759,11582291,11591745,11582819,11574700],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[11575050],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[13977070],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[5652542,5652466,5653075,5670649,5670783],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[11577871,11575754,11577592,11577702],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[11836735],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[11836799,11839624,11855817,11840125,11855951],"length":1,"stats":{"Line":0},"fn_name":null},{"line":294,"address":[11855770],"length":1,"stats":{"Line":1},"fn_name":null},{"line":296,"address":[5520477,5520539,5519967],"length":1,"stats":{"Line":1},"fn_name":null},{"line":297,"address":[11845430,11845689,11847822,11831617,11845152,11845034,11845767,11845842],"length":1,"stats":{"Line":1},"fn_name":null},{"line":299,"address":[5662028,5671775,5671641,5661431],"length":1,"stats":{"Line":2},"fn_name":null},{"line":300,"address":[5459070],"length":1,"stats":{"Line":1},"fn_name":null},{"line":311,"address":[11595302,11595151,11595378,11595104,11596728,11597931],"length":1,"stats":{"Line":16},"fn_name":"{async_fn#0}"},{"line":312,"address":[5473093,5473207,5473148,5473325],"length":1,"stats":{"Line":8},"fn_name":null},{"line":313,"address":[11861003],"length":1,"stats":{"Line":4},"fn_name":null},{"line":315,"address":[11877537,11874464,11874672,11874394,11875156,11874324,11877531],"length":1,"stats":{"Line":13},"fn_name":"{closure#0}"},{"line":316,"address":[11861455],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[11864316,11864304],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":318,"address":[5476939,5476912],"length":1,"stats":{"Line":2},"fn_name":"{closure#1}"},{"line":320,"address":[5474126,5474047,5474470,5477113,5477247,5474705],"length":1,"stats":{"Line":3},"fn_name":null},{"line":321,"address":[5474600],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":94,"coverable":150},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","admin_integration_tests.rs"],"content":"// tests/admin_integration_tests.rs\n\nuse axum::{\n    body::Body,\n    http::{header, HeaderMap, Method, Request, StatusCode},\n};\nuse gemini_proxy_key_rotation_rust::{\n    admin::{CsrfTokenResponse, KeysUpdateRequest},\n    config::{AppConfig, KeyGroup},\n    run,\n};\nuse http_body_util::BodyExt;\nuse md5;\nuse serde_json::json;\nuse tempfile::TempDir;\nuse std::sync::Once;\nuse tower::util::ServiceExt;\nuse wiremock::{\n    matchers::{method, path},\n    Mock, MockServer, ResponseTemplate,\n};\nuse tracing_subscriber::{fmt, layer::SubscriberExt, util::SubscriberInitExt, EnvFilter};\n\nstatic TRACING_INIT: Once = Once::new();\n\n/// Initializes the tracing subscriber for tests, ensuring it only runs once.\nfn ensure_tracing_initialized() {\n    TRACING_INIT.call_once(|| {\n        let env_filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\"));\n        let json_layer = fmt::layer()\n            .json()\n            .with_current_span(true)\n            .with_span_list(true);\n        tracing_subscriber::registry()\n            .with(env_filter)\n            .with(json_layer)\n            .init();\n    });\n}\n\n\n// Helper structure to manage the test application state\nstruct TestApp {\n    router: axum::Router,\n    // _state: Arc\u003cAppState\u003e, // Keep state alive\n    _temp_dir: TempDir,   // Keep temp dir alive\n    auth_cookie: Option\u003cString\u003e,\n    csrf_token: Option\u003cString\u003e,\n    csrf_cookie: Option\u003cString\u003e,\n}\n\nimpl TestApp {\n    async fn new(config: AppConfig) -\u003e Self {\n        ensure_tracing_initialized();\n        let temp_dir = tempfile::tempdir().unwrap();\n        // Define paths for config and state files within the temp directory\n        let config_file_path = temp_dir.path().join(\"config.yaml\");\n        let state_file_path = temp_dir.path().join(\"key_states.json\");\n\n        // Save the provided config to a temporary file\n        let config_str = serde_yaml::to_string(\u0026config).unwrap();\n        tokio::fs::write(\u0026config_file_path, \u0026config_str)\n            .await\n            .unwrap();\n        \n        // Also create an empty key_states.json file\n        tokio::fs::write(state_file_path, \"{}\")\n            .await\n            .unwrap();\n\n\n        // The `run` function now returns a router and config, which is ideal for testing.\n        let (router, _config) = run(Some(config_file_path.clone()))\n            .await\n            .expect(\"Failed to create test router\");\n\n        TestApp {\n            router,\n            // _state: state,\n            _temp_dir: temp_dir,\n            auth_cookie: None,\n            csrf_token: None,\n            csrf_cookie: None,\n        }\n    }\n\n    /// Logs in to the application and stores the auth cookie.\n    async fn login(\u0026mut self, token: \u0026str) {\n        let response = self\n            .router\n            .clone()\n            .oneshot(\n                Request::builder()\n                    .method(\"POST\")\n                    .uri(\"/admin/login\")\n                    .header(\"Content-Type\", \"application/json\")\n                    .body(Body::from(format!(r#\"{{\"token\": \"{}\"}}\"#, token)))\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n        let cookie = response.headers().get(\"set-cookie\").unwrap().to_str().unwrap();\n        self.auth_cookie = Some(cookie.to_string());\n    }\n\n    /// Gets a CSRF token and stores it.\n    async fn get_csrf_token(\u0026mut self) {\n        let response = self\n            .router\n            .clone()\n            .oneshot(\n                Request::builder()\n                    .uri(\"/admin/csrf-token\")\n                    .header(header::COOKIE, self.auth_cookie.as_ref().unwrap())\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n        \n        assert_eq!(response.status(), StatusCode::OK);\n        let csrf_cookie = response.headers().get(\"set-cookie\").unwrap().to_str().unwrap();\n        self.csrf_cookie = Some(csrf_cookie.to_string());\n\n        let body = response.into_body().collect().await.unwrap().to_bytes();\n        let csrf_response: CsrfTokenResponse = serde_json::from_slice(\u0026body).unwrap();\n        self.csrf_token = Some(csrf_response.csrf_token);\n    }\n\n    /// Sends a request with authentication and CSRF headers.\n    async fn authed_request(\n        \u0026self,\n        method: Method,\n        uri: \u0026str,\n        body: Body,\n    ) -\u003e axum::response::Response {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            header::COOKIE,\n            format!(\n                \"{}; {}\",\n                self.auth_cookie.as_ref().unwrap(),\n                self.csrf_cookie.as_ref().unwrap()\n            )\n            .parse()\n            .unwrap(),\n        );\n        headers.insert(\n            \"x-csrf-token\",\n            self.csrf_token.as_ref().unwrap().parse().unwrap(),\n        );\n        headers.insert(\"Content-Type\", \"application/json\".parse().unwrap());\n\n        self.router\n            .clone()\n            .oneshot(\n                Request::builder()\n                    .method(method)\n                    .uri(uri)\n                    .header(\"Content-Type\", \"application/json\")\n                    .header(header::COOKIE, format!(\"{}; {}\", self.auth_cookie.as_ref().unwrap(), self.csrf_cookie.as_ref().unwrap()))\n                    .header(\"x-csrf-token\", self.csrf_token.as_ref().unwrap())\n                    .body(body)\n                    .unwrap(),\n            )\n            .await\n            .unwrap()\n    }\n}\n\nfn get_default_config() -\u003e AppConfig {\n    let mut config = AppConfig::default();\n    config.server.admin_token = Some(\"secret_admin_token\".to_string());\n    config.groups = vec![KeyGroup {\n        name: \"default\".to_string(),\n        api_keys: vec![\"key1\".to_string()],\n        ..Default::default()\n    }];\n    config\n}\n\n\n#[tokio::test]\nasync fn test_detailed_health_ok() {\n    let config = get_default_config();\n    let app = TestApp::new(config).await;\n\n    let response = app\n        .router\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/health\")\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_login_and_get_config_success() {\n    let config = get_default_config();\n    let mut app = TestApp::new(config.clone()).await;\n\n    // 1. Login\n    app.login(\"secret_admin_token\").await;\n    assert!(app.auth_cookie.is_some());\n\n    // 2. Get config (doesn't require CSRF)\n    let response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    assert_eq!(response.status(), StatusCode::OK);\n    let body = response.into_body().collect().await.unwrap().to_bytes();\n    let received_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n    \n    // Just check one field to confirm it's the right config\n    assert_eq!(received_config.server.admin_token, config.server.admin_token);\n}\n\n\n#[tokio::test]\nasync fn test_add_keys_unauthorized() {\n    let config = get_default_config();\n    let app = TestApp::new(config).await;\n\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"new_key\".to_string()],\n    }).unwrap());\n\n    let response = app\n        .router\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/admin/keys\")\n                .header(\"Content-Type\", \"application/json\")\n                .body(body)\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    // Unauthorized because no auth cookie/token\n    // It's a CSRF failure, which results in FORBIDDEN\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_add_keys_no_csrf() {\n    let config = get_default_config();\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"new_key\".to_string()],\n    }).unwrap());\n\n    let response = app\n        .router\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/admin/keys\")\n                .header(\"Content-Type\", \"application/json\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(body)\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    // Forbidden because no CSRF token in header\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n\n#[tokio::test]\nasync fn test_add_keys_success() {\n    let config = get_default_config();\n    let mut app = TestApp::new(config).await;\n    \n    // 1. Login and get CSRF token\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 2. Prepare and send request\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"new_key_1\".to_string(), \"new_key_2\".to_string()],\n    }).unwrap());\n\n    let response = app.authed_request(Method::POST, \"/admin/keys\", body).await;\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // 3. Verify the change by getting the config again\n    let get_config_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    let body = get_config_response\n        .into_body()\n        .collect()\n        .await\n        .unwrap()\n        .to_bytes();\n    let updated_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n    \n    let default_group = updated_config.groups.iter().find(|g| g.name == \"default\").unwrap();\n    assert_eq!(default_group.api_keys.len(), 3); // key1, new_key_1, new_key_2\n    assert!(default_group.api_keys.contains(\u0026\"key1\".to_string()));\n    assert!(default_group.api_keys.contains(\u0026\"new_key_1\".to_string()));\n}\n\n#[tokio::test]\nasync fn test_verify_key_success() {\n    // 1. Setup Wiremock\n    let mock_server = MockServer::start().await;\n    Mock::given(method(\"POST\"))\n        .and(path(\"/v1beta/models/gemini-pro:generateContent\"))\n        .respond_with(ResponseTemplate::new(200).set_body_json(json!({\n            \"candidates\": [{\n                \"content\": {\n                    \"parts\": [{\"text\": \"OK\"}],\n                    \"role\": \"model\"\n                }\n            }]\n        })))\n        .mount(\u0026mock_server)\n        .await;\n\n    // 2. Setup TestApp with a key group pointing to the mock server\n    let mut config = get_default_config();\n    config.groups[0].target_url = mock_server.uri(); // Point to mock server\n    let api_key_to_verify = config.groups[0].api_keys[0].clone();\n    let key_id = format!(\"{:x}\", md5::compute(api_key_to_verify.as_bytes()));\n\n\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 3. Make the request to verify the key\n    let response = app\n        .authed_request(\n            Method::POST,\n            \u0026format!(\"/admin/keys/{}/verify\", key_id),\n            Body::empty(),\n        )\n        .await;\n\n    // 4. Assert the response\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // Assert that the mock server received exactly one request,\n    // which confirms our handler called the verification logic.\n    mock_server.verify().await;\n}\n#[tokio::test]\nasync fn test_reset_key_success() {\n    // 1. Setup Wiremock to return a rate-limit error\n    let mock_server = MockServer::start().await;\n    Mock::given(method(\"POST\"))\n        .and(path(\"/v1beta/models/gemini-pro:generateContent\"))\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit exceeded\"))\n        .mount(\u0026mock_server)\n        .await;\n\n    // 2. Setup TestApp and get key info\n    let mut config = get_default_config();\n    config.groups[0].target_url = mock_server.uri();\n    let api_key_to_test = config.groups[0].api_keys[0].clone();\n    let key_id = format!(\"{:x}\", md5::compute(api_key_to_test.as_bytes()));\n\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 3. Call verify_key to get the key rate-limited\n    let verify_response = app\n        .authed_request(\n            Method::POST,\n            \u0026format!(\"/admin/keys/{}/verify\", key_id),\n            Body::empty(),\n        )\n        .await;\n    assert_eq!(verify_response.status(), StatusCode::OK);\n    mock_server.verify().await; // Ensure the mock was called\n\n    // 4. Verify the key is now limited\n    let list_keys_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/keys\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    let body_bytes = list_keys_response.into_body().collect().await.unwrap().to_bytes();\n    let keys: Vec\u003cserde_json::Value\u003e = serde_json::from_slice(\u0026body_bytes).unwrap();\n    assert_eq!(keys[0][\"id\"], key_id);\n    assert_eq!(keys[0][\"status\"], \"invalid\"); // Note: 429 is currently treated as invalid, not limited. This is ok for the test.\n\n    // 5. Call reset_key to reset its status\n    let reset_response = app\n        .authed_request(\n            Method::POST,\n            \u0026format!(\"/admin/keys/{}/reset\", key_id),\n            Body::empty(),\n        )\n        .await;\n    assert_eq!(reset_response.status(), StatusCode::OK);\n\n    // 6. Verify the key is available again\n    let list_keys_response_after_reset = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/keys\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    let body_bytes_after_reset = list_keys_response_after_reset.into_body().collect().await.unwrap().to_bytes();\n    let keys_after_reset: Vec\u003cserde_json::Value\u003e = serde_json::from_slice(\u0026body_bytes_after_reset).unwrap();\n    assert_eq!(keys_after_reset[0][\"id\"], key_id);\n    assert_eq!(keys_after_reset[0][\"status\"], \"available\");\n}\n#[tokio::test]\nasync fn test_delete_keys_success() {\n    // 1. Setup app with a config containing multiple keys\n    let mut config = get_default_config();\n    config.groups[0].api_keys.push(\"key_to_delete\".to_string());\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 2. Send request to delete one of the keys\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"key_to_delete\".to_string()],\n    }).unwrap());\n\n    let response = app.authed_request(Method::DELETE, \"/admin/keys\", body).await;\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // 3. Verify the change by getting the config again\n    let get_config_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    let body = get_config_response.into_body().collect().await.unwrap().to_bytes();\n    let updated_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n    \n    let default_group = updated_config.groups.iter().find(|g| g.name == \"default\").unwrap();\n    assert_eq!(default_group.api_keys.len(), 1);\n    assert!(default_group.api_keys.contains(\u0026\"key1\".to_string()));\n    assert!(!default_group.api_keys.contains(\u0026\"key_to_delete\".to_string()));\n}\n\n#[tokio::test]\nasync fn test_update_config_success() {\n    // 1. Setup app with initial config\n    let initial_config = get_default_config();\n    let mut app = TestApp::new(initial_config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 2. Create a new, modified config\n    let mut new_config = get_default_config();\n    new_config.server.port = 9999; // Change a server setting\n    new_config.groups[0].name = \"renamed_group\".to_string(); // Change a group setting\n    new_config.groups[0].api_keys.push(\"new_key_in_updated_config\".to_string());\n\n    // 3. Send request to update the config\n    let body = Body::from(serde_json::to_string(\u0026new_config).unwrap());\n    let response = app.authed_request(Method::PUT, \"/admin/config\", body).await;\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // 4. Verify the change by getting the config again\n    let get_config_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n\n    let body = get_config_response.into_body().collect().await.unwrap().to_bytes();\n    let updated_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n\n    // Assert that the fetched config matches the new config\n    assert_eq!(updated_config.server.port, 9999);\n    assert_eq!(updated_config.groups.len(), 1);\n    assert_eq!(updated_config.groups[0].name, \"renamed_group\");\n    assert_eq!(updated_config.groups[0].api_keys.len(), 2);\n    assert!(updated_config.groups[0].api_keys.contains(\u0026\"new_key_in_updated_config\".to_string()));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","integration_tests.rs"],"content":"// tests/integration_tests.rs\n\nuse axum::{\n    // body::Bytes as _, // Removed unused import placeholder\n    extract::{Request, State},\n    http::{/* header, */ Method, StatusCode, Uri}, // Removed unused header\n    response::Response,\n};\nuse gemini_proxy_key_rotation_rust::{\n    config::{AppConfig, KeyGroup, ServerConfig},\n    handler, // Import the handler module\n    // key_manager::FlattenedKeyInfo, // Removed unused import\n    // proxy,\n    state::AppState,\n};\nuse std::{fs::File, path::PathBuf, sync::Arc};\nuse tempfile::tempdir;\nuse wiremock::{\n    matchers::{method, path, path_regex, query_param}, // Use path and query_param\n    Mock,\n    MockServer,\n    ResponseTemplate,\n};\n\n// Helper function to create a basic AppConfig for testing\nfn create_test_config(groups: Vec\u003cKeyGroup\u003e, server_port: u16) -\u003e AppConfig {\n    AppConfig {\n        server: ServerConfig {\n            port: server_port,\n            top_p: None,\n            admin_token: Some(\"test_token\".to_string()),\n        },\n        groups,\n        rate_limit_behavior: Default::default(),\n        internal_retries: 3,\n        temporary_block_minutes: 1,\n    }\n}\n\n// Helper to create a dummy config file path within a temp dir\nfn create_dummy_config_path_for_test(dir: \u0026tempfile::TempDir) -\u003e PathBuf {\n    let file_path = dir.path().join(\"dummy_config_for_test.yaml\");\n    // Create the file, but content doesn't strictly matter for these handler tests\n    File::create(\u0026file_path).expect(\"Failed to create dummy config file\");\n    file_path\n}\n\n// Helper to make a request to the proxy handler\nasync fn call_proxy_handler(\n    state: Arc\u003cAppState\u003e,\n    method: Method,\n    path: \u0026str,\n    body: axum::body::Body,\n) -\u003e Response {\n    let uri: Uri = format!(\"http://test-proxy.com{}\", path) // Base URL doesn't matter here\n        .parse()\n        .expect(\"Failed to parse test URI for handler\");\n    let request = Request::builder()\n        .method(method)\n        .uri(uri)\n        .body(body) // Use empty body for GET/POST tests for simplicity\n        .unwrap();\n\n    // Call the actual handler function\n    handler::proxy_handler(State(state), request)\n        .await\n        .expect(\"Proxy handler returned an error\") // Unwrap the Result\u003cResponse, AppError\u003e\n}\n\n#[tokio::test]\nasync fn test_forward_request_openai_compat_success_no_proxy() {\n    // This test now implicitly tests the handler as well for the success path.\n    // We can keep it or refactor it slightly to use call_proxy_handler.\n    // Let's keep it for now as it tests proxy::forward_request logic well.\n\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"test-key-123\";\n    let test_path = \"/v1/models\";\n    let expected_path = \"/v1beta/openai/models\";\n    // let _expected_bearer = format!(\"Bearer {}\", test_api_key); // Unused now\n\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key)) // Match key in query param\n        // Removed header matchers\n        .respond_with(\n            ResponseTemplate::new(200).set_body_string(\"{\\\"object\\\": \\\"list\\\", \\\"data\\\": []}\"),\n        )\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"test-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9999);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    ); // Wrap in Arc\n\n    // 3. Call handler directly\n    let response =\n        call_proxy_handler(app_state, Method::GET, test_path, axum::body::Body::empty()).await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200)\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read response body\");\n    let body_str = String::from_utf8(body_bytes.to_vec()).expect(\"Body not UTF-8\");\n    assert!(body_str.contains(\"list\"), \"Response body mismatch\");\n}\n\n#[tokio::test]\nasync fn test_handler_retries_on_429_and_succeeds() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let key1 = \"key-limited\";\n    let key2 = \"key-working\";\n    let test_path = \"/v1/generateContent\";\n    let expected_path = \"/v1beta/openai/generateContent\";\n\n    // Mock for the first key (key1) - returns 429\n    Mock::given(method(\"POST\")) // Assuming POST for generateContent\n        .and(path(expected_path))\n        .and(query_param(\"key\", key1)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit exceeded\"))\n        .mount(\u0026server)\n        .await;\n\n    // Mock for the second key (key2) - returns 200\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key2)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(200).set_body_string(\"{\\\"candidates\\\": []}\")) // Example success response\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    // Key order matters for the round-robin\n    let test_group = KeyGroup {\n        name: \"retry-group\".to_string(),\n        api_keys: vec![key1.to_string(), key2.to_string()], // key1 will be tried first\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9998); // Different port just in case\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    // We expect the handler to try key1, get 429, mark it, try key2, get 200, and return 200.\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) after retry\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read success response body\");\n    let body_str = String::from_utf8(body_bytes.to_vec()).expect(\"Success body not UTF-8\");\n    assert!(\n        body_str.contains(\"candidates\"),\n        \"Success response body mismatch\"\n    );\n\n    // TODO: Optionally, check the persisted state file to ensure key1 is marked as limited.\n    // This requires reading the state file (`key_states.json`) from the temp_dir.\n}\n\n#[tokio::test]\nasync fn test_handler_returns_last_429_on_exhaustion() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let key1 = \"key-exhausted-1\";\n    let key2 = \"key-exhausted-2\";\n    let test_path = \"/v1/models\"; // Using GET for simplicity here\n    let expected_path = \"/v1beta/openai/models\";\n\n    // Mock for the first key (key1) - returns 429\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key1)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit 1\"))\n        .mount(\u0026server)\n        .await;\n\n    // Mock for the second key (key2) - also returns 429\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key2)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit 2\")) // Different body to check which 429 is returned\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"exhaust-group\".to_string(),\n        api_keys: vec![key1.to_string(), key2.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9997);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    // We expect the handler to try key1 (429), try key2 (429), run out of keys, and return the *last* 429 response.\n    let response =\n        call_proxy_handler(app_state, Method::GET, test_path, axum::body::Body::empty()).await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::TOO_MANY_REQUESTS,\n        \"Expected status 429 when all keys are exhausted\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read 429 response body\");\n    let body_str = String::from_utf8(body_bytes.to_vec()).expect(\"429 body not UTF-8\");\n    // Check it returned the body from the *second* 429 response\n    assert!(\n        body_str.contains(\"Rate limit 2\"),\n        \"Expected body from the last 429 response, got: {}\",\n        body_str\n    );\n}\n\n\n\n#[tokio::test]\nasync fn test_handler_group_round_robin() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_path = \"/v1/models\";\n    let expected_path = \"/v1beta/openai/models\";\n\n    let g1_key1 = \"g1-key-1\";\n    let g1_key2 = \"g1-key-2\";\n    let g2_key1 = \"g2-key-1\"; // Single key in this group\n    let g3_key1 = \"g3-key-1\";\n\n    // Mock successful responses for all keys initially\n    for key in [g1_key1, g1_key2, g2_key1, g3_key1] {\n        Mock::given(method(\"GET\"))\n            .and(path_regex(format!(\"^{}.*\", expected_path))) // Match any path starting with test_path\n            .and(query_param(\"key\", key))\n            .respond_with(ResponseTemplate::new(200).set_body_string(format!(\"{{\\\"key_used\\\": \\\"{}\\\"}}\", key)))\n            .mount(\u0026server)\n            .await;\n    }\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let groups = vec![\n        KeyGroup {\n            name: \"group1\".to_string(),\n            api_keys: vec![g1_key1.to_string(), g1_key2.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        },\n        KeyGroup {\n            name: \"group2\".to_string(),\n            api_keys: vec![g2_key1.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        },\n        KeyGroup {\n            name: \"group3\".to_string(),\n            api_keys: vec![g3_key1.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        },\n    ];\n    let config = create_test_config(groups, 9996);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // Helper to extract key from response body\n    async fn get_key_from_response(response: Response) -\u003e String {\n        let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n            .await\n            .expect(\"Failed to read response body\");\n        let body_json: serde_json::Value = serde_json::from_slice(\u0026body_bytes).expect(\"Invalid JSON\");\n        body_json[\"key_used\"].as_str().unwrap().to_string()\n    }\n\n    // 3. Call handler multiple times and check key rotation\n    // Expected sequence: g1k1, g2k1, g3k1, g1k2, g2k1, g3k1, g1k1, ...\n\n    let res1 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=1\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res1.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res1).await, g1_key1);\n\n    let res2 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=2\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res2.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res2).await, g2_key1);\n\n    let res3 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=3\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res3.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res3).await, g3_key1);\n\n    let res4 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=4\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res4.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res4).await, g1_key2); // Next key in group1\n\n    let res5 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=5\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res5.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res5).await, g2_key1); // Back to group2 (only one key)\n\n    let res6 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=6\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res6.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res6).await, g3_key1); // Back to group3 (only one key)\n\n    let res7 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=7\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res7.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res7).await, g1_key1); // Back to start of group1\n\n    // 4. Test skipping a rate-limited group\n    // Reset mocks and set g2_key1 to return 429, others to 200\n    server.reset().await;\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", g2_key1))\n        .respond_with(ResponseTemplate::new(429))\n        .mount(\u0026server)\n        .await;\n    // Remount mocks for other keys to return 200\n    for key in [g1_key1, g1_key2, g3_key1] { // Exclude g2_key1\n        Mock::given(method(\"GET\"))\n            .and(path(expected_path))\n            .and(query_param(\"key\", key))\n            .respond_with(ResponseTemplate::new(200).set_body_string(format!(\"{{\\\"key_used\\\": \\\"{}\\\"}}\", key)))\n            .mount(\u0026server)\n            .await;\n    }\n\n    // Make a request - should hit g2k1, get 429, mark key, retry\n    // Expected sequence now: g3k1 (skips g2), g1k2 (skips g2), ...\n\n    // Current state: next should be group2 (index 1) according to previous calls\n    // Try g2k1 -\u003e 429 -\u003e mark g2k1 limited -\u003e continue search\n    // Try group3 (index 2) -\u003e g3k1 -\u003e OK\n    let res_skip1 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=8\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res_skip1.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res_skip1).await, g3_key1); // Expect g3_key1 because g2 is skipped\n\n    // Current state: next should be group0 (index 0)\n    // Try g1k2 -\u003e OK\n    let res_skip2 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=9\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res_skip2.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res_skip2).await, g1_key2);\n\n    // Current state: next should be group1 (index 1)\n    // Try g2k1 -\u003e still 429 -\u003e continue search\n    // Try group3 (index 2) -\u003e g3k1 -\u003e OK\n    let res_skip3 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=10\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res_skip3.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res_skip3).await, g3_key1);\n}\n\n// TODO: Add more tests from the plan:\n// - Test with POST /v1/chat/completions and body forwarding (similar structure, just change method and add body to request/mocks)\n// - Test error scenarios (e.g., mock server returning 500) -\u003e Handler should return the corresponding error response immediately\n// - Test persistence logic explicitly by reading/writing state file.\n// - Test SOCKS5 proxy scenario (more complex setup needed)\n\n#[tokio::test]\nasync fn test_openai_top_p_injection_correctly() {\n    // Goal: Verify that top_p is injected at the top level for OpenAI compatibility.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"openai-top-p-key\";\n    let test_path = \"/v1/chat/completions\";\n    let expected_path = \"/v1beta/openai/chat/completions\";\n    let top_p_value = 0.88f32;\n\n    // Mock to verify the body modification\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key))\n        .and(move |req: \u0026wiremock::Request| {\n            // Custom matcher to inspect the body for a top-level \"top_p\"\n            if let Ok(body_json) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026req.body) {\n                if let Some(top_p) = body_json.get(\"top_p\") {\n                    return top_p.as_f64().map_or(false, |v| (v as f32 - top_p_value).abs() \u003c f32::EPSILON);\n                }\n            }\n            false\n        })\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"id\": \"chatcmpl-123\", \"object\": \"chat.completion\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    \n    // Create a new AppConfig with top_p at the server level for this test\n    let mut config = create_test_config(vec![\n        KeyGroup {\n            name: \"openai-top-p-group\".to_string(),\n            api_keys: vec![test_api_key.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None, // Group level top_p is not used for this path\n        }\n    ], 9993);\n    config.server.top_p = Some(top_p_value); // Set top_p at the server level\n\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with a standard OpenAI body\n    let original_body = serde_json::json!({\n        \"model\": \"gpt-4\",\n        \"messages\": [{\"role\": \"user\", \"content\": \"Hello!\"}]\n    });\n    let body_bytes = serde_json::to_vec(\u0026original_body).unwrap();\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::from(body_bytes),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) with top_p injected for openai compat\"\n    );\n}\n\n#[tokio::test]\nasync fn test_health_detailed_maps_to_models_endpoint() {\n    // Goal: Verify that /health/detailed calls the upstream /v1beta/models endpoint.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"health-check-key\";\n    let models_path = \"/v1beta/models\";\n    let mock_response_body = serde_json::json!({ \"data\": [\"model1\"] });\n\n    // Mock for the upstream models endpoint\n    Mock::given(method(\"GET\"))\n        .and(path(models_path))\n        .and(query_param(\"key\", test_api_key))\n        .respond_with(ResponseTemplate::new(200).set_body_json(\u0026mock_response_body))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"health-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9992);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler for the /health/detailed path\n    let response = call_proxy_handler(\n        app_state,\n        Method::GET,\n        \"/health/detailed\",\n        axum::body::Body::empty(),\n    ).await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) for /health/detailed\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read response body\");\n    let body_json: serde_json::Value = serde_json::from_slice(\u0026body_bytes).expect(\"Invalid JSON response\");\n    assert_eq!(body_json, mock_response_body, \"Response body from /health/detailed did not match expected models list\");\n}\n\n#[tokio::test]\nasync fn test_content_length_is_updated_after_top_p_injection() {\n    // Goal: Verify Content-Length is recalculated after body modification.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"content-length-key\";\n    let test_path = \"/v1/chat/completions\";\n    let expected_path = \"/v1beta/openai/chat/completions\";\n    let top_p_value = 0.88f32;\n\n    // The original body without top_p\n    let original_body = serde_json::json!({\n        \"model\": \"gpt-4\",\n        \"messages\": [{\"role\": \"user\", \"content\": \"Hello!\"}]\n    });\n\n    // The expected body *after* injection\n    let mut expected_body_json = original_body.clone();\n    expected_body_json[\"top_p\"] = serde_json::json!(top_p_value);\n    let expected_body_bytes = serde_json::to_vec(\u0026expected_body_json).unwrap();\n    let expected_content_length = expected_body_bytes.len().to_string();\n\n    // Mock to verify the body and the Content-Length header\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key))\n        .and(move |req: \u0026wiremock::Request| {\n            // Check Content-Length header first\n            let has_correct_content_length = req\n                .headers\n                .get(\"Content-Length\")\n                .map_or(false, |val| val.to_str().unwrap() == expected_content_length);\n\n            if !has_correct_content_length {\n                return false;\n            }\n\n            // Check body content\n            if let Ok(body_json) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026req.body) {\n                if let Some(top_p) = body_json.get(\"top_p\") {\n                    return top_p.as_f64().map_or(false, |v| (v as f32 - top_p_value).abs() \u003c f32::EPSILON);\n                }\n            }\n            false\n        })\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"id\": \"chatcmpl-456\", \"object\": \"chat.completion\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    \n    let mut config = create_test_config(vec![\n        KeyGroup {\n            name: \"content-length-group\".to_string(),\n            api_keys: vec![test_api_key.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        }\n    ], 9991);\n    config.server.top_p = Some(top_p_value);\n\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    let body_bytes = serde_json::to_vec(\u0026original_body).unwrap();\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::from(body_bytes),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) with correct content-length\"\n    );\n}\n\n#[tokio::test]\nasync fn test_top_p_client_precedence() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"client-precedence-key\";\n    let test_path = \"/v1/models:generateContent\";\n    let expected_path = \"/v1beta/openai/models:generateContent\";\n    let server_top_p = 0.5; // Server-side config\n    let client_top_p = 0.99; // Client-side value, should win\n\n    // Mock to verify that the client's top_p is what arrives\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key))\n        .and(move |req: \u0026wiremock::Request| {\n            // Custom matcher to inspect the body\n            if let Ok(body_json) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026req.body) {\n                if let Some(config) = body_json.get(\"generationConfig\") {\n                    if let Some(top_p) = config.get(\"topP\") {\n                        // Check that the value is the one from the client\n                        return top_p.as_f64().map_or(false, |v| (v - client_top_p as f64).abs() \u003c f64::EPSILON);\n                    }\n                }\n            }\n            false\n        })\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"candidates\": [] })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"client-precedence-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: Some(server_top_p), // Set a server-side value\n    };\n    let config = create_test_config(vec![test_group], 9994);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with a body that already contains topP\n    let original_body = serde_json::json!({\n        \"contents\": [{\"role\": \"user\", \"parts\": [{\"text\": \"Hello\"}]}],\n        \"generationConfig\": {\n            \"temperature\": 0.7,\n            \"topP\": client_top_p // Client provides topP\n        }\n    });\n    let body_bytes = serde_json::to_vec(\u0026original_body).unwrap();\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::from(body_bytes),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) when client top_p takes precedence\"\n    );\n}\n\n#[tokio::test]\nasync fn test_url_translation_for_v1_path() {\n    // Goal: Verify that a request to a `/v1/...` path is translated to `/v1beta/openai/...`\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"translation-key-v1\";\n    let incoming_path = \"/v1/chat/completions\";\n    let expected_translated_path = \"/v1beta/openai/chat/completions\";\n\n    // Mock to expect the *translated* path\n    Mock::given(method(\"POST\"))\n        .and(path(expected_translated_path))\n        .and(query_param(\"key\", test_api_key))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"status\": \"ok\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"translation-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9990);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with the original `/v1/...` path\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        incoming_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) for translated v1 path\"\n    );\n    // The mock server implicitly verifies that the path was translated correctly.\n    // If the request had gone to the original path, the mock would not have matched,\n    // and wiremock would have returned a 404, failing the test.\n}\n\n#[tokio::test]\nasync fn test_url_translation_for_non_v1_path() {\n    // Goal: Verify that a request to a path NOT starting with `/v1/` is NOT translated.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"translation-key-non-v1\";\n    let incoming_path = \"/health\"; // A non-v1 path\n\n    // Mock to expect the *original* path, unchanged\n    Mock::given(method(\"GET\"))\n        .and(path(incoming_path))\n        .and(query_param(\"key\", test_api_key))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"status\": \"healthy\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"non-translation-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9989);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with the non-v1 path\n    let response = call_proxy_handler(\n        app_state,\n        Method::GET,\n        incoming_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) for non-v1 path\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .unwrap();\n    let body_str = String::from_utf8(body_bytes.to_vec()).unwrap();\n    assert!(body_str.contains(\"healthy\"));\n}\n\n#[tokio::test]\nasync fn test_handler_retries_on_400_and_succeeds() {\n    // This test verifies that if a key returns a 400 Bad Request,\n    // the handler marks it as invalid and successfully retries with the next key.\n\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let key1_invalid = \"key-invalid-400\";\n    let key2_valid = \"key-valid-200\";\n    let test_path = \"/v1/chat/completions\";\n    let expected_path = \"/v1beta/openai/chat/completions\";\n\n    // Mock for the first key (key1_invalid) - returns 400\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key1_invalid))\n        .respond_with(ResponseTemplate::new(400).set_body_string(\"Invalid API key\"))\n        .mount(\u0026server)\n        .await;\n\n    // Mock for the second key (key2_valid) - returns 200\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key2_valid))\n        .respond_with(ResponseTemplate::new(200).set_body_string(\"{\\\"candidates\\\": []}\"))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"retry-400-group\".to_string(),\n        api_keys: vec![key1_invalid.to_string(), key2_valid.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9996); // Different port\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    let response = call_proxy_handler(\n        app_state.clone(), // Clone for the call\n        Method::POST,\n        test_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) after retry on 400\"\n    );\n    // Verify that the first key is now marked as invalid\n    let is_invalid = app_state.key_manager.read().await.is_key_invalid(key1_invalid);\n    assert!(\n        is_invalid,\n        \"Expected the first key to be marked as invalid after a 400 response\"\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","main_integration_tests.rs"],"content":"use gemini_proxy_key_rotation_rust::{error::AppError, run};\nuse std::fs::File;\nuse std::io::Write;\nuse tempfile::tempdir;\n\n#[tokio::test]\nasync fn test_run_successful_startup() {\n    let temp_dir = tempdir().expect(\"Failed to create temp directory\");\n    let config_path = temp_dir.path().join(\"config.yaml\");\n\n    let mut temp_config = File::create(\u0026config_path).expect(\"Failed to create temp config file\");\n    let config_content = r#\"\nserver:\n  port: 8080\n  admin_token: \"test_token\"\ngroups:\n  - name: \"default\"\n    api_keys: [\"key1\"]\n\"#;\n    temp_config\n        .write_all(config_content.as_bytes())\n        .expect(\"Failed to write to temp config\");\n\n    // This test now verifies that `run` can successfully initialize the application\n    // state and router when provided with a valid configuration.\n    // It no longer tests the `main` function directly, as `main` is not part of the\n    // library's public API and testing it requires fragile workarounds.\n    let result = run(Some(config_path)).await;\n\n    assert!(result.is_ok(), \"run() should succeed with a valid config\");\n}\n\n#[tokio::test]\nasync fn test_run_fails_with_invalid_config() {\n    let temp_dir = tempdir().expect(\"Failed to create temp directory\");\n    let config_path = temp_dir.path().join(\"config.yaml\");\n\n    let mut temp_config = File::create(\u0026config_path).expect(\"Failed to create temp config file\");\n    // Invalid structure (port is a string)\n    let config_content = r#\"\nserver:\n  port: \"not-a-number\"\n  admin_token: \"test_token\"\ngroups: []\n\"#;\n    temp_config\n        .write_all(config_content.as_bytes())\n        .expect(\"Failed to write to temp config\");\n\n    let result = run(Some(config_path)).await;\n\n    assert!(matches!(result, Err(AppError::Config(_))));\n}\n\n#[tokio::test]\nasync fn test_run_fails_without_config_file() {\n    let temp_dir = tempdir().expect(\"Failed to create temp directory\");\n\n    // Set CONFIG_PATH to a non-existent file in our temp directory\n    let config_path = temp_dir.path().join(\"non_existent_config.yaml\");\n\n    let result = run(Some(config_path)).await;\n\n    // Expect a config error because the file is required if the path is set,\n    // and default values are not sufficient to run.\n    assert!(matches!(result, Err(AppError::Config(_))));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","system_integration_tests.rs"],"content":"// tests/system_integration_tests.rs\n\nuse axum::http::{Method, StatusCode};\nuse gemini_proxy_key_rotation_rust::{\n    config::{AppConfig, KeyGroup, ServerConfig},\n    handler,\n    state::AppState,\n};\nuse futures::future;\nuse std::{\n    fs::File,\n    sync::Arc,\n};\nuse tempfile::tempdir;\nuse wiremock::{\n    matchers::{method, path},\n    Mock, MockServer, ResponseTemplate,\n};\n\nasync fn create_test_system() -\u003e (Arc\u003cAppState\u003e, MockServer, tempfile::TempDir) {\n    let server = MockServer::start().await;\n    let temp_dir = tempdir().unwrap();\n    let config_path = temp_dir.path().join(\"config.yaml\");\n    File::create(\u0026config_path).unwrap();\n    \n    let test_group = KeyGroup {\n        name: \"test-group\".to_string(),\n        api_keys: vec![\"test-key-1\".to_string(), \"test-key-2\".to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    \n    let config = AppConfig {\n        server: ServerConfig {\n            port: 8080,\n            top_p: None,\n            admin_token: Some(\"test_token\".to_string()),\n        },\n        groups: vec![test_group],\n        rate_limit_behavior: Default::default(),\n        internal_retries: 3,\n        temporary_block_minutes: 1,\n    };\n    \n    let app_state = Arc::new(AppState::new(\u0026config, \u0026config_path).await.unwrap());\n    \n    (app_state, server, temp_dir)\n}\n\n\n#[tokio::test]\nasync fn test_metrics_collection() {\n    let (app_state, server, _temp_dir) = create_test_system().await;\n    \n    // Mock a successful request\n    Mock::given(method(\"GET\"))\n        .and(path(\"/v1beta/openai/models\"))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({\"data\": []})))\n        .mount(\u0026server)\n        .await;\n    \n    // Make a request to generate metrics\n    let request = axum::extract::Request::builder()\n        .method(Method::GET)\n        .uri(\"/v1/models\")\n        .body(axum::body::Body::empty())\n        .unwrap();\n    \n    let _response = handler::proxy_handler(\n        axum::extract::State(app_state.clone()),\n        request,\n    ).await.unwrap();\n    \n    // Metrics should be recorded (this is more of a smoke test)\n    // In a real scenario, you'd check the actual metrics values\n    // but that requires more complex setup with the metrics registry\n}\n\n#[tokio::test]\nasync fn test_error_handling_and_recovery() {\n    let (app_state, server, _temp_dir) = create_test_system().await;\n    \n    // Mock server error followed by success\n    Mock::given(method(\"GET\"))\n        .and(path(\"/v1beta/openai/models\"))\n        .respond_with(ResponseTemplate::new(500).set_body_string(\"Internal Server Error\"))\n        .expect(6) // Expect 3 internal retries for each of the 2 keys\n        .mount(\u0026server)\n        .await;\n    \n    let request = axum::extract::Request::builder()\n        .method(Method::GET)\n        .uri(\"/v1/models\")\n        .body(axum::body::Body::empty())\n        .unwrap();\n    \n    let response = handler::proxy_handler(\n        axum::extract::State(app_state.clone()),\n        request,\n    ).await.unwrap();\n    \n    // Should return the error response\n    assert_eq!(response.status(), StatusCode::INTERNAL_SERVER_ERROR);\n}\n\n#[tokio::test]\nasync fn test_concurrent_requests() {\n    let (app_state, server, _temp_dir) = create_test_system().await;\n    \n    // Mock responses for concurrent requests\n    Mock::given(method(\"GET\"))\n        .and(path(\"/v1beta/openai/models\"))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({\"data\": []})))\n        .expect(10)\n        .mount(\u0026server)\n        .await;\n    \n    // Create multiple concurrent requests\n    let mut handles = Vec::new();\n    \n    for i in 0..10 {\n        let app_state_clone = app_state.clone();\n        let handle = tokio::spawn(async move {\n            let request = axum::extract::Request::builder()\n                .method(Method::GET)\n                .uri(format!(\"/v1/models?req={}\", i))\n                .body(axum::body::Body::empty())\n                .unwrap();\n            \n            handler::proxy_handler(\n                axum::extract::State(app_state_clone),\n                request,\n            ).await\n        });\n        handles.push(handle);\n    }\n    \n    // Wait for all requests to complete\n    let results = future::join_all(handles).await;\n    \n    // All requests should succeed\n    for result in results {\n        let response = result.unwrap().unwrap();\n        assert_eq!(response.status(), StatusCode::OK);\n    }\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","admin.rs"],"content":"// src/admin.rs\n\nuse crate::{\n    config::{self, AppConfig},\n    error::{AppError, Result},\n    key_manager::{KeyState, KeyStatus as KmKeyStatus},\n    state::AppState,\n};\nuse axum::{\n    body::Body,\n    extract::{Path, Query, State},\n    http::{Request, StatusCode},\n    middleware::{self, Next},\n    response::{Html, IntoResponse, Json, Response},\n    routing::{delete, get, post, put},\n    Router,\n};\nuse axum_extra::{\n    headers::{authorization::Bearer, Authorization},\n    TypedHeader,\n};\nuse chrono::{DateTime, Utc};\nuse cookie::{time::Duration, SameSite};\nuse http::HeaderName;\nuse rand::{distributions::Alphanumeric, Rng};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse sysinfo::System;\nuse tokio::sync::Mutex;\nuse tower_cookies::{Cookie, Cookies};\nuse tracing::warn;\n\n// Define the custom header name for CSRF token\nstatic X_CSRF_TOKEN: HeaderName = HeaderName::from_static(\"x-csrf-token\");\n\n/// Collector for system information.\n/// Holds a single `System` instance to avoid repeated initialization\n/// and to allow for more accurate CPU readings over time.\n#[derive(Debug)]\npub struct SystemInfoCollector {\n    system: Mutex\u003cSystem\u003e,\n}\n\nimpl SystemInfoCollector {\n    /// Creates a new `SystemInfoCollector`.\n    pub fn new() -\u003e Self {\n        Self {\n            system: Mutex::new(System::new_all()),\n        }\n    }\n\n    /// Returns the current memory usage in MB.\n    pub async fn get_memory_usage(\u0026self) -\u003e u64 {\n        let mut sys = self.system.lock().await;\n        sys.refresh_memory();\n        sys.used_memory() / 1024 / 1024\n    }\n\n    /// Returns the current global CPU usage percentage.\n    /// This requires a short delay between refreshes to get an accurate reading.\n    pub async fn get_cpu_usage(\u0026self) -\u003e f64 {\n        let mut sys = self.system.lock().await;\n        sys.refresh_cpu();\n        // Drop the lock to allow other tasks to run during sleep\n        drop(sys);\n\n        tokio::time::sleep(std::time::Duration::from_millis(200)).await;\n\n        let mut sys = self.system.lock().await;\n        sys.refresh_cpu();\n        sys.global_cpu_info().cpu_usage() as f64\n    }\n\n    /// Returns the disk usage in MB.\n    /// Placeholder for now.\n    pub fn get_disk_usage(\u0026self) -\u003e u64 {\n        // TODO: Implement actual disk usage detection using sysinfo\n        0\n    }\n}\n\nimpl Default for SystemInfoCollector {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Administrative API routes\npub fn admin_routes() -\u003e Router\u003cArc\u003cAppState\u003e\u003e {\n    // Routes that require CSRF protection\n    let protected_routes = Router::new()\n        .route(\"/admin/keys\", post(add_keys))\n        .route(\"/admin/keys\", delete(delete_keys))\n        .route(\"/admin/keys/:key_id/verify\", post(verify_key))\n        .route(\"/admin/keys/:key_id/reset\", post(reset_key))\n        .route(\"/admin/config\", put(update_config))\n        .route_layer(middleware::from_fn(csrf_middleware));\n\n    // Combine all admin routes\n    Router::new()\n        .route(\"/admin\", get(serve_dashboard))\n        .route(\"/admin/health\", get(detailed_health))\n        .route(\"/admin/keys\", get(list_keys))\n        .route(\"/admin/config\", get(get_config))\n        .route(\"/admin/metrics\", get(get_metrics_summary))\n        .route(\"/admin/csrf-token\", get(get_csrf_token))\n        .route(\"/admin/login\", post(login)) // Moved here, outside of CSRF protection\n        .merge(protected_routes)\n}\n\n/// Detailed health check response\n#[derive(Debug, Serialize)]\npub struct DetailedHealthStatus {\n    pub status: String,\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub version: String,\n    pub uptime_seconds: u64,\n    pub server_info: ServerInfo,\n    pub key_status: KeyStatus,\n    pub proxy_status: HashMap\u003cString, ProxyStatus\u003e,\n    pub system_info: SystemInfo,\n}\n\n#[derive(Debug, Serialize)]\npub struct ServerInfo {\n    pub host: String,\n    pub port: u16,\n    pub rust_version: String,\n    pub build_info: BuildInfo,\n}\n\n#[derive(Debug, Serialize)]\npub struct BuildInfo {\n    pub version: String,\n    pub git_hash: String,\n    pub build_date: String,\n    pub target: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct KeyStatus {\n    pub total_keys: usize,\n    pub active_keys: usize,\n    pub limited_keys: usize,\n    pub invalid_keys: usize,\n    pub temporarily_unavailable_keys: usize,\n    pub groups: Vec\u003cGroupStatus\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct GroupStatus {\n    pub name: String,\n    pub total_keys: usize,\n    pub active_keys: usize,\n    pub proxy_url: Option\u003cString\u003e,\n    pub target_url: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct ProxyStatus {\n    pub url: String,\n    pub status: String,\n    pub last_check: DateTime\u003cUtc\u003e,\n    pub groups_using: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct SystemInfo {\n    pub memory_usage_mb: u64,\n    pub cpu_usage_percent: f64,\n    pub disk_usage_mb: u64,\n}\n\n/// Key management request/response types\n#[derive(Debug, Deserialize, Serialize)]\npub struct KeysUpdateRequest {\n    pub group_name: String,\n    pub api_keys: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct KeyInfo {\n    pub id: String,\n    pub group_name: String,\n    pub key_preview: String,\n    pub status: String,\n    pub last_used: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub reset_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ListKeysQuery {\n    pub group: Option\u003cString\u003e,\n    pub status: Option\u003cString\u003e,\n}\n\n/// Configuration update request\n#[derive(Debug, Deserialize)]\npub struct ConfigUpdateRequest {\n    pub config: AppConfig,\n    pub restart_required: Option\u003cbool\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct LoginRequest {\n    token: String,\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct CsrfTokenResponse {\n    pub csrf_token: String,\n}\n\n/// Detailed health check endpoint\n///\n/// # Errors\n///\n/// This function currently does not return any errors, but is declared as `Result`\n/// for future compatibility where I/O or other operations might fail.\n#[axum::debug_handler]\npub async fn detailed_health(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n) -\u003e Result\u003cJson\u003cDetailedHealthStatus\u003e\u003e {\n    let key_manager_guard = state.key_manager.read().await;\n    let all_key_info = key_manager_guard.get_all_key_info();\n    let _key_states = key_manager_guard.get_key_states();\n    let now = Utc::now();\n    let mut active_keys = 0;\n    let mut limited_keys = 0;\n    let mut invalid_keys = 0;\n    let mut temp_unavailable_keys = 0;\n\n    for key_info in \u0026all_key_info {\n        let (status_str, _) = get_key_status_str(key_manager_guard.get_key_states().get(\u0026key_info.key), now);\n        match status_str {\n            \"available\" =\u003e active_keys += 1,\n            \"limited\" =\u003e limited_keys += 1,\n            \"invalid\" =\u003e invalid_keys += 1,\n            \"unavailable\" =\u003e temp_unavailable_keys += 1,\n            _ =\u003e warn!(\n                \"Unknown key status '{}' encountered during health check\",\n                status_str\n            ),\n        }\n    }\n\n    // Build group status\n    let mut groups_map: HashMap\u003cString, GroupStatus\u003e = HashMap::new();\n    for key_info in \u0026all_key_info {\n        let entry = groups_map\n            .entry(key_info.group_name.clone())\n            .or_insert_with(|| GroupStatus {\n                name: key_info.group_name.clone(),\n                total_keys: 0,\n                active_keys: 0,\n                proxy_url: key_info.proxy_url.clone(),\n                target_url: key_info.target_url.clone(),\n            });\n        entry.total_keys += 1;\n\n        let (status_str, _) = get_key_status_str(key_manager_guard.get_key_states().get(\u0026key_info.key), now);\n        if status_str == \"available\" {\n            entry.active_keys += 1;\n        }\n    }\n    let group_statuses = groups_map.into_values().collect();\n\n    // Build proxy status\n    let proxy_status = HashMap::new();\n    // TODO: Implement proxy health checks\n\n    let uptime = state.start_time.elapsed().as_secs();\n    let config_guard = state.config.read().await;\n\n    let health_status = DetailedHealthStatus {\n        status: \"healthy\".to_string(),\n        timestamp: now,\n        version: option_env!(\"CARGO_PKG_VERSION\")\n            .unwrap_or(\"N/A\")\n            .to_string(),\n        uptime_seconds: uptime,\n        server_info: ServerInfo {\n            host: \"0.0.0.0\".to_string(),\n            port: config_guard.server.port,\n            rust_version: \"N/A\".to_string(), // sysinfo doesn't provide this\n            build_info: BuildInfo {\n                version: option_env!(\"CARGO_PKG_VERSION\")\n                    .unwrap_or(\"N/A\")\n                    .to_string(),\n                git_hash: \"N/A\".to_string(),\n                build_date: \"N/A\".to_string(),\n                target: \"N/A\".to_string(),\n            },\n        },\n        key_status: KeyStatus {\n            total_keys: all_key_info.len(),\n            active_keys,\n            limited_keys,\n            invalid_keys,\n            temporarily_unavailable_keys: temp_unavailable_keys,\n            groups: group_statuses,\n        },\n        proxy_status,\n        system_info: SystemInfo {\n            memory_usage_mb: state.system_info.get_memory_usage().await,\n            cpu_usage_percent: state.system_info.get_cpu_usage().await,\n            disk_usage_mb: state.system_info.get_disk_usage(),\n        },\n    };\n\n    Ok(Json(health_status))\n}\n\n/// List API keys\n///\n/// # Errors\n///\n/// This function currently does not return errors but is declared as `Result`\n/// for future compatibility.\n#[axum::debug_handler]\n#[allow(clippy::significant_drop_tightening)]\npub async fn list_keys(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    Query(query): Query\u003cListKeysQuery\u003e,\n) -\u003e Result\u003cJson\u003cVec\u003cKeyInfo\u003e\u003e\u003e {\n    let key_manager_guard = state.key_manager.read().await;\n    let key_states = key_manager_guard.get_key_states();\n    let all_key_info = key_manager_guard.get_all_key_info();\n    let now = Utc::now();\n\n    let mut keys = Vec::new();\n\n    for key_info in \u0026all_key_info {\n        // Filter by group if specified\n        if let Some(ref group_filter) = query.group {\n            if \u0026key_info.group_name != group_filter {\n                continue;\n            }\n        }\n\n        let (status_str, reset_time) = get_key_status_str(key_states.get(\u0026key_info.key), now);\n\n        // Filter by status if specified\n        if let Some(ref status_filter) = query.status {\n            if status_str != status_filter {\n                continue;\n            }\n        }\n\n        keys.push(KeyInfo {\n            id: format!(\"{:x}\", md5::compute(\u0026key_info.key)),\n            group_name: key_info.group_name.clone(),\n            key_preview: format!(\n                \"{}...{}\",\n                \u0026key_info.key[..6.min(key_info.key.len())],\n                if key_info.key.len() \u003e 10 {\n                    \u0026key_info.key[key_info.key.len() - 4..]\n                } else {\n                    \"\"\n                }\n            ),\n            status: status_str.to_string(),\n            last_used: None, // TODO: Track last usage\n            reset_time,\n        });\n    }\n    Ok(Json(keys))\n}\n\n/// Verify a single API key by making a test request.\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized.\n#[axum::debug_handler]\npub async fn verify_key(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Path(key_id): Path\u003cString\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"verify_key\").await?;\n\n    let mut key_manager_guard = state.key_manager.write().await;\n\n    // 1. Get key info under the write lock\n    let (key_to_verify, proxy_url, target_url) =\n        match key_manager_guard.get_key_info_by_id(\u0026key_id) {\n            Some(info) =\u003e (\n                info.key.clone(),\n                info.proxy_url.clone(),\n                info.target_url.clone(),\n            ),\n            None =\u003e {\n                return Err(AppError::NotFound(format!(\n                    \"Key with ID '{}' not found\",\n                    key_id\n                )));\n            }\n        };\n\n    // 2. Perform verification and update status within the single write lock\n    let client = state.get_client(proxy_url.as_deref()).await?;\n    let verification_result = key_manager_guard\n        .perform_key_verification(\u0026key_to_verify, \u0026target_url, \u0026client)\n        .await;\n\n    if key_manager_guard.update_key_status_from_verification(\u0026key_to_verify, verification_result) {\n        key_manager_guard.save_states().await?;\n    }\n\n    Ok(StatusCode::OK)\n}\n\n/// Reset the status of a single API key.\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized.\n#[axum::debug_handler]\npub async fn reset_key(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Path(key_id): Path\u003cString\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"reset_key\").await?;\n\n    let mut key_manager_guard = state.key_manager.write().await;\n    if key_manager_guard.reset_key_status(\u0026key_id) {\n        key_manager_guard.save_states().await?;\n    }\n\n    Ok(StatusCode::OK)\n}\n///\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized, 404 if group not found, 500 on other errors.\n#[axum::debug_handler]\npub async fn add_keys(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Json(request): Json\u003cKeysUpdateRequest\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    // 1. Authentication\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"add_keys\").await?;\n\n    // Hold write lock for the entire operation to ensure atomicity\n    let mut config_write_guard = state.config.write().await;\n\n    // 2. Modify in-memory config\n    let group_name = request.group_name;\n    let keys_to_add = request.api_keys;\n\n    let group = config_write_guard\n        .groups\n        .iter_mut()\n        .find(|g| g.name == group_name)\n        .ok_or_else(|| AppError::NotFound(format!(\"Group '{group_name}' not found\")))?;\n\n    for key in keys_to_add {\n        if !key.trim().is_empty() \u0026\u0026 !group.api_keys.contains(\u0026key) {\n            group.api_keys.push(key);\n        }\n    }\n\n    // 3. Validate before saving\n    if !config::validate_config(\u0026mut config_write_guard, \"admin_add_keys\") {\n        return Err(AppError::Config(\n            \"Validation failed after adding keys; changes not saved.\".to_string(),\n        ));\n    }\n\n    // 4. Persist to file\n    config::save_config(\u0026config_write_guard, \u0026state.config_path).await?;\n\n    // Release lock before reloading to avoid deadlock\n    drop(config_write_guard);\n\n    // 5. Reload State\n    state.reload_state_from_config().await?;\n\n    Ok(StatusCode::OK)\n}\n\n/// Remove API keys from a group\n///\n/// # Errors\n///\n/// Returns 401 if unauthorized, 404 if group not found, 500 on other errors.\n#[axum::debug_handler]\npub async fn delete_keys(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Json(request): Json\u003cKeysUpdateRequest\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    // 1. Authentication\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"delete_keys\").await?;\n\n    // Hold write lock for the entire operation to ensure atomicity\n    let mut config_write_guard = state.config.write().await;\n\n    // 2. Modify in-memory config\n    let group_name = request.group_name;\n    let keys_to_delete: std::collections::HashSet\u003c_\u003e = request.api_keys.into_iter().collect();\n\n    let group = config_write_guard\n        .groups\n        .iter_mut()\n        .find(|g| g.name == group_name)\n        .ok_or_else(|| AppError::NotFound(format!(\"Group '{group_name}' not found\")))?;\n\n    group.api_keys.retain(|k| !keys_to_delete.contains(k));\n\n    // 3. Validate before saving\n    if !config::validate_config(\u0026mut config_write_guard, \"admin_delete_keys\") {\n        return Err(AppError::Config(\n            \"Validation failed after deleting keys; changes not saved.\".to_string(),\n        ));\n    }\n\n    // 4. Persist to file\n    config::save_config(\u0026config_write_guard, \u0026state.config_path).await?;\n\n    // Release lock before reloading to avoid deadlock\n    drop(config_write_guard);\n\n    // 5. Reload State\n    state.reload_state_from_config().await?;\n\n    Ok(StatusCode::OK)\n}\n\n/// Get current configuration\n///\n/// # Errors\n///\n/// Returns an error as this feature is not yet implemented.\n#[axum::debug_handler]\npub async fn get_config(State(state): State\u003cArc\u003cAppState\u003e\u003e) -\u003e Result\u003cJson\u003cAppConfig\u003e\u003e {\n    let config = state.config.read().await;\n    Ok(Json(config.clone()))\n}\n\n/// Update configuration\n///\n/// # Errors\n///\n/// Returns an error as this feature is not yet implemented.\n#[axum::debug_handler]\npub async fn update_config(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    Json(mut new_config): Json\u003cAppConfig\u003e,\n) -\u003e Result\u003cStatusCode\u003e {\n    // 1. Authentication\n    require_admin_token(\u0026state, \u0026jar, auth_header, \"update_config\").await?;\n\n    // 2. Validation\n    if !config::validate_config(\u0026mut new_config, \"admin_update\") {\n        return Err(AppError::Config(\n            \"Validation failed for the new configuration\".to_string(),\n        ));\n    }\n\n    // 3. Persist to file\n    config::save_config(\u0026new_config, \u0026state.config_path).await?;\n\n    // 4. Update in-memory config\n    let mut config_write_guard = state.config.write().await;\n    *config_write_guard = new_config;\n    drop(config_write_guard);\n\n    // 5. Reload State\n    state.reload_state_from_config().await?;\n\n    Ok(StatusCode::OK)\n}\n\n/// Get metrics summary\n///\n/// # Errors\n///\n/// This function currently does not return errors but is declared as `Result`\n/// for future compatibility.\n#[axum::debug_handler]\npub async fn get_metrics_summary(State(_state): State\u003cArc\u003cAppState\u003e\u003e) -\u003e Result\u003cJson\u003c()\u003e\u003e {\n    // TODO: Collect actual metrics\n    Ok(Json(()))\n}\n\n/// Returns a string representation of the key's status.\nfn get_key_status_str(\n    key_state: Option\u003c\u0026KeyState\u003e,\n    now: DateTime\u003cUtc\u003e,\n) -\u003e (\u0026'static str, Option\u003cDateTime\u003cUtc\u003e\u003e) {\n    match key_state {\n        Some(state) =\u003e {\n            let is_expired = state.reset_time.is_some_and(|rt| now \u003e= rt);\n            let status = match state.status {\n                KmKeyStatus::Available =\u003e \"available\",\n                KmKeyStatus::RateLimited if is_expired =\u003e \"available\",\n                KmKeyStatus::RateLimited =\u003e \"limited\",\n                KmKeyStatus::Invalid =\u003e \"invalid\",\n                KmKeyStatus::TemporarilyUnavailable if is_expired =\u003e \"available\",\n                KmKeyStatus::TemporarilyUnavailable =\u003e \"unavailable\",\n            };\n            (status, state.reset_time)\n        }\n        None =\u003e (\"available\", None), // Default to active if no state\n    }\n}\n/// Serve the admin dashboard\n#[axum::debug_handler]\npub async fn serve_dashboard(State(state): State\u003cArc\u003cAppState\u003e\u003e) -\u003e Html\u003cString\u003e {\n    let content = include_str!(\"../static/dashboard.html\").to_string();\n\n    // Inject system info\n    let mem_usage = state.system_info.get_memory_usage().await;\n    let cpu_usage = state.system_info.get_cpu_usage().await;\n\n    let system_info_html = format!(\n        \"\u003cdiv class=\\\"p-4 bg-gray-800 rounded-lg shadow-md\\\"\u003e\n\u003ch2 class=\\\"text-xl font-bold mb-2\\\"\u003eSystem Info\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eMemory Usage:\u003c/strong\u003e {mem_usage} MB\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCPU Usage:\u003c/strong\u003e {cpu_usage:.2} %\u003c/p\u003e\n\u003c/div\u003e\"\n    );\n\n    // A bit of a hacky way to inject the info.\n    // A proper templating engine would be better.\n    let final_content = content.replace(\"\u003c!-- SYSINFO_PLACEHOLDER --\u003e\", \u0026system_info_html);\n\n    Html(final_content)\n}\n\n/// Generates a CSRF token, sets it as a cookie, and returns it in the response body.\n#[axum::debug_handler]\npub async fn get_csrf_token(jar: Cookies) -\u003e Result\u003cimpl IntoResponse\u003e {\n    let token: String = rand::thread_rng()\n        .sample_iter(\u0026Alphanumeric)\n        .take(32)\n        .map(char::from)\n        .collect();\n\n    let cookie = Cookie::build((\"csrf_token\", token.clone()))\n        .path(\"/\")\n        .secure(true)\n        .same_site(SameSite::Strict)\n        .build();\n\n    Ok((\n        jar.add(cookie),\n        Json(CsrfTokenResponse { csrf_token: token }),\n    ))\n}\n\n/// CSRF protection middleware.\nasync fn csrf_middleware(\n    cookies: Cookies,\n    req: Request\u003cBody\u003e,\n    next: Next,\n) -\u003e std::result::Result\u003cResponse, AppError\u003e {\n    // Extract the CSRF token from the cookie\n    let cookie_token = cookies\n        .get(\"csrf_token\")\n        .map(|cookie| cookie.value().to_string());\n\n    // Extract the CSRF token from the header\n    let header_token = req\n        .headers()\n        .get(\u0026X_CSRF_TOKEN)\n        .and_then(|value| value.to_str().ok())\n        .map(String::from);\n\n    match (cookie_token, header_token) {\n        (Some(c_token), Some(h_token)) if !c_token.is_empty() \u0026\u0026 c_token == h_token =\u003e {\n            // Tokens match, proceed with the request\n            Ok(next.run(req).await)\n        }\n        _ =\u003e {\n            // Tokens do not match or are missing\n            warn!(\"CSRF token mismatch or missing\");\n            Err(AppError::Csrf)\n        }\n    }\n}\n\n/// New login endpoint to set HttpOnly cookie\n#[axum::debug_handler]\npub async fn login(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    jar: Cookies,\n    Json(request): Json\u003cLoginRequest\u003e,\n) -\u003e Result\u003cimpl IntoResponse\u003e {\n    let config = state.config.read().await;\n    let expected_token = config.server.admin_token.as_deref();\n\n    match expected_token {\n        Some(token) if !token.is_empty() \u0026\u0026 request.token == token =\u003e {\n            let cookie = Cookie::build((\"admin_token\", token.to_string()))\n                .path(\"/\")\n                .http_only(true)\n                .secure(true)\n                .same_site(SameSite::Strict)\n                .max_age(Duration::days(7)) // Uses time::Duration\n                .build();\n            Ok((jar.add(cookie), StatusCode::OK))\n        }\n        _ =\u003e {\n            warn!(\"Failed login attempt\");\n            Err(AppError::Unauthorized)\n        }\n    }\n}\n\n/// Middleware to verify admin token from Cookie or Bearer token.\nasync fn require_admin_token(\n    state: \u0026Arc\u003cAppState\u003e,\n    jar: \u0026Cookies,\n    auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n    endpoint_name: \u0026str,\n) -\u003e Result\u003c()\u003e {\n    let config = state.config.read().await;\n    let expected_token = config.server.admin_token.as_deref();\n\n    let token_from_cookie = jar.get(\"admin_token\").map(|c| c.value().to_string());\n\n    let token_from_header = auth_header.map(|h| h.token().to_string());\n\n    let provided_token = token_from_cookie.or(token_from_header);\n\n    match (expected_token, provided_token) {\n        (Some(expected), Some(provided)) if !expected.is_empty() \u0026\u0026 provided == expected =\u003e Ok(()),\n        (Some(\"\"), _) =\u003e {\n            warn!(\n                \"Admin endpoint ({}) accessed but no admin_token is configured\",\n                endpoint_name\n            );\n            Err(AppError::Unauthorized)\n        }\n        _ =\u003e {\n            warn!(\n                \"Unauthorized admin access attempt for endpoint: {}\",\n                endpoint_name\n            );\n            Err(AppError::Unauthorized)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::ServerConfig;\n    use crate::key_manager::{KeyState, KeyStatus as KmKeyStatus};\n    use axum::{\n        body::Body,\n        http::{header, Request, StatusCode},\n        middleware::from_fn_with_state,\n        routing::get,\n        Router,\n    };\n    use axum_extra::headers::Authorization;\n    use chrono::{Duration, Utc};\n    use std::sync::Arc;\nuse tower::util::ServiceExt;\n    use tower_cookies::CookieManagerLayer;\n    use tempfile::TempDir;\n \n     // Handler that will be protected by the middleware\n     async fn protected_handler() -\u003e StatusCode {\n        StatusCode::OK\n    }\n\n    // Middleware test wrapper\n    async fn auth_middleware_wrapper(\n        State(state): State\u003cArc\u003cAppState\u003e\u003e,\n        jar: Cookies,\n        auth_header: Option\u003cTypedHeader\u003cAuthorization\u003cBearer\u003e\u003e\u003e,\n        req: Request\u003cBody\u003e,\n        next: Next,\n    ) -\u003e Response {\n        match require_admin_token(\u0026state, \u0026jar, auth_header, \"test\").await {\n            Ok(_) =\u003e next.run(req).await,\n            Err(e) =\u003e e.into_response(),\n        }\n    }\n\n    #[test]\n    fn test_get_key_status_str() {\n        let now = Utc::now();\n        let past = now - Duration::seconds(10);\n        let future = now + Duration::seconds(10);\n\n        // 1. No state (None) -\u003e should be \"available\"\n        let (status, reset_time) = get_key_status_str(None, now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, None);\n\n        // 2. Available state\n        let state_available = KeyState {\n            status: KmKeyStatus::Available,\n            reset_time: None,\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_available), now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, None);\n\n        // 3. RateLimited, not expired\n        let state_limited_pending = KeyState {\n            status: KmKeyStatus::RateLimited,\n            reset_time: Some(future),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_limited_pending), now);\n        assert_eq!(status, \"limited\");\n        assert_eq!(reset_time, Some(future));\n\n        // 4. RateLimited, expired\n        let state_limited_expired = KeyState {\n            status: KmKeyStatus::RateLimited,\n            reset_time: Some(past),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_limited_expired), now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, Some(past));\n\n        // 5. Invalid\n        let state_invalid = KeyState {\n            status: KmKeyStatus::Invalid,\n            reset_time: None,\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_invalid), now);\n        assert_eq!(status, \"invalid\");\n        assert_eq!(reset_time, None);\n\n        // 6. TemporarilyUnavailable, not expired\n        let state_unavailable_pending = KeyState {\n            status: KmKeyStatus::TemporarilyUnavailable,\n            reset_time: Some(future),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_unavailable_pending), now);\n        assert_eq!(status, \"unavailable\");\n        assert_eq!(reset_time, Some(future));\n\n        // 7. TemporarilyUnavailable, expired\n        let state_unavailable_expired = KeyState {\n            status: KmKeyStatus::TemporarilyUnavailable,\n            reset_time: Some(past),\n        };\n        let (status, reset_time) = get_key_status_str(Some(\u0026state_unavailable_expired), now);\n        assert_eq!(status, \"available\");\n        assert_eq!(reset_time, Some(past));\n    }\n\n    // --- Tests for require_admin_token ---\n \n    async fn setup_state(admin_token: Option\u003cString\u003e) -\u003e (Arc\u003cAppState\u003e, TempDir) {\n        let temp_dir = tempfile::tempdir().unwrap();\n        let config_path = temp_dir.path().to_path_buf();\n        let mut config = AppConfig {\n            server: ServerConfig {\n                admin_token,\n                ..Default::default()\n            },\n            ..Default::default()\n        };\n        let app_state = Arc::new(\n            AppState::new(\u0026mut config, \u0026config_path)\n                .await\n                .unwrap(),\n        );\n        (app_state, temp_dir)\n    }\n \n     fn app(state: Arc\u003cAppState\u003e) -\u003e Router {\n        Router::new()\n            .route(\"/\", get(protected_handler))\n            .route_layer(from_fn_with_state(state.clone(), auth_middleware_wrapper))\n            .layer(CookieManagerLayer::new())\n            .with_state(state)\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_no_token_provided() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n             .oneshot(Request::builder().uri(\"/\").body(Body::empty()).unwrap())\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_bearer_valid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::AUTHORIZATION, \"Bearer secret_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_cookie_valid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::COOKIE, \"admin_token=secret_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_bearer_invalid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::AUTHORIZATION, \"Bearer wrong_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_cookie_invalid() {\n        let (state, _temp_dir) = setup_state(Some(\"secret_token\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n            .oneshot(\n                Request::builder()\n                    .uri(\"/\")\n                    .header(header::COOKIE, \"admin_token=wrong_token\")\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n    }\n\n    #[tokio::test]\n    async fn test_require_admin_token_no_token_configured() {\n        let (state, _temp_dir) = setup_state(Some(\"\".to_string())).await;\n        let app = app(state);\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .uri(\"/\")\n                     .header(header::AUTHORIZATION, \"Bearer any_token\")\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n     }\n \n     // --- Tests for csrf_middleware ---\n \n     async fn csrf_protected_handler() -\u003e StatusCode {\n         StatusCode::OK\n     }\n \n     fn csrf_app() -\u003e Router {\n         Router::new()\n             .route(\"/\", post(csrf_protected_handler))\n             .route_layer(middleware::from_fn(csrf_middleware))\n             .layer(CookieManagerLayer::new())\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_success() {\n         let app = csrf_app();\n         let token = \"correct_csrf_token\";\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, format!(\"csrf_token={}\", token))\n                     .header(\u0026X_CSRF_TOKEN, token)\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::OK);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_no_header() {\n         let app = csrf_app();\n         let token = \"correct_csrf_token\";\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, format!(\"csrf_token={}\", token))\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_no_cookie() {\n         let app = csrf_app();\n         let token = \"correct_csrf_token\";\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(\u0026X_CSRF_TOKEN, token)\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_mismatch() {\n         let app = csrf_app();\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, \"csrf_token=token_in_cookie\")\n                     .header(\u0026X_CSRF_TOKEN, \"token_in_header\")\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n \n     #[tokio::test]\n     async fn test_csrf_middleware_empty_tokens() {\n         let app = csrf_app();\n \n         let response = app\n             .oneshot(\n                 Request::builder()\n                     .method(\"POST\")\n                     .uri(\"/\")\n                     .header(header::COOKIE, \"csrf_token=\")\n                     .header(\u0026X_CSRF_TOKEN, \"\")\n                     .body(Body::empty())\n                     .unwrap(),\n             )\n             .await\n             .unwrap();\n \n         assert_eq!(response.status(), StatusCode::FORBIDDEN);\n     }\n }","traces":[{"line":47,"address":[11549632],"length":1,"stats":{"Line":4},"fn_name":null},{"line":49,"address":[11549648],"length":1,"stats":{"Line":4},"fn_name":null},{"line":54,"address":[5032905,5033026,5033586,5033138,5032989,5032880],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":55,"address":[11053868,11054024,11053822,11053925],"length":1,"stats":{"Line":2},"fn_name":null},{"line":56,"address":[11067246,11067313],"length":1,"stats":{"Line":2},"fn_name":null},{"line":57,"address":[11054300,11054367],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[11571984,11571992],"length":1,"stats":{"Line":4},"fn_name":null},{"line":63,"address":[11817793],"length":1,"stats":{"Line":2},"fn_name":null},{"line":64,"address":[11055171,11055093],"length":1,"stats":{"Line":2},"fn_name":null},{"line":66,"address":[5034258],"length":1,"stats":{"Line":1},"fn_name":null},{"line":68,"address":[11835477],"length":1,"stats":{"Line":2},"fn_name":null},{"line":70,"address":[11817833],"length":1,"stats":{"Line":1},"fn_name":null},{"line":71,"address":[11132453,11132526],"length":1,"stats":{"Line":2},"fn_name":null},{"line":72,"address":[11055945,11056015],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[11581712],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[11585056],"length":1,"stats":{"Line":0},"fn_name":"default"},{"line":85,"address":[4901144],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[11585088,11587414,11587276],"length":1,"stats":{"Line":1},"fn_name":"admin_routes"},{"line":92,"address":[11582711,11582423,11582275,11582127,11581782,11581979,11582571],"length":1,"stats":{"Line":7},"fn_name":null},{"line":93,"address":[11585266,11585247,11587538,11585379],"length":1,"stats":{"Line":2},"fn_name":null},{"line":94,"address":[4901471,4903443,4901478,4901587],"length":1,"stats":{"Line":2},"fn_name":null},{"line":95,"address":[11572538,11574476,11572519,11572651],"length":1,"stats":{"Line":2},"fn_name":null},{"line":96,"address":[11550462,11550575,11550443,11552233],"length":1,"stats":{"Line":2},"fn_name":null},{"line":97,"address":[11550591,11550723,11552214,11550610],"length":1,"stats":{"Line":2},"fn_name":null},{"line":98,"address":[11572963,11574419,11572974,11573064],"length":1,"stats":{"Line":2},"fn_name":null},{"line":101,"address":[11583884,11583503,11582776,11582911,11583207,11583355,11583059,11583799,11583651,11582838],"length":1,"stats":{"Line":10},"fn_name":null},{"line":102,"address":[4902198,4902221,4903340,4902327],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[11574346,11573435,11573303,11573322],"length":1,"stats":{"Line":2},"fn_name":null},{"line":104,"address":[4903304,4902491,4902607,4902498],"length":1,"stats":{"Line":2},"fn_name":null},{"line":105,"address":[11583427,11583314,11583295,11583998],"length":1,"stats":{"Line":2},"fn_name":null},{"line":106,"address":[11586790,11586903,11586771,11587304],"length":1,"stats":{"Line":2},"fn_name":null},{"line":107,"address":[11573895,11574027,11574258,11573914],"length":1,"stats":{"Line":2},"fn_name":null},{"line":108,"address":[11587067,11587254,11587086,11587191],"length":1,"stats":{"Line":2},"fn_name":null},{"line":109,"address":[11587199],"length":1,"stats":{"Line":1},"fn_name":null},{"line":222,"address":[11556672,11556753,11556768],"length":1,"stats":{"Line":1},"fn_name":"detailed_health"},{"line":225,"address":[11180204,11180069,11168636,11168434,11180002,11168501,11180374,11168806],"length":1,"stats":{"Line":2},"fn_name":null},{"line":226,"address":[5082029,5082108,5070813,5070892],"length":1,"stats":{"Line":2},"fn_name":null},{"line":227,"address":[11104178,11092610,11092700,11104268],"length":1,"stats":{"Line":2},"fn_name":null},{"line":228,"address":[11145855,11134287],"length":1,"stats":{"Line":1},"fn_name":null},{"line":229,"address":[11117353,11105785],"length":1,"stats":{"Line":1},"fn_name":null},{"line":230,"address":[11134332,11145900],"length":1,"stats":{"Line":1},"fn_name":null},{"line":231,"address":[11180959,11169391],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[11117410,11105842],"length":1,"stats":{"Line":1},"fn_name":null},{"line":234,"address":[11104405,11092837],"length":1,"stats":{"Line":1},"fn_name":null},{"line":235,"address":[11104577,11093009,11106113,11094545],"length":1,"stats":{"Line":0},"fn_name":null},{"line":237,"address":[11147919,11138740,11136254,11147822,11136351,11150308],"length":1,"stats":{"Line":0},"fn_name":null},{"line":238,"address":[11185299,11183057,11183009,11173731,11171441,11171349,11182917,11171489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":239,"address":[5073048,5084404,5084356,5073140,5073188,5086495,5084264,5075279],"length":1,"stats":{"Line":0},"fn_name":null},{"line":240,"address":[11108069,11119545,11108103,11107977,11110065,11119637,11121633,11119671],"length":1,"stats":{"Line":0},"fn_name":null},{"line":241,"address":[5091513,5092009,5091647,5084460,5084538,5073244,5092639,5092505,5073322,5092143],"length":1,"stats":{"Line":0},"fn_name":null},{"line":249,"address":[11106067,11117635],"length":1,"stats":{"Line":1},"fn_name":null},{"line":250,"address":[11146346,11134660,11134778,11146228],"length":1,"stats":{"Line":2},"fn_name":null},{"line":251,"address":[5072323,5082821,5083539,5071605],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[11093360,11104928],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[11116180,11126528,11126697,11114960,11116174,11115236,11115904,11126804,11116073,11126798,11115230,11115129],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":254,"address":[11144451,11155075,11143507],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[11115946,11115002,11126570],"length":1,"stats":{"Line":0},"fn_name":null},{"line":258,"address":[11113606,11102038,11102982],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[11170748,11182388,11182316,11170820],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[11147376,11135749,11147317,11135808],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[11171103,11171005,11182671,11182573],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[5072721,5072675,5083891,5083937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[11135066,11134938,11146634,11146506],"length":1,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[11146683,11135115],"length":1,"stats":{"Line":1},"fn_name":null},{"line":273,"address":[5083121,5071905,5072006,5083222],"length":1,"stats":{"Line":2},"fn_name":null},{"line":274,"address":[11840297],"length":1,"stats":{"Line":1},"fn_name":null},{"line":277,"address":[11185684,11174116],"length":1,"stats":{"Line":1},"fn_name":null},{"line":279,"address":[11174385,11185804,11174236,11185953],"length":1,"stats":{"Line":2},"fn_name":null},{"line":283,"address":[11140167,11151735],"length":1,"stats":{"Line":1},"fn_name":null},{"line":296,"address":[11175554,11187122],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[11189179,11177611],"length":1,"stats":{"Line":1},"fn_name":null},{"line":312,"address":[5079427,5090643],"length":1,"stats":{"Line":1},"fn_name":null},{"line":323,"address":[11118394,11118570,11118496,11118766],"length":1,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[11119271,11119332,11115805,11115572,11115511,11119565,11119401,11115641],"length":1,"stats":{"Line":2},"fn_name":null},{"line":328,"address":[5093781,5097318,5093718,5097381],"length":1,"stats":{"Line":2},"fn_name":null},{"line":329,"address":[11196548,11192788],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[5093858,5097458],"length":1,"stats":{"Line":1},"fn_name":null},{"line":332,"address":[5093925,5097525],"length":1,"stats":{"Line":1},"fn_name":null},{"line":334,"address":[5093940,5094010,5097610,5097540],"length":1,"stats":{"Line":2},"fn_name":null},{"line":336,"address":[11193115,11196875,11197280,11193520],"length":1,"stats":{"Line":1},"fn_name":null},{"line":337,"address":[11193540,11197376,11193616,11197300],"length":1,"stats":{"Line":0},"fn_name":null},{"line":342,"address":[11162351,11158591,11162316,11158556],"length":1,"stats":{"Line":2},"fn_name":null},{"line":345,"address":[11193750,11197510],"length":1,"stats":{"Line":1},"fn_name":null},{"line":346,"address":[11134003,11134062,11130243,11130302],"length":1,"stats":{"Line":0},"fn_name":null},{"line":351,"address":[11121839,11118079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":352,"address":[11158807,11158840,11162600,11162567],"length":1,"stats":{"Line":2},"fn_name":null},{"line":353,"address":[11130444,11134204],"length":1,"stats":{"Line":1},"fn_name":null},{"line":354,"address":[11121633,11117873,11121494,11117635,11117734,11121395],"length":1,"stats":{"Line":3},"fn_name":null},{"line":356,"address":[11130516,11130574,11134334,11134276],"length":1,"stats":{"Line":2},"fn_name":null},{"line":357,"address":[5098863,5095416,5095215,5099016,5095263,5098815],"length":1,"stats":{"Line":2},"fn_name":null},{"line":358,"address":[11194358,11198118,11194314,11198074],"length":1,"stats":{"Line":0},"fn_name":null},{"line":360,"address":[11194282,11198042],"length":1,"stats":{"Line":1},"fn_name":null},{"line":363,"address":[11134773,11131013],"length":1,"stats":{"Line":1},"fn_name":null},{"line":364,"address":[11134852,11131092],"length":1,"stats":{"Line":1},"fn_name":null},{"line":368,"address":[11196925,11193165],"length":1,"stats":{"Line":1},"fn_name":null},{"line":377,"address":[11592688,11592673,11592400],"length":1,"stats":{"Line":1},"fn_name":"verify_key"},{"line":383,"address":[5099841,5105665,5100002,5105922,5099753,5105577,5100098,5106495,5105826,5100671],"length":1,"stats":{"Line":2},"fn_name":null},{"line":385,"address":[11916944],"length":1,"stats":{"Line":1},"fn_name":null},{"line":388,"address":[11200977,11207073],"length":1,"stats":{"Line":1},"fn_name":null},{"line":390,"address":[11165399,11171495,11165841,11171937],"length":1,"stats":{"Line":2},"fn_name":null},{"line":391,"address":[5101171,5106995],"length":1,"stats":{"Line":1},"fn_name":null},{"line":392,"address":[5101446,5107270],"length":1,"stats":{"Line":1},"fn_name":null},{"line":393,"address":[11130321,11124225],"length":1,"stats":{"Line":1},"fn_name":null},{"line":396,"address":[5101193,5107017],"length":1,"stats":{"Line":0},"fn_name":null},{"line":404,"address":[11903946],"length":1,"stats":{"Line":2},"fn_name":null},{"line":405,"address":[11138826,11144664,11144922,11138245,11138568,11138516,11144612,11144341],"length":1,"stats":{"Line":4},"fn_name":null},{"line":406,"address":[11131414,11125318],"length":1,"stats":{"Line":1},"fn_name":null},{"line":407,"address":[5102777,5099904,5102875,5108641,5102817,5108965,5108601,5108699,5105728,5103141],"length":1,"stats":{"Line":4},"fn_name":null},{"line":409,"address":[5109059,5103163,5103235,5108987,5109800,5103976],"length":1,"stats":{"Line":3},"fn_name":null},{"line":410,"address":[11886334],"length":1,"stats":{"Line":1},"fn_name":null},{"line":413,"address":[11167710,11173806],"length":1,"stats":{"Line":1},"fn_name":null},{"line":422,"address":[5112946,5112876,5113130,5112778],"length":1,"stats":{"Line":1},"fn_name":null},{"line":428,"address":[11175412,11175506,11178532,11175329,11179308,11175617,11178626,11178737,11178449,11176188],"length":1,"stats":{"Line":2},"fn_name":null},{"line":430,"address":[11137787,11134477,11133878,11134667,11136998,11137597],"length":1,"stats":{"Line":1},"fn_name":null},{"line":431,"address":[11138761,11138028,11138098,11134908,11134978,11135641],"length":1,"stats":{"Line":3},"fn_name":null},{"line":432,"address":[7191547],"length":1,"stats":{"Line":1},"fn_name":null},{"line":435,"address":[5111848,5114792],"length":1,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[11558513,11558528,11558240],"length":1,"stats":{"Line":1},"fn_name":"add_keys"},{"line":450,"address":[11914406],"length":1,"stats":{"Line":2},"fn_name":null},{"line":453,"address":[11159960,11160219,11160041,11152619,11153272,11159307,11153531,11153353],"length":1,"stats":{"Line":2},"fn_name":null},{"line":456,"address":[11182339,11189027],"length":1,"stats":{"Line":1},"fn_name":null},{"line":457,"address":[11140835,11147523],"length":1,"stats":{"Line":1},"fn_name":null},{"line":459,"address":[11189547,11190744,11182545,11182662,11182859,11189233,11182712,11189400,11184056,11182455,11189350,11189143],"length":1,"stats":{"Line":4},"fn_name":null},{"line":462,"address":[11158545,11160807,11157617,11157600,11164288,11164305,11158528,11154119],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":463,"address":[11221237,11227904,11217835,11221216,11222144,11224425,11224523,11217737,11227925,11222165],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":465,"address":[5118057,5124489,5125310,5118878,5117852,5124284],"length":1,"stats":{"Line":3},"fn_name":null},{"line":466,"address":[11155326,11154686,11162014,11161907,11155219,11161374],"length":1,"stats":{"Line":3},"fn_name":null},{"line":467,"address":[11155367,11162055],"length":1,"stats":{"Line":1},"fn_name":null},{"line":472,"address":[11141707,11148395],"length":1,"stats":{"Line":1},"fn_name":null},{"line":473,"address":[5118310,5124742],"length":1,"stats":{"Line":0},"fn_name":null},{"line":474,"address":[5118252,5124684],"length":1,"stats":{"Line":0},"fn_name":null},{"line":479,"address":[5125393,5125995,5124715,5119563,5118428,5118283,5124860,5116188,5122620,5118961],"length":1,"stats":{"Line":3},"fn_name":null},{"line":482,"address":[11184488,11191176],"length":1,"stats":{"Line":1},"fn_name":null},{"line":485,"address":[11883796],"length":1,"stats":{"Line":2},"fn_name":null},{"line":487,"address":[5119975,5126407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[11590976,11590961,11590688],"length":1,"stats":{"Line":1},"fn_name":"delete_keys"},{"line":503,"address":[11171235,11170991,11165007,11164915,11165251,11165131,11170899,11171115,11171887,11165903],"length":1,"stats":{"Line":2},"fn_name":null},{"line":506,"address":[7098629],"length":1,"stats":{"Line":2},"fn_name":null},{"line":509,"address":[11159174,11153190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":510,"address":[5135145,5129286,5129417,5135014],"length":1,"stats":{"Line":2},"fn_name":null},{"line":512,"address":[11236159,11230880,11235979,11230082,11230219,11236350,11236864,11236066,11230366,11236203,11230175,11229995],"length":1,"stats":{"Line":4},"fn_name":null},{"line":515,"address":[11170241,11175248,11166592,11170224,11169281,11169264,11175265,11172576],"length":1,"stats":{"Line":3},"fn_name":"{closure#0}"},{"line":516,"address":[11162293,11162272,11153612,11156288,11159694,11153710,11156309,11157248,11159596,11157269],"length":1,"stats":{"Line":1},"fn_name":"{closure#1}"},{"line":518,"address":[11162478,11159811,11156494,11157454,11162464,11157440,11156480,11153827],"length":1,"stats":{"Line":3},"fn_name":"{closure#2}"},{"line":521,"address":[11201393,11195409],"length":1,"stats":{"Line":1},"fn_name":null},{"line":522,"address":[5135720,5129992],"length":1,"stats":{"Line":0},"fn_name":null},{"line":523,"address":[11166954,11172938],"length":1,"stats":{"Line":0},"fn_name":null},{"line":528,"address":[11193577,11201649,11196486,11202470,11201497,11201829,11199561,11195665,11195513,11195845],"length":1,"stats":{"Line":3},"fn_name":null},{"line":531,"address":[5136412,5130684],"length":1,"stats":{"Line":1},"fn_name":null},{"line":534,"address":[11805764],"length":1,"stats":{"Line":2},"fn_name":null},{"line":536,"address":[11174373,11168389],"length":1,"stats":{"Line":1},"fn_name":null},{"line":545,"address":[11240717,11240800,11240209,11240105,11241158,11240851,11240391,11240080,11240785,11240686,11240725,11239972,11239223,11239123,11241700,11240951,11240061,11240672,11239430,11241789,11240784,11239088,11240816],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":546,"address":[11886014],"length":1,"stats":{"Line":2},"fn_name":null},{"line":547,"address":[11204654,11206457,11206382,11204729],"length":1,"stats":{"Line":2},"fn_name":null},{"line":556,"address":[4910576,4910849,4910864],"length":1,"stats":{"Line":1},"fn_name":"update_config"},{"line":563,"address":[11170371,11165635,11166776,11170698,11165845,11165962,11171512,11170466,11165730,11170581],"length":1,"stats":{"Line":2},"fn_name":null},{"line":566,"address":[11184143,11179407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":567,"address":[11184271,11179535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":568,"address":[11247763,11243027],"length":1,"stats":{"Line":0},"fn_name":null},{"line":573,"address":[11825248],"length":1,"stats":{"Line":3},"fn_name":null},{"line":576,"address":[11184968,11185046,11180232,11178790,11180450,11183526,11185186,11180310],"length":1,"stats":{"Line":2},"fn_name":null},{"line":577,"address":[11244883,11244426,11249025,11249224,11249619,11249162,11244488,11244289],"length":1,"stats":{"Line":1},"fn_name":null},{"line":578,"address":[11168026,11172762],"length":1,"stats":{"Line":1},"fn_name":null},{"line":581,"address":[11242376,11249651,11244738,11244915,11247112,11249474],"length":1,"stats":{"Line":2},"fn_name":null},{"line":583,"address":[11173479,11168743],"length":1,"stats":{"Line":1},"fn_name":null},{"line":593,"address":[11582225,11582192,11582224,11582241,11582208,11582264,11582184,11582256,11582176],"length":1,"stats":{"Line":0},"fn_name":"get_metrics_summary"},{"line":595,"address":[11216585,11215625],"length":1,"stats":{"Line":0},"fn_name":null},{"line":599,"address":[11584240],"length":1,"stats":{"Line":2},"fn_name":"get_key_status_str"},{"line":603,"address":[4903499],"length":1,"stats":{"Line":2},"fn_name":null},{"line":604,"address":[11587628],"length":1,"stats":{"Line":2},"fn_name":null},{"line":605,"address":[11056256,11056261],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":606,"address":[11587692],"length":1,"stats":{"Line":2},"fn_name":null},{"line":607,"address":[4903684],"length":1,"stats":{"Line":2},"fn_name":null},{"line":608,"address":[11584483,11584612],"length":1,"stats":{"Line":2},"fn_name":null},{"line":609,"address":[11552669],"length":1,"stats":{"Line":1},"fn_name":null},{"line":610,"address":[4903717],"length":1,"stats":{"Line":2},"fn_name":null},{"line":611,"address":[11574820,11574965],"length":1,"stats":{"Line":2},"fn_name":null},{"line":612,"address":[11552715],"length":1,"stats":{"Line":1},"fn_name":null},{"line":614,"address":[11574840],"length":1,"stats":{"Line":2},"fn_name":null},{"line":616,"address":[11552479],"length":1,"stats":{"Line":1},"fn_name":null},{"line":621,"address":[11595416,11595408,11595393,11595377,11595344,11595336,11595376,11595328,11595360],"length":1,"stats":{"Line":0},"fn_name":"serve_dashboard"},{"line":622,"address":[11216876,11219244],"length":1,"stats":{"Line":0},"fn_name":null},{"line":625,"address":[5150597,5150445,5152795,5152869,5150719,5152717,5150523,5152991],"length":1,"stats":{"Line":0},"fn_name":null},{"line":626,"address":[11216962,11219825,11219330,11217604,11219972,11217457],"length":1,"stats":{"Line":0},"fn_name":null},{"line":628,"address":[11217828,11220196],"length":1,"stats":{"Line":0},"fn_name":null},{"line":638,"address":[11191974,11189505,11189606,11191873],"length":1,"stats":{"Line":0},"fn_name":null},{"line":640,"address":[11218209,11220577],"length":1,"stats":{"Line":0},"fn_name":null},{"line":645,"address":[11256720,11256679,11257341,11255840,11258279,11256849,11257409,11257470,11257424,11255933,11257440,11257310,11257533,11257296,11255870,11256590,11257032,11258190,11257408,11257349,11256745],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":646,"address":[11193949,11192349,11194033,11192433],"length":1,"stats":{"Line":2},"fn_name":null},{"line":652,"address":[11256163,11257698,11257924,11256098,11257763,11256324],"length":1,"stats":{"Line":3},"fn_name":null},{"line":655,"address":[11192748,11194348],"length":1,"stats":{"Line":1},"fn_name":null},{"line":658,"address":[11221452,11223052],"length":1,"stats":{"Line":1},"fn_name":null},{"line":659,"address":[5156194,5154658],"length":1,"stats":{"Line":1},"fn_name":null},{"line":660,"address":[11179810,11181410],"length":1,"stats":{"Line":1},"fn_name":null},{"line":665,"address":[11588016],"length":1,"stats":{"Line":2},"fn_name":"csrf_middleware"},{"line":671,"address":[5035606,5035759],"length":1,"stats":{"Line":4},"fn_name":null},{"line":673,"address":[11102731,11102704],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":676,"address":[11056829,11056746],"length":1,"stats":{"Line":4},"fn_name":null},{"line":679,"address":[11137897,11137888],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":682,"address":[11133517],"length":1,"stats":{"Line":2},"fn_name":null},{"line":683,"address":[11057375,11057220],"length":1,"stats":{"Line":4},"fn_name":null},{"line":685,"address":[11808888],"length":1,"stats":{"Line":5},"fn_name":null},{"line":689,"address":[11070862,11194809,11071406,11194943,11070213],"length":1,"stats":{"Line":6},"fn_name":null},{"line":690,"address":[11071334],"length":1,"stats":{"Line":2},"fn_name":null},{"line":697,"address":[4911696,4911681,4911488],"length":1,"stats":{"Line":1},"fn_name":"login"},{"line":702,"address":[11228423,11224007,11228553,11224301,11224137,11228717,11228484,11224068],"length":1,"stats":{"Line":2},"fn_name":null},{"line":703,"address":[11183105,11187521,11187442,11183026],"length":1,"stats":{"Line":2},"fn_name":null},{"line":705,"address":[11264176,11259760],"length":1,"stats":{"Line":1},"fn_name":null},{"line":706,"address":[11196307,11200723,11200647,11196231],"length":1,"stats":{"Line":2},"fn_name":null},{"line":707,"address":[5158178,5162663,5162482,5162767,5162830,5158359,5158526,5158463,5162428,5158124],"length":1,"stats":{"Line":5},"fn_name":null},{"line":711,"address":[5158390,5162655,5162694,5158351],"length":1,"stats":{"Line":2},"fn_name":null},{"line":712,"address":[11260346,11260266,11260242,11264658,11264395,11264762,11260458,11259979,11264874,11264682],"length":1,"stats":{"Line":2},"fn_name":null},{"line":714,"address":[11229753,11225337],"length":1,"stats":{"Line":1},"fn_name":null},{"line":717,"address":[11188317,11183245,11184429,11183901,11190543,11191535,11191401,11187661,11188845,11190409,11191039,11190905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":718,"address":[11197397,11201813],"length":1,"stats":{"Line":0},"fn_name":null},{"line":724,"address":[11552896],"length":1,"stats":{"Line":2},"fn_name":"require_admin_token"},{"line":730,"address":[11103173,11103222,11103291,11103447],"length":1,"stats":{"Line":4},"fn_name":null},{"line":731,"address":[11075188,11075267],"length":1,"stats":{"Line":4},"fn_name":null},{"line":733,"address":[11139001,11144048,11144075,11138920],"length":1,"stats":{"Line":8},"fn_name":"{closure#0}"},{"line":735,"address":[5041392,5046555,5046528],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":737,"address":[11139172],"length":1,"stats":{"Line":2},"fn_name":null},{"line":739,"address":[11075695],"length":1,"stats":{"Line":2},"fn_name":null},{"line":740,"address":[11063015,11062852],"length":1,"stats":{"Line":4},"fn_name":null},{"line":741,"address":[11063213,11062914],"length":1,"stats":{"Line":2},"fn_name":null},{"line":742,"address":[5042154,5042717,5166639,5166505],"length":1,"stats":{"Line":2},"fn_name":null},{"line":746,"address":[11076753],"length":1,"stats":{"Line":1},"fn_name":null},{"line":749,"address":[11075837,11078771,11205417,11078243,11205551],"length":1,"stats":{"Line":3},"fn_name":null},{"line":753,"address":[11078715],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":189,"coverable":228},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","config.rs"],"content":"// src/config.rs\nuse serde::{Deserialize, Serialize};\nuse std::{collections::HashSet, fs, io, path::Path};\nuse tracing::{debug, error, info, warn};\nuse url::Url;\nuse uuid::Uuid;\n\nuse crate::error::{AppError, Result};\n\n// --- Data Structures ---\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Serialize)]\n#[serde(deny_unknown_fields)]\npub struct KeyGroup {\n    pub name: String,\n    #[serde(default)]\n    pub api_keys: Vec\u003cString\u003e,\n    #[serde(default)]\n    pub proxy_url: Option\u003cString\u003e,\n    #[serde(default = \"default_target_url\")]\n    pub target_url: String,\n    #[serde(default)]\n    pub top_p: Option\u003cf32\u003e,\n}\n\nimpl Default for KeyGroup {\n    fn default() -\u003e Self {\n        Self {\n            name: String::new(),\n            api_keys: Vec::new(),\n            proxy_url: None,\n            target_url: default_target_url(),\n            top_p: None,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Eq, Default, Serialize)]\n#[serde(rename_all = \"camelCase\")]\npub enum RateLimitBehavior {\n    BlockUntilMidnight,\n    #[default]\n    RetryNextKey,\n}\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Default, Serialize)]\n#[serde(deny_unknown_fields)]\npub struct AppConfig {\n    #[serde(default)]\n    pub server: ServerConfig,\n    #[serde(default)]\n    pub groups: Vec\u003cKeyGroup\u003e,\n    #[serde(default)]\n    pub rate_limit_behavior: RateLimitBehavior,\n    #[serde(default = \"default_internal_retries\")]\n    pub internal_retries: u32,\n    #[serde(default = \"default_temporary_block_minutes\")]\n    pub temporary_block_minutes: i64,\n}\n\n#[derive(Debug, Deserialize, Clone, PartialEq, Serialize)]\n#[serde(deny_unknown_fields)]\npub struct ServerConfig {\n    #[serde(default = \"default_server_port\")]\n    pub port: u16,\n    #[serde(default)]\n    pub top_p: Option\u003cf32\u003e,\n    #[serde(default)]\n    pub admin_token: Option\u003cString\u003e,\n}\n\n// --- Default Implementations ---\n\nimpl Default for ServerConfig {\n    fn default() -\u003e Self {\n        Self {\n            port: default_server_port(),\n            top_p: None,\n            admin_token: None,\n        }\n    }\n}\nconst fn default_server_port() -\u003e u16 {\n    8080\n}\n\nconst fn default_internal_retries() -\u003e u32 {\n    2\n}\n\nconst fn default_temporary_block_minutes() -\u003e i64 {\n    5\n}\n\nfn default_target_url() -\u003e String {\n    \"https://generativelanguage.googleapis.com/\".to_string()\n}\n\n// --- Helper Functions ---\n\nfn clean_target_url(url_str: \u0026str) -\u003e String {\n    url_str.strip_suffix('/').unwrap_or(url_str).to_string()\n}\n\n// --- Configuration Validation Functions ---\nfn validate_server_config(server: \u0026ServerConfig) -\u003e bool {\n    let mut errors = 0;\n    // Port 0 is valid, it means the OS will assign a random available port.\n    if server.port != 0 \u0026\u0026 (server.port \u003c 1024) {\n        warn!(p = server.port, w = \"low server port warning\");\n    }\n    if let Some(tp) = server.top_p {\n        if !(0.0..=1.0).contains(\u0026tp) {\n            error!(err = \"server top_p out of range\", top_p = tp);\n            errors += 1;\n        }\n    }\n    errors == 0\n}\nfn validate_target_url(g: \u0026str, url: \u0026str) -\u003e bool {\n    match Url::parse(url) {\n        Ok(p) =\u003e {\n            if !p.has_host()\n                || p.host_str().is_none_or(str::is_empty)\n                || p.cannot_be_a_base()\n            {\n                error!(group = g, err = \"invalid/base\", url = %url);\n                false\n            } else {\n                true\n            }\n        }\n        Err(e) =\u003e {\n            error!(group = g, err = %e, url = %url, \"target parse err\");\n            false\n        }\n    }\n}\nfn validate_proxy_url(g: \u0026str, url: \u0026str) -\u003e bool {\n    match Url::parse(url) {\n        Ok(p) =\u003e {\n            if !p.has_host() || p.host_str().is_none_or(str::is_empty) {\n                error!(group = g, err = \"no_host\", url = %url);\n                return false;\n            }\n            let s = p.scheme().to_lowercase();\n            if [\"http\", \"https\", \"socks5\"].contains(\u0026s.as_str()) {\n                true\n            } else {\n                error!(group = g, err = \"bad_scheme\", url = %url, scheme = %s);\n                false\n            }\n        }\n        Err(e) =\u003e {\n            error!(group = g, err = %e, url = %url, \"proxy parse err\");\n            false\n        }\n    }\n}\n\n#[tracing::instrument(level = \"debug\", skip(cfg, source), fields(cfg.source = %source))]\npub fn validate_config(cfg: \u0026mut AppConfig, source: \u0026str) -\u003e bool {\n    let mut errors = 0;\n    if !validate_server_config(\u0026cfg.server) {\n        errors += 1;\n    }\n\n    if cfg.groups.is_empty() {\n        error!(source = source, err = \"no_groups\");\n        errors += 1;\n    } else {\n        let mut names = HashSet::new();\n        let mut keys_total = 0;\n        for group in \u0026mut cfg.groups {\n            let name = group.name.trim();\n            if name.is_empty() {\n                // Check for empty name first\n                error!(err = \"empty_name\");\n                errors += 1;\n            } else {\n                // Only check for duplicates if name is not empty\n                let upper_name = group.name.to_uppercase(); // Use uppercase for HashSet check\n                debug!(group.name = %group.name, group.upper = %upper_name, ?names, \"Attempting to insert into HashSet\"); // Added debug before insert\n                let insert_result = names.insert(upper_name.clone());\n                debug!(group.name = %group.name, group.upper = %upper_name, set.insert_result = insert_result, set.current_size = names.len(), \"Checking group name for duplicates\");\n                if !insert_result {\n                    // Check duplicate result\n                    error!(group = %group.name, err = \"duplicate\");\n                    errors += 1;\n                }\n            }\n            // Check for empty keys independently\n            if group.api_keys.is_empty() {\n                warn!(group = %group.name, warn = \"no_keys\"); /* Group without keys is warned, but not instant error */\n            }\n            keys_total += group.api_keys.len();\n\n            // Clean the target URL in-place\n            group.target_url = clean_target_url(\u0026group.target_url);\n\n            if !validate_target_url(\u0026group.name, \u0026group.target_url) {\n                errors += 1;\n            }\n            if let Some(p) = \u0026group.proxy_url {\n                if !validate_proxy_url(\u0026group.name, p) {\n                    errors += 1;\n                }\n            }\n            if let Some(tp) = group.top_p {\n                if !(0.0..=1.0).contains(\u0026tp) {\n                    error!(group = %group.name, err = \"top_p_out_of_range\", top_p = tp);\n                    errors += 1;\n                }\n            }\n        }\n        // Error only if total keys across all groups is zero (ignoring groups that might have been defined but had no keys)\n        if keys_total == 0 {\n            error!(err = \"no_usable_keys\");\n            errors += 1;\n        }\n    }\n    if errors \u003e 0 {\n        error!(count = errors, \"Validation finished: ERRORS.\");\n        false\n    } else {\n        debug!(\"Validation OK.\");\n        true\n    }\n}\n\n// --- Main Loading Function ---\n#[tracing::instrument(level = \"info\", skip(path), fields(config.path = %path.display()))]\n/// Loads the application configuration from a YAML file.\n///\n/// # Arguments\n/// * `path` - The path to the configuration YAML file.\n///\n/// # Errors\n/// Returns an `AppError::Config` if:\n/// - The YAML file cannot be read or parsed.\n/// - Validation of the final configuration fails.\n/// - Any I/O error occurs during file reading.\npub fn load_config(path: \u0026Path) -\u003e Result\u003cAppConfig\u003e {\n    let path_str = path.display().to_string();\n    let contents = match fs::read_to_string(path) {\n        Ok(c) =\u003e c,\n        Err(e) if e.kind() == io::ErrorKind::NotFound =\u003e {\n            error!(src = \"yaml\", path = %path_str, \"Config file not found.\");\n            return Err(AppError::Config(format!(\n                \"Config file not found: {path_str}\"\n            )));\n        }\n        Err(e) =\u003e {\n            error!(src = \"yaml\", e = %e, \"Read error\");\n            return Err(AppError::Io(io::Error::new(\n                e.kind(),\n                format!(\"Read error {path_str}: {e}\"),\n            )));\n        }\n    };\n\n    if contents.trim().is_empty() {\n        warn!(src = \"yaml\", \"Config file is empty.\");\n        return Err(AppError::Config(format!(\n            \"Config file is empty: {path_str}\"\n        )));\n    }\n\n    let mut config: AppConfig = match serde_yaml::from_str(\u0026contents) {\n        Ok(cfg) =\u003e cfg,\n        Err(e) =\u003e {\n            error!(src = \"yaml\", e = %e, \"Parse error\");\n            return Err(AppError::Config(format!(\n                \"Failed to parse config file {path_str}: {e}\"\n            )));\n        }\n    };\n\n    if !validate_config(\u0026mut config, \u0026path_str) {\n        error!(config.source = %path_str, \"Validation failed.\");\n        return Err(AppError::Config(\"Validation failed\".to_string()));\n    }\n\n    info!(\n        groups = config.groups.len(),\n        keys_total = config\n            .groups\n            .iter()\n            .map(|g| g.api_keys.len())\n            .sum::\u003cusize\u003e(),\n        \"Config loaded OK.\"\n    );\n    Ok(config)\n}\n\n/// Asynchronously saves the application configuration to a YAML file atomically.\n///\n/// # Arguments\n/// * `config` - A reference to the `AppConfig` to be saved.\n/// * `path` - The path to the target configuration YAML file.\n///\n/// # Errors\n/// Returns an `AppError` if:\n/// - The configuration cannot be serialized to YAML.\n/// - The parent directory of the path does not exist.\n/// - The temporary file cannot be written.\n/// - The temporary file cannot be renamed to the final path.\n#[tracing::instrument(level = \"info\", skip(config, path), fields(config.path = %path.display()))]\npub async fn save_config(config: \u0026AppConfig, path: \u0026Path) -\u003e Result\u003c()\u003e {\n    let yaml_data = serde_yaml::to_string(config).map_err(|e| {\n        error!(error = %e, \"Failed to serialize AppConfig to YAML\");\n        AppError::Config(format!(\"Failed to serialize config: {e}\"))\n    })?;\n\n    let parent_dir = path.parent().ok_or_else(|| {\n        error!(\"Config file path has no parent directory\");\n        AppError::Io(io::Error::new(\n            io::ErrorKind::InvalidInput,\n            \"Config file path has no parent directory\",\n        ))\n    })?;\n\n    tokio::fs::create_dir_all(parent_dir).await?;\n\n    let base_filename = path.file_name().unwrap_or_default().to_string_lossy();\n    let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n    let temp_path = parent_dir.join(\u0026temp_filename);\n\n    tokio::fs::write(\u0026temp_path, yaml_data).await?;\n\n    if let Err(e) = tokio::fs::rename(\u0026temp_path, path).await {\n        error!(\n            from = %temp_path.display(),\n            to = %path.display(),\n            error = ?e,\n            \"Failed to atomically rename temporary config file\"\n        );\n        // Attempt to clean up the temp file on rename failure\n        if let Err(rm_err) = tokio::fs::remove_file(\u0026temp_path).await {\n            warn!(\n                temp_file.path = %temp_path.display(),\n                error = ?rm_err,\n                \"Failed to remove temporary file after rename failure\"\n            );\n        }\n        return Err(e.into());\n    }\n\n    info!(\"Successfully saved configuration.\");\n    Ok(())\n}\n\n// --- Tests ---\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::fs::File;\n    use std::io::Write;\n    use std::path::PathBuf;\n    use tempfile::tempdir;\n    fn create_temp_config_file(d: \u0026tempfile::TempDir, c: \u0026str) -\u003e PathBuf {\n        let p = d.path().join(\"t.yaml\");\n        File::create(\u0026p)\n            .unwrap()\n            .write_all(c.as_bytes())\n            .unwrap();\n        p\n    }\n    #[test]\n    fn test_clean_url() {\n        assert_eq!(clean_target_url(\"h://a/p/\"), \"h://a/p\");\n        assert_eq!(clean_target_url(\"h://a/p\"), \"h://a/p\");\n    }\n    #[test]\n    fn test_val_srv() {\n        // Default config should be valid\n        assert!(validate_server_config(\u0026ServerConfig::default()));\n        // Port 0 is now considered valid for testing purposes (OS assigns a random port)\n        assert!(validate_server_config(\u0026ServerConfig {\n            port: 0,\n            top_p: None,\n            admin_token: None,\n        }));\n    }\n    #[test]\n    fn test_val_target_ok() {\n        assert!(validate_target_url(\"g\", \"https://e.com\"));\n    }\n    #[test]\n    fn test_val_target_bad() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        assert!(!validate_target_url(\"g\", \":b\"));\n        assert!(!validate_target_url(\"g\", \"e.com\"));\n        assert!(!validate_target_url(\"g\", \"https://\"));\n        assert!(!validate_target_url(\"g\", \"\"));\n        assert!(!validate_target_url(\"g\", \"http://\"));\n    }\n    #[test]\n    fn test_val_proxy_ok() {\n        assert!(validate_proxy_url(\"g\", \"http://p\"));\n        assert!(validate_proxy_url(\"g\", \"socks5://p\"));\n    }\n    #[test]\n    fn test_val_proxy_bad() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        assert!(!validate_proxy_url(\"g\", \":b\"));\n        assert!(!validate_proxy_url(\"g\", \"ftp://p\"));\n        assert!(!validate_proxy_url(\"g\", \"http://\"));\n        assert!(!validate_proxy_url(\"g\", \"socks5://\"));\n        assert!(!validate_proxy_url(\"g\", \"\"));\n    }\n    #[test]\n    fn test_val_cfg_ok() {\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"G\".into(),\n                api_keys: vec![\"k\".into()],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_bad_name() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"\".into(),\n                api_keys: vec![\"k\".into()],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_dupe_name() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![\n                KeyGroup {\n                    name: \"N\".into(),\n                    api_keys: vec![\"k\".into()],\n                    proxy_url: None,\n                    target_url: default_target_url(),\n                    top_p: None,\n                },\n                KeyGroup {\n                    name: \"n\".into(),\n                    api_keys: vec![\"k\".into()],\n                    proxy_url: None,\n                    target_url: default_target_url(),\n                    top_p: None,\n                },\n            ],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_empty_keys_ok() {\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"G\".into(),\n                api_keys: vec![\"k1\".to_string(), \"k3\".to_string()],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(validate_config(\u0026mut cfg, \"\"));\n    }\n    #[test]\n    fn test_val_cfg_no_keys() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![KeyGroup {\n                name: \"G\".into(),\n                api_keys: vec![],\n                proxy_url: None,\n                target_url: default_target_url(),\n                top_p: None,\n            }],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    } // Should fail validation as total keys = 0\n    #[test]\n    fn test_val_cfg_no_groups() {\n        let _ = tracing::subscriber::set_default(\n            tracing_subscriber::fmt()\n                .with_max_level(tracing::Level::WARN)\n                .finish(),\n        );\n        let mut cfg = AppConfig {\n            groups: vec![],\n            ..Default::default()\n        };\n        assert!(!validate_config(\u0026mut cfg, \"\"));\n    }\n\n    #[test]\n    fn test_load_no_groups_from_file() {\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, \"server:\\n  port: 1\\n\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Validation failed\"))\n        );\n    }\n\n    #[test]\n    fn test_load_config_from_file_ok() {\n        let yaml_content = r#\"\nserver:\n  port: 8081\ngroups:\n  - name: \"Group1\"\n    api_keys: [\"key1\", \"key2\"]\n    target_url: \"https://api.example.com/\"\n    proxy_url: \"http://proxy.example.com\"\n    top_p: 0.9\n\"#;\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, yaml_content);\n        let cfg = load_config(\u0026p).expect(\"Should load config successfully\");\n\n        assert_eq!(cfg.server.port, 8081);\n        assert_eq!(cfg.groups.len(), 1);\n        let group = \u0026cfg.groups[0];\n        assert_eq!(group.name, \"Group1\");\n        assert_eq!(group.api_keys, vec![\"key1\", \"key2\"]);\n        assert_eq!(group.target_url, \"https://api.example.com\"); // Note trailing slash is removed\n        assert_eq!(group.proxy_url, Some(\"http://proxy.example.com\".to_string()));\n        assert_eq!(group.top_p, Some(0.9));\n    }\n\n    #[test]\n    fn test_load_config_file_not_found() {\n        let d = tempdir().unwrap();\n        let p = d.path().join(\"non_existent_config.yaml\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Config file not found\"))\n        );\n    }\n\n    #[test]\n    fn test_load_empty_config_file() {\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, \"\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Config file is empty\"))\n        );\n    }\n\n    #[test]\n    fn test_load_bad_yaml() {\n        let d = tempdir().unwrap();\n        let p = create_temp_config_file(\u0026d, \"server: { port: 123,\");\n        let r = load_config(\u0026p);\n        assert!(\n            r.is_err() \u0026\u0026 matches!(r.err(), Some(AppError::Config(m)) if m.contains(\"Failed to parse config file\"))\n        );\n    }\n} // end tests module\n","traces":[{"line":27,"address":[11479396,11479072,11479371],"length":1,"stats":{"Line":1},"fn_name":"default"},{"line":29,"address":[6592693],"length":1,"stats":{"Line":1},"fn_name":null},{"line":30,"address":[11500618],"length":1,"stats":{"Line":1},"fn_name":null},{"line":32,"address":[6592772],"length":1,"stats":{"Line":1},"fn_name":null},{"line":75,"address":[6593008],"length":1,"stats":{"Line":2},"fn_name":"default"},{"line":77,"address":[11479422],"length":1,"stats":{"Line":2},"fn_name":null},{"line":83,"address":[25287760,25287733,25287769],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}\u003creqwest::config::RequestTimeout\u003e"},{"line":84,"address":[13276864,13277825,13277927],"length":1,"stats":{"Line":0},"fn_name":null},{"line":87,"address":[25155808],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[25155817],"length":1,"stats":{"Line":0},"fn_name":null},{"line":95,"address":[11501088],"length":1,"stats":{"Line":2},"fn_name":"default_target_url"},{"line":96,"address":[11479576],"length":1,"stats":{"Line":2},"fn_name":null},{"line":101,"address":[13277623],"length":1,"stats":{"Line":2},"fn_name":null},{"line":102,"address":[11511570],"length":1,"stats":{"Line":2},"fn_name":null},{"line":106,"address":[11514256,11515105],"length":1,"stats":{"Line":2},"fn_name":"validate_server_config"},{"line":107,"address":[11479735],"length":1,"stats":{"Line":2},"fn_name":null},{"line":109,"address":[11479789,11479746],"length":1,"stats":{"Line":4},"fn_name":null},{"line":110,"address":[11511717,11512483],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[11514305,11516054],"length":1,"stats":{"Line":2},"fn_name":null},{"line":113,"address":[11515205,11513444],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[5335353,5335487],"length":1,"stats":{"Line":0},"fn_name":null},{"line":115,"address":[11515210,11515198,11514336],"length":1,"stats":{"Line":0},"fn_name":null},{"line":118,"address":[6595150],"length":1,"stats":{"Line":2},"fn_name":null},{"line":120,"address":[11520898,11517856,11520904],"length":1,"stats":{"Line":2},"fn_name":"validate_target_url"},{"line":121,"address":[11484170,11483351],"length":1,"stats":{"Line":2},"fn_name":null},{"line":122,"address":[11518007],"length":1,"stats":{"Line":2},"fn_name":null},{"line":123,"address":[6597159,6597236,6597890],"length":1,"stats":{"Line":4},"fn_name":null},{"line":124,"address":[11515593],"length":1,"stats":{"Line":2},"fn_name":null},{"line":125,"address":[11518307],"length":1,"stats":{"Line":2},"fn_name":null},{"line":127,"address":[11505162,11505819,11505348,11505692],"length":1,"stats":{"Line":0},"fn_name":null},{"line":128,"address":[11505806],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[11505314],"length":1,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[11515337],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[10848351,10848217],"length":1,"stats":{"Line":2},"fn_name":null},{"line":135,"address":[11519558],"length":1,"stats":{"Line":1},"fn_name":null},{"line":139,"address":[11520848,11524625,11527159],"length":1,"stats":{"Line":1},"fn_name":"validate_proxy_url"},{"line":140,"address":[11524544,11523526],"length":1,"stats":{"Line":1},"fn_name":null},{"line":141,"address":[13174027,13173008,13173989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":142,"address":[6602904,6602867,6602790],"length":1,"stats":{"Line":3},"fn_name":null},{"line":143,"address":[11510793,11514238,11514721],"length":1,"stats":{"Line":3},"fn_name":null},{"line":144,"address":[11527718],"length":1,"stats":{"Line":1},"fn_name":null},{"line":146,"address":[6602990],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[11521463,11521566,11522044,11521380],"length":1,"stats":{"Line":4},"fn_name":null},{"line":148,"address":[13279830,13279613],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[13292834],"length":1,"stats":{"Line":3},"fn_name":null},{"line":151,"address":[11511636],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[13425000],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[5337833,5337967],"length":1,"stats":{"Line":2},"fn_name":null},{"line":156,"address":[11528437],"length":1,"stats":{"Line":1},"fn_name":null},{"line":162,"address":[11522688,11550210,11524329],"length":1,"stats":{"Line":2},"fn_name":"validate_config"},{"line":163,"address":[11536220],"length":1,"stats":{"Line":2},"fn_name":null},{"line":164,"address":[6616859,6615255,6616794],"length":1,"stats":{"Line":4},"fn_name":null},{"line":165,"address":[11537776,11537841,11537832],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[11535183,11535244,11556495],"length":1,"stats":{"Line":5},"fn_name":null},{"line":169,"address":[10592783,10592649],"length":1,"stats":{"Line":3},"fn_name":null},{"line":170,"address":[6636385,6638056,6638068],"length":1,"stats":{"Line":2},"fn_name":null},{"line":172,"address":[11524850],"length":1,"stats":{"Line":2},"fn_name":null},{"line":173,"address":[11503388],"length":1,"stats":{"Line":2},"fn_name":null},{"line":174,"address":[13175025,13174992,13175100,13175072],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":175,"address":[11540074,11538145],"length":1,"stats":{"Line":4},"fn_name":null},{"line":176,"address":[11527105,11538163],"length":1,"stats":{"Line":3},"fn_name":null},{"line":178,"address":[13294050],"length":1,"stats":{"Line":3},"fn_name":null},{"line":179,"address":[13175340,13175312,13175265,13175232],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":182,"address":[11527140,11527210],"length":1,"stats":{"Line":4},"fn_name":null},{"line":183,"address":[10725257,10725391],"length":1,"stats":{"Line":6},"fn_name":null},{"line":184,"address":[13426444,13426336,13426369,13426416],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":185,"address":[13294336],"length":1,"stats":{"Line":4},"fn_name":null},{"line":186,"address":[6623013,6628311],"length":1,"stats":{"Line":3},"fn_name":null},{"line":188,"address":[13175650],"length":1,"stats":{"Line":3},"fn_name":null},{"line":189,"address":[11534559,11536316,11536328],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[11514837,11516676],"length":1,"stats":{"Line":4},"fn_name":null},{"line":194,"address":[11548636],"length":1,"stats":{"Line":1},"fn_name":null},{"line":196,"address":[11516690,11519014,11518942],"length":1,"stats":{"Line":4},"fn_name":null},{"line":199,"address":[11540507,11540617,11540579],"length":1,"stats":{"Line":4},"fn_name":null},{"line":201,"address":[11519192,11519436],"length":1,"stats":{"Line":2},"fn_name":null},{"line":202,"address":[11540949,11540861,11540958],"length":1,"stats":{"Line":0},"fn_name":null},{"line":204,"address":[11553916,11554019],"length":1,"stats":{"Line":3},"fn_name":null},{"line":205,"address":[11554027,11554118,11554239],"length":1,"stats":{"Line":2},"fn_name":null},{"line":206,"address":[11554204,11554244],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[6633014,6633229],"length":1,"stats":{"Line":3},"fn_name":null},{"line":210,"address":[6633243,6635896],"length":1,"stats":{"Line":1},"fn_name":null},{"line":211,"address":[10727375,10727241],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[6633780,6635889,6635901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[11535547,11537389],"length":1,"stats":{"Line":3},"fn_name":null},{"line":218,"address":[10727737,10727871],"length":1,"stats":{"Line":3},"fn_name":null},{"line":219,"address":[6619030,6619018,6617707],"length":1,"stats":{"Line":2},"fn_name":null},{"line":222,"address":[6619051,6638619,6640442],"length":1,"stats":{"Line":5},"fn_name":null},{"line":223,"address":[10583593,10583727],"length":1,"stats":{"Line":4},"fn_name":null},{"line":224,"address":[11526946],"length":1,"stats":{"Line":1},"fn_name":null},{"line":226,"address":[5342927,5342793],"length":1,"stats":{"Line":6},"fn_name":null},{"line":227,"address":[13295328],"length":1,"stats":{"Line":2},"fn_name":null},{"line":243,"address":[11583688,11565003,11563280],"length":1,"stats":{"Line":1},"fn_name":"load_config"},{"line":244,"address":[11563805,11565500],"length":1,"stats":{"Line":2},"fn_name":null},{"line":245,"address":[11565559,11565622],"length":1,"stats":{"Line":2},"fn_name":null},{"line":246,"address":[11563076],"length":1,"stats":{"Line":1},"fn_name":null},{"line":247,"address":[11577588,11577689,11565667],"length":1,"stats":{"Line":3},"fn_name":null},{"line":248,"address":[10855161,10855295],"length":1,"stats":{"Line":3},"fn_name":null},{"line":249,"address":[11578633,11580697],"length":1,"stats":{"Line":2},"fn_name":null},{"line":253,"address":[11543093],"length":1,"stats":{"Line":0},"fn_name":null},{"line":254,"address":[10855657,10855791],"length":1,"stats":{"Line":0},"fn_name":null},{"line":255,"address":[11567561],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[6657111],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[6659252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[6644708,6644791],"length":1,"stats":{"Line":2},"fn_name":null},{"line":263,"address":[10585711,10585577],"length":1,"stats":{"Line":3},"fn_name":null},{"line":264,"address":[11562531,11564247],"length":1,"stats":{"Line":2},"fn_name":null},{"line":269,"address":[11566007,11565937],"length":1,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[11563486],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[11553039],"length":1,"stats":{"Line":1},"fn_name":null},{"line":272,"address":[5344777,5344911],"length":1,"stats":{"Line":3},"fn_name":null},{"line":273,"address":[11570032,11572194],"length":1,"stats":{"Line":2},"fn_name":null},{"line":279,"address":[6645202,6645289],"length":1,"stats":{"Line":2},"fn_name":null},{"line":280,"address":[5345407,5345273],"length":1,"stats":{"Line":3},"fn_name":null},{"line":281,"address":[11566114,11564298],"length":1,"stats":{"Line":2},"fn_name":null},{"line":284,"address":[11569516,11568887,11571747,11566428,11570456,11571419,11570784],"length":1,"stats":{"Line":3},"fn_name":null},{"line":285,"address":[11568744,11567781],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[11571559,11570596],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[10858080,10858153,10858105,10858128],"length":1,"stats":{"Line":0},"fn_name":"{closure#6}"},{"line":293,"address":[6648259],"length":1,"stats":{"Line":1},"fn_name":null},{"line":309,"address":[5346526,5346351,5346602,5346304,5349596,5347809,5348633],"length":1,"stats":{"Line":5},"fn_name":"{async_fn#0}"},{"line":310,"address":[10603588,10591187,10605607,10603136,10591342,10605601,10591946,10590988],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":311,"address":[10603590,10607231,10603167,10607097,10603246,10603734],"length":1,"stats":{"Line":0},"fn_name":null},{"line":312,"address":[10616728,10618438],"length":1,"stats":{"Line":0},"fn_name":null},{"line":315,"address":[10876771,10862288,10876208,10862037,10862500,10862141],"length":1,"stats":{"Line":2},"fn_name":"{closure#1}"},{"line":316,"address":[5364777,5364612,5366009,5366143,5364065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":317,"address":[10606298],"length":1,"stats":{"Line":0},"fn_name":null},{"line":318,"address":[10750930],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[7116319],"length":1,"stats":{"Line":2},"fn_name":null},{"line":325,"address":[10736989],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[10863125,10863046],"length":1,"stats":{"Line":2},"fn_name":null},{"line":327,"address":[10737355],"length":1,"stats":{"Line":1},"fn_name":null},{"line":329,"address":[10864095,10861649,10863376,10863508,10863610],"length":1,"stats":{"Line":3},"fn_name":null},{"line":331,"address":[10591094,10593386,10593547],"length":1,"stats":{"Line":2},"fn_name":null},{"line":332,"address":[10596945,10608223,10593956,10595445,10594469,10593850,10608089,10596683,10595707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[10595339,10596577],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[10740276,10741514],"length":1,"stats":{"Line":0},"fn_name":null},{"line":339,"address":[10739068,10735755,10742161,10744245],"length":1,"stats":{"Line":0},"fn_name":null},{"line":340,"address":[5360823,5358368,5358487,5359945,5358988,5367001,5367135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[5359855,5360733],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[10747508,10747580],"length":1,"stats":{"Line":0},"fn_name":null},{"line":349,"address":[10611200,10622105,10622239,10610642],"length":1,"stats":{"Line":2},"fn_name":null},{"line":350,"address":[10611159],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":108,"coverable":142},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","config_watcher.rs"],"content":"// src/config_watcher.rs\n\nuse crate::config::{load_config, AppConfig};\nuse crate::error::{AppError, Result};\nuse notify::{Config, Event, RecommendedWatcher, RecursiveMode, Watcher};\nuse std::path::{Path, PathBuf};\nuse std::sync::Arc;\nuse tokio::sync::{mpsc, RwLock};\nuse tracing::{debug, error, info, warn};\n\n/// Configuration watcher that monitors config file changes\npub struct ConfigWatcher {\n    config_path: PathBuf,\n    current_config: Arc\u003cRwLock\u003cAppConfig\u003e\u003e,\n    _watcher: RecommendedWatcher,\n    receiver: mpsc::Receiver\u003cResult\u003cAppConfig\u003e\u003e,\n}\n\nimpl ConfigWatcher {\n    /// Create a new config watcher\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if the initial configuration cannot be loaded or if the\n    /// file watcher cannot be created.\n    pub fn new(config_path: PathBuf) -\u003e Result\u003cSelf\u003e {\n        let (tx, receiver) = mpsc::channel(10);\n        let config_path_clone = config_path.clone();\n\n        let mut watcher = RecommendedWatcher::new(\n            #[allow(clippy::cognitive_complexity)]\n            move |res: notify::Result\u003cEvent\u003e| {\n                if let Ok(event) = res {\n                    debug!(\"Config file event: {event:?}\");\n\n                    // Only react to write events\n                    if matches!(event.kind, notify::EventKind::Modify(_)) {\n                        info!(\"Config file modified, reloading...\");\n\n                        match load_config(\u0026config_path_clone) {\n                            Ok(new_config) =\u003e {\n                                if let Err(e) = tx.try_send(Ok(new_config)) {\n                                    warn!(\"Failed to send config update: {e}\");\n                                }\n                            }\n                            Err(e) =\u003e {\n                                error!(\"Failed to reload config: {e:?}\");\n                                if let Err(send_err) = tx.try_send(Err(e)) {\n                                    warn!(\"Failed to send config error: {send_err}\");\n                                }\n                            }\n                        }\n                    }\n                } else if let Err(e) = res {\n                    error!(\"Config watcher error: {e:?}\");\n                }\n            },\n            Config::default(),\n        )\n        .map_err(|e| AppError::Internal(format!(\"Failed to create file watcher: {e}\")))?;\n\n        // Watch the config file\n        watcher\n            .watch(\u0026config_path, RecursiveMode::NonRecursive)\n            .map_err(|e| AppError::Internal(format!(\"Failed to watch config file: {e}\")))?;\n\n        // Load initial config\n        let initial_config = load_config(\u0026config_path)?;\n        let current_config = Arc::new(RwLock::new(initial_config));\n\n        info!(\"Config watcher initialized for: {}\", config_path.display());\n\n        Ok(Self {\n            config_path,\n            current_config,\n            _watcher: watcher,\n            receiver,\n        })\n    }\n\n    /// Get the current configuration\n    pub async fn get_config(\u0026self) -\u003e AppConfig {\n        self.current_config.read().await.clone()\n    }\n\n    /// Wait for the next configuration change\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if the configuration cannot be reloaded or if the\n    /// watcher channel has been closed.\n    pub async fn wait_for_change(\u0026mut self) -\u003e Result\u003cAppConfig\u003e {\n        if let Some(config_result) = self.receiver.recv().await {\n            match config_result {\n                Ok(new_config) =\u003e {\n                    info!(\"Configuration reloaded successfully\");\n                    *self.current_config.write().await = new_config.clone();\n                    Ok(new_config)\n                }\n                Err(e) =\u003e {\n                    warn!(\"Configuration reload failed, keeping current config: {e:?}\");\n                    Err(e)\n                }\n            }\n        } else {\n            error!(\"Config watcher channel closed\");\n            Err(AppError::Internal(\n                \"Config watcher channel closed\".to_string(),\n            ))\n        }\n    }\n\n    /// Force reload the configuration\n    ///\n    /// # Errors\n    ///\n    /// Returns an error if the configuration file cannot be read or parsed.\n    pub async fn force_reload(\u0026self) -\u003e Result\u003cAppConfig\u003e {\n        info!(\"Force reloading configuration from: {}\", self.config_path.display());\n        \n        match load_config(\u0026self.config_path) {\n            Ok(new_config) =\u003e {\n                *self.current_config.write().await = new_config.clone();\n                info!(\"Configuration force reloaded successfully\");\n                Ok(new_config)\n            }\n            Err(e) =\u003e {\n                error!(\"Failed to force reload config: {e:?}\");\n                Err(e)\n            }\n        }\n    }\n\n    /// Get configuration file path\n    #[must_use]\n    #[allow(clippy::missing_const_for_fn)]\n    pub fn config_path(\u0026self) -\u003e \u0026Path {\n        \u0026self.config_path\n    }\n}\n\n/// Configuration change notification\n#[derive(Debug, Clone)]\npub struct ConfigChange {\n    pub old_config: AppConfig,\n    pub new_config: AppConfig,\n    pub timestamp: chrono::DateTime\u003cchrono::Utc\u003e,\n}\n\nimpl ConfigChange {\n    #[must_use]\n    pub fn new(old_config: AppConfig, new_config: AppConfig) -\u003e Self {\n        Self {\n            old_config,\n            new_config,\n            timestamp: chrono::Utc::now(),\n        }\n    }\n\n    /// Check if API keys have changed\n    #[must_use]\n    pub fn keys_changed(\u0026self) -\u003e bool {\n        self.old_config.groups != self.new_config.groups\n    }\n\n    /// Check if server configuration has changed\n    #[must_use]\n    pub fn server_changed(\u0026self) -\u003e bool {\n        self.old_config.server != self.new_config.server\n    }\n\n    /// Get summary of changes\n    #[must_use]\n    pub fn change_summary(\u0026self) -\u003e String {\n        let mut changes = Vec::new();\n        \n        if self.server_changed() {\n            changes.push(\"server configuration\");\n        }\n        \n        if self.keys_changed() {\n            changes.push(\"API key groups\");\n        }\n\n        if changes.is_empty() {\n            \"no significant changes detected\".to_string()\n        } else {\n            format!(\"changed: {}\", changes.join(\", \"))\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::{KeyGroup, ServerConfig};\n    use std::fs;\n    use tempfile::tempdir;\n\n    #[tokio::test]\n    async fn test_config_watcher_creation() {\n        let temp_dir = tempdir().unwrap();\n        let config_path = temp_dir.path().join(\"test_config.yaml\");\n        use std::io::Write;\n\n        // Create an empty config file to ensure the watcher can be created.\n        // The watcher needs to be able to read the file on initialization.\n        let initial_config = AppConfig {\n            server: ServerConfig {\n                host: \"127.0.0.1\".to_string(),\n                port: 8080,\n            },\n            groups: vec![KeyGroup {\n                name: \"test-group\".to_string(),\n                api_keys: vec![\"test-key\".to_string()],\n                target_url: \"http://localhost:1234\".to_string(),\n                proxy_url: None,\n            }],\n        };\n        let yaml = serde_yaml::to_string(\u0026initial_config).unwrap();\n        \n        // Use File::create and sync_all to ensure the file is written to disk\n        let mut temp_file = fs::File::create(\u0026config_path).unwrap();\n        temp_file.write_all(yaml.as_bytes()).unwrap();\n        temp_file.sync_all().unwrap(); // This is the fix\n\n        // Give the filesystem and notify crate a moment to catch up.\n        // This is the definitive fix for the race condition.\n        std::thread::sleep(std::time::Duration::from_millis(50));\n\n        let watcher_result = ConfigWatcher::new(config_path);\n        assert!(watcher_result.is_ok(), \"Watcher creation failed: {:?}\", watcher_result.err());\n    }\n\n    #[tokio::test]\n    async fn test_config_change_detection() {\n        let change = ConfigChange::new(\n            AppConfig {\n                server: ServerConfig {\n                    host: \"127.0.0.1\".to_string(),\n                    port: 8080,\n                },\n                groups: vec![],\n            },\n            AppConfig {\n                server: ServerConfig {\n                    host: \"0.0.0.0\".to_string(),\n                    port: 8081,\n                },\n                groups: vec![KeyGroup {\n                    name: \"test\".to_string(),\n                    api_keys: vec![\"key1\".to_string()],\n                    proxy_url: None,\n                    target_url: \"http://test.com\".to_string(),\n                }],\n            },\n        );\n\n        assert!(change.server_changed());\n        assert!(change.keys_changed());\n        assert!(change.change_summary().contains(\"server configuration\"));\n        assert!(change.change_summary().contains(\"API key groups\"));\n    }\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","error.rs"],"content":"// src/error.rs\nuse axum::{\n    http::StatusCode,\n    response::{IntoResponse, Response},\n    Json,\n};\nuse serde::Serialize;\nuse thiserror::Error;\nuse tracing::error; // Import error for logging\n\n/// Represents the structured error response body.\n#[derive(Serialize, Debug)]\nstruct ErrorResponse {\n    error: ErrorDetails,\n}\n\n/// Contains the details of an error for the response body.\n#[derive(Serialize, Debug)]\nstruct ErrorDetails {\n    #[serde(rename = \"type\")]\n    error_type: String,\n    message: String,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    details: Option\u003cString\u003e,\n}\n\n/// Specific kinds of proxy configuration errors.\n#[derive(Error, Debug)]\npub enum ProxyConfigErrorKind {\n    #[error(\"Invalid URL format: {0}\")]\n    UrlParse(#[from] url::ParseError),\n    #[error(\"Unsupported scheme: {0}\")]\n    UnsupportedScheme(String),\n    #[error(\"Invalid proxy definition: {0}\")]\n    InvalidDefinition(String), // For errors from reqwest::Proxy constructors\n}\n\n/// Detailed error information for proxy configuration issues.\n#[derive(Error, Debug)]\n#[error(\"Proxy configuration error for URL '{url}': {kind}\")]\n// Make struct and fields public\npub struct ProxyConfigErrorData {\n    pub url: String,\n    pub kind: ProxyConfigErrorKind,\n}\n\n\n/// Represents the possible errors that can occur within the application.\n///\n/// Implements `IntoResponse` to automatically convert errors into appropriate\n/// HTTP error responses with a standardized JSON body.\n#[derive(Error, Debug)]\npub enum AppError {\n    #[error(\"Configuration error: {0}\")]\n    Config(String), // Keep as String for general config issues, be specific elsewhere\n\n    #[error(\"Reqwest HTTP client error: {0}\")]\n    Reqwest(#[from] reqwest::Error), // RESTORED #[from] here\n\n    #[error(\"IO error: {0}\")]\n    Io(#[from] std::io::Error),\n\n    #[error(\"YAML parsing error: {0}\")]\n    YamlParsing(#[from] serde_yaml::Error),\n\n    // UrlParse error is now typically wrapped in ProxyConfigError or handled elsewhere\n    // #[error(\"URL parsing error: {0}\")]\n    // UrlParse(#[from] url::ParseError),\n    #[error(\"No available API keys\")]\n    NoAvailableKeys,\n\n    #[error(\"Upstream service error: {status} - {body}\")]\n    UpstreamServiceError { status: StatusCode, body: String },\n\n    #[error(\"Request body processing error: {0}\")]\n    RequestBodyError(String), // Keep as String for diverse sources\n\n    #[error(\"JSON processing error: {0}\")]\n    JsonProcessing(String, #[source] serde_json::Error),\n\n    #[error(\"Response body processing error: {0}\")]\n    ResponseBodyError(String), // Keep as String for diverse sources\n\n    #[error(\"Invalid API key provided by client\")]\n    InvalidClientApiKey, // If client-side key validation is added\n\n    #[error(\"Unauthorized\")]\n    Unauthorized,\n\n    #[error(\"Not Found: {0}\")]\n    NotFound(String),\n\n    #[error(\"Internal server error: {0}\")]\n    Internal(String), // Catch-all for unexpected errors\n\n    #[error(transparent)] // Use transparent to delegate display/source\n    ProxyConfigError(#[from] ProxyConfigErrorData),\n\n    #[error(\"HTTP client build error: {source}\")] // Reference source directly\n    HttpClientBuildError {\n        source: reqwest::Error,    // #[from] is definitely removed here\n        proxy_url: Option\u003cString\u003e, // Add context\n    },\n\n    #[error(\"Failed to join URL components: {0}\")]\n    UrlJoinError(String),\n\n    #[error(\"CSRF token invalid\")]\n    Csrf,\n\n    #[error(\"Axum error: {0}\")]\n    Axum(#[from] axum::Error),\n\n    #[error(\"URL parsing error: {0}\")]\n    UrlParse(#[from] url::ParseError),\n}\n\n// Removed manual `impl From\u003creqwest::Error\u003e for AppError` to resolve conflict\n// with the restored `#[from]` on `AppError::Reqwest`.\n// HttpClientBuildError MUST be constructed explicitly where it occurs.\n\n// Implement IntoResponse for AppError to automatically convert errors into HTTP responses\nimpl IntoResponse for AppError {\n    fn into_response(self) -\u003e Response {\n        let (status, error_details) = match self {\n            // --- 5xx Server Errors (Internal details logged, generic message to client) ---\n            Self::Config(msg) =\u003e {\n                error!(\"Configuration error: {}\", msg); // Log the specific error\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"CONFIG_ERROR\".to_string(),\n                        message: \"Internal server configuration error\".to_string(),\n                        details: None, // Don't expose details\n                    },\n                )\n            }\n            Self::Io(e) =\u003e {\n                error!(\"IO error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"IO_ERROR\".to_string(),\n                        message: \"Internal server error during IO operation\".to_string(),\n                        details: None,\n                    },\n                )\n            }\n            Self::YamlParsing(e) =\u003e {\n                error!(\"YAML parsing error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"CONFIG_PARSE_ERROR\".to_string(),\n                        message: \"Failed to parse configuration file\".to_string(),\n                        details: None,\n                    },\n                )\n            }\n            Self::ProxyConfigError(data) =\u003e {\n                error!(\"Proxy configuration error: {}\", data); // Log detailed error\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR, // Config issue is internal\n                    ErrorDetails {\n                        error_type: \"PROXY_CONFIG_ERROR\".to_string(),\n                        message: \"Internal server error related to proxy configuration\".to_string(),\n                        // Optionally expose the problematic URL, but not the internal kind\n                        details: Some(format!(\"Affected proxy URL: {}\", data.url)),\n                        // details: None, // Stricter approach: hide URL too\n                    },\n                )\n            }\n            Self::HttpClientBuildError { source, proxy_url } =\u003e {\n                error!(proxy_url = ?proxy_url, \"HTTP client build error: {}\", source);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"HTTP_CLIENT_BUILD_ERROR\".to_string(),\n                        message: \"Internal server error building HTTP client\".to_string(),\n                        details: proxy_url.map(|u| format!(\"Related proxy: {u}\")),\n                    },\n                )\n            }\n            Self::Internal(msg) =\u003e {\n                error!(\"Internal server error: {}\", msg);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"INTERNAL_SERVER_ERROR\".to_string(),\n                        message: \"An unexpected internal server error occurred\".to_string(),\n                        details: None,\n                    },\n                )\n            }\n            Self::UrlJoinError(msg) =\u003e {\n                error!(\"URL join error: {}\", msg);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"URL_CONSTRUCTION_ERROR\".to_string(),\n                        message: \"Internal error during URL construction\".to_string(),\n                        details: None, // Do not expose internal path details\n                    },\n                )\n            }\n\n            // --- 5xx Errors related to upstream/proxying ---\n            Self::Reqwest(e) =\u003e {\n                error!(\"Upstream reqwest error: {}\", e);\n                // More robust error classification\n                let (status_code, msg_key) = if e.is_timeout() {\n                    (StatusCode::GATEWAY_TIMEOUT, \"timeout\")\n                } else if e.is_connect() {\n                    (StatusCode::BAD_GATEWAY, \"connect\")\n                } else if e.is_request() {\n                    (StatusCode::BAD_GATEWAY, \"request_setup\") // Error building the request itself (e.g., DNS issue)\n                } else if e.is_body() || e.is_decode() {\n                    (StatusCode::BAD_GATEWAY, \"body_or_decode\") // Error processing response body\n                } else {\n                    (StatusCode::BAD_GATEWAY, \"generic\") // Other communication errors\n                };\n\n                let message = match msg_key {\n                    \"timeout\" =\u003e \"Upstream request timed out\".to_string(),\n                    \"connect\" =\u003e \"Could not connect to upstream service\".to_string(),\n                    \"request_setup\" =\u003e \"Internal error setting up upstream request\".to_string(),\n                    \"body_or_decode\" =\u003e {\n                        \"Error processing response body from upstream service\".to_string()\n                    }\n                    _ =\u003e \"Error communicating with upstream service\".to_string(),\n                };\n\n                (\n                    status_code,\n                    ErrorDetails {\n                        error_type: \"UPSTREAM_ERROR\".to_string(),\n                        message,\n                        details: Some(e.to_string()), // Provide reqwest error string as detail\n                    },\n                )\n            }\n            Self::UpstreamServiceError { status, body } =\u003e {\n                error!(\n                    \"Upstream service returned error: Status={}, Body='{}'\",\n                    status, body\n                );\n                (\n                    status, // Use the status code from the upstream service\n                    ErrorDetails {\n                        error_type: \"UPSTREAM_SERVICE_ERROR\".to_string(),\n                        message: \"Upstream service returned an error\".to_string(),\n                        details: Some(body), // Include upstream body if needed\n                    },\n                )\n            }\n            Self::ResponseBodyError(msg) =\u003e {\n                error!(\"Response body processing error: {}\", msg);\n                (\n                    StatusCode::BAD_GATEWAY, // Error processing upstream response\n                    ErrorDetails {\n                        error_type: \"RESPONSE_PROCESSING_ERROR\".to_string(),\n                        message: \"Failed to process response from upstream service\".to_string(),\n                        details: Some(msg),\n                    },\n                )\n            }\n            Self::NoAvailableKeys =\u003e (\n                StatusCode::SERVICE_UNAVAILABLE,\n                ErrorDetails {\n                    error_type: \"NO_AVAILABLE_KEYS\".to_string(),\n                    message: \"No available API keys to process the request at this time\"\n                        .to_string(),\n                    details: None,\n                },\n            ),\n\n            // --- 4xx Client Errors ---\n            Self::RequestBodyError(msg) =\u003e (\n                StatusCode::BAD_REQUEST,\n                ErrorDetails {\n                    error_type: \"REQUEST_BODY_ERROR\".to_string(),\n                    message: \"Failed to process request body\".to_string(),\n                    details: Some(msg),\n                },\n            ),\n            Self::JsonProcessing(msg, source) =\u003e {\n                error!(\"JSON processing error: {} - Source: {}\", msg, source);\n                (\n                    StatusCode::BAD_REQUEST, // JSON error is a client-side malformed request\n                    ErrorDetails {\n                        error_type: \"JSON_PROCESSING_ERROR\".to_string(),\n                        message: msg,\n                        details: Some(source.to_string()),\n                    },\n                )\n            }\n            Self::InvalidClientApiKey =\u003e (\n                StatusCode::UNAUTHORIZED, // Or FORBIDDEN depending on semantics\n                ErrorDetails {\n                    error_type: \"INVALID_API_KEY\".to_string(),\n                    message: \"Invalid or unauthorized API key provided\".to_string(),\n                    details: None,\n                },\n            ),\n            Self::Unauthorized =\u003e (\n                StatusCode::UNAUTHORIZED,\n                ErrorDetails {\n                    error_type: \"UNAUTHORIZED\".to_string(),\n                    message: \"Authentication token is missing or invalid\".to_string(),\n                    details: None,\n                },\n            ),\n            Self::NotFound(resource) =\u003e (\n                StatusCode::NOT_FOUND,\n                ErrorDetails {\n                    error_type: \"NOT_FOUND\".to_string(),\n                    message: format!(\"Resource not found: {resource}\"),\n                    details: None,\n                },\n            ),\n            Self::Csrf =\u003e (\n                StatusCode::FORBIDDEN,\n                ErrorDetails {\n                    error_type: \"CSRF_TOKEN_INVALID\".to_string(),\n                    message: \"CSRF token is missing or invalid.\".to_string(),\n                    details: None,\n                },\n            ),\n            Self::Axum(e) =\u003e {\n                error!(\"Internal Axum error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"AXUM_INTERNAL_ERROR\".to_string(),\n                        message: \"An internal server error occurred\".to_string(),\n                        details: Some(e.to_string()),\n                    },\n                )\n            }\n            Self::UrlParse(e) =\u003e {\n                error!(\"Internal URL parsing error: {}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    ErrorDetails {\n                        error_type: \"URL_PARSE_ERROR\".to_string(),\n                        message: \"An internal error occurred while parsing a URL\".to_string(),\n                        details: Some(e.to_string()),\n                    },\n                )\n            }\n        };\n\n        let body = Json(ErrorResponse {\n            error: error_details,\n        });\n\n        (status, body).into_response()\n    }\n}\n\n// Optional: Define a type alias for Result using the AppError\npub type Result\u003cT\u003e = std::result::Result\u003cT, AppError\u003e;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::body::to_bytes;\n    use serde_json::Value;\n    use std::io;\n\n    // Helper to check the structured response\n    async fn check_response(\n        error: AppError,\n        expected_status: StatusCode,\n        expected_type: \u0026str,\n        expected_message_substring: \u0026str,\n        expect_details: bool, // Whether to assert that details field exists (doesn't check content)\n    ) {\n        let response = error.into_response();\n        assert_eq!(response.status(), expected_status, \"Status code mismatch\");\n\n        let body = response.into_body();\n        let bytes = to_bytes(body, usize::MAX)\n            .await\n            .expect(\"Failed to read response body\");\n        let body_json: Value = serde_json::from_slice(\u0026bytes).unwrap_or_else(|e| {\n            panic!(\n                \"Response body is not valid JSON: {}. Body: {}\",\n                e,\n                String::from_utf8_lossy(\u0026bytes)\n            )\n        });\n\n        let error_obj = \u0026body_json[\"error\"];\n        assert!(!error_obj.is_null(), \"JSON 'error' field is missing\");\n\n        let error_type = error_obj[\"type\"]\n            .as_str()\n            .expect(\"JSON 'error.type' field is not a string or missing\");\n        assert_eq!(error_type, expected_type, \"Error type mismatch\");\n\n        let error_msg = error_obj[\"message\"]\n            .as_str()\n            .expect(\"JSON 'error.message' field is not a string or missing\");\n        assert!(\n            error_msg.contains(expected_message_substring),\n            \"Expected error message '{}' to contain '{}'\",\n            error_msg,\n            expected_message_substring\n        );\n\n        if expect_details {\n            assert!(\n                !error_obj[\"details\"].is_null(),\n                \"Expected 'error.details' field to exist but it was null or missing\"\n            );\n            assert!(\n                error_obj[\"details\"].is_string(),\n                \"Expected 'error.details' field to be a string\"\n            );\n        } else {\n            assert!(\n                error_obj[\"details\"].is_null() || !error_obj[\"details\"].is_string(),\n                \"Expected 'error.details' field to be null or non-existent/non-string\"\n            );\n        }\n    }\n\n    #[tokio::test]\n    async fn test_into_response_config() {\n        check_response(\n            AppError::Config(\"Test config issue\".to_string()),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"CONFIG_ERROR\",\n            \"Internal server configuration error\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_io() {\n        let io_error = io::Error::new(io::ErrorKind::NotFound, \"File not found\");\n        check_response(\n            AppError::Io(io_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"IO_ERROR\",\n            \"Internal server error during IO operation\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_yaml() {\n        let yaml_error: serde_yaml::Error =\n            serde_yaml::from_str::\u003c()\u003e(\"invalid: yaml:\").unwrap_err();\n        check_response(\n            AppError::YamlParsing(yaml_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"CONFIG_PARSE_ERROR\",\n            \"Failed to parse configuration file\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_proxy_config_url_parse() {\n        let url_error = url::Url::parse(\"::invalid url\").unwrap_err();\n        let proxy_error = ProxyConfigErrorData {\n            url: \"::invalid url\".to_string(),\n            kind: ProxyConfigErrorKind::UrlParse(url_error),\n        };\n        check_response(\n            AppError::ProxyConfigError(proxy_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"PROXY_CONFIG_ERROR\",\n            \"Internal server error related to proxy configuration\",\n            true,\n        )\n        .await; // Expect details (URL)\n    }\n\n    #[tokio::test]\n    async fn test_into_response_proxy_config_unsupported_scheme() {\n        let proxy_error = ProxyConfigErrorData {\n            url: \"ftp://bad\".to_string(),\n            kind: ProxyConfigErrorKind::UnsupportedScheme(\"ftp\".to_string()),\n        };\n        check_response(\n            AppError::ProxyConfigError(proxy_error),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"PROXY_CONFIG_ERROR\",\n            \"Internal server error related to proxy configuration\",\n            true,\n        )\n        .await; // Expect details (URL)\n    }\n\n    #[tokio::test]\n    async fn test_into_response_no_keys() {\n        check_response(\n            AppError::NoAvailableKeys,\n            StatusCode::SERVICE_UNAVAILABLE,\n            \"NO_AVAILABLE_KEYS\",\n            \"No available API keys\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_upstream_service_error() {\n        check_response(\n            AppError::UpstreamServiceError {\n                status: StatusCode::BAD_GATEWAY,\n                body: \"Upstream failed\".to_string(),\n            },\n            StatusCode::BAD_GATEWAY,\n            \"UPSTREAM_SERVICE_ERROR\",\n            \"Upstream service returned an error\",\n            true, // Expect details (body)\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_request_body_error() {\n        check_response(\n            AppError::RequestBodyError(\"Bad body\".to_string()),\n            StatusCode::BAD_REQUEST,\n            \"REQUEST_BODY_ERROR\",\n            \"Failed to process request body\",\n            true,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_response_body_error() {\n        check_response(\n            AppError::ResponseBodyError(\"Bad response body\".to_string()),\n            StatusCode::BAD_GATEWAY,\n            \"RESPONSE_PROCESSING_ERROR\",\n            \"Failed to process response\",\n            true,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    // Removed ignore from this test\n    async fn test_into_response_invalid_client_key() {\n        check_response(\n            AppError::InvalidClientApiKey,\n            StatusCode::UNAUTHORIZED,\n            \"INVALID_API_KEY\",\n            \"Invalid or unauthorized API key\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_internal() {\n        check_response(\n            AppError::Internal(\"Something went wrong\".to_string()),\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"INTERNAL_SERVER_ERROR\",\n            \"unexpected internal server error\",\n            false,\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_http_client_build_error() {\n        // Simulate a reqwest build error by providing an impossible TLS version range.\n        // This is a reliable way to make the client build fail.\n        let build_error = reqwest::Client::builder()\n            .min_tls_version(reqwest::tls::Version::TLS_1_3)\n            .max_tls_version(reqwest::tls::Version::TLS_1_2)\n            .build()\n            .expect_err(\"Client build should fail with an impossible TLS version range\");\n\n        check_response(\n            // Manually construct the error variant now\n            AppError::HttpClientBuildError {\n                source: build_error,\n                proxy_url: None, // No proxy was involved in this specific build failure\n            },\n            StatusCode::INTERNAL_SERVER_ERROR,\n            \"HTTP_CLIENT_BUILD_ERROR\",\n            \"Internal server error building HTTP client\",\n            false, // No details to expect in this case\n        )\n        .await;\n    }\n\n    #[tokio::test]\n    async fn test_into_response_reqwest_timeout() {\n        // Simulate a timeout error - need a way to create reqwest::Error directly or mock\n        // For now, test the logic path using a placeholder error that is_timeout() == true\n        // This requires mocking or a feature flag for testing, skipping for now.\n        // let e = create_mock_reqwest_timeout_error();\n        // check_response(AppError::Reqwest(e), StatusCode::GATEWAY_TIMEOUT, \"UPSTREAM_ERROR\", \"Upstream request timed out\", true).await;\n        assert!(true); // Placeholder\n    }\n\n    #[tokio::test]\n    async fn test_into_response_reqwest_connect() {\n        // Simulate a connect error\n        // Skipping for now due to complexity of creating reqwest::Error\n        assert!(true); // Placeholder\n    }\n\n    #[tokio::test]\n    async fn test_into_response_reqwest_generic() {\n        // Simulate a generic reqwest error\n        let e = reqwest::get(\"http://invalid-url-that-does-not-exist-and-causes-error\")\n            .await\n            .unwrap_err();\n        // Check based on the new logic: request setup errors (like DNS) are now BAD_GATEWAY\n        check_response(\n            AppError::Reqwest(e),\n            StatusCode::BAD_GATEWAY,\n            \"UPSTREAM_ERROR\",\n            \"Internal error setting up upstream request\", // This is the correct message for a DNS/request setup error\n            true,\n        )\n        .await;\n    }\n}\n","traces":[{"line":123,"address":[31795295],"length":1,"stats":{"Line":1},"fn_name":null},{"line":124,"address":[25049665,25049617],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[13329494],"length":1,"stats":{"Line":5},"fn_name":null},{"line":127,"address":[14060265],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[35556356],"length":1,"stats":{"Line":3},"fn_name":null},{"line":130,"address":[39468016],"length":1,"stats":{"Line":2},"fn_name":null},{"line":131,"address":[14073400],"length":1,"stats":{"Line":1},"fn_name":null},{"line":132,"address":[6745929],"length":1,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[14205489,14205441],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[13223811,13223901,13223765],"length":1,"stats":{"Line":2},"fn_name":null},{"line":138,"address":[14853488],"length":1,"stats":{"Line":4},"fn_name":"description"},{"line":139,"address":[35424600],"length":1,"stats":{"Line":3},"fn_name":null},{"line":141,"address":[38541187],"length":1,"stats":{"Line":1},"fn_name":null},{"line":142,"address":[34207691],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[26630525,26630817],"length":1,"stats":{"Line":2},"fn_name":null},{"line":144,"address":[6753439],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[26775841,26775945,26775906],"length":1,"stats":{"Line":1},"fn_name":null},{"line":149,"address":[14747798,14747853,14747992],"length":1,"stats":{"Line":1},"fn_name":null},{"line":150,"address":[25049897,25050046],"length":1,"stats":{"Line":5},"fn_name":null},{"line":152,"address":[12576265,12576343],"length":1,"stats":{"Line":1},"fn_name":null},{"line":153,"address":[25621283],"length":1,"stats":{"Line":1},"fn_name":null},{"line":154,"address":[38251514],"length":1,"stats":{"Line":1},"fn_name":null},{"line":155,"address":[11647114],"length":1,"stats":{"Line":1},"fn_name":null},{"line":156,"address":[35411723],"length":1,"stats":{"Line":1},"fn_name":null},{"line":160,"address":[31928336],"length":1,"stats":{"Line":2},"fn_name":"internal_desc"},{"line":161,"address":[25183777,25183832],"length":1,"stats":{"Line":5},"fn_name":null},{"line":163,"address":[12138951,12139012,12138167,12138228],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[31796478],"length":1,"stats":{"Line":1},"fn_name":null},{"line":165,"address":[35425274],"length":1,"stats":{"Line":1},"fn_name":null},{"line":166,"address":[25183875],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[33234272,33234297],"length":1,"stats":{"Line":2},"fn_name":"fmt"},{"line":173,"address":[32973096],"length":1,"stats":{"Line":5},"fn_name":null},{"line":174,"address":[32973021],"length":1,"stats":{"Line":7},"fn_name":null},{"line":176,"address":[6136608,6136651,6135867,6135824],"length":1,"stats":{"Line":0},"fn_name":null},{"line":177,"address":[26644604],"length":1,"stats":{"Line":2},"fn_name":null},{"line":178,"address":[12576634,12576695],"length":1,"stats":{"Line":3},"fn_name":null},{"line":179,"address":[25037152,25037184],"length":1,"stats":{"Line":2},"fn_name":null},{"line":180,"address":[6772010],"length":1,"stats":{"Line":1},"fn_name":null},{"line":184,"address":[35558241],"length":1,"stats":{"Line":1},"fn_name":null},{"line":185,"address":[12682704],"length":1,"stats":{"Line":3},"fn_name":null},{"line":187,"address":[13956020],"length":1,"stats":{"Line":0},"fn_name":null},{"line":188,"address":[13477198],"length":1,"stats":{"Line":1},"fn_name":null},{"line":189,"address":[34997626],"length":1,"stats":{"Line":1},"fn_name":null},{"line":190,"address":[9497319],"length":1,"stats":{"Line":1},"fn_name":null},{"line":191,"address":[14208595],"length":1,"stats":{"Line":1},"fn_name":null},{"line":195,"address":[39737888,39737916],"length":1,"stats":{"Line":0},"fn_name":null},{"line":196,"address":[26644802],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[6137038],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[34852725],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[23995084,23995147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[13345695],"length":1,"stats":{"Line":0},"fn_name":null},{"line":202,"address":[13226835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":208,"address":[13227599],"length":1,"stats":{"Line":1},"fn_name":null},{"line":209,"address":[13346528,13346699],"length":1,"stats":{"Line":3},"fn_name":null},{"line":211,"address":[25182785,25182730,25182857,25182962],"length":1,"stats":{"Line":3},"fn_name":null},{"line":212,"address":[25622155],"length":1,"stats":{"Line":0},"fn_name":null},{"line":213,"address":[13478720,13478859],"length":1,"stats":{"Line":2},"fn_name":null},{"line":214,"address":[6137084,6137370],"length":1,"stats":{"Line":0},"fn_name":null},{"line":215,"address":[33226883],"length":1,"stats":{"Line":3},"fn_name":null},{"line":216,"address":[12683392],"length":1,"stats":{"Line":1},"fn_name":null},{"line":217,"address":[14077326],"length":1,"stats":{"Line":0},"fn_name":null},{"line":218,"address":[12696486],"length":1,"stats":{"Line":0},"fn_name":null},{"line":220,"address":[11608534],"length":1,"stats":{"Line":0},"fn_name":null},{"line":223,"address":[26631888],"length":1,"stats":{"Line":1},"fn_name":null},{"line":224,"address":[25622417],"length":1,"stats":{"Line":2},"fn_name":null},{"line":225,"address":[26778697],"length":1,"stats":{"Line":2},"fn_name":null},{"line":226,"address":[13346416],"length":1,"stats":{"Line":5},"fn_name":null},{"line":227,"address":[33810093,33810366,33810434,33810325,33810067,33810461],"length":1,"stats":{"Line":0},"fn_name":null},{"line":228,"address":[11629281,11629351],"length":1,"stats":{"Line":0},"fn_name":null},{"line":230,"address":[13217562],"length":1,"stats":{"Line":0},"fn_name":null},{"line":234,"address":[26776959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":235,"address":[6751215],"length":1,"stats":{"Line":1},"fn_name":null},{"line":236,"address":[8816509],"length":1,"stats":{"Line":1},"fn_name":null},{"line":237,"address":[12683824],"length":1,"stats":{"Line":1},"fn_name":null},{"line":238,"address":[9630505,9630542],"length":1,"stats":{"Line":2},"fn_name":null},{"line":242,"address":[11602517],"length":1,"stats":{"Line":2},"fn_name":null},{"line":243,"address":[13228263],"length":1,"stats":{"Line":3},"fn_name":null},{"line":245,"address":[26778853],"length":1,"stats":{"Line":0},"fn_name":null},{"line":248,"address":[33649074,33649040],"length":1,"stats":{"Line":2},"fn_name":null},{"line":249,"address":[11636865],"length":1,"stats":{"Line":2},"fn_name":null},{"line":250,"address":[26777093,26777120,26777129],"length":1,"stats":{"Line":6},"fn_name":"{closure#0}"},{"line":251,"address":[26778910],"length":1,"stats":{"Line":2},"fn_name":null},{"line":252,"address":[33649106],"length":1,"stats":{"Line":5},"fn_name":null},{"line":256,"address":[12578710],"length":1,"stats":{"Line":2},"fn_name":null},{"line":257,"address":[26778976],"length":1,"stats":{"Line":5},"fn_name":null},{"line":259,"address":[12578687],"length":1,"stats":{"Line":1},"fn_name":null},{"line":260,"address":[27166031],"length":1,"stats":{"Line":1},"fn_name":null},{"line":261,"address":[10648821],"length":1,"stats":{"Line":1},"fn_name":null},{"line":262,"address":[12697458],"length":1,"stats":{"Line":4},"fn_name":null},{"line":263,"address":[6763598],"length":1,"stats":{"Line":2},"fn_name":null},{"line":267,"address":[7324231,7323962,7324122],"length":1,"stats":{"Line":4},"fn_name":null},{"line":268,"address":[33229535,33229193,33229385,33229343],"length":1,"stats":{"Line":2},"fn_name":null},{"line":269,"address":[12578948,12579080],"length":1,"stats":{"Line":2},"fn_name":null},{"line":270,"address":[11634101],"length":1,"stats":{"Line":1},"fn_name":null},{"line":271,"address":[11635810],"length":1,"stats":{"Line":2},"fn_name":null},{"line":272,"address":[33229330,33229522],"length":1,"stats":{"Line":4},"fn_name":null},{"line":273,"address":[13219518],"length":1,"stats":{"Line":2},"fn_name":null},{"line":278,"address":[21939269,21942709,21943589,21943429,21940149,21944389,21944949,21942309,21943749,21945029,21943189,21946949,21942629,21939909,21944469,21941749,21945669,21946149,21940389,21942869,21944789,21942789,21945909,21946229,21945509,21945829,21944709,21941989,21941669,21946549,21943829,21939829,21939749,21943269,21946069,21941189,21946789,21943669,21939349,21946869,21941589,21939589,21945349,21946389,21941909,21943989,21943029,21946629,21943909,21945189,21941269,21939989,21942389,21942149,21939669,21939189,21941029,21941829,21944309,21940309,21941429,21940789,21944149,21946309,21943109,21940949,21945109,21943509,21945589,21941509,21942069,21942549,21944549,21943349,21945749,21942229,21941349,21940069,21939509,21946469,21944069,21944629,21940709,21944229,21940549,21942469,21940869,21940629,21945269,21940229,21939109,21945429,21938949,21946709,21939029,21941109,21942949,21939429,21945989,21944869,21940469],"length":1,"stats":{"Line":2},"fn_name":null},{"line":279,"address":[26779136],"length":1,"stats":{"Line":0},"fn_name":null},{"line":280,"address":[26777349],"length":1,"stats":{"Line":1},"fn_name":null},{"line":281,"address":[26632344],"length":1,"stats":{"Line":1},"fn_name":null},{"line":282,"address":[12685200,12685306,12685252],"length":1,"stats":{"Line":1},"fn_name":null},{"line":283,"address":[13219245,13219174],"length":1,"stats":{"Line":1},"fn_name":null},{"line":286,"address":[13959552],"length":1,"stats":{"Line":0},"fn_name":null},{"line":287,"address":[11651026,11650536,11636030],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[14599264,14599498],"length":1,"stats":{"Line":0},"fn_name":"invalid_value"},{"line":290,"address":[25042888,25042864,25043052],"length":1,"stats":{"Line":0},"fn_name":"fmt"},{"line":291,"address":[6759568],"length":1,"stats":{"Line":0},"fn_name":null},{"line":292,"address":[26779243],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[34868608],"length":1,"stats":{"Line":3},"fn_name":null},{"line":297,"address":[13959891],"length":1,"stats":{"Line":1},"fn_name":null},{"line":298,"address":[14078869],"length":1,"stats":{"Line":0},"fn_name":null},{"line":299,"address":[13960105],"length":1,"stats":{"Line":1},"fn_name":null},{"line":300,"address":[14079113],"length":1,"stats":{"Line":1},"fn_name":null},{"line":301,"address":[26777798],"length":1,"stats":{"Line":1},"fn_name":null},{"line":302,"address":[11642335],"length":1,"stats":{"Line":1},"fn_name":null},{"line":305,"address":[21997008,21999024,21997552,21999376,21997168,21998608,21999696,21999600,21998384,21996944,21998320,21998896,21997488,21999216,21998928,21999472,21996720,21999760,21997840,21998288,21999856,21999568,21998160,21998576,21999056,21999152,21997360,21999312,21999088,21998768,21999792,21998448,21999184,21999504,21997744,21997200,21999248,21997232,21998480,21999632,21998544,21997040,21998640,21999120,21998096,21998800,21997712,21996976,21998736,21997808,21997648,21997584,21998704,21997328,21999728,21998416,21998352,21999888,21998512,21996752,21998128,21999664,21996848,21998960,21998000,21998992,21996688,21997520,21999344,21999408,21996880,21998064,21997456,21996784,21998672,21997968,21996816,21999536,21997680,21997424,21997296,21998256,21996912,21999824,21997264,21999440,21998032,21997104,21999280,21998224,21998192,21997936,21998864,21997904,21997872,21997072,21998832,21997136,21997616,21997776,21997392],"length":1,"stats":{"Line":1},"fn_name":null},{"line":306,"address":[13960786],"length":1,"stats":{"Line":1},"fn_name":null},{"line":307,"address":[14600532],"length":1,"stats":{"Line":2},"fn_name":null},{"line":308,"address":[35000704],"length":1,"stats":{"Line":2},"fn_name":null},{"line":309,"address":[6744849],"length":1,"stats":{"Line":1},"fn_name":null},{"line":310,"address":[11653946],"length":1,"stats":{"Line":1},"fn_name":null},{"line":313,"address":[14080016],"length":1,"stats":{"Line":0},"fn_name":null},{"line":314,"address":[25185584,25185536,25185472],"length":1,"stats":{"Line":0},"fn_name":"decode\u003calloc::boxed::Box\u003c(dyn core::error::Error + core::marker::Send + core::marker::Sync), alloc::alloc::Global\u003e\u003e"},{"line":315,"address":[14067089],"length":1,"stats":{"Line":1},"fn_name":null},{"line":316,"address":[25187410,25187366,25187313],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[11642837,11642905],"length":1,"stats":{"Line":3},"fn_name":null},{"line":318,"address":[14601021],"length":1,"stats":{"Line":2},"fn_name":null},{"line":321,"address":[11664643],"length":1,"stats":{"Line":2},"fn_name":null},{"line":322,"address":[14078509],"length":1,"stats":{"Line":0},"fn_name":null},{"line":323,"address":[11664499],"length":1,"stats":{"Line":2},"fn_name":null},{"line":324,"address":[25625356,25625501,25625066,25625239,25625527,25625213],"length":1,"stats":{"Line":2},"fn_name":null},{"line":325,"address":[34855873],"length":1,"stats":{"Line":2},"fn_name":null},{"line":326,"address":[26647170],"length":1,"stats":{"Line":2},"fn_name":null},{"line":329,"address":[33992777],"length":1,"stats":{"Line":0},"fn_name":null},{"line":330,"address":[6774935,6745341,6775425],"length":1,"stats":{"Line":0},"fn_name":null},{"line":332,"address":[34856075,34855904,34856049],"length":1,"stats":{"Line":0},"fn_name":null},{"line":333,"address":[34855913,34855989],"length":1,"stats":{"Line":0},"fn_name":null},{"line":334,"address":[34855954,34856064,34856044],"length":1,"stats":{"Line":0},"fn_name":null},{"line":335,"address":[26779671],"length":1,"stats":{"Line":0},"fn_name":null},{"line":336,"address":[11655338,11655406],"length":1,"stats":{"Line":0},"fn_name":null},{"line":340,"address":[14212411],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[11656439,11623758,11655657],"length":1,"stats":{"Line":2},"fn_name":null},{"line":343,"address":[25041717,25041612],"length":1,"stats":{"Line":0},"fn_name":null},{"line":344,"address":[6778873],"length":1,"stats":{"Line":1},"fn_name":null},{"line":345,"address":[13961648],"length":1,"stats":{"Line":0},"fn_name":"unknown_field"},{"line":346,"address":[32776151,32776050,32776087,32776178],"length":1,"stats":{"Line":1},"fn_name":null},{"line":347,"address":[25041994,25041868],"length":1,"stats":{"Line":0},"fn_name":null},{"line":353,"address":[6747884],"length":1,"stats":{"Line":2},"fn_name":null},{"line":354,"address":[14080704],"length":1,"stats":{"Line":2},"fn_name":"missing_field"},{"line":357,"address":[25055177],"length":1,"stats":{"Line":2},"fn_name":null},{"line":362,"address":[26652601],"length":1,"stats":{"Line":0},"fn_name":null},{"line":364,"address":[33230337],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":109,"coverable":153},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","handler.rs"],"content":"// src/handler.rs\n\nuse crate::{\n    error::{AppError, Result},\n    proxy,\n    state::AppState,\n};\nuse axum::{\n    body::{to_bytes, Bytes},\n    extract::{Request, State},\n    http::{HeaderMap, StatusCode},\n    response::Response,\n};\nuse std::sync::Arc;\nuse tracing::{debug, error, info, instrument, warn};\nuse url::Url;\n\n/// Enum to control the flow of the retry loop in the proxy handler.\nenum NextAction {\n    /// Return the response to the client immediately.\n    ReturnResponse(Response),\n    /// Break the inner loop (internal retries) and try the next key.\n    BreakLoop,\n    /// Continue the inner loop to retry with the same key.\n    ContinueLoop,\n}\n\n/// Simple health check handler. Returns HTTP 200 OK.\n#[instrument(name = \"health_check\", level = \"debug\", skip_all)]\npub async fn health_check() -\u003e StatusCode {\n    debug!(\"Responding to health check\");\n    StatusCode::OK\n}\n\n\n/// Helper to apply an action to a key and save the state.\n/// This function centralizes the logic of acquiring a write lock,\n/// performing an action, and then saving the state if the action was successful.\nasync fn apply_key_action\u003cF\u003e(\n    state: \u0026Arc\u003cAppState\u003e,\n    api_key: \u0026str,\n    action: F,\n) -\u003e Result\u003cNextAction\u003e\nwhere\n    F: FnOnce(\u0026mut crate::key_manager::KeyManager, \u0026str) -\u003e bool,\n{\n    let mut km = state.key_manager.write().await;\n    if action(\u0026mut km, api_key) {\n        km.save_states().await?;\n    }\n    Ok(NextAction::BreakLoop)\n}\n\n/// Handles the response from the upstream service and determines the next action.\n#[instrument(skip_all, fields(status = response.status().as_u16()))]\nasync fn handle_upstream_response(\n    response: Response,\n    state: \u0026Arc\u003cAppState\u003e,\n    api_key_to_mark: \u0026str,\n    internal_retry_count: u32,\n    last_error: \u0026mut Option\u003c(StatusCode, HeaderMap, Bytes)\u003e,\n) -\u003e Result\u003cNextAction\u003e {\n    let status = response.status();\n\n    match status {\n        s if s.is_success() =\u003e {\n            info!(\"Request successful.\");\n            Ok(NextAction::ReturnResponse(response))\n        }\n        StatusCode::NOT_FOUND | StatusCode::GATEWAY_TIMEOUT =\u003e {\n            warn!(\"Received terminal client error, not retrying.\");\n            Ok(NextAction::ReturnResponse(response))\n        }\n        s if s.is_client_error() =\u003e {\n            let (parts, body) = response.into_parts();\n            let body_bytes = to_bytes(body, usize::MAX).await?;\n            *last_error = Some((parts.status, parts.headers, body_bytes));\n\n            if s == StatusCode::TOO_MANY_REQUESTS {\n                warn!(\"Marking key as rate-limited and retrying with next key.\");\n                apply_key_action(state, api_key_to_mark, |km, key| {\n                    km.mark_key_as_limited(key)\n                })\n                .await\n            } else {\n                warn!(\n                    \"Client error {}. Marking key as invalid and retrying with next key.\",\n                    s\n                );\n                apply_key_action(state, api_key_to_mark, |km, key| {\n                    km.mark_key_as_invalid(key)\n                })\n                .await\n            }\n        }\n        s if s.is_server_error() =\u003e {\n            let (parts, body) = response.into_parts();\n            let body_bytes = to_bytes(body, usize::MAX).await?;\n            *last_error = Some((parts.status, parts.headers, body_bytes));\n\n            warn!(\"Received retriable server error {}.\", s);\n            let config = state.config.read().await;\n            if internal_retry_count \u003e= config.internal_retries {\n                error!(\"Internal retries exhausted. Marking key as temporarily unavailable.\");\n                let temporary_block_minutes = config.temporary_block_minutes;\n                apply_key_action(state, api_key_to_mark, |km, key| {\n                    km.mark_key_as_temporarily_unavailable(\n                        key,\n                        chrono::Duration::minutes(temporary_block_minutes),\n                    )\n                })\n                .await\n            } else {\n                tokio::time::sleep(std::time::Duration::from_secs(1)).await;\n                Ok(NextAction::ContinueLoop)\n            }\n        }\n        _ =\u003e {\n            warn!(\"Received unexpected status code {}. Not retrying.\", status);\n            Ok(NextAction::ReturnResponse(response))\n        }\n    }\n}\n\n/// The main Axum handler for proxying requests.\n#[instrument(name=\"proxy_handler\", skip(state, req), fields(uri = %req.uri(), method = %req.method()))]\npub async fn proxy_handler(\n    State(state): State\u003cArc\u003cAppState\u003e\u003e,\n    req: Request,\n) -\u003e Result\u003cResponse\u003e {\n    let method = req.method().clone();\n    let uri = req.uri().clone();\n    let headers = req.headers().clone();\n    let body_bytes = match to_bytes(req.into_body(), usize::MAX).await {\n        Ok(bytes) =\u003e bytes,\n        Err(e) =\u003e {\n            error!(error = ?e, \"Failed to buffer request body\");\n            return Err(AppError::RequestBodyError(e.to_string()));\n        }\n    };\n\n    let mut last_error: Option\u003c(StatusCode, HeaderMap, Bytes)\u003e = None;\n    let mut attempt_count = 0;\n\n    loop {\n        attempt_count += 1;\n        debug!(attempt = attempt_count, \"Looking for next available API key\");\n\n        let key_info = state.key_manager.read().await.get_next_available_key_info();\n\n        let Some(key_info) = key_info else {\n            warn!(attempts = attempt_count, \"No available API keys remaining.\");\n            return if let Some((status, headers, body)) = last_error {\n                let mut response = Response::new(axum::body::Body::from(body));\n                *response.status_mut() = status;\n                *response.headers_mut() = headers;\n                Ok(response)\n            } else {\n                Err(AppError::NoAvailableKeys)\n            };\n        };\n\n        let api_key_to_mark = key_info.key.clone();\n        let mut internal_retry_count = 0;\n\n        loop {\n            internal_retry_count += 1;\n            debug!(attempt = attempt_count, internal_attempt = internal_retry_count, \"Attempting request with key\");\n\n            let translated_path = if uri.path() == \"/health/detailed\" {\n                \"/v1beta/models\".to_string()\n            } else if let Some(stripped) = uri.path().strip_prefix(\"/v1/\") {\n                match stripped {\n                    s if s.starts_with(\"chat/completions\") =\u003e format!(\"/v1beta/openai/{s}\"),\n                    s if s.starts_with(\"embeddings\") =\u003e format!(\"/v1beta/{s}\"),\n                    s if s.starts_with(\"audio/speech\") =\u003e format!(\"/v1beta/{s}\"),\n                    _ =\u003e format!(\"/v1beta/openai/{stripped}\"),\n                }\n            } else {\n                uri.path().to_string()\n            };\n\n            let base_url = Url::parse(\u0026key_info.target_url)?;\n            let mut final_target_url = base_url.join(\u0026translated_path)?;\n            final_target_url.set_query(uri.query());\n            final_target_url.query_pairs_mut().append_pair(\"key\", \u0026key_info.key);\n\n            let response_result = proxy::forward_request(\n                \u0026state, \u0026key_info, method.clone(), final_target_url, headers.clone(), body_bytes.clone(),\n            ).await;\n\n            let response = match response_result {\n                Ok(res) =\u003e res,\n                Err(e) =\u003e {\n                    error!(error = ?e, \"Failed to forward request\");\n                    // Treat request forwarding errors as temporary unavailability of the key/service\n                    let mut km = state.key_manager.write().await;\n                    let temporary_block_minutes = state.config.read().await.temporary_block_minutes;\n                    if km.mark_key_as_temporarily_unavailable(\n                        \u0026api_key_to_mark,\n                        chrono::Duration::minutes(temporary_block_minutes),\n                    ) {\n                        km.save_states().await?;\n                    }\n                    break;\n                }\n            };\n\n            match handle_upstream_response(response, \u0026state, \u0026api_key_to_mark, internal_retry_count, \u0026mut last_error).await? {\n                NextAction::ReturnResponse(r) =\u003e return Ok(r),\n                NextAction::BreakLoop =\u003e break,\n                NextAction::ContinueLoop =\u003e {\n                    // Clear last_error on successful internal retry\n                    last_error.take();\n                    continue;\n                }\n            }\n        }\n    }\n}\n","traces":[{"line":30,"address":[12260784,12260787],"length":1,"stats":{"Line":0},"fn_name":"health_check"},{"line":31,"address":[12153372,12154815,12152753,12152856,12154681],"length":1,"stats":{"Line":0},"fn_name":null},{"line":39,"address":[10658016,10658064,10657968],"length":1,"stats":{"Line":3},"fn_name":"apply_key_action\u003cgemini_proxy_key_rotation_rust::handler::handle_upstream_response::{async_fn#0}::{async_block#0}::{closure_env#1}\u003e"},{"line":47,"address":[11881326,11881054,11881598],"length":1,"stats":{"Line":6},"fn_name":null},{"line":48,"address":[12146043,12150452,12147768,12150037,12148733,12149499,12147819,12146085,12148319,12146996,12149541,12146581],"length":1,"stats":{"Line":6},"fn_name":null},{"line":49,"address":[10659187,10661777,10660926,10658946,10658321,10659306,10660685,10662402,10662643,10662762,10661044,10660046],"length":1,"stats":{"Line":9},"fn_name":null},{"line":51,"address":[12149726,12146270,12148009],"length":1,"stats":{"Line":3},"fn_name":null},{"line":56,"address":[10823344],"length":1,"stats":{"Line":2},"fn_name":"handle_upstream_response"},{"line":63,"address":[12442317,12442037],"length":1,"stats":{"Line":4},"fn_name":null},{"line":65,"address":[10685442],"length":1,"stats":{"Line":2},"fn_name":null},{"line":66,"address":[6500233,6500128],"length":1,"stats":{"Line":4},"fn_name":null},{"line":67,"address":[12159792,12165693,12165116,12180137,12180271],"length":1,"stats":{"Line":6},"fn_name":null},{"line":68,"address":[6506012],"length":1,"stats":{"Line":2},"fn_name":null},{"line":71,"address":[12180633,12180767,12159863,12160475],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[6500834],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[12159823,12161905,12161859],"length":1,"stats":{"Line":5},"fn_name":null},{"line":75,"address":[12164717,12161927],"length":1,"stats":{"Line":2},"fn_name":null},{"line":76,"address":[11858562],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[10693528,10693169],"length":1,"stats":{"Line":1},"fn_name":null},{"line":79,"address":[10680598,10680689],"length":1,"stats":{"Line":2},"fn_name":null},{"line":80,"address":[12463919,12450675,12463785,12453310,12452780],"length":1,"stats":{"Line":3},"fn_name":null},{"line":81,"address":[6510972,6512704,6512362,6520144],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":82,"address":[6520163],"length":1,"stats":{"Line":1},"fn_name":null},{"line":84,"address":[10672183,10684675,10685312,10684896,10684735],"length":1,"stats":{"Line":4},"fn_name":null},{"line":86,"address":[6521849,6521983,6508457,6508391,6508983],"length":1,"stats":{"Line":3},"fn_name":null},{"line":90,"address":[6508929,6513193,6510427,6520176],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":91,"address":[10692675],"length":1,"stats":{"Line":1},"fn_name":null},{"line":93,"address":[12172693,12159500,12170020,12173109,12170080],"length":1,"stats":{"Line":4},"fn_name":null},{"line":96,"address":[12162090,12161865,12162127],"length":1,"stats":{"Line":3},"fn_name":null},{"line":97,"address":[6502605,6504765],"length":1,"stats":{"Line":2},"fn_name":null},{"line":98,"address":[11845616],"length":1,"stats":{"Line":2},"fn_name":null},{"line":99,"address":[6514010,6514365],"length":1,"stats":{"Line":1},"fn_name":null},{"line":101,"address":[12464911,12456882,12456799,12464777,12457398],"length":1,"stats":{"Line":3},"fn_name":null},{"line":102,"address":[6515014,6516732,6516483,6500006],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[6519885,6517108,6517003],"length":1,"stats":{"Line":3},"fn_name":null},{"line":104,"address":[6517316,6522841,6517140,6517828,6522975],"length":1,"stats":{"Line":3},"fn_name":null},{"line":105,"address":[10690228,10691519],"length":1,"stats":{"Line":2},"fn_name":null},{"line":106,"address":[6519090,6519373,6519164,6520208],"length":1,"stats":{"Line":4},"fn_name":"{closure#2}"},{"line":107,"address":[6520279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[10692726],"length":1,"stats":{"Line":1},"fn_name":null},{"line":112,"address":[12178889,12159563,12179393,12178980,12178949],"length":1,"stats":{"Line":4},"fn_name":null},{"line":114,"address":[7128806],"length":1,"stats":{"Line":3},"fn_name":null},{"line":115,"address":[6519847],"length":1,"stats":{"Line":1},"fn_name":null},{"line":119,"address":[6502764,6523471,6503341,6502552,6523337],"length":1,"stats":{"Line":0},"fn_name":null},{"line":120,"address":[12445440],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[10823504],"length":1,"stats":{"Line":2},"fn_name":"proxy_handler"},{"line":131,"address":[12470878,12471133],"length":1,"stats":{"Line":4},"fn_name":null},{"line":132,"address":[10701203,10701289],"length":1,"stats":{"Line":4},"fn_name":null},{"line":133,"address":[10714421,10714335],"length":1,"stats":{"Line":4},"fn_name":null},{"line":134,"address":[7120239],"length":1,"stats":{"Line":4},"fn_name":null},{"line":135,"address":[6529428],"length":1,"stats":{"Line":2},"fn_name":null},{"line":136,"address":[10701959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":137,"address":[12495433,12471943,12472772,12495567,12472263],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[12472735,12474535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[10715178],"length":1,"stats":{"Line":2},"fn_name":null},{"line":143,"address":[10715227],"length":1,"stats":{"Line":2},"fn_name":null},{"line":145,"address":[10717884],"length":1,"stats":{"Line":2},"fn_name":null},{"line":146,"address":[12205192,12189517,12205234],"length":1,"stats":{"Line":4},"fn_name":null},{"line":147,"address":[12488498,12487862,12495929,12487982,12496063],"length":1,"stats":{"Line":6},"fn_name":null},{"line":149,"address":[7120260],"length":1,"stats":{"Line":6},"fn_name":null},{"line":151,"address":[10733840],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[6548116,6548697,6553647,6548174,6553513],"length":1,"stats":{"Line":6},"fn_name":null},{"line":153,"address":[12493191,12491511,12493482],"length":1,"stats":{"Line":4},"fn_name":null},{"line":154,"address":[6550669,6550524],"length":1,"stats":{"Line":4},"fn_name":null},{"line":155,"address":[10736629,10736704],"length":1,"stats":{"Line":4},"fn_name":null},{"line":156,"address":[12211115,12211177,12211379,12210979],"length":1,"stats":{"Line":2},"fn_name":null},{"line":157,"address":[12493922],"length":1,"stats":{"Line":2},"fn_name":null},{"line":159,"address":[10723470],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[12208289],"length":1,"stats":{"Line":2},"fn_name":null},{"line":164,"address":[10734081],"length":1,"stats":{"Line":2},"fn_name":null},{"line":166,"address":[12208371],"length":1,"stats":{"Line":2},"fn_name":null},{"line":167,"address":[10706457,10706537],"length":1,"stats":{"Line":2},"fn_name":null},{"line":168,"address":[12214399,12214265,12193805,12194380,12193860],"length":1,"stats":{"Line":6},"fn_name":null},{"line":170,"address":[12194332,12196457],"length":1,"stats":{"Line":4},"fn_name":null},{"line":171,"address":[12480416,12479213],"length":1,"stats":{"Line":2},"fn_name":null},{"line":172,"address":[6536649,6536554],"length":1,"stats":{"Line":4},"fn_name":null},{"line":174,"address":[12196858,12197601,12196756,12196926],"length":1,"stats":{"Line":6},"fn_name":null},{"line":175,"address":[10723217,10722600,10722723,10722791],"length":1,"stats":{"Line":4},"fn_name":null},{"line":176,"address":[10710081,10709836,10709869,10709713],"length":1,"stats":{"Line":4},"fn_name":null},{"line":177,"address":[6537262,6537173],"length":1,"stats":{"Line":4},"fn_name":null},{"line":180,"address":[6536845,6537764],"length":1,"stats":{"Line":2},"fn_name":null},{"line":183,"address":[6551464,6537875,6537371],"length":1,"stats":{"Line":4},"fn_name":null},{"line":184,"address":[12480960,12494307,12480807],"length":1,"stats":{"Line":4},"fn_name":null},{"line":185,"address":[10711461,10711334],"length":1,"stats":{"Line":4},"fn_name":null},{"line":186,"address":[10724496],"length":1,"stats":{"Line":2},"fn_name":null},{"line":189,"address":[6539289,6539077,6538965],"length":1,"stats":{"Line":6},"fn_name":null},{"line":192,"address":[10712694],"length":1,"stats":{"Line":2},"fn_name":null},{"line":193,"address":[12482784],"length":1,"stats":{"Line":2},"fn_name":null},{"line":194,"address":[10712729],"length":1,"stats":{"Line":0},"fn_name":null},{"line":195,"address":[12483511,12497417,12482753,12484027,12497551],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[10714073,10728884,10728999,10717861,10727055],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[12203738,12188366,12203623,12203530,12192170],"length":1,"stats":{"Line":0},"fn_name":null},{"line":199,"address":[12204307,12204917,12204133],"length":1,"stats":{"Line":0},"fn_name":null},{"line":200,"address":[10729895],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[12486901],"length":1,"stats":{"Line":0},"fn_name":null},{"line":203,"address":[10717935,10730095,10730221,10714115],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[10705362,10713337,10712968,10704948,10704982,10701112],"length":1,"stats":{"Line":10},"fn_name":null},{"line":210,"address":[10718739],"length":1,"stats":{"Line":2},"fn_name":null},{"line":214,"address":[10719395,10719083],"length":1,"stats":{"Line":2},"fn_name":null}],"covered":81,"coverable":99},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","key_manager.rs"],"content":"// src/key_manager.rs\n\nuse crate::config::{AppConfig, RateLimitBehavior};\nuse crate::error::{AppError, Result as AppResult}; // Use AppResult alias where appropriate\nuse axum::http::StatusCode;\nuse chrono::{DateTime, Duration as ChronoDuration, NaiveDateTime, TimeZone, Utc}; // ENSURED TimeZone is imported\nuse chrono_tz::America::Los_Angeles; // Use Los_Angeles timezone (PST/PDT)\nuse chrono_tz::Tz; // Import Tz trait\nuse reqwest::{header::CONTENT_TYPE, Client};\nuse serde::{Deserialize, Serialize};\nuse std::{\n    collections::HashMap,\n    io as std_io, // Import standard io for Error kind\n    path::{Path, PathBuf},\n    sync::{\n        atomic::{AtomicUsize, Ordering},\n        Arc,\n    }, // Added Arc for mutex cloning\n};\nuse tokio::fs::{self as async_fs};\nuse tokio::sync::Mutex;\nuse tracing::{debug, error, info, warn};\nuse uuid::Uuid; // For unique temporary file names\n\n// --- Structures ---\n\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Default)]\npub enum KeyStatus {\n    #[default]\n    Available,\n    RateLimited,\n    Invalid,\n    TemporarilyUnavailable,\n}\n\n#[derive(Debug, Clone, Default, Serialize, Deserialize, PartialEq)]\npub struct KeyState {\n    pub status: KeyStatus,\n    pub reset_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct FlattenedKeyInfo {\n    pub key: String,\n    pub proxy_url: Option\u003cString\u003e,\n    pub target_url: String,\n    pub group_name: String,\n    pub top_p: Option\u003cf32\u003e,\n}\n// --- KeyManager ---\n\n#[derive(Debug)]\npub struct KeyManager {\n    // Store keys grouped by their original group name.\n    // The outer Vec represents groups, the tuple holds (group_name, keys_in_group).\n    // Order of groups is preserved based on config processing order.\n    grouped_keys: Vec\u003c(String, Vec\u003cFlattenedKeyInfo\u003e)\u003e,\n    // Map for O(1) lookup of key info by its MD5 hash ID.\n    key_id_map: HashMap\u003cString, FlattenedKeyInfo\u003e,\n    // Index of the group to try next.\n    current_group_index: AtomicUsize,\n    // Index of the key to try next *within each group*. The order matches `grouped_keys`.\n    key_indices_per_group: Vec\u003cAtomicUsize\u003e,\n    // REMOVED Arc\u003cRwLock\u003c...\u003e\u003e. State is now managed directly here.\n    // The entire KeyManager will be wrapped in an RwLock in AppState.\n    key_states: HashMap\u003cString, KeyState\u003e,\n    state_file_path: PathBuf,\n    // This mutex is for controlling writes to the state *file*, not in-memory state.\n    save_mutex: Arc\u003cMutex\u003c()\u003e\u003e,\n    rate_limit_behavior: crate::config::RateLimitBehavior, // Add the new field\n}\n\nimpl KeyManager {\n    #[tracing::instrument(level = \"info\", skip(config, config_path))]\n    pub async fn new(config: \u0026AppConfig, config_path: \u0026Path) -\u003e Self {\n        info!(\"Initializing KeyManager...\");\n        let state_file_path = config_path\n            .parent()\n            .unwrap_or_else(|| Path::new(\".\"))\n            .join(\"key_states.json\");\n        let state_file_path_display = state_file_path.display().to_string(); // Capture for logs\n        info!(key_state.path = %state_file_path_display, \"Key state persistence file\");\n\n        let persisted_states = load_key_states_from_file(\u0026state_file_path).await;\n        let mut grouped_keys_map: HashMap\u003cString, Vec\u003cFlattenedKeyInfo\u003e\u003e = HashMap::new();\n        // This HashMap now correctly implements  2\n        let mut key_id_map: HashMap\u003cString, FlattenedKeyInfo\u003e = HashMap::new();\n        let mut initial_key_states = HashMap::new();\n        let mut processed_keys_count = 0;\n        let now = Utc::now();\n\n        // First pass: Collect keys into a map grouped by name to preserve group structure\n        for group in \u0026config.groups {\n            if group.api_keys.is_empty() {\n                warn!(group.name = %group.name, \"Skipping group with no API keys.\");\n                continue;\n            }\n            info!(\n               group.name = %group.name,\n               group.key_count = group.api_keys.len(),\n               group.proxy_url = group.proxy_url.as_deref().unwrap_or(\"None\"),\n               group.target_url = %group.target_url,\n               \"Processing group for KeyManager\"\n            );\n            let group_entry = grouped_keys_map.entry(group.name.clone()).or_default();\n            for key in \u0026group.api_keys {\n                if key.trim().is_empty() {\n                    warn!(group.name = %group.name, \"Skipping empty API key string in group.\");\n                    continue;\n                }\n                let key_info = FlattenedKeyInfo {\n                    key: key.clone(),\n                    proxy_url: group.proxy_url.clone(),\n                    target_url: group.target_url.clone(),\n                    group_name: group.name.clone(),\n                    top_p: group.top_p,\n                };\n                group_entry.push(key_info.clone()); // Add key to its group in the map\n\n                // Calculate MD5 hash for O(1) lookup\n                let key_id = format!(\"{:x}\", md5::compute(key.as_bytes()));\n                key_id_map.insert(key_id, key_info.clone()); // Add to the ID map\n\n                // Process state (this part remains largely the same)\n                let state_to_insert =\n                    persisted_states\n                        .get(key)\n                        .map_or_else(KeyState::default, |persisted| {\n                            let is_expired = persisted.reset_time.is_some_and(|rt| now \u003e= rt);\n                            match persisted.status {\n                                KeyStatus::RateLimited | KeyStatus::TemporarilyUnavailable\n                                    if is_expired =\u003e\n                                {\n                                    info!(api_key.preview = %Self::preview(key), group.name = %group.name, \"Persisted limit for key has expired. Initializing as available.\");\n                                    KeyState::default()\n                                }\n                                KeyStatus::Invalid =\u003e {\n                                    info!(api_key.preview = %Self::preview(key), group.name = %group.name, \"Loaded persisted invalid state for key.\");\n                                    persisted.clone()\n                                }\n                                KeyStatus::RateLimited | KeyStatus::TemporarilyUnavailable =\u003e {\n                                    info!(api_key.preview = %Self::preview(key), group.name = %group.name, key.status = ?persisted.status, key.reset_time = ?persisted.reset_time, \"Loaded persisted limited state for key.\");\n                                    persisted.clone()\n                                }\n                                KeyStatus::Available =\u003e persisted.clone(),\n                            }\n                        });\n                initial_key_states\n                    .entry(key.clone())\n                    .or_insert(state_to_insert);\n                processed_keys_count += 1;\n            }\n        }\n\n        let mut grouped_keys: Vec\u003c(String, Vec\u003cFlattenedKeyInfo\u003e)\u003e =\n            Vec::with_capacity(config.groups.len());\n        let mut key_indices_per_group: Vec\u003cAtomicUsize\u003e =\n            Vec::with_capacity(config.groups.len());\n\n        // Iterate through config.groups again to maintain the original order\n        let mut active_group_count = 0;\n        for group_config in \u0026config.groups {\n            if let Some(keys) = grouped_keys_map.remove(\u0026group_config.name) {\n                if !keys.is_empty() {\n                    grouped_keys.push((group_config.name.clone(), keys));\n                    key_indices_per_group.push(AtomicUsize::new(0));\n                    active_group_count += 1;\n                }\n            }\n        }\n\n        let all_keys_in_config: std::collections::HashSet\u003cString\u003e = grouped_keys\n            .iter()\n            .flat_map(|(_, keys)| keys.iter().map(|ki| ki.key.clone()))\n            .collect();\n\n        initial_key_states.retain(|key, _| {\n            let key_in_config = all_keys_in_config.contains(key);\n            if !key_in_config {\n                warn!(api_key.preview = %Self::preview(key), \"Removing state for key no longer present in configuration.\");\n            }\n            key_in_config\n        });\n\n        if processed_keys_count == 0 {\n            error!(\"KeyManager Initialization Error: No usable API keys found after processing configuration. Application might not function correctly.\");\n        } else if active_group_count == 0 {\n            error!(\"KeyManager Initialization Error: Keys were processed, but no active groups were formed. Check group definitions.\");\n        }\n\n        info!(\n            key_manager.total_keys = processed_keys_count,\n            key_manager.total_groups = active_group_count,\n            \"KeyManager: Grouped keys into rotation list.\"\n        );\n        info!(\n            key_manager.state_count = initial_key_states.len(),\n            key_manager.persisted_count = persisted_states.len(),\n            \"KeyManager: Initialized key states.\"\n        );\n\n        let manager = Self {\n            grouped_keys,\n            key_id_map,\n            current_group_index: AtomicUsize::new(0),\n            key_indices_per_group,\n            key_states: initial_key_states,\n            state_file_path: state_file_path.clone(),\n            save_mutex: Arc::new(Mutex::new(())),\n            rate_limit_behavior: config.rate_limit_behavior.clone(),\n        };\n\n        debug!(key_state.path = %state_file_path_display, \"Performing initial state save/sync after KeyManager initialization.\");\n        if let Err(e) = manager.save_states().await {\n            error!(key_state.path = %state_file_path_display, error = ?e, \"Failed to perform initial save of key states. The state file might be outdated or missing.\");\n        } else {\n            debug!(key_state.path = %state_file_path_display, \"Initial state save completed successfully.\");\n        }\n        manager\n    }\n\n    #[tracing::instrument(level = \"debug\", skip(self))]\n    pub fn get_next_available_key_info(\u0026self) -\u003e Option\u003cFlattenedKeyInfo\u003e {\n        if self.grouped_keys.is_empty() {\n            warn!(\n                key_manager.status = \"empty\",\n                \"No key groups configured or available. Cannot provide a key.\"\n            );\n            return None;\n        }\n\n        let num_groups = self.grouped_keys.len();\n        let initial_group_index = self.current_group_index.load(Ordering::Relaxed);\n\n        for group_offset in 0..num_groups {\n            let current_group_idx = (initial_group_index + group_offset) % num_groups;\n            let Some((group_name, keys_in_group)) = self.grouped_keys.get(current_group_idx) else {\n                error!(group.index = current_group_idx, \"Internal inconsistency: Group index out of bounds. Skipping.\");\n                continue;\n            };\n\n            if keys_in_group.is_empty() {\n                debug!(group.index = current_group_idx, group.name = %group_name, \"Skipping empty group\");\n                continue;\n            }\n\n            let num_keys_in_group = keys_in_group.len();\n            let Some(group_key_index_atomic) = self.key_indices_per_group.get(current_group_idx) else {\n                error!(group.index = current_group_idx, group.name=%group_name, \"Internal inconsistency: Missing key index for group. Skipping.\");\n                continue;\n            };\n            let initial_key_index_in_group = group_key_index_atomic.load(Ordering::Relaxed);\n\n            debug!(group.index = current_group_idx, group.name = %group_name, group.key_count = num_keys_in_group, group.start_key_index = initial_key_index_in_group, \"Searching within group\");\n\n            for key_offset in 0..num_keys_in_group {\n                let current_key_idx_in_group =\n                    (initial_key_index_in_group + key_offset) % num_keys_in_group;\n                let Some(key_info) = keys_in_group.get(current_key_idx_in_group) else {\n                    error!(group.index = current_group_idx, group.name=%group_name, key.index=current_key_idx_in_group, \"Internal inconsistency: Key index out of bounds within group. Skipping key.\");\n                    continue;\n                };\n\n                let Some(key_state) = self.key_states.get(\u0026key_info.key) else {\n                    error!(api_key.preview = %Self::preview(\u0026key_info.key), group.name = %group_name, \"Internal inconsistency: Key found in group but missing from state map! Skipping.\");\n                    continue;\n                };\n\n                let now = Utc::now();\n                let is_expired = key_state.reset_time.is_some_and(|rt| now \u003e= rt);\n\n                let is_available = match key_state.status {\n                    KeyStatus::Available =\u003e true,\n                    KeyStatus::RateLimited | KeyStatus::TemporarilyUnavailable if is_expired =\u003e true,\n                    _ =\u003e false,\n                };\n\n                if is_available {\n                    if key_state.status != KeyStatus::Available {\n                         debug!(api_key.preview = %Self::preview(\u0026key_info.key), group.name = %group_name, \"Limit previously set but now expired\");\n                    }\n\n                    let next_key_idx_in_group = (current_key_idx_in_group + 1) % num_keys_in_group;\n                    group_key_index_atomic.store(next_key_idx_in_group, Ordering::Relaxed);\n                    let next_group_idx = (current_group_idx + 1) % num_groups;\n                    self.current_group_index.store(next_group_idx, Ordering::Relaxed);\n\n                    debug!(\n                       api_key.preview = %Self::preview(\u0026key_info.key),\n                       group.name = %group_name,\n                       \"Selected available API key using group round-robin\"\n                    );\n                    return Some(key_info.clone());\n                }\n            }\n            group_key_index_atomic.store(0, Ordering::Relaxed);\n        }\n\n        warn!(\n            key_manager.status = \"all_limited\",\n            \"All API keys checked are currently rate-limited or unavailable.\"\n        );\n        None\n    }\n\n    #[tracing::instrument(level = \"warn\", skip(self, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn mark_key_as_limited(\u0026mut self, api_key: \u0026str) -\u003e bool {\n        let mut group_name_for_log = \"unknown\".to_string();\n\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            if let Some(found_key_info) = self.grouped_keys.iter().flat_map(|(_, keys)| keys.iter()).find(|k| k.key == api_key) {\n                group_name_for_log.clone_from(\u0026found_key_info.group_name);\n            }\n\n            let now_utc = Utc::now();\n            let is_expired = key_state.reset_time.is_some_and(|rt| now_utc \u003e= rt);\n            if key_state.status != KeyStatus::Available \u0026\u0026 !is_expired {\n                debug!(key.status = ?key_state.status, \"Key already marked as limited. Ignoring.\");\n                return false;\n            }\n\n            warn!(group.name=%group_name_for_log, behavior = ?self.rate_limit_behavior, \"Marking key as rate-limited\");\n            match self.rate_limit_behavior {\n                RateLimitBehavior::BlockUntilMidnight =\u003e {\n                    let target_tz: Tz = Los_Angeles;\n                    let now_in_target_tz = now_utc.with_timezone(\u0026target_tz);\n                    let tomorrow_naive_target = (now_in_target_tz + ChronoDuration::days(1)).date_naive();\n                    let reset_time_naive_target: NaiveDateTime = tomorrow_naive_target.and_hms_opt(0, 0, 0).expect(\"Failed to calculate next midnight\");\n                    let reset_time_utc = target_tz.from_local_datetime(\u0026reset_time_naive_target).single().expect(\"Timezone conversion failed\").with_timezone(\u0026Utc);\n                    key_state.status = KeyStatus::RateLimited;\n                    key_state.reset_time = Some(reset_time_utc);\n                }\n                RateLimitBehavior::RetryNextKey =\u003e {\n                    key_state.status = KeyStatus::RateLimited;\n                    key_state.reset_time = Some(Utc::now() + ChronoDuration::seconds(1));\n                }\n            }\n            true\n        } else {\n            error!(\"Attempted to mark an unknown API key as limited!\");\n            false\n        }\n    }\n\n    #[tracing::instrument(level = \"warn\", skip(self, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn mark_key_as_invalid(\u0026mut self, api_key: \u0026str) -\u003e bool {\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            if key_state.status != KeyStatus::Invalid {\n                warn!(\"Marking key as permanently invalid\");\n                key_state.status = KeyStatus::Invalid;\n                key_state.reset_time = None;\n                return true;\n            }\n        } else {\n            error!(\"Attempted to mark an unknown API key as invalid!\");\n        }\n        false\n    }\n\n    #[tracing::instrument(level = \"warn\", skip(self, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn mark_key_as_temporarily_unavailable(\u0026mut self, api_key: \u0026str, duration: ChronoDuration) -\u003e bool {\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            let reset_time = Utc::now() + duration;\n            warn!(?duration, %reset_time, \"Marking key as temporarily unavailable\");\n            key_state.status = KeyStatus::TemporarilyUnavailable;\n            key_state.reset_time = Some(reset_time);\n            true\n        } else {\n            error!(\"Attempted to mark an unknown API key as temporarily unavailable!\");\n            false\n        }\n    }\n\n    /// Asynchronously saves the current state of the KeyManager.\n    #[tracing::instrument(level = \"debug\", skip(self))]\n    pub async fn save_states(\u0026self) -\u003e AppResult\u003c()\u003e {\n        let _save_guard = self.save_mutex.lock().await;\n        debug!(key_state.path = %self.state_file_path.display(), \"Acquired save mutex lock for save\");\n\n        Self::save_states_to_file_impl(\u0026self.state_file_path, \u0026self.key_states)\n            .await\n            .map_err(|io_err| {\n                error!(key_state.path = %self.state_file_path.display(), error = ?io_err, \"Save states failed\");\n                AppError::Io(io_err)\n            })\n    }\n\n    /// Implementation detail: Performs the atomic save operation.\n    #[tracing::instrument(level = \"debug\", skip(final_path, states), fields(key_state.path = %final_path.display(), state.count = states.len()))]\n    async fn save_states_to_file_impl(\n        final_path: \u0026Path,\n        states: \u0026HashMap\u003cString, KeyState\u003e,\n    ) -\u003e std_io::Result\u003c()\u003e {\n        debug!(\"Attempting atomic save\");\n        let parent_dir = final_path.parent().ok_or_else(|| {\n            std_io::Error::new(std_io::ErrorKind::InvalidInput, \"State file path has no parent directory\")\n        })?;\n        async_fs::create_dir_all(parent_dir).await?;\n\n        let base_filename = final_path.file_name().unwrap_or_default().to_string_lossy();\n        let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n        let temp_path = parent_dir.join(\u0026temp_filename);\n\n        let json_data = serde_json::to_string_pretty(states).map_err(|e| {\n            std_io::Error::new(std_io::ErrorKind::InvalidData, format!(\"Failed to serialize key states: {e}\"))\n        })?;\n\n        async_fs::write(\u0026temp_path, json_data.as_bytes()).await?;\n        async_fs::copy(\u0026temp_path, final_path).await?;\n        async_fs::remove_file(\u0026temp_path).await?;\n\n        info!(\"Successfully saved key states atomically\");\n        Ok(())\n    }\n\n    /// Generates a shortened preview of an API key for logging.\n    #[inline]\n    fn preview(key: \u0026str) -\u003e String {\n        let len = key.chars().count();\n        let end = std::cmp::min(6, len);\n        let start = if len \u003e 10 { len - 4 } else { len };\n        if len \u003e 10 {\n            format!(\"{}...{}\", key.chars().take(end).collect::\u003cString\u003e(), key.chars().skip(start).collect::\u003cString\u003e())\n        } else {\n            format!(\"{}...\", key.chars().take(end).collect::\u003cString\u003e())\n        }\n    }\n\n    pub fn get_key_states(\u0026self) -\u003e \u0026HashMap\u003cString, KeyState\u003e {\n        \u0026self.key_states\n    }\n\n    /// Provides a flattened list of all key info for admin/debug purposes.\n    pub fn get_all_key_info(\u0026self) -\u003e Vec\u003cFlattenedKeyInfo\u003e {\n        self.key_id_map.values().cloned().collect()\n    }\n\n    pub fn is_key_invalid(\u0026self, api_key: \u0026str) -\u003e bool {\n        self.key_states.get(api_key).map_or(false, |s| s.status == KeyStatus::Invalid)\n    }\n\n    fn reset_key_state_to_available(\u0026mut self, api_key: \u0026str) -\u003e bool {\n        if let Some(key_state) = self.key_states.get_mut(api_key) {\n            if key_state.status != KeyStatus::Available || key_state.reset_time.is_some() {\n                info!(api_key.preview = %Self::preview(api_key), \"Resetting key status to Available\");\n                key_state.status = KeyStatus::Available;\n                key_state.reset_time = None;\n                return true;\n            }\n        }\n        false\n    }\n\n    #[tracing::instrument(level = \"info\", skip(self), fields(key.id = %key_id))]\n    pub fn reset_key_status(\u0026mut self, key_id: \u0026str) -\u003e bool {\n        if let Some(key_info) = self.key_id_map.get(key_id) {\n            let key_to_reset = key_info.key.clone();\n            self.reset_key_state_to_available(\u0026key_to_reset)\n        } else {\n            warn!(\"Could not find key with ID '{}' to reset\", key_id);\n            false\n        }\n    }\n\n    /// Finds key info by its MD5 hash ID. Used to fetch data under a read lock.\n    pub fn get_key_info_by_id(\u0026self, key_id: \u0026str) -\u003e Option\u003c\u0026FlattenedKeyInfo\u003e {\n        self.key_id_map.get(key_id)\n    }\n\n    #[tracing::instrument(level = \"info\", skip(self, client, api_key), fields(api_key.preview = %Self::preview(api_key)))]\n    pub async fn perform_key_verification(\n        \u0026self,\n        api_key: \u0026str,\n        target_url_base: \u0026str,\n        client: \u0026Client,\n    ) -\u003e std::result::Result\u003cString, (StatusCode, String)\u003e {\n        info!(\"Verifying key with Gemini API\");\n\n        // Construct the full URL for verification\n        let target_url = format!(\n            \"{}/v1beta/models/gemini-pro:generateContent?key={}\",\n            target_url_base, api_key\n        );\n\n        let request_body = serde_json::json!({\n            \"contents\": [{\"parts\":[ {\"text\": \"Hi\"}]}]\n        });\n\n        match client\n            .post(\u0026target_url)\n            .header(CONTENT_TYPE, \"application/json\")\n            .json(\u0026request_body)\n            .send()\n            .await {\n                Ok(response) =\u003e {\n                    let status = response.status();\n                    let text = response.text().await.unwrap_or_else(|_| \"Could not read response body\".to_string());\n                    if status.is_success() {\n                        info!(api_key.preview = %Self::preview(api_key), \"Key verification successful\");\n                        Ok(text)\n                    } else {\n                        warn!(\n                            api_key.preview = %Self::preview(api_key),\n                            %status,\n                            error.body = %text,\n                            \"Key verification failed with non-success status\"\n                        );\n                        Err((status, text))\n                    }\n                }\n                Err(e) =\u003e {\n                     error!(api_key.preview = %Self::preview(api_key), error = ?e, \"Network or other error during key verification\");\n                     Err((StatusCode::INTERNAL_SERVER_ERROR, e.to_string()))\n                }\n            }\n    }\n\n    #[tracing::instrument(level = \"info\", skip(self, verification_result), fields(api_key.preview = %Self::preview(api_key)))]\n    pub fn update_key_status_from_verification(\n        \u0026mut self,\n        api_key: \u0026str,\n        verification_result: std::result::Result\u003cString, (StatusCode, String)\u003e,\n    ) -\u003e bool {\n        match verification_result {\n            Ok(_) =\u003e self.reset_key_state_to_available(api_key),\n            Err((status, _)) =\u003e {\n                if status.is_server_error() || status == StatusCode::REQUEST_TIMEOUT {\n                    self.mark_key_as_temporarily_unavailable(api_key, ChronoDuration::minutes(5))\n                } else {\n                    self.mark_key_as_invalid(api_key)\n                }\n            }\n        }\n    }\n}\n/// Helper function to load key states from the JSON file, with recovery attempt from temp file.\n#[tracing::instrument(level = \"info\", skip(path), fields(key_state.path = %path.display()))]\nasync fn load_key_states_from_file(path: \u0026Path) -\u003e HashMap\u003cString, KeyState\u003e {\n    let base_filename = path.file_name().unwrap_or_default().to_string_lossy();\n    let parent_dir = path.parent().unwrap_or_else(|| Path::new(\".\"));\n    let path_display = path.display().to_string(); // Capture display string\n\n    let mut recovered_from_temp = false;\n    let mut recovered_states = HashMap::new();\n\n    match async_fs::read_to_string(path).await {\n        Ok(json_data) =\u003e {\n            // Attempt to clean up any old temp files on successful load\n            cleanup_temp_files(parent_dir, \u0026base_filename).await;\n            match serde_json::from_str::\u003cHashMap\u003cString, KeyState\u003e\u003e(\u0026json_data) {\n                Ok(states) =\u003e {\n                    info!(state.count = states.len(), \"Successfully loaded key states\");\n                    return states;\n                }\n                Err(e) =\u003e {\n                    error!(error = %e, \"Failed to parse key state file (JSON invalid). Attempting recovery.\");\n                }\n            }\n        }\n        Err(ref e) if e.kind() == std_io::ErrorKind::NotFound =\u003e {\n            // This is not an error, just information\n            info!(\"Key state file not found. Checking for temporary recovery file.\");\n        }\n        Err(e) =\u003e {\n            // Log actual IO errors\n            error!(error = %e, \"Failed to read key state file due to IO error. Attempting recovery.\");\n        }\n    }\n\n    // Attempt recovery from temp file if main file failed or not found\n    if let Some(temp_path) = find_latest_temp_file(parent_dir, \u0026base_filename).await {\n        let temp_path_display = temp_path.display().to_string(); // Capture display string\n        warn!(temp_file.path = %temp_path_display, \"Attempting recovery from temporary state file.\");\n        match async_fs::read_to_string(\u0026temp_path).await {\n            Ok(temp_json_data) =\u003e {\n                match serde_json::from_str::\u003cHashMap\u003cString, KeyState\u003e\u003e(\u0026temp_json_data) {\n                    Ok(states) =\u003e {\n                        info!(state.count = states.len(), temp_file.path = %temp_path_display, \"Successfully recovered key states from temporary file\");\n                        // Attempt to copy recovered file to main path\n                        if let Err(copy_err) = async_fs::copy(\u0026temp_path, path).await {\n                            error!(\n                                temp_file.path = %temp_path_display,\n                                final_file.path = %path_display,\n                                error = ?copy_err,\n                                \"Failed to copy recovered temp state file to main path. State recovered in memory, but file system may be inconsistent.\"\n                            );\n                        } else {\n                            info!(final_file.path = %path_display, \"Successfully copied recovered temp state file to main path.\");\n                            if let Err(rm_err) = async_fs::remove_file(\u0026temp_path).await {\n                                warn!(temp_file.path = %temp_path_display, error = ?rm_err, \"Failed to remove temporary file after successful recovery.\");\n                            }\n                            // Clean up potentially other old temp files after successful copy\n                            cleanup_temp_files(parent_dir, \u0026base_filename).await;\n                        }\n                        recovered_from_temp = true;\n                        recovered_states = states; // Store recovered states\n                    }\n                    Err(parse_e) =\u003e {\n                        error!(temp_file.path = %temp_path_display, error = %parse_e, \"Failed to parse temporary key state file (JSON invalid). Recovery failed.\");\n                        // Attempt to remove corrupt temp file\n                        if let Err(rm_err) = async_fs::remove_file(\u0026temp_path).await {\n                            warn!(temp_file.path = %temp_path_display, error = ?rm_err, \"Failed to remove corrupt temporary file after parse failure\");\n                        }\n                        recovered_states = HashMap::new(); // Ensure empty map on parse failure\n                    }\n                }\n            }\n            Err(read_e) =\u003e {\n                error!(temp_file.path = %temp_path_display, error = %read_e, \"Failed to read temporary key state file. Recovery failed.\");\n                // Attempt to remove unreadable temp file\n                if let Err(rm_err) = async_fs::remove_file(\u0026temp_path).await {\n                    warn!(temp_file.path = %temp_path_display, error = ?rm_err, \"Failed to remove unreadable temporary file\");\n                }\n                recovered_states = HashMap::new(); // Ensure empty map on read failure\n            }\n        }\n    } else {\n        info!(\"No temporary state file found for recovery.\");\n    }\n\n    // Return recovered states if successful, otherwise empty map\n    if recovered_from_temp {\n        recovered_states\n    } else {\n        warn!(\"Recovery failed or no file found. Starting with empty key states.\");\n        HashMap::new()\n    }\n}\n\n/// Finds the most recently modified temporary state file matching the pattern.\n#[tracing::instrument(level = \"debug\", skip(temp_dir, base_filename))]\nasync fn find_latest_temp_file(temp_dir: \u0026Path, base_filename: \u0026str) -\u003e Option\u003cPathBuf\u003e {\n    let mut latest_mod_time: Option\u003cstd::time::SystemTime\u003e = None;\n    let mut latest_temp_file: Option\u003cPathBuf\u003e = None;\n    let temp_prefix = format!(\".{base_filename}.\");\n    let temp_suffix = \".tmp\";\n    debug!(temp_file.prefix = %temp_prefix, temp_file.suffix = %temp_suffix, directory = %temp_dir.display(), \"Searching for latest temporary file\");\n\n    if let Ok(mut read_dir) = async_fs::read_dir(temp_dir).await {\n        while let Ok(Some(entry)) = read_dir.next_entry().await {\n            let path = entry.path();\n            if path.is_file() {\n                if let Some(filename) = path.file_name().map(|n| n.to_string_lossy()) {\n                    if filename.starts_with(\u0026temp_prefix) \u0026\u0026 filename.ends_with(temp_suffix) {\n                        debug!(temp_file.path = %path.display(), \"Found potential temporary file\");\n                        if let Ok(metadata) = entry.metadata().await {\n                            if let Ok(modified) = metadata.modified() {\n                                if latest_mod_time.is_none() || modified \u003e latest_mod_time.unwrap()\n                                {\n                                    debug!(temp_file.path = %path.display(), ?modified, \"Updating latest temporary file\");\n                                    latest_mod_time = Some(modified);\n                                    latest_temp_file = Some(path.clone());\n                                }\n                            } else {\n                                warn!(temp_file.path = %path.display(), \"Could not get modified time for temp file\");\n                            }\n                        } else {\n                            warn!(temp_file.path = %path.display(), \"Could not get metadata for temp file\");\n                        }\n                    }\n                }\n            }\n        }\n    } else {\n        warn!(directory = %temp_dir.display(), \"Could not read directory to find temp files\");\n    }\n\n    if let Some(ref p) = latest_temp_file {\n        debug!(temp_file.path = %p.display(), \"Found latest temporary file\");\n    } else {\n        debug!(\"No suitable temporary file found\");\n    }\n    latest_temp_file\n}\n\n/// Cleans up all temporary state files matching the pattern in a directory.\n#[tracing::instrument(level = \"debug\", skip(temp_dir, base_filename))]\nasync fn cleanup_temp_files(temp_dir: \u0026Path, base_filename: \u0026str) {\n    let temp_prefix = format!(\".{base_filename}.\");\n    let temp_suffix = \".tmp\";\n\n    debug!(temp_file.prefix = %temp_prefix, temp_file.suffix = %temp_suffix, directory = %temp_dir.display(), \"Cleaning up temporary files\");\n    let mut cleaned_count = 0;\n\n    if let Ok(mut read_dir) = async_fs::read_dir(temp_dir).await {\n        while let Ok(Some(entry)) = read_dir.next_entry().await {\n            let path = entry.path();\n            if path.is_file() {\n                if let Some(filename) = path.file_name().map(|n| n.to_string_lossy()) {\n                    if filename.starts_with(\u0026temp_prefix) \u0026\u0026 filename.ends_with(temp_suffix) {\n                        warn!(temp_file.path = %path.display(), \"Cleaning up leftover temporary state file.\");\n                        if let Err(e) = async_fs::remove_file(\u0026path).await {\n                            error!(temp_file.path = %path.display(), error = ?e, \"Failed during cleanup of temporary state file.\");\n                        } else {\n                            cleaned_count += 1;\n                            debug!(temp_file.path = %path.display(), \"Successfully cleaned up temporary file.\");\n                        }\n                    }\n                }\n            }\n        }\n    } else {\n        warn!(directory = %temp_dir.display(), \"Could not read directory to clean temp files\");\n    }\n    debug!(cleaned_count, \"Temporary file cleanup finished\");\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::{KeyGroup, RateLimitBehavior, ServerConfig};\n    use std::fs::{self as sync_fs, File};\n    use std::io::Write;\n    use std::path::PathBuf;\n    use std::time::Duration;\n    use tempfile::tempdir;\n    use tokio::time::sleep;\n\n    fn create_test_config(groups: Vec\u003cKeyGroup\u003e) -\u003e AppConfig {\n        AppConfig {\n            server: ServerConfig {\n                port: 8080,\n                top_p: None,\n                admin_token: None,\n            },\n            groups,\n            rate_limit_behavior: RateLimitBehavior::default(),\n            internal_retries: 2,\n            temporary_block_minutes: 5,\n        }\n    }\n\n    fn create_temp_yaml_config(dir: \u0026tempfile::TempDir) -\u003e PathBuf {\n        let file_path = dir.path().join(\"test_config.yaml\");\n        let content = r#\"\n server:\n   port: 8080\n # No groups needed here, KeyManager uses AppConfig directly\n \"#;\n        let mut file = File::create(\u0026file_path).unwrap();\n        writeln!(file, \"{}\", content).unwrap();\n        file_path\n    }\n\n    // Helper to get the internal state for verification\n    // async fn get_manager_indices(manager: \u0026KeyManager) -\u003e (usize, Vec\u003cusize\u003e) {\n    //    let group_idx = manager.current_group_index.load(Ordering::Relaxed);\n    //    let key_indices = manager.key_indices_per_group.iter().map(|a| a.load(Ordering::Relaxed)).collect();\n    //    (group_idx, key_indices)\n    // }\n\n    #[tokio::test]\n    async fn test_key_manager_initialization_loads_persisted_state() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n\n        let future_reset = Utc::now() + ChronoDuration::hours(1);\n        let past_reset = Utc::now() - ChronoDuration::hours(1);\n        let persisted_states: HashMap\u003cString, KeyState\u003e = [\n            (\n                \"key_limited\".to_string(),\n                KeyState {\n                    status: KeyStatus::RateLimited,\n                    reset_time: Some(future_reset),\n                },\n            ),\n            (\n                \"key_expired\".to_string(),\n                KeyState {\n                    status: KeyStatus::RateLimited,\n                    reset_time: Some(past_reset),\n                },\n            ),\n            (\n                \"key_nolimit\".to_string(),\n                KeyState {\n                    status: KeyStatus::Available,\n                    reset_time: None,\n                },\n            ),\n            (\n                \"key_not_in_config\".to_string(),\n                KeyState {\n                    status: KeyStatus::Invalid,\n                    reset_time: None,\n                },\n            ),\n        ]\n        .iter()\n        .cloned()\n        .collect();\n        let json_data = serde_json::to_string(\u0026persisted_states).unwrap();\n        sync_fs::write(\u0026state_path, json_data).unwrap();\n\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\n                \"key_limited\".to_string(),\n                \"key_expired\".to_string(),\n                \"key_nolimit\".to_string(),\n                \"key_new\".to_string(),\n            ],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n        let manager = KeyManager::new(\u0026config, \u0026config_path).await;\n        let final_states = \u0026manager.key_states;\n\n        assert_eq!(final_states.len(), 4);\n        assert_eq!(final_states[\"key_limited\"].status, KeyStatus::RateLimited);\n        assert_eq!(final_states[\"key_limited\"].reset_time, Some(future_reset));\n        assert_eq!(final_states[\"key_expired\"].status, KeyStatus::Available);\n        assert!(final_states[\"key_expired\"].reset_time.is_none());\n        assert_eq!(final_states[\"key_nolimit\"].status, KeyStatus::Available);\n        assert!(final_states[\"key_nolimit\"].reset_time.is_none());\n        assert!(final_states.contains_key(\"key_new\"));\n        assert_eq!(final_states[\"key_new\"].status, KeyStatus::Available);\n        assert!(final_states[\"key_new\"].reset_time.is_none());\n        assert!(!final_states.contains_key(\"key_not_in_config\"));\n        assert_eq!(manager.state_file_path, state_path);\n    }\n\n    #[tokio::test]\n    async fn test_mark_key_as_limited_saves_state_atomically() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n        File::create(\u0026state_path)\n            .unwrap()\n            .write_all(b\"initial_content\")\n            .unwrap();\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"k1\".to_string(), \"k2\".to_string()],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        sleep(Duration::from_millis(50)).await;\n        let initial_saved_json =\n            sync_fs::read_to_string(\u0026state_path).expect(\"State file should exist after init\");\n        let initial_saved_states: HashMap\u003cString, KeyState\u003e =\n            serde_json::from_str(\u0026initial_saved_json).expect(\"Should parse initial JSON\");\n        assert_eq!(initial_saved_states.len(), 2);\n\n        manager.mark_key_as_limited(\"k1\");\n        manager.save_states().await.unwrap(); // Explicitly save for test\n\n        let saved_json =\n            sync_fs::read_to_string(\u0026state_path).expect(\"State file should exist after save\");\n        let saved_states: HashMap\u003cString, KeyState\u003e =\n            serde_json::from_str(\u0026saved_json).expect(\"Should parse saved JSON\");\n\n        assert_eq!(saved_states.len(), 2);\n        assert_eq!(saved_states[\"k1\"].status, KeyStatus::RateLimited);\n        assert!(saved_states[\"k1\"].reset_time.is_some());\n        assert!(saved_states[\"k1\"].reset_time.unwrap() \u003e Utc::now() - ChronoDuration::seconds(1)); // Check it's recent\n        assert_eq!(saved_states[\"k2\"].status, KeyStatus::Available);\n\n        let base_filename = state_path.file_name().unwrap().to_string_lossy();\n        let mut found_temp = false;\n        for entry in sync_fs::read_dir(dir.path()).unwrap() {\n            let path = entry.unwrap().path();\n            if path.is_file() {\n                if let Some(filename) = path.file_name().map(|n| n.to_string_lossy()) {\n                    if filename.starts_with(\u0026format!(\".{}.\", base_filename))\n                        \u0026\u0026 filename.ends_with(\".tmp\")\n                    {\n                        error!(\"Found unexpected temp file: {}\", path.display());\n                        found_temp = true;\n                    }\n                }\n            }\n        }\n        assert!(\n            !found_temp,\n            \"Temporary state file should not exist after successful save\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_skips_persisted_limited_key() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n        let future_reset = Utc::now() + ChronoDuration::hours(1);\n        let persisted: HashMap\u003cString, KeyState\u003e = [(\n            \"k1\".to_string(),\n            KeyState {\n                status: KeyStatus::RateLimited,\n                reset_time: Some(future_reset),\n            },\n        )]\n        .iter()\n        .cloned()\n        .collect();\n        sync_fs::write(\u0026state_path, serde_json::to_string(\u0026persisted).unwrap()).unwrap();\n\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"k1\".to_string(), \"k2\".to_string()],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n        let manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        let key_info1 = manager.get_next_available_key_info().unwrap();\n        assert_eq!(key_info1.key, \"k2\"); // Should skip k1\n        let key_info2 = manager.get_next_available_key_info().unwrap();\n        assert_eq!(key_info2.key, \"k2\"); // Should loop back to k2 as k1 is still limited\n    }\n\n    #[tokio::test]\n    async fn test_initial_save_syncs_state_after_loading() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let state_path = dir.path().join(\"key_states.json\");\n\n        // State file with an expired key and a key not in the new config\n        let past_reset = Utc::now() - ChronoDuration::hours(1);\n        let persisted: HashMap\u003cString, KeyState\u003e = [\n            (\n                \"k1_expired\".to_string(),\n                KeyState {\n                    status: KeyStatus::RateLimited,\n                    reset_time: Some(past_reset),\n                },\n            ),\n            (\n                \"k2_stale\".to_string(),\n                KeyState {\n                    status: KeyStatus::Available,\n                    reset_time: None,\n                },\n            ),\n        ]\n        .iter()\n        .cloned()\n        .collect();\n        sync_fs::write(\u0026state_path, serde_json::to_string(\u0026persisted).unwrap()).unwrap();\n\n        // New config only has k1_expired and a new key k3\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"k1_expired\".to_string(), \"k3_new\".to_string()],\n            proxy_url: None,\n            target_url: \"t1\".to_string(),\n            top_p: None,\n        }];\n        let config = create_test_config(groups);\n\n        // Init manager - this should trigger an initial save\n        let _manager = KeyManager::new(\u0026config, \u0026config_path).await;\n        sleep(Duration::from_millis(250)).await; // Wait for async save\n\n        // Read the file back and check its contents\n        let final_json = sync_fs::read_to_string(\u0026state_path).unwrap();\n        let final_states: HashMap\u003cString, KeyState\u003e = serde_json::from_str(\u0026final_json).unwrap();\n\n        // The final saved state should reflect the cleanup:\n        // - k1_expired should be Available because its timer expired on load.\n        // - k2_stale should be removed because it's not in the new config.\n        // - k3_new should be added as Available.\n        assert_eq!(final_states.len(), 2);\n        assert!(final_states.contains_key(\"k1_expired\"));\n        assert!(final_states.contains_key(\"k3_new\"));\n        assert!(!final_states.contains_key(\"k2_stale\"));\n        assert_eq!(final_states[\"k1_expired\"].status, KeyStatus::Available);\n        assert!(final_states[\"k1_expired\"].reset_time.is_none());\n        assert_eq!(final_states[\"k3_new\"].status, KeyStatus::Available);\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_group_round_robin() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![\n            KeyGroup {\n                name: \"g1\".to_string(),\n                api_keys: vec![\"g1k1\".to_string(), \"g1k2\".to_string()],\n                proxy_url: None,\n                target_url: \"t1\".to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g2\".to_string(),\n                api_keys: vec![\"g2k1\".to_string()],\n                proxy_url: None,\n                target_url: \"t2\".to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g3\".to_string(),\n                api_keys: vec![\"g3k1\".to_string(), \"g3k2\".to_string(), \"g3k3\".to_string()],\n                proxy_url: None,\n                target_url: \"t3\".to_string(),\n                top_p: None,\n            },\n        ];\n        let config = create_test_config(groups);\n        let manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        // Expected sequence: g1k1, g2k1, g3k1, g1k2, g2k1 (loops), g3k2, g1k1 (loops), ...\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g2k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k2\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g2k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k2\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g2k1\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k3\");\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_skips_limited_keys_and_groups() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![\n            KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"g1k1\".to_string(), \"g1k2\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None },\n            KeyGroup { name: \"g2\".to_string(), api_keys: vec![\"g2k1\".to_string()], proxy_url: None, target_url: \"t2\".to_string(), top_p: None },\n            KeyGroup { name: \"g3\".to_string(), api_keys: vec![\"g3k1\".to_string()], proxy_url: None, target_url: \"t3\".to_string(), top_p: None },\n        ];\n        let mut config = create_test_config(groups);\n        // Use BlockUntilMidnight to make test deterministic\n        config.rate_limit_behavior = RateLimitBehavior::BlockUntilMidnight;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        // Limit g1k1 and all of g2\n        manager.mark_key_as_limited(\"g1k1\");\n        manager.mark_key_as_limited(\"g2k1\");\n        sleep(Duration::from_millis(50)).await; // allow state to be saved\n\n        // Expected sequence: g1k2 (starts at g1, skips g1k1), g3k1 (skips g2), g1k2 (wraps around)\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k2\", \"Should select g1k2 first\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g3k1\", \"Should select g3k1 after skipping g2\");\n        assert_eq!(manager.get_next_available_key_info().unwrap().key, \"g1k2\", \"Should wrap around and select g1k2 again\");\n    }\n\n    #[tokio::test]\n    async fn test_get_next_key_returns_none_when_all_limited() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![\n            KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"g1k1\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None },\n            KeyGroup { name: \"g2\".to_string(), api_keys: vec![\"g2k1\".to_string()], proxy_url: None, target_url: \"t2\".to_string(), top_p: None },\n        ];\n        let mut config = create_test_config(groups);\n        // Use BlockUntilMidnight to make test deterministic\n        config.rate_limit_behavior = RateLimitBehavior::BlockUntilMidnight;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        manager.mark_key_as_limited(\"g1k1\");\n        manager.mark_key_as_limited(\"g2k1\");\n        sleep(Duration::from_millis(250)).await;\n\n        assert!(manager.get_next_available_key_info().is_none(), \"Should return None when all keys are limited\");\n    }\n\n    #[tokio::test]\n    async fn test_load_recovers_from_temp_file() {\n        let dir = tempdir().unwrap();\n        let final_path = dir.path().join(\"key_states.json\");\n        let base_filename = final_path.file_name().unwrap().to_string_lossy();\n        let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n        let temp_path = dir.path().join(temp_filename);\n\n        let expected_states: HashMap\u003cString, KeyState\u003e =\n            [(\"recovered_key\".to_string(), KeyState::default())]\n                .iter()\n                .cloned()\n                .collect();\n        let json_data = serde_json::to_string(\u0026expected_states).unwrap();\n        sync_fs::write(\u0026temp_path, json_data).unwrap();\n\n        // Ensure final file does not exist\n        let _ = sync_fs::remove_file(\u0026final_path);\n\n        let loaded_states = load_key_states_from_file(\u0026final_path).await;\n\n        assert_eq!(loaded_states, expected_states);\n        assert!(\n            final_path.exists(),\n            \"Final file should be created from temp file\"\n        );\n        assert!(\n            !temp_path.exists(),\n            \"Temp file should be removed after successful recovery\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_load_does_not_recover_from_corrupted_temp_file() {\n        let dir = tempdir().unwrap();\n        let final_path = dir.path().join(\"key_states.json\");\n        let base_filename = final_path.file_name().unwrap().to_string_lossy();\n        let temp_filename = format!(\".{}.{}.tmp\", base_filename, Uuid::new_v4());\n        let temp_path = dir.path().join(temp_filename);\n\n        // Write corrupted JSON\n        sync_fs::write(\u0026temp_path, \"{ not json }\").unwrap();\n\n        // Ensure final file does not exist\n        let _ = sync_fs::remove_file(\u0026final_path);\n\n        let loaded_states = load_key_states_from_file(\u0026final_path).await;\n\n        assert!(\n            loaded_states.is_empty(),\n            \"Should return empty map on recovery failure\"\n        );\n        assert!(\n            !final_path.exists(),\n            \"Final file should not be created on recovery failure\"\n        );\n        assert!(\n            !temp_path.exists(),\n            \"Corrupted temp file should be removed after failed recovery attempt\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_mark_key_as_limited_block_until_midnight() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"k1\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None }];\n        let mut config = create_test_config(groups);\n        config.rate_limit_behavior = RateLimitBehavior::BlockUntilMidnight;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        manager.mark_key_as_limited(\"k1\");\n\n        let states = \u0026manager.key_states;\n        let key_state = states.get(\"k1\").unwrap();\n\n        assert_eq!(key_state.status, KeyStatus::RateLimited);\n        assert!(key_state.reset_time.is_some());\n        let reset_time = key_state.reset_time.unwrap();\n        assert!(reset_time \u003e Utc::now());\n        // Check that it's roughly 24h from now (could be less depending on time of day)\n        assert!(reset_time \u003c Utc::now() + ChronoDuration::hours(25));\n    }\n\n    #[tokio::test]\n    async fn test_mark_key_as_limited_retry_next_key() {\n        let dir = tempdir().unwrap();\n        let config_path = create_temp_yaml_config(\u0026dir);\n        let groups = vec![KeyGroup { name: \"g1\".to_string(), api_keys: vec![\"k1\".to_string()], proxy_url: None, target_url: \"t1\".to_string(), top_p: None }];\n        let mut config = create_test_config(groups);\n        config.rate_limit_behavior = RateLimitBehavior::RetryNextKey;\n        let mut manager = KeyManager::new(\u0026config, \u0026config_path).await;\n\n        manager.mark_key_as_limited(\"k1\");\n\n        let states = \u0026manager.key_states;\n        let key_state = states.get(\"k1\").unwrap();\n\n        assert_eq!(key_state.status, KeyStatus::RateLimited);\n        assert!(key_state.reset_time.is_some());\n        let reset_time = key_state.reset_time.unwrap();\n        // Should be very close to now\n        assert!(reset_time \u003e Utc::now());\n        assert!(reset_time \u003c Utc::now() + ChronoDuration::seconds(1));\n    }\n}\n","traces":[{"line":75,"address":[11433346,11433328],"length":1,"stats":{"Line":20},"fn_name":null},{"line":76,"address":[12081802,12081656,12128991,12082327,12128857],"length":1,"stats":{"Line":12},"fn_name":null},{"line":77,"address":[10446738,10448124],"length":1,"stats":{"Line":8},"fn_name":null},{"line":79,"address":[10337121,10337120],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":81,"address":[10448309,10448210],"length":1,"stats":{"Line":8},"fn_name":null},{"line":82,"address":[10316862,10362201,10317379,10362335,10316779],"length":1,"stats":{"Line":12},"fn_name":null},{"line":84,"address":[7124127],"length":1,"stats":{"Line":12},"fn_name":null},{"line":85,"address":[10306555],"length":1,"stats":{"Line":4},"fn_name":null},{"line":87,"address":[6114217],"length":1,"stats":{"Line":4},"fn_name":null},{"line":88,"address":[10319735],"length":1,"stats":{"Line":4},"fn_name":null},{"line":89,"address":[10451446],"length":1,"stats":{"Line":4},"fn_name":null},{"line":90,"address":[6114413],"length":1,"stats":{"Line":4},"fn_name":null},{"line":93,"address":[10319931],"length":1,"stats":{"Line":4},"fn_name":null},{"line":94,"address":[10321080,10307076],"length":1,"stats":{"Line":8},"fn_name":null},{"line":95,"address":[10321114,10328877,10349807,10349673],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[12104620,12130479,12102975,12130345,12103249,12104346,12101859,12101262,12101328],"length":1,"stats":{"Line":12},"fn_name":null},{"line":100,"address":[10322752,10324123],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[10322947,10324318],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[6129038,6132376],"length":1,"stats":{"Line":8},"fn_name":null},{"line":106,"address":[12105228],"length":1,"stats":{"Line":4},"fn_name":null},{"line":107,"address":[10325217],"length":1,"stats":{"Line":4},"fn_name":null},{"line":108,"address":[10350665,10350799,10325349,10326622],"length":1,"stats":{"Line":0},"fn_name":null},{"line":112,"address":[12105506],"length":1,"stats":{"Line":4},"fn_name":null},{"line":113,"address":[6132766],"length":1,"stats":{"Line":4},"fn_name":null},{"line":114,"address":[10470103],"length":1,"stats":{"Line":4},"fn_name":null},{"line":115,"address":[10325535],"length":1,"stats":{"Line":4},"fn_name":null},{"line":116,"address":[12105779],"length":1,"stats":{"Line":4},"fn_name":null},{"line":118,"address":[6133204,6133149],"length":1,"stats":{"Line":8},"fn_name":null},{"line":121,"address":[10470504],"length":1,"stats":{"Line":4},"fn_name":null},{"line":122,"address":[10339607,10339158,10339073],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[6133615,6133717],"length":1,"stats":{"Line":8},"fn_name":null},{"line":128,"address":[10326312,10337152,10339583],"length":1,"stats":{"Line":6},"fn_name":"{closure#1}"},{"line":129,"address":[12126416,12117390,12126421],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":130,"address":[10337279],"length":1,"stats":{"Line":2},"fn_name":null},{"line":132,"address":[10337347,10337385],"length":1,"stats":{"Line":1},"fn_name":null},{"line":134,"address":[6158431,6151626,6150863,6144667,6158297],"length":1,"stats":{"Line":3},"fn_name":null},{"line":135,"address":[12124624],"length":1,"stats":{"Line":1},"fn_name":null},{"line":138,"address":[10338246,10351657,10337353,10337471,10339602,10351791],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[10482876],"length":1,"stats":{"Line":0},"fn_name":null},{"line":142,"address":[10340139,10352287,10337407,10352153,10340914],"length":1,"stats":{"Line":3},"fn_name":null},{"line":143,"address":[6148108],"length":1,"stats":{"Line":1},"fn_name":null},{"line":145,"address":[10481973],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[12106562,12106611],"length":1,"stats":{"Line":8},"fn_name":null},{"line":149,"address":[10326408],"length":1,"stats":{"Line":4},"fn_name":null},{"line":151,"address":[6133827,6133896],"length":1,"stats":{"Line":4},"fn_name":null},{"line":155,"address":[10451819,10451741],"length":1,"stats":{"Line":8},"fn_name":null},{"line":157,"address":[10451960,10451864],"length":1,"stats":{"Line":8},"fn_name":null},{"line":161,"address":[6114918],"length":1,"stats":{"Line":4},"fn_name":null},{"line":162,"address":[10465689,10452123,10452023],"length":1,"stats":{"Line":12},"fn_name":null},{"line":163,"address":[10465593,10452237,10464961],"length":1,"stats":{"Line":12},"fn_name":null},{"line":164,"address":[10333944,10333438,10333558],"length":1,"stats":{"Line":12},"fn_name":null},{"line":165,"address":[10333572,10333640],"length":1,"stats":{"Line":8},"fn_name":null},{"line":166,"address":[10465386],"length":1,"stats":{"Line":4},"fn_name":null},{"line":167,"address":[12101101,12101045],"length":1,"stats":{"Line":4},"fn_name":null},{"line":172,"address":[10320658],"length":1,"stats":{"Line":4},"fn_name":null},{"line":174,"address":[12126448,12126528,12126475,12126563],"length":1,"stats":{"Line":16},"fn_name":"{closure#2}"},{"line":177,"address":[10348293,10348287,10347181,10307788,10346416],"length":1,"stats":{"Line":8},"fn_name":"{closure#3}"},{"line":178,"address":[10359479],"length":1,"stats":{"Line":4},"fn_name":null},{"line":179,"address":[10346483],"length":1,"stats":{"Line":4},"fn_name":null},{"line":180,"address":[6154330,6153638,6153680,6159919,6159785,6155449],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[10320899],"length":1,"stats":{"Line":4},"fn_name":null},{"line":186,"address":[10452532,10497785,10453103,10497919,10452593],"length":1,"stats":{"Line":6},"fn_name":null},{"line":187,"address":[6115441],"length":1,"stats":{"Line":4},"fn_name":null},{"line":188,"address":[12133951,12133817,12089956],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[10311624,10312134,10354137,10308425,10354271],"length":1,"stats":{"Line":12},"fn_name":null},{"line":196,"address":[10328971,10327841,10327222,10367791,10325120,10328772,10367657,10329613,10329812],"length":1,"stats":{"Line":12},"fn_name":null},{"line":197,"address":[12095866,12096707],"length":1,"stats":{"Line":0},"fn_name":null},{"line":198,"address":[12096064,12096905],"length":1,"stats":{"Line":0},"fn_name":null},{"line":205,"address":[6124580,6122301],"length":1,"stats":{"Line":8},"fn_name":null},{"line":208,"address":[12097410],"length":1,"stats":{"Line":4},"fn_name":null},{"line":209,"address":[12097548,12097481],"length":1,"stats":{"Line":8},"fn_name":null},{"line":210,"address":[10330439],"length":1,"stats":{"Line":4},"fn_name":null},{"line":213,"address":[10499769,10462371,10499903,10462457,10462973],"length":1,"stats":{"Line":12},"fn_name":null},{"line":214,"address":[10446199,10464779,10475765,10462929],"length":1,"stats":{"Line":12},"fn_name":null},{"line":215,"address":[12135935,12111744,12112355,12111854,12135801],"length":1,"stats":{"Line":0},"fn_name":null},{"line":217,"address":[12111772,12114691,12136431,12136297],"length":1,"stats":{"Line":8},"fn_name":null},{"line":219,"address":[12116867],"length":1,"stats":{"Line":4},"fn_name":null},{"line":223,"address":[11464152,11433376,11434724],"length":1,"stats":{"Line":3},"fn_name":null},{"line":224,"address":[11434869,11433899],"length":1,"stats":{"Line":6},"fn_name":null},{"line":225,"address":[10356649,10356783],"length":1,"stats":{"Line":0},"fn_name":null},{"line":229,"address":[7032180],"length":1,"stats":{"Line":0},"fn_name":null},{"line":232,"address":[11434949,11434883],"length":1,"stats":{"Line":6},"fn_name":null},{"line":233,"address":[11434957],"length":1,"stats":{"Line":3},"fn_name":null},{"line":235,"address":[11437131],"length":1,"stats":{"Line":3},"fn_name":null},{"line":236,"address":[7005035,7007407,7007495],"length":1,"stats":{"Line":6},"fn_name":null},{"line":237,"address":[11439736,11439797],"length":1,"stats":{"Line":6},"fn_name":null},{"line":238,"address":[11426858,11404845],"length":1,"stats":{"Line":0},"fn_name":null},{"line":242,"address":[11404883,11404827],"length":1,"stats":{"Line":6},"fn_name":null},{"line":243,"address":[10357775,10357641],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[11404897,11404963],"length":1,"stats":{"Line":6},"fn_name":null},{"line":248,"address":[11404971],"length":1,"stats":{"Line":3},"fn_name":null},{"line":249,"address":[11438123,11454626],"length":1,"stats":{"Line":0},"fn_name":null},{"line":252,"address":[11440274,11440204],"length":1,"stats":{"Line":6},"fn_name":null},{"line":254,"address":[11405194,11405727],"length":1,"stats":{"Line":6},"fn_name":null},{"line":256,"address":[11427749,11430661],"length":1,"stats":{"Line":6},"fn_name":null},{"line":257,"address":[11443861,11443959,11443798],"length":1,"stats":{"Line":6},"fn_name":null},{"line":259,"address":[11430908,11430972],"length":1,"stats":{"Line":6},"fn_name":null},{"line":260,"address":[10359263,10359129],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[11409014,11409076],"length":1,"stats":{"Line":6},"fn_name":null},{"line":265,"address":[10504265,10504399],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[7011919],"length":1,"stats":{"Line":3},"fn_name":null},{"line":270,"address":[6163696,6163701],"length":1,"stats":{"Line":9},"fn_name":"{closure#0}"},{"line":272,"address":[7012053],"length":1,"stats":{"Line":3},"fn_name":null},{"line":273,"address":[11409338],"length":1,"stats":{"Line":3},"fn_name":null},{"line":274,"address":[11444443,11444461],"length":1,"stats":{"Line":3},"fn_name":null},{"line":275,"address":[7012104],"length":1,"stats":{"Line":0},"fn_name":null},{"line":278,"address":[7012158],"length":1,"stats":{"Line":3},"fn_name":null},{"line":279,"address":[11431468],"length":1,"stats":{"Line":3},"fn_name":null},{"line":280,"address":[10360255,10360121],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[11445420,11442422,11445517],"length":1,"stats":{"Line":6},"fn_name":null},{"line":284,"address":[11445494],"length":1,"stats":{"Line":3},"fn_name":null},{"line":285,"address":[11445670,11445538],"length":1,"stats":{"Line":3},"fn_name":null},{"line":286,"address":[11445640],"length":1,"stats":{"Line":3},"fn_name":null},{"line":288,"address":[12140927,12140793],"length":1,"stats":{"Line":6},"fn_name":null},{"line":289,"address":[11437146,11436189],"length":1,"stats":{"Line":0},"fn_name":null},{"line":293,"address":[7015978,7018446],"length":1,"stats":{"Line":6},"fn_name":null},{"line":296,"address":[11408741],"length":1,"stats":{"Line":3},"fn_name":null},{"line":299,"address":[11424831,11424300],"length":1,"stats":{"Line":6},"fn_name":null},{"line":303,"address":[11402735],"length":1,"stats":{"Line":3},"fn_name":null},{"line":307,"address":[7044348,7033920,7035531],"length":1,"stats":{"Line":2},"fn_name":null},{"line":308,"address":[11466774],"length":1,"stats":{"Line":2},"fn_name":null},{"line":310,"address":[11455487,11455578,11462453,11461822],"length":1,"stats":{"Line":6},"fn_name":null},{"line":311,"address":[7036347,7036277],"length":1,"stats":{"Line":12},"fn_name":null},{"line":312,"address":[11433819,11433861],"length":1,"stats":{"Line":4},"fn_name":null},{"line":315,"address":[11468930],"length":1,"stats":{"Line":2},"fn_name":null},{"line":316,"address":[11468959],"length":1,"stats":{"Line":2},"fn_name":null},{"line":317,"address":[11433950,11434030],"length":1,"stats":{"Line":2},"fn_name":null},{"line":318,"address":[10506543,10506409],"length":1,"stats":{"Line":0},"fn_name":null},{"line":319,"address":[11456591],"length":1,"stats":{"Line":0},"fn_name":null},{"line":322,"address":[11458543,11459035,11456056],"length":1,"stats":{"Line":6},"fn_name":null},{"line":323,"address":[11436943,11431510],"length":1,"stats":{"Line":2},"fn_name":null},{"line":325,"address":[11439253],"length":1,"stats":{"Line":1},"fn_name":null},{"line":326,"address":[11461327],"length":1,"stats":{"Line":1},"fn_name":null},{"line":327,"address":[7041943],"length":1,"stats":{"Line":1},"fn_name":null},{"line":328,"address":[11439474],"length":1,"stats":{"Line":1},"fn_name":null},{"line":329,"address":[11461597],"length":1,"stats":{"Line":1},"fn_name":null},{"line":330,"address":[11474769],"length":1,"stats":{"Line":1},"fn_name":null},{"line":331,"address":[11474787],"length":1,"stats":{"Line":1},"fn_name":null},{"line":333,"address":[7042507],"length":1,"stats":{"Line":2},"fn_name":null},{"line":334,"address":[7041857],"length":1,"stats":{"Line":2},"fn_name":null},{"line":335,"address":[11439231,11439768],"length":1,"stats":{"Line":4},"fn_name":null},{"line":338,"address":[11439750],"length":1,"stats":{"Line":2},"fn_name":null},{"line":340,"address":[11462458,11461989,11455676],"length":1,"stats":{"Line":0},"fn_name":null},{"line":341,"address":[7042997],"length":1,"stats":{"Line":0},"fn_name":null},{"line":346,"address":[11464135,11470052,11463840,11465472],"length":1,"stats":{"Line":2},"fn_name":null},{"line":347,"address":[11479088,11477359],"length":1,"stats":{"Line":4},"fn_name":null},{"line":348,"address":[11479151,11479218],"length":1,"stats":{"Line":4},"fn_name":null},{"line":349,"address":[11444163,11444739],"length":1,"stats":{"Line":4},"fn_name":null},{"line":350,"address":[7047254],"length":1,"stats":{"Line":2},"fn_name":null},{"line":351,"address":[7047272],"length":1,"stats":{"Line":2},"fn_name":null},{"line":352,"address":[11466776],"length":1,"stats":{"Line":2},"fn_name":null},{"line":355,"address":[12143929,12144063],"length":1,"stats":{"Line":0},"fn_name":null},{"line":357,"address":[7046728],"length":1,"stats":{"Line":0},"fn_name":null},{"line":361,"address":[11477604,11471967,11470096,11470407],"length":1,"stats":{"Line":1},"fn_name":null},{"line":362,"address":[11454164,11451449,11448543,11450718],"length":1,"stats":{"Line":3},"fn_name":null},{"line":363,"address":[11483757,11483807],"length":1,"stats":{"Line":2},"fn_name":null},{"line":364,"address":[10508889,10509023],"length":1,"stats":{"Line":2},"fn_name":null},{"line":365,"address":[11451372],"length":1,"stats":{"Line":1},"fn_name":null},{"line":366,"address":[11473454],"length":1,"stats":{"Line":1},"fn_name":null},{"line":367,"address":[11484417],"length":1,"stats":{"Line":1},"fn_name":null},{"line":369,"address":[6171999,6171865],"length":1,"stats":{"Line":0},"fn_name":null},{"line":370,"address":[11487132],"length":1,"stats":{"Line":0},"fn_name":null},{"line":376,"address":[12146381,12145611,12145407,12145535,12146903,12145360],"length":1,"stats":{"Line":16},"fn_name":"{async_fn#0}"},{"line":377,"address":[6174765,6174925,6174828,6175038],"length":1,"stats":{"Line":8},"fn_name":null},{"line":378,"address":[10512935,10512852,10519033,10513455,10519167],"length":1,"stats":{"Line":12},"fn_name":null},{"line":380,"address":[6177909,6178238,6178132,6177812,6175807],"length":1,"stats":{"Line":20},"fn_name":null},{"line":381,"address":[12147957,12151103,12151137,12151046,12151328],"length":1,"stats":{"Line":16},"fn_name":null},{"line":382,"address":[10387345,10384368,10387339,10384251,10384828],"length":1,"stats":{"Line":4},"fn_name":"{closure#0}"},{"line":383,"address":[10387913,10384486,10384993,10388047,10384830,10384407],"length":1,"stats":{"Line":0},"fn_name":null},{"line":384,"address":[12152112],"length":1,"stats":{"Line":0},"fn_name":null},{"line":390,"address":[11490704],"length":1,"stats":{"Line":4},"fn_name":null},{"line":394,"address":[10523746,10523552,10531279,10524270,10531145],"length":1,"stats":{"Line":12},"fn_name":null},{"line":395,"address":[10379578,10380963,10381056,10381273,10386176],"length":1,"stats":{"Line":8},"fn_name":"{closure#0}"},{"line":396,"address":[6192929],"length":1,"stats":{"Line":0},"fn_name":null},{"line":398,"address":[11835716],"length":1,"stats":{"Line":8},"fn_name":null},{"line":400,"address":[10526374],"length":1,"stats":{"Line":4},"fn_name":null},{"line":401,"address":[6188710,6188789],"length":1,"stats":{"Line":8},"fn_name":null},{"line":402,"address":[12162275],"length":1,"stats":{"Line":4},"fn_name":null},{"line":404,"address":[10382261,10382185,10386208,10386431,10386425,10382368,10382707],"length":1,"stats":{"Line":8},"fn_name":"{closure#1}"},{"line":405,"address":[12166466,12166396],"length":1,"stats":{"Line":0},"fn_name":null},{"line":408,"address":[7140263],"length":1,"stats":{"Line":12},"fn_name":null},{"line":409,"address":[11853426],"length":1,"stats":{"Line":8},"fn_name":null},{"line":410,"address":[11853452],"length":1,"stats":{"Line":8},"fn_name":null},{"line":412,"address":[6191005,6193887,6191557,6193753],"length":1,"stats":{"Line":8},"fn_name":null},{"line":413,"address":[6191512],"length":1,"stats":{"Line":4},"fn_name":null},{"line":418,"address":[11416784,11417355,11417349],"length":1,"stats":{"Line":3},"fn_name":null},{"line":419,"address":[],"length":0,"stats":{"Line":3},"fn_name":null},{"line":420,"address":[11394811],"length":1,"stats":{"Line":3},"fn_name":null},{"line":421,"address":[11427880,11427819],"length":1,"stats":{"Line":4},"fn_name":null},{"line":422,"address":[11427867],"length":1,"stats":{"Line":3},"fn_name":null},{"line":423,"address":[],"length":0,"stats":{"Line":1},"fn_name":null},{"line":425,"address":[11428098,11427910],"length":1,"stats":{"Line":3},"fn_name":null},{"line":429,"address":[11395648],"length":1,"stats":{"Line":1},"fn_name":null},{"line":430,"address":[11395656],"length":1,"stats":{"Line":1},"fn_name":null},{"line":434,"address":[11428640],"length":1,"stats":{"Line":1},"fn_name":null},{"line":435,"address":[11417746],"length":1,"stats":{"Line":1},"fn_name":null},{"line":438,"address":[11428720],"length":1,"stats":{"Line":1},"fn_name":null},{"line":439,"address":[11430850],"length":1,"stats":{"Line":3},"fn_name":null},{"line":442,"address":[11430880,11431731,11432905,11432899],"length":1,"stats":{"Line":1},"fn_name":null},{"line":443,"address":[11430927],"length":1,"stats":{"Line":1},"fn_name":null},{"line":444,"address":[11418020,11417976],"length":1,"stats":{"Line":2},"fn_name":null},{"line":445,"address":[11430806,11428944,11429621,11429785],"length":1,"stats":{"Line":2},"fn_name":null},{"line":446,"address":[11431834],"length":1,"stats":{"Line":1},"fn_name":null},{"line":447,"address":[11418828],"length":1,"stats":{"Line":1},"fn_name":null},{"line":448,"address":[11431884],"length":1,"stats":{"Line":1},"fn_name":null},{"line":451,"address":[11417999],"length":1,"stats":{"Line":1},"fn_name":null},{"line":455,"address":[7062801,7059990,7058208,7058487],"length":1,"stats":{"Line":1},"fn_name":null},{"line":456,"address":[11458791,11456127,11458048],"length":1,"stats":{"Line":2},"fn_name":null},{"line":457,"address":[11491079],"length":1,"stats":{"Line":1},"fn_name":null},{"line":458,"address":[11493340,11493249],"length":1,"stats":{"Line":2},"fn_name":null},{"line":460,"address":[10532767,10532633],"length":1,"stats":{"Line":0},"fn_name":null},{"line":461,"address":[11493871],"length":1,"stats":{"Line":0},"fn_name":null},{"line":466,"address":[11398160],"length":1,"stats":{"Line":1},"fn_name":null},{"line":467,"address":[11420242],"length":1,"stats":{"Line":1},"fn_name":null},{"line":471,"address":[11482368],"length":1,"stats":{"Line":1},"fn_name":null},{"line":477,"address":[10392394,10407305,10407439,10392907,10392245],"length":1,"stats":{"Line":3},"fn_name":null},{"line":480,"address":[10407248,10405890],"length":1,"stats":{"Line":2},"fn_name":null},{"line":485,"address":[10539403,10539623,10539335,10539023,10539116,10541163,10539554,10539184,10539078],"length":1,"stats":{"Line":2},"fn_name":null},{"line":489,"address":[10541487,10540952,10540713,10540881,10541597,10540732,10541046,10540795],"length":1,"stats":{"Line":8},"fn_name":null},{"line":490,"address":[10409112],"length":1,"stats":{"Line":1},"fn_name":null},{"line":492,"address":[12176409],"length":1,"stats":{"Line":1},"fn_name":null},{"line":494,"address":[10409911,10409387,10409659,10409452,10405327],"length":1,"stats":{"Line":4},"fn_name":null},{"line":495,"address":[12177216],"length":1,"stats":{"Line":1},"fn_name":null},{"line":496,"address":[10541731,10541842],"length":1,"stats":{"Line":2},"fn_name":null},{"line":497,"address":[7139784],"length":1,"stats":{"Line":1},"fn_name":null},{"line":498,"address":[10401622,10400800,10400880,10405097],"length":1,"stats":{"Line":4},"fn_name":null},{"line":499,"address":[12184693,12188111,12181090,12187977,12185285],"length":1,"stats":{"Line":3},"fn_name":null},{"line":500,"address":[10549629],"length":1,"stats":{"Line":1},"fn_name":null},{"line":502,"address":[12181128,12183870,12181810,12181062,12188473,12188607,12182714],"length":1,"stats":{"Line":3},"fn_name":null},{"line":503,"address":[10415531,10416687],"length":1,"stats":{"Line":0},"fn_name":null},{"line":508,"address":[12181603],"length":1,"stats":{"Line":1},"fn_name":null},{"line":511,"address":[12177165],"length":1,"stats":{"Line":0},"fn_name":null},{"line":512,"address":[12178125,12177185,12177616,12189103,12188969],"length":1,"stats":{"Line":0},"fn_name":null},{"line":513,"address":[10544982,10542552],"length":1,"stats":{"Line":0},"fn_name":null},{"line":519,"address":[11497217,11498462,11495488],"length":1,"stats":{"Line":1},"fn_name":null},{"line":524,"address":[7063231,7063415],"length":1,"stats":{"Line":1},"fn_name":null},{"line":525,"address":[11495883],"length":1,"stats":{"Line":1},"fn_name":null},{"line":526,"address":[11495844],"length":1,"stats":{"Line":1},"fn_name":null},{"line":527,"address":[11498058,11497976,11498115],"length":1,"stats":{"Line":3},"fn_name":null},{"line":528,"address":[11496084,11495983],"length":1,"stats":{"Line":0},"fn_name":null},{"line":530,"address":[7065577],"length":1,"stats":{"Line":1},"fn_name":null},{"line":538,"address":[11498493,11498480],"length":1,"stats":{"Line":20},"fn_name":"load_key_states_from_file"},{"line":539,"address":[6219149,6219478],"length":1,"stats":{"Line":8},"fn_name":null},{"line":540,"address":[10557687,10602817,10557803,10602816],"length":1,"stats":{"Line":8},"fn_name":"{closure#0}"},{"line":541,"address":[12193420],"length":1,"stats":{"Line":4},"fn_name":null},{"line":543,"address":[12193531],"length":1,"stats":{"Line":4},"fn_name":null},{"line":544,"address":[10426394],"length":1,"stats":{"Line":4},"fn_name":null},{"line":546,"address":[11848708],"length":1,"stats":{"Line":12},"fn_name":null},{"line":547,"address":[6220520],"length":1,"stats":{"Line":2},"fn_name":null},{"line":549,"address":[10557396,10558888,10563413,10558740],"length":1,"stats":{"Line":6},"fn_name":null},{"line":550,"address":[12199126],"length":1,"stats":{"Line":2},"fn_name":null},{"line":551,"address":[10563741],"length":1,"stats":{"Line":2},"fn_name":null},{"line":552,"address":[12199960,12199325,12199404,12238441,12238575],"length":1,"stats":{"Line":6},"fn_name":null},{"line":553,"address":[10419700],"length":1,"stats":{"Line":2},"fn_name":null},{"line":555,"address":[10432078],"length":1,"stats":{"Line":1},"fn_name":null},{"line":556,"address":[12239071,12202440,12238937,12201939,12199246],"length":1,"stats":{"Line":3},"fn_name":null},{"line":560,"address":[6220888,6220457],"length":1,"stats":{"Line":6},"fn_name":null},{"line":562,"address":[10561611,10559199,10604031,10603897],"length":1,"stats":{"Line":6},"fn_name":null},{"line":564,"address":[6220937],"length":1,"stats":{"Line":0},"fn_name":null},{"line":566,"address":[6265753,6265887,6221085,6220975,6221586],"length":1,"stats":{"Line":0},"fn_name":null},{"line":571,"address":[11861784],"length":1,"stats":{"Line":9},"fn_name":null},{"line":572,"address":[10569457,10569593],"length":1,"stats":{"Line":2},"fn_name":null},{"line":573,"address":[10570284,10569768,10604889,10569682,10605023],"length":1,"stats":{"Line":3},"fn_name":null},{"line":574,"address":[10429814,10429498,10425600,10427472,10412798],"length":1,"stats":{"Line":4},"fn_name":null},{"line":575,"address":[10442935],"length":1,"stats":{"Line":1},"fn_name":null},{"line":576,"address":[12210123,12210228],"length":1,"stats":{"Line":2},"fn_name":null},{"line":577,"address":[10443184],"length":1,"stats":{"Line":1},"fn_name":null},{"line":578,"address":[10460745,10430213,10460879,10430296,10430829],"length":1,"stats":{"Line":3},"fn_name":null},{"line":580,"address":[11848812],"length":1,"stats":{"Line":3},"fn_name":null},{"line":581,"address":[10453074,10474265,10452573,10474399,10452463],"length":1,"stats":{"Line":0},"fn_name":null},{"line":588,"address":[12219643,12223511,12222995,12242047,12241913],"length":1,"stats":{"Line":3},"fn_name":null},{"line":589,"address":[6249459,6219336,6251315,6251385],"length":1,"stats":{"Line":3},"fn_name":null},{"line":590,"address":[12242543,12242409,12226336,12225716,12225835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":593,"address":[11861888],"length":1,"stats":{"Line":3},"fn_name":null},{"line":595,"address":[10448842],"length":1,"stats":{"Line":1},"fn_name":null},{"line":596,"address":[6255058,6254945],"length":1,"stats":{"Line":1},"fn_name":null},{"line":598,"address":[10443134],"length":1,"stats":{"Line":1},"fn_name":null},{"line":599,"address":[6236433,6268863,6240041,6239529,6268729],"length":1,"stats":{"Line":3},"fn_name":null},{"line":601,"address":[10578369,10593868,10580685,10557522],"length":1,"stats":{"Line":2},"fn_name":null},{"line":602,"address":[12230323,12229822,12243401,12229703,12243535],"length":1,"stats":{"Line":0},"fn_name":null},{"line":604,"address":[12232625,12232564,12232602],"length":1,"stats":{"Line":2},"fn_name":null},{"line":608,"address":[10574498],"length":1,"stats":{"Line":0},"fn_name":null},{"line":609,"address":[10442904,10476745,10449740,10449224,10476879],"length":1,"stats":{"Line":0},"fn_name":null},{"line":611,"address":[11848916],"length":1,"stats":{"Line":0},"fn_name":null},{"line":612,"address":[10464217,10464351,10453107,10452988,10453608],"length":1,"stats":{"Line":0},"fn_name":null},{"line":614,"address":[12236025,12236086,12236063],"length":1,"stats":{"Line":0},"fn_name":null},{"line":618,"address":[6231207,6270713,6234505,6233973,6270847],"length":1,"stats":{"Line":9},"fn_name":null},{"line":622,"address":[10456249,10456131],"length":1,"stats":{"Line":4},"fn_name":null},{"line":623,"address":[10469228],"length":1,"stats":{"Line":1},"fn_name":null},{"line":625,"address":[10469200,10469811,10469310,10478233,10478367],"length":1,"stats":{"Line":9},"fn_name":null},{"line":626,"address":[12238190,12236934],"length":1,"stats":{"Line":6},"fn_name":null},{"line":632,"address":[10610335,10611426,10610530,10611952,10610288,10612861,10610606],"length":1,"stats":{"Line":15},"fn_name":"{async_fn#0}"},{"line":633,"address":[10468266],"length":1,"stats":{"Line":3},"fn_name":null},{"line":634,"address":[10468281],"length":1,"stats":{"Line":3},"fn_name":null},{"line":635,"address":[6274437,6274270],"length":1,"stats":{"Line":6},"fn_name":null},{"line":636,"address":[10481613],"length":1,"stats":{"Line":3},"fn_name":null},{"line":637,"address":[12273433,12248792,12273567,12249392,12248875],"length":1,"stats":{"Line":9},"fn_name":null},{"line":639,"address":[11846722],"length":1,"stats":{"Line":12},"fn_name":null},{"line":640,"address":[11829080],"length":1,"stats":{"Line":12},"fn_name":null},{"line":641,"address":[10498211],"length":1,"stats":{"Line":3},"fn_name":null},{"line":642,"address":[12265399,12264648,12265504],"length":1,"stats":{"Line":9},"fn_name":null},{"line":643,"address":[12273328,12273350,12265538],"length":1,"stats":{"Line":9},"fn_name":"{closure#0}"},{"line":644,"address":[10630239],"length":1,"stats":{"Line":3},"fn_name":null},{"line":645,"address":[12273929,12266538,12265987,12274063],"length":1,"stats":{"Line":2},"fn_name":null},{"line":646,"address":[11846766],"length":1,"stats":{"Line":6},"fn_name":null},{"line":647,"address":[10620500,10620376,10620439],"length":1,"stats":{"Line":3},"fn_name":null},{"line":648,"address":[12256143,12256239,12259531,12256066],"length":1,"stats":{"Line":3},"fn_name":null},{"line":650,"address":[10494249,10476020,10494383,10476154,10476725],"length":1,"stats":{"Line":3},"fn_name":null},{"line":651,"address":[12256802],"length":1,"stats":{"Line":1},"fn_name":null},{"line":652,"address":[6284999,6285054,6282549],"length":1,"stats":{"Line":2},"fn_name":null},{"line":655,"address":[10639519,10639385,10624007,10620469],"length":1,"stats":{"Line":0},"fn_name":null},{"line":658,"address":[12262038,12275551,12255835,12275417],"length":1,"stats":{"Line":0},"fn_name":null},{"line":665,"address":[12252759,12276047,12252962,12275913,12253494],"length":1,"stats":{"Line":0},"fn_name":null},{"line":668,"address":[12268734,12268668],"length":1,"stats":{"Line":4},"fn_name":null},{"line":669,"address":[12276543,12268828,12269380,12276409,12268762],"length":1,"stats":{"Line":3},"fn_name":null},{"line":671,"address":[10635821,10633254,10641503,10641369],"length":1,"stats":{"Line":6},"fn_name":null},{"line":673,"address":[10633764],"length":1,"stats":{"Line":3},"fn_name":null},{"line":678,"address":[6305182,6303154,6302928,6304566,6304062,6302959,6303230],"length":1,"stats":{"Line":10},"fn_name":"{async_fn#0}"},{"line":679,"address":[10512717,10512548],"length":1,"stats":{"Line":4},"fn_name":null},{"line":680,"address":[10499797],"length":1,"stats":{"Line":2},"fn_name":null},{"line":682,"address":[10500441,10519177,10499823,10499906,10519311],"length":1,"stats":{"Line":6},"fn_name":null},{"line":683,"address":[10513402],"length":1,"stats":{"Line":2},"fn_name":null},{"line":685,"address":[11856706],"length":1,"stats":{"Line":8},"fn_name":null},{"line":686,"address":[10513064,10499609,10503859,10512979,10513336,10506413],"length":1,"stats":{"Line":9},"fn_name":null},{"line":687,"address":[10658026],"length":1,"stats":{"Line":2},"fn_name":null},{"line":688,"address":[10525707,10526551,10526446],"length":1,"stats":{"Line":6},"fn_name":null},{"line":689,"address":[10532096,10526585,10532118],"length":1,"stats":{"Line":6},"fn_name":"{closure#0}"},{"line":690,"address":[6319362,6319471,6318106],"length":1,"stats":{"Line":4},"fn_name":null},{"line":691,"address":[10664447,10664313,10658700,10659251],"length":1,"stats":{"Line":0},"fn_name":null},{"line":692,"address":[10519508,10512654,10527591,10529616,10519781,10519474],"length":1,"stats":{"Line":0},"fn_name":null},{"line":693,"address":[10651452,10664943,10651570,10664809,10652071],"length":1,"stats":{"Line":0},"fn_name":null},{"line":695,"address":[10651480,10654605,10654647],"length":1,"stats":{"Line":0},"fn_name":null},{"line":696,"address":[10665305,10654619,10654674,10665439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":703,"address":[10516997,10516800,10517526,10534185,10534319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":705,"address":[10529765,10530328,10534815,10529823,10534681],"length":1,"stats":{"Line":6},"fn_name":null}],"covered":275,"coverable":335},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","lib.rs"],"content":"// src/lib.rs\n\n// Declare modules that constitute the library's public API or internal structure\npub mod config;\npub mod error;\npub mod handler;\npub mod key_manager;\npub mod proxy;\npub mod state;\npub mod admin;\n\n// Re-export key types for easier use by the binary or tests\nuse axum::{\n    body::Body,\n    http::Request as AxumRequest,\n    middleware::{self, Next},\n    response::Response as AxumResponse,\n    routing::{any, get},\n    Router,\n};\nuse std::{path::PathBuf, sync::Arc, time::Instant};\nuse tower_cookies::CookieManagerLayer;\nuse tracing::{error, info, span, Instrument, Level};\nuse uuid::Uuid;\n\n\npub use config::AppConfig;\npub use error::{AppError, Result};\npub use state::AppState;\n\n/// Creates the main Axum router for the application.\npub fn create_router(state: Arc\u003cAppState\u003e) -\u003e Router {\n    Router::new()\n        .route(\"/health\", get(handler::health_check))\n        .merge(admin::admin_routes())\n        .route(\"/*path\", any(handler::proxy_handler))\n        .layer(CookieManagerLayer::new())\n        .with_state(state)\n}\n\n/// Middleware to add Request ID and trace requests.\nasync fn trace_requests(req: AxumRequest\u003cBody\u003e, next: Next) -\u003e AxumResponse {\n    let request_id = Uuid::new_v4();\n    let start_time = Instant::now();\n    let method = req.method().clone();\n    let path = req.uri().path().to_string();\n\n    let span = span!(\n        Level::INFO,\n        \"request\",\n        request_id = %request_id,\n        http.method = %method,\n        url.path = %path,\n    );\n\n    let response = next.run(req).instrument(span).await;\n    let elapsed = start_time.elapsed();\n\n    info!(\n        http.response.duration = ?elapsed,\n        http.status_code = response.status().as_u16(),\n        \"Finished processing request\"\n    );\n\n    response\n}\n\n/// The main application setup function, responsible for configuration, state initialization,\n/// and router creation.\n///\n/// # Errors\n///\n/// This function will return an error if:\n/// - Configuration loading or validation fails.\n/// - The application state (e.g., HTTP clients) cannot be initialized.\npub async fn run(\n    config_path_override: Option\u003cPathBuf\u003e,\n) -\u003e std::result::Result\u003c(Router, AppConfig), AppError\u003e {\n    // --- Configuration Path ---\n    let config_path = config_path_override.unwrap_or_else(|| {\n        std::env::var(\"CONFIG_PATH\").map_or_else(|_| PathBuf::from(\"config.yaml\"), PathBuf::from)\n    });\n\n    info!(\"Starting Gemini API Key Rotation Proxy...\");\n\n    let config_path_display = config_path.display().to_string();\n    if config_path.exists() {\n        info!(config.path = %config_path_display, \"Using configuration file\");\n    } else {\n        info!(config.path = %config_path_display, \"Optional configuration file not found. Using defaults and environment variables.\");\n    }\n\n    // --- Configuration Loading \u0026 Validation ---\n    let app_config = config::load_config(\u0026config_path).map_err(|e| {\n        error!(\n            config.path = %config_path_display,\n            error = ?e,\n            \"Failed to load or validate configuration. Exiting.\"\n        );\n        e\n    })?;\n\n    let total_keys: usize = app_config.groups.iter().map(|g| g.api_keys.len()).sum();\n    let group_names: Vec\u003cString\u003e = app_config.groups.iter().map(|g| g.name.clone()).collect();\n    info!(\n         config.groups.count = app_config.groups.len(),\n         config.groups.names = ?group_names,\n         config.total_keys = total_keys,\n         server.port = app_config.server.port,\n         \"Configuration loaded and validated successfully.\"\n    );\n\n    // --- Application State Initialization ---\n    let app_state = AppState::new(\u0026app_config, \u0026config_path).await.map_err(|e| {\n        error!(\n            error = ?e,\n            \"Failed to initialize application state. Exiting.\"\n        );\n        e\n    })?;\n    let app_state = Arc::new(app_state);\n// --- Router Setup ---\nlet app = create_router(app_state.clone()).layer(middleware::from_fn(trace_requests));\n\nOk((app, app_config))\n}\n","traces":[{"line":24,"address":[11660260,11661100,11661249,11661211,11660240,11660371],"length":1,"stats":{"Line":4},"fn_name":"{async_fn#0}"},{"line":25,"address":[11660668,11660355,11660979,11660790,11660527,11660924,11660457],"length":1,"stats":{"Line":7},"fn_name":null},{"line":26,"address":[2477354],"length":1,"stats":{"Line":2},"fn_name":null},{"line":27,"address":[11692796,11692270,11692065,11692378,11692286,11692825],"length":1,"stats":{"Line":2},"fn_name":null},{"line":28,"address":[6286704,6286279,6286788,6286734],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":29,"address":[11692536,11692622,11692812,11692738,11692547,11692081],"length":1,"stats":{"Line":6},"fn_name":null},{"line":30,"address":[30988022],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":7,"coverable":7},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","main.rs"],"content":"// src/main.rs\n\nuse axum::serve;\nuse gemini_proxy_key_rotation_rust::{run, AppError};\nuse std::net::SocketAddr;\nuse tokio::net::TcpListener;\nuse tokio::signal;\nuse tracing::{error, info};\n\nasync fn shutdown_signal() {\n    let ctrl_c = async {\n        signal::ctrl_c()\n            .await\n            .expect(\"Failed to install Ctrl+C handler\");\n    };\n\n    #[cfg(unix)]\n    let terminate = async {\n        signal::unix::signal(signal::unix::SignalKind::terminate())\n            .expect(\"Failed to install signal handler\")\n            .recv()\n            .await;\n    };\n\n    #[cfg(not(unix))]\n    let terminate = std::future::pending::\u003c()\u003e();\n\n    tokio::select! {\n        () = ctrl_c =\u003e { info!(signal = \"Ctrl+C\", \"Received signal. Initiating graceful shutdown...\") },\n        () = terminate =\u003e { info!(signal = \"Terminate\", \"Received signal. Initiating graceful shutdown...\") },\n    }\n}\n\nuse tracing_subscriber::{fmt, layer::SubscriberExt, util::SubscriberInitExt, EnvFilter};\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), AppError\u003e {\n    // --- Initialize Tracing (JSON format) ---\n    let env_filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\"));\n    let json_layer = fmt::layer()\n        .json()\n        .with_current_span(true)\n        .with_span_list(true);\n    tracing_subscriber::registry()\n        .with(env_filter)\n        .with(json_layer)\n        .init();\n\n    // The `run` function now configures the app and returns both the router and the config.\n    let (app, config) = run(None).await.map_err(|e| {\n        eprintln!(\"Application setup error: {:?}\", e);\n        e\n    })?;\n\n    let addr = SocketAddr::from(([0, 0, 0, 0], config.server.port));\n    let listener = TcpListener::bind(addr).await.map_err(|e| {\n        error!(server.address = %addr, error = ?e, \"Failed to bind to address. Exiting.\");\n        AppError::from(e)\n    })?;\n    info!(server.address = %addr, \"Server listening\");\n\n    // --- Run with Graceful Shutdown ---\n    info!(\"Starting server run loop...\");\n    serve(listener, app.into_make_service())\n        .with_graceful_shutdown(shutdown_signal())\n        .await\n        .map_err(|e| {\n            error!(error = ?e, \"Server run loop encountered an error. Exiting.\");\n            AppError::from(e)\n        })?;\n\n    info!(\"Server shut down gracefully.\");\n    Ok(())\n}\n","traces":[{"line":26,"address":[5061600],"length":1,"stats":{"Line":0},"fn_name":"trace_requests"},{"line":30,"address":[5372416],"length":1,"stats":{"Line":0},"fn_name":null},{"line":31,"address":[5372533],"length":1,"stats":{"Line":0},"fn_name":null},{"line":32,"address":[5372610],"length":1,"stats":{"Line":0},"fn_name":null},{"line":33,"address":[5372767,5372674],"length":1,"stats":{"Line":0},"fn_name":null},{"line":36,"address":[5372919,5373303,5374576,5372832],"length":1,"stats":{"Line":0},"fn_name":null},{"line":37,"address":[5373260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":48,"address":[5375675,5374409,5372472,5375469],"length":1,"stats":{"Line":0},"fn_name":null},{"line":51,"address":[5376105,5376205],"length":1,"stats":{"Line":0},"fn_name":null},{"line":54,"address":[5386713,5378005,5386847,5378836,5376220,5376909],"length":1,"stats":{"Line":0},"fn_name":null},{"line":56,"address":[5378753,5377922],"length":1,"stats":{"Line":0},"fn_name":null},{"line":60,"address":[5376730],"length":1,"stats":{"Line":0},"fn_name":null},{"line":72,"address":[5061712,5062099,5062105],"length":1,"stats":{"Line":0},"fn_name":"main"},{"line":74,"address":[5387636,5387353,5418832,5418848],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":77,"address":[5387760,5387689],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[5387919,5387823],"length":1,"stats":{"Line":0},"fn_name":null},{"line":84,"address":[5387842],"length":1,"stats":{"Line":0},"fn_name":null},{"line":90,"address":[5418960,5418944,5387972],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":94,"address":[5388630,5419225,5388113,5388030,5419359],"length":1,"stats":{"Line":0},"fn_name":null},{"line":97,"address":[5388585,5389959],"length":1,"stats":{"Line":0},"fn_name":null},{"line":98,"address":[5390150,5390048],"length":1,"stats":{"Line":0},"fn_name":null},{"line":99,"address":[5392540,5419721,5390205,5419855],"length":1,"stats":{"Line":0},"fn_name":null},{"line":101,"address":[5420351,5390177,5390760,5390243,5420217],"length":1,"stats":{"Line":0},"fn_name":null},{"line":105,"address":[5390715,5394814],"length":1,"stats":{"Line":0},"fn_name":null},{"line":106,"address":[5394965],"length":1,"stats":{"Line":0},"fn_name":null},{"line":107,"address":[5394870],"length":1,"stats":{"Line":0},"fn_name":null},{"line":109,"address":[5399273,5394934,5420847,5399771,5420713],"length":1,"stats":{"Line":0},"fn_name":null},{"line":114,"address":[5399745],"length":1,"stats":{"Line":0},"fn_name":null},{"line":119,"address":[5395113,5419056,5395216,5419081],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":120,"address":[5395354,5419104,5419139],"length":1,"stats":{"Line":0},"fn_name":"{closure#3}"},{"line":121,"address":[5421343,5397056,5395599,5395513,5421209,5398267,5396131],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[5398212,5397001],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[5026436],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[5402403],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[5402272],"length":1,"stats":{"Line":0},"fn_name":null},{"line":134,"address":[5402336,5421705,5421839,5402754,5403252],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[5403226],"length":1,"stats":{"Line":0},"fn_name":null},{"line":144,"address":[5405011,5405314,5402469,5387495,5402546],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[5026659,5026636],"length":1,"stats":{"Line":0},"fn_name":null},{"line":147,"address":[5026477],"length":1,"stats":{"Line":0},"fn_name":null},{"line":148,"address":[5387537,5406279,5406167,5406349],"length":1,"stats":{"Line":0},"fn_name":null},{"line":149,"address":[5406640],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[5406688,5407340,5406767,5422201,5422335],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[5407239],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[5406593],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[5406609,5411974,5422831,5411476,5422697],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[5411948],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[5409751,5423193,5409149,5407302,5423327],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[5061979,5061743,5061873,5061803],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[5411178,5411368,5411258,5411171],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[5026525],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[5414444,5423689,5414545,5415043,5423823],"length":1,"stats":{"Line":0},"fn_name":null},{"line":167,"address":[5415017],"length":1,"stats":{"Line":0},"fn_name":null},{"line":170,"address":[5417375,5416802,5424185,5424319],"length":1,"stats":{"Line":0},"fn_name":null},{"line":173,"address":[5061696,5061699],"length":1,"stats":{"Line":0},"fn_name":"shutdown_signal"},{"line":174,"address":[5379440,5385616,5385717,5385582,5385488,5385513,5385976],"length":1,"stats":{"Line":0},"fn_name":"{async_block#0}"},{"line":175,"address":[5385882,5385680,5385563,5385918],"length":1,"stats":{"Line":0},"fn_name":null},{"line":176,"address":[5385606,5385700,5385673,5385902,5385743],"length":1,"stats":{"Line":0},"fn_name":null},{"line":181,"address":[5379501,5385984,5386074,5386114,5386402,5386009,5386645],"length":1,"stats":{"Line":0},"fn_name":"{async_block#1}"},{"line":182,"address":[5386567,5386353,5386059,5386162],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[5386581,5386428,5386377,5386101,5386288],"length":1,"stats":{"Line":0},"fn_name":null},{"line":191,"address":[5028326,5028311,5028375],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[5381049,5380954,5382714,5425353,5379668,5425487],"length":1,"stats":{"Line":0},"fn_name":null},{"line":194,"address":[5383281,5425849,5379779,5380982,5425983],"length":1,"stats":{"Line":0},"fn_name":null}],"covered":0,"coverable":64},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","metrics.rs"],"content":"// src/metrics.rs\n\nuse metrics::{counter, gauge, histogram};\nuse metrics_exporter_prometheus::{PrometheusBuilder, PrometheusHandle};\nuse std::time::Instant;\n\npub fn initialize_metrics() -\u003e PrometheusHandle {\n    let builder = PrometheusBuilder::new();\n    builder\n        .install_recorder()\n        .expect(\"failed to install Prometheus recorder\")\n}\n\npub fn record_request_start() {\n    gauge!(\"proxy_requests_in_flight\").increment(1.0);\n}\n\npub fn record_request_end(start_time: Instant, status_code: u16, group_name: \u0026str) {\n    let duration = start_time.elapsed().as_secs_f64();\n    gauge!(\"proxy_requests_in_flight\").decrement(1.0);\n    counter!(\"proxy_requests_total\", \"status\" =\u003e status_code.to_string(), \"group\" =\u003e group_name.to_string()).increment(1);\n    histogram!(\"proxy_request_duration_seconds\", \"status\" =\u003e status_code.to_string(), \"group\" =\u003e group_name.to_string()).record(duration);\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","proxy.rs"],"content":"// src/proxy.rs\n\nuse crate::{\n    error::{AppError, Result},\n    key_manager::FlattenedKeyInfo,\n    state::AppState, // Import AppState\n};\nuse axum::{\n    body::{Body, Bytes},\n    http::{header, HeaderMap, HeaderValue, Method}, // Removed unused StatusCode\n    response::Response,\n};\n\nuse futures_util::TryStreamExt;\nuse std::error::Error; // Import Error trait for source()\nuse std::time::Instant; // Added Instant\nuse tracing::{debug, error, info, trace, warn};\nuse url::Url; // Keep Url\n\n// Hop-by-hop headers that should not be forwarded\nconst HOP_BY_HOP_HEADERS: \u0026[\u0026str] = \u0026[\n    \"connection\",\n    \"keep-alive\",\n    \"proxy-authenticate\",\n    \"proxy-authorization\",\n    \"te\",\n    \"trailers\",\n    \"transfer-encoding\",\n    \"upgrade\",\n    \"host\",           // Explicitly include host as it's often added by clients\n    \"authorization\",  // Original authorization should be replaced\n    \"x-goog-api-key\", // Original key (if any) should be replaced\n];\n/// Takes incoming request components and forwards them to the appropriate upstream target.\n///\n/// Orchestrates the core proxying logic. Rate limit handling (429) is delegated to the calling handler.\n/// Assumes this function is called within a tracing span that includes `request_id`.\n///\n/// # Errors\n///\n/// This function will return an error if:\n/// - The base URL from configuration is invalid.\n/// - The final target URL cannot be constructed.\n/// - The HTTP client for the required proxy cannot be retrieved.\n/// - The request to the target fails (e.g., network error, timeout).\n/// - The response body stream from the target has an error.\n/// - The final response to the client cannot be constructed.\npub async fn forward_request(\n    state: \u0026AppState,\n    key_info: \u0026FlattenedKeyInfo,\n    method: Method,\n    target_url: Url,\n    headers: HeaderMap,\n    body_bytes: Bytes,\n) -\u003e Result\u003cResponse\u003e {\n    let api_key = \u0026key_info.key;\n    let proxy_url_option = key_info.proxy_url.as_deref();\n    let group_name = \u0026key_info.group_name;\n    let request_key_preview = format!(\"{}...\", api_key.chars().take(4).collect::\u003cString\u003e());\n\n    let final_target_url = target_url;\n    let outgoing_method = method;\n    let mut outgoing_headers = build_forward_headers(\u0026headers, api_key)?;\n\n    // --- Body Modification ---\n    let body_to_send = {\n        let config_guard = state.config.read().await;\n        if let Some(top_p_value) = config_guard.server.top_p {\n            // Drop the read lock as soon as we have the value\n            drop(config_guard);\n            // The logic is wrapped in a closure to easily return the original bytes on any failure.\n            let modified_body_bytes = (|| {\n                if let Ok(mut json_body) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026body_bytes) {\n                    if let Some(obj) = json_body.as_object_mut() {\n                        obj.insert(\"top_p\".to_string(), serde_json::json!(top_p_value));\n                        if let Ok(modified_bytes) = serde_json::to_vec(\u0026json_body) {\n                            info!(top_p = top_p_value, \"Successfully injected top_p into request body\");\n                            return Bytes::from(modified_bytes);\n                        } else {\n                            warn!(\"Failed to re-serialize JSON body after injecting top_p, forwarding original body.\");\n                        }\n                    } else {\n                        debug!(\"Request body is valid JSON but not an object, cannot inject top_p.\");\n                    }\n                } else {\n                    debug!(\"Request body is not valid JSON, cannot inject top_p.\");\n                }\n                body_bytes.clone() // Return original on any failure\n            })();\n\n            // If the body was modified, update the Content-Length header.\n            if modified_body_bytes.len() != body_bytes.len() {\n                let new_length = modified_body_bytes.len();\n                debug!(old_len = body_bytes.len(), new_len = new_length, \"Updating Content-Length due to body modification\");\n                outgoing_headers.insert(header::CONTENT_LENGTH, HeaderValue::from(new_length));\n            }\nmodified_body_bytes\n} else {\nbody_bytes\n}\n};\n\n    let outgoing_reqwest_body = reqwest::Body::from(body_to_send);\n    // --- End Body Modification ---\n    // --- Get Client ---\n    let http_client = state.get_client(proxy_url_option).await?; // Error handled within\n                                                                 // ---\n\n    // Log before sending the request\n    info!(\n        http.method = %outgoing_method,\n        target.url = %final_target_url,\n        http.headers = ?outgoing_headers,\n        api_key.preview = %request_key_preview,\n        group.name = %group_name,\n        proxy.url = ?proxy_url_option, // Use debug formatting for Option\u003c\u0026str\u003e\n        \"Forwarding raw request to target\"\n    );\n\n    // --- Send request ---\n    let start_time = Instant::now();\n\n    let target_response_result = http_client\n        .request(outgoing_method.clone(), final_target_url.clone()) // Clone Url for request\n        .headers(outgoing_headers)\n        .body(outgoing_reqwest_body)\n        .send()\n        .await;\n\n    let elapsed_time = start_time.elapsed(); // Calculate duration immediately after await\n\n    let target_response = match target_response_result {\n        Ok(resp) =\u003e {\n            let status = resp.status();\n            // Structured success log\n            info!(\n                // Use standard semantic convention fields where possible\n                http.status_code = status.as_u16(),\n                http.response.duration = ?elapsed_time, // Use standard field name if available in log aggregator\n                target.url = %final_target_url,\n                api_key.preview = %request_key_preview,\n                group.name = %group_name,\n                proxy.url = ?proxy_url_option,\n                \"Received response from target\"\n            );\n            resp // Return the response\n        }\n        Err(e) =\u003e {\n            // Structured error log, trying to extract more detail from reqwest::Error\n            let error_kind = if e.is_timeout() {\n                \"timeout\"\n            } else if e.is_connect() {\n                \"connect\"\n            } else if e.is_redirect() {\n                \"redirect_policy\"\n            } else if e.is_request() {\n                \"request_error\"\n            } else if e.is_body() || e.is_decode() {\n                \"body/decode\"\n            } else if e.is_builder() {\n                \"builder\"\n            } else {\n                \"unknown\"\n            };\n            // Use the imported Error trait to call source()\n            let underlying_source = e.source().map(ToString::to_string); // Get underlying error if available\n\n            error!(\n                error = %e, // Display format for top-level error\n                error.kind = error_kind,\n                error.source = ?underlying_source, // Debug format for underlying source\n                http.response.duration = ?elapsed_time,\n                target.url = %final_target_url, // Log target URL on error too\n                api_key.preview = %request_key_preview,\n                group.name = %group_name,\n                proxy.url = ?proxy_url_option,\n                \"Error received while sending request to target\"\n            );\n            // Return the error wrapped in AppError\n            return Err(AppError::Reqwest(e));\n        }\n    };\n    // --- End Send Request ---\n\n    let response_status = target_response.status();\n    let response_headers = build_response_headers(target_response.headers());\n\n    // Stream response body back\n    let captured_response_status = response_status; // Capture status for closure\n    let response_body_stream = target_response.bytes_stream().map_err(move |e| {\n        // Log error during stream reading\n        warn!(\n            status = captured_response_status.as_u16(),\n            error = %e,\n            \"Error reading upstream response body stream\"\n        );\n        AppError::ResponseBodyError(format!(\n            \"Upstream body stream error (status {captured_response_status}): {e}\"\n        ))\n    });\n    let axum_response_body = Body::from_stream(response_body_stream);\n\n    // Build final response to client\n    let mut client_response = Response::builder()\n        .status(response_status)\n        .body(axum_response_body)\n        .map_err(|e| {\n            error!(error = %e, \"Failed to build final client response\");\n            AppError::Internal(format!(\"Failed to construct client response: {e}\"))\n        })?;\n\n    *client_response.headers_mut() = response_headers;\n\n    Ok(client_response)\n}\n\n/// Creates the `HeaderMap` for the outgoing request to the target service.\n/// Now returns a Result to handle potential errors from add_auth_headers.\n#[tracing::instrument(level=\"debug\", skip(original_headers, api_key), fields(header_count = original_headers.len()))]\nfn build_forward_headers(original_headers: \u0026HeaderMap, api_key: \u0026str) -\u003e Result\u003cHeaderMap\u003e {\n    let mut filtered = HeaderMap::with_capacity(original_headers.len() + 3);\n    copy_non_hop_by_hop_headers(original_headers, \u0026mut filtered, true);\n    add_auth_headers(\u0026mut filtered, api_key)?;\n    Ok(filtered)\n}\n\n\n/// Creates the `HeaderMap` for the response sent back to the original client.\n#[tracing::instrument(level=\"debug\", skip(original_headers), fields(header_count = original_headers.len()))]\nfn build_response_headers(original_headers: \u0026HeaderMap) -\u003e HeaderMap {\n    let mut filtered = HeaderMap::with_capacity(original_headers.len());\n    copy_non_hop_by_hop_headers(original_headers, \u0026mut filtered, false);\n    filtered\n}\n\n/// Copies headers from `source` to `dest`, excluding hop-by-hop headers.\nfn copy_non_hop_by_hop_headers(source: \u0026HeaderMap, dest: \u0026mut HeaderMap, is_request: bool) {\n    for (name, value) in source {\n        let name_str = name.as_str().to_lowercase();\n        // Check against the HOP_BY_HOP_HEADERS list using lowercase comparison\n        if HOP_BY_HOP_HEADERS.contains(\u0026name_str.as_str()) {\n            trace!(header.name=%name, header.action=\"skip\", context=if is_request {\"request\"} else {\"response\"}, \"Skipping hop-by-hop or auth header\");\n        } else {\n            dest.insert(name.clone(), value.clone());\n            trace!(header.name=%name, header.action=\"forward\", context=if is_request {\"request\"} else {\"response\"}, \"Forwarding header\");\n        }\n    }\n}\n\n/// Adds the necessary authentication headers (`x-goog-api-key` and `Authorization: Bearer`).\n/// Returns a Result to indicate potential failures.\n#[tracing::instrument(level=\"debug\")] // Removed skip attribute\n// Now takes api_key to add the Bearer token\nfn add_auth_headers(headers: \u0026mut HeaderMap, api_key: \u0026str) -\u003e Result\u003c()\u003e {\n    let auth_value_str = format!(\"Bearer {api_key}\");\n    match HeaderValue::from_str(\u0026auth_value_str) {\n        Ok(auth_value) =\u003e {\n            headers.insert(header::AUTHORIZATION, auth_value);\n            trace!(header.name=\"Authorization\", header.action=\"add\", \"Added Bearer token\");\n            Ok(())\n        }\n        Err(e) =\u003e {\n            error!(error = %e, \"Failed to create Authorization header value\");\n            Err(AppError::Internal(\n                \"Failed to construct Authorization header\".to_string(),\n            ))\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::http::{header, HeaderName, HeaderValue,};\n     // Import Error trait for source()\n\n    #[test]\n    fn test_build_forward_headers_basic() {\n        let mut original_headers = HeaderMap::new();\n        original_headers.insert(\"content-type\", HeaderValue::from_static(\"application/json\"));\n        original_headers.insert(\"x-custom-header\", HeaderValue::from_static(\"value1\"));\n        original_headers.insert(\"host\", HeaderValue::from_static(\"original.host.com\")); // Hop-by-hop\n        original_headers.insert(\"connection\", HeaderValue::from_static(\"keep-alive\")); // Hop-by-hop\n        original_headers.insert(\n            \"authorization\",\n            HeaderValue::from_static(\"Bearer old_token\"),\n        ); // Auth, should be removed\n        original_headers.insert(\"x-goog-api-key\", HeaderValue::from_static(\"old_key\")); // Auth, should be removed\n\n        // api_key is no longer passed as it's handled in URL construction\n        let result_headers = build_forward_headers(\u0026original_headers, \"test_key\").unwrap();\n\n        // Check standard headers are present\n        assert_eq!(\n            result_headers.get(\"content-type\").unwrap(),\n            \"application/json\"\n        );\n        assert_eq!(result_headers.get(\"x-custom-header\").unwrap(), \"value1\");\n\n        // Check hop-by-hop are absent\n        assert!(result_headers.get(\"host\").is_none());\n        assert!(result_headers.get(\"connection\").is_none());\n\n        // Check that x-goog-api-key is absent, but the new Authorization header is present.\n        assert!(result_headers.get(\"x-goog-api-key\").is_none());\n        let auth_header = result_headers.get(header::AUTHORIZATION).unwrap();\n        assert_eq!(auth_header, \"Bearer test_key\");\n    }\n\n    #[test]\n    fn test_build_forward_headers_removes_auth_headers() {\n        let mut original_headers = HeaderMap::new();\n        original_headers.insert(\n            header::AUTHORIZATION,\n            HeaderValue::from_static(\"Bearer client_token\"),\n        );\n        original_headers.insert(\"x-goog-api-key\", HeaderValue::from_static(\"client_key\"));\n        original_headers.insert(\"x-custom-header\", HeaderValue::from_static(\"custom_value\"));\n\n        let result_headers = build_forward_headers(\u0026original_headers, \"some_key\").unwrap();\n\n        assert!(result_headers.get(\"x-goog-api-key\").is_none());\n        assert_eq!(\n            result_headers.get(\"x-custom-header\").unwrap(),\n            \"custom_value\"\n        );\n        assert_eq!(result_headers.len(), 2);\n    }\n\n    // Removed test: test_build_forward_headers_invalid_key_chars\n\n    #[test]\n    fn test_build_response_headers_filters_hop_by_hop() {\n\n\n\n\n\n\n\n\n\n\n\n        let mut upstream_headers = HeaderMap::new();\n        upstream_headers.insert(\"content-type\", HeaderValue::from_static(\"text/plain\"));\n        upstream_headers.insert(\"x-upstream-specific\", HeaderValue::from_static(\"value2\"));\n        upstream_headers.insert(\"transfer-encoding\", HeaderValue::from_static(\"chunked\")); // Hop-by-hop\n        upstream_headers.insert(\"connection\", HeaderValue::from_static(\"close\")); // Hop-by-hop\n        upstream_headers.insert(\n            HeaderName::from_static(\"keep-alive\"),\n            HeaderValue::from_static(\"timeout=15\"),\n        ); // Hop-by-hop (case insensitive check needed)\n\n        let result_headers = build_response_headers(\u0026upstream_headers);\n\n        // Check standard headers are present\n        assert_eq!(result_headers.get(\"content-type\").unwrap(), \"text/plain\");\n        assert_eq!(result_headers.get(\"x-upstream-specific\").unwrap(), \"value2\");\n\n        // Check hop-by-hop are absent\n        assert!(result_headers.get(\"transfer-encoding\").is_none());\n        assert!(result_headers.get(\"connection\").is_none());\n        assert!(result_headers.get(\"keep-alive\").is_none());\n    }\n\n    #[test]\n    fn test_copy_non_hop_by_hop_headers_request() {\n        let mut source = HeaderMap::new();\n        source.insert(\"content-type\", HeaderValue::from_static(\"application/json\"));\n        source.insert(\"host\", HeaderValue::from_static(\"example.com\")); // Hop-by-hop\n        source.insert(\"authorization\", HeaderValue::from_static(\"Bearer old\")); // Hop-by-hop (for request)\n        source.insert(\"x-custom\", HeaderValue::from_static(\"custom\"));\n\n        let mut dest = HeaderMap::new();\n        copy_non_hop_by_hop_headers(\u0026source, \u0026mut dest, true); // is_request = true\n\n        assert!(dest.contains_key(\"content-type\"));\n        assert!(dest.contains_key(\"x-custom\"));\n        assert!(!dest.contains_key(\"host\"));\n        assert!(!dest.contains_key(\"authorization\")); // Should be filtered for request\n        assert_eq!(dest.len(), 2);\n    }\n\n    #[test]\n    fn test_copy_non_hop_by_hop_headers_response() {\n        let mut source = HeaderMap::new();\n        source.insert(\"content-type\", HeaderValue::from_static(\"application/json\"));\n        source.insert(\"transfer-encoding\", HeaderValue::from_static(\"chunked\")); // Hop-by-hop\n        source.insert(\"connection\", HeaderValue::from_static(\"close\")); // Hop-by-hop\n        source.insert(\"x-custom\", HeaderValue::from_static(\"custom\"));\n\n        let mut dest = HeaderMap::new();\n        copy_non_hop_by_hop_headers(\u0026source, \u0026mut dest, false); // is_request = false\n\n        assert!(dest.contains_key(\"content-type\"));\n        assert!(dest.contains_key(\"x-custom\"));\n        assert!(!dest.contains_key(\"transfer-encoding\"));\n        assert!(!dest.contains_key(\"connection\"));\n        assert_eq!(dest.len(), 2);\n    }\n}\n","traces":[{"line":48,"address":[12704288],"length":1,"stats":{"Line":2},"fn_name":"forward_request"},{"line":56,"address":[24540099],"length":1,"stats":{"Line":2},"fn_name":null},{"line":57,"address":[11221029,11220808],"length":1,"stats":{"Line":4},"fn_name":null},{"line":58,"address":[24553201],"length":1,"stats":{"Line":2},"fn_name":null},{"line":59,"address":[5848578],"length":1,"stats":{"Line":2},"fn_name":null},{"line":61,"address":[11234416],"length":1,"stats":{"Line":2},"fn_name":null},{"line":62,"address":[12650913],"length":1,"stats":{"Line":2},"fn_name":null},{"line":63,"address":[5849759,5849074,5849217],"length":1,"stats":{"Line":4},"fn_name":null},{"line":67,"address":[11811702],"length":1,"stats":{"Line":4},"fn_name":null},{"line":68,"address":[11236140,11235888,11235661,11235737],"length":1,"stats":{"Line":7},"fn_name":null},{"line":70,"address":[24685684],"length":1,"stats":{"Line":1},"fn_name":null},{"line":72,"address":[12322613,12346544,12347722,12349883,12355499],"length":1,"stats":{"Line":2},"fn_name":"{closure#0}"},{"line":73,"address":[5874054,5874176],"length":1,"stats":{"Line":2},"fn_name":null},{"line":74,"address":[11247017,11247096],"length":1,"stats":{"Line":2},"fn_name":null},{"line":75,"address":[12346903,12351817,12347004,12346973],"length":1,"stats":{"Line":2},"fn_name":null},{"line":76,"address":[5874616,5874699],"length":1,"stats":{"Line":2},"fn_name":null},{"line":77,"address":[12347908,12360671,12347304,12347724,12360537,12347380],"length":1,"stats":{"Line":3},"fn_name":null},{"line":78,"address":[12677510],"length":1,"stats":{"Line":1},"fn_name":null},{"line":80,"address":[11263676,11260505,11263198,11274447,11274313],"length":1,"stats":{"Line":0},"fn_name":null},{"line":83,"address":[11261785,11252102,11261919,11247190],"length":1,"stats":{"Line":0},"fn_name":null},{"line":86,"address":[5881103,5874145,5889433,5889567],"length":1,"stats":{"Line":0},"fn_name":null},{"line":88,"address":[5882854],"length":1,"stats":{"Line":0},"fn_name":null},{"line":92,"address":[11235966,11236025],"length":1,"stats":{"Line":2},"fn_name":null},{"line":93,"address":[11223129],"length":1,"stats":{"Line":1},"fn_name":null},{"line":94,"address":[5890063,5850621,5851225,5889929],"length":1,"stats":{"Line":2},"fn_name":null},{"line":95,"address":[11238920,11239051,11236691],"length":1,"stats":{"Line":1},"fn_name":null},{"line":97,"address":[11236076],"length":1,"stats":{"Line":1},"fn_name":null},{"line":99,"address":[11222781],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[11239249,11239091],"length":1,"stats":{"Line":4},"fn_name":null},{"line":106,"address":[7104652],"length":1,"stats":{"Line":4},"fn_name":null},{"line":110,"address":[11276431,11240570,11276297,11240040,11239954],"length":1,"stats":{"Line":6},"fn_name":null},{"line":121,"address":[5854901,5859007],"length":1,"stats":{"Line":4},"fn_name":null},{"line":123,"address":[12661664,12661283,12661447,12661060,12661535,12661982],"length":1,"stats":{"Line":12},"fn_name":null},{"line":124,"address":[12661137,12661720,12661326,12661167,12661237],"length":1,"stats":{"Line":4},"fn_name":null},{"line":125,"address":[5859279],"length":1,"stats":{"Line":2},"fn_name":null},{"line":126,"address":[5859427],"length":1,"stats":{"Line":2},"fn_name":null},{"line":128,"address":[11843418],"length":1,"stats":{"Line":8},"fn_name":null},{"line":130,"address":[11232652,11232765],"length":1,"stats":{"Line":4},"fn_name":null},{"line":132,"address":[11232780],"length":1,"stats":{"Line":2},"fn_name":null},{"line":133,"address":[12332613],"length":1,"stats":{"Line":2},"fn_name":null},{"line":134,"address":[12332667,12332734],"length":1,"stats":{"Line":4},"fn_name":null},{"line":136,"address":[5860339,5863575,5860925,5861845,5890921,5891055],"length":1,"stats":{"Line":4},"fn_name":null},{"line":138,"address":[11236215,11234465],"length":1,"stats":{"Line":0},"fn_name":null},{"line":146,"address":[5860846],"length":1,"stats":{"Line":2},"fn_name":null},{"line":148,"address":[12662216],"length":1,"stats":{"Line":0},"fn_name":null},{"line":150,"address":[11232840,11240061,11240120],"length":1,"stats":{"Line":0},"fn_name":null},{"line":151,"address":[11253117],"length":1,"stats":{"Line":0},"fn_name":null},{"line":152,"address":[11253091,11253669,11253156,11253215],"length":1,"stats":{"Line":0},"fn_name":null},{"line":153,"address":[5867422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":154,"address":[11253637,11253286,11253227,11253162],"length":1,"stats":{"Line":0},"fn_name":null},{"line":155,"address":[12339979],"length":1,"stats":{"Line":0},"fn_name":null},{"line":156,"address":[5867839,5867591,5867467,5867532],"length":1,"stats":{"Line":0},"fn_name":null},{"line":157,"address":[5867564],"length":1,"stats":{"Line":0},"fn_name":null},{"line":158,"address":[11240280,11240345,11240404,11240549],"length":1,"stats":{"Line":0},"fn_name":null},{"line":159,"address":[12669785],"length":1,"stats":{"Line":0},"fn_name":null},{"line":160,"address":[11240488,11240517,11240422],"length":1,"stats":{"Line":0},"fn_name":null},{"line":161,"address":[12340234],"length":1,"stats":{"Line":0},"fn_name":null},{"line":163,"address":[11253485],"length":1,"stats":{"Line":0},"fn_name":null},{"line":166,"address":[11253701],"length":1,"stats":{"Line":0},"fn_name":null},{"line":168,"address":[12364143,12340491,12364009,12340570,12341192],"length":1,"stats":{"Line":0},"fn_name":null},{"line":180,"address":[5868555],"length":1,"stats":{"Line":0},"fn_name":null},{"line":185,"address":[12662967,12667085],"length":1,"stats":{"Line":4},"fn_name":null},{"line":186,"address":[11250717,11250772],"length":1,"stats":{"Line":4},"fn_name":null},{"line":190,"address":[5885916,5865068,5883428,5882960,5885910,5865214],"length":1,"stats":{"Line":4},"fn_name":"{closure#1}"},{"line":192,"address":[11270317,11277785,11269286,11269430,11277919,11271111,11268942,11268863],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[11258054,11257260],"length":1,"stats":{"Line":0},"fn_name":null},{"line":197,"address":[11271556,11269408],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[11237943,11238029],"length":1,"stats":{"Line":4},"fn_name":null},{"line":204,"address":[11238114,11238341,11238168,11238061],"length":1,"stats":{"Line":6},"fn_name":null},{"line":206,"address":[5865426],"length":1,"stats":{"Line":2},"fn_name":null},{"line":207,"address":[5885936,5886718],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":208,"address":[12358558,12359601,12359314,12365001,12365135],"length":1,"stats":{"Line":0},"fn_name":null},{"line":209,"address":[11259667],"length":1,"stats":{"Line":0},"fn_name":null},{"line":212,"address":[11252824,11252854,11251658,11251797,11251865],"length":1,"stats":{"Line":2},"fn_name":null},{"line":214,"address":[12338730],"length":1,"stats":{"Line":2},"fn_name":null},{"line":220,"address":[12713902,12712880,12711328],"length":1,"stats":{"Line":3},"fn_name":"build_forward_headers"},{"line":221,"address":[11380335,11381780],"length":1,"stats":{"Line":6},"fn_name":null},{"line":222,"address":[5461411],"length":1,"stats":{"Line":3},"fn_name":null},{"line":223,"address":[5461494,5459703],"length":1,"stats":{"Line":3},"fn_name":null},{"line":224,"address":[5461658],"length":1,"stats":{"Line":3},"fn_name":null},{"line":230,"address":[11384586,11383944,11382448,11382727],"length":1,"stats":{"Line":3},"fn_name":"build_response_headers"},{"line":231,"address":[12714399,12715818],"length":1,"stats":{"Line":6},"fn_name":null},{"line":232,"address":[5463919],"length":1,"stats":{"Line":3},"fn_name":null},{"line":233,"address":[12715914],"length":1,"stats":{"Line":3},"fn_name":null},{"line":237,"address":[11392849,11386032,11389841],"length":1,"stats":{"Line":3},"fn_name":"copy_non_hop_by_hop_headers"},{"line":238,"address":[12704551,12704637,12705518],"length":1,"stats":{"Line":6},"fn_name":null},{"line":239,"address":[12704738],"length":1,"stats":{"Line":3},"fn_name":null},{"line":241,"address":[11386323,11386414],"length":1,"stats":{"Line":6},"fn_name":null},{"line":242,"address":[11386504,11389854],"length":1,"stats":{"Line":2},"fn_name":null},{"line":244,"address":[11386562,11386481,11386539,11389819],"length":1,"stats":{"Line":6},"fn_name":null},{"line":245,"address":[11374032,11373657,11374165],"length":1,"stats":{"Line":6},"fn_name":null},{"line":254,"address":[11399437,11397648,11405512],"length":1,"stats":{"Line":3},"fn_name":"add_auth_headers"},{"line":255,"address":[11400027,11398126],"length":1,"stats":{"Line":6},"fn_name":null},{"line":256,"address":[25114352],"length":1,"stats":{"Line":7},"fn_name":null},{"line":257,"address":[24677011],"length":1,"stats":{"Line":4},"fn_name":null},{"line":258,"address":[12383912,12383795],"length":1,"stats":{"Line":7},"fn_name":null},{"line":259,"address":[12696153,12696287],"length":1,"stats":{"Line":7},"fn_name":null},{"line":260,"address":[24530126],"length":1,"stats":{"Line":4},"fn_name":null},{"line":263,"address":[24676993],"length":1,"stats":{"Line":1},"fn_name":null},{"line":264,"address":[11405243],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[11403517],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":72,"coverable":101},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","src","state.rs"],"content":"// src/state.rs\n\nuse crate::config::AppConfig;\nuse crate::error::{AppError, ProxyConfigErrorData, ProxyConfigErrorKind, Result}; // Ensured Proxy types are imported\nuse crate::key_manager::KeyManager;\nuse reqwest::{Client, ClientBuilder, Proxy};\nuse std::collections::{HashMap, HashSet};\nuse std::path::{Path, PathBuf};\nuse std::sync::Arc;\nuse crate::admin::SystemInfoCollector;\nuse std::time::{Duration, Instant};\nuse tokio::sync::RwLock;\nuse tracing::Instrument;\nuse tracing::{debug, error, info, instrument, warn}; // Base tracing macros // Explicitly import the Instrument trait\n\nuse url::Url;\n/// Represents the shared application state that is accessible by all Axum handlers.\n#[derive(Debug)]\npub struct AppState {\n    pub key_manager: Arc\u003cRwLock\u003cKeyManager\u003e\u003e,\n    http_clients: Arc\u003cRwLock\u003cHashMap\u003cOption\u003cString\u003e, Arc\u003cClient\u003e\u003e\u003e\u003e,\n    pub start_time: Instant,\n    pub config: Arc\u003cRwLock\u003cAppConfig\u003e\u003e,\n    pub system_info: SystemInfoCollector,\n    pub config_path: PathBuf,\n}\n\nimpl AppState {\n    /// Creates a new `AppState`. Initializes KeyManager and pre-builds HTTP clients.\n    ///\n    /// # Errors\n    ///\n    /// Returns `Err` if:\n    /// - The base HTTP client (no proxy) fails to build, which is a fatal error.\n    /// - A proxy URL has a syntactically invalid format or an unsupported scheme.\n    /// - An unexpected I/O or other error occurs during client initialization.\n    #[instrument(level = \"info\", skip(config, config_path), fields(config.path = %config_path.display()))]\n    pub async fn new(config: \u0026AppConfig, config_path: \u0026Path) -\u003e Result\u003cSelf\u003e {\n        info!(\"Creating shared AppState: Initializing KeyManager and HTTP clients...\");\n        let key_manager = KeyManager::new(config, config_path).await; // KeyManager init logs its progress\n        let mut http_clients = HashMap::new();\n\n        // Determine connection pool size based on key count, with a minimum floor\n        let total_key_count: usize = config\n            .groups\n            .iter()\n            .flat_map(|g| \u0026g.api_keys)\n            .filter(|k| !k.trim().is_empty())\n            .count()\n            .max(10); // Ensure at least 10 connections possible even with few keys\n        debug!(\n            pool.max_idle_per_host = total_key_count,\n            \"Calculated max idle connections per host\"\n        );\n\n        // Centralized client configuration function\n        let configure_builder = |builder: ClientBuilder| -\u003e ClientBuilder {\n            builder\n                .connect_timeout(Duration::from_secs(10))\n                .timeout(Duration::from_secs(300)) // Overall request timeout\n                .pool_idle_timeout(Duration::from_secs(90)) // Keep idle connections open for 90s\n                .pool_max_idle_per_host(total_key_count) // Adjust pool size based on keys\n                .tcp_keepalive(Some(Duration::from_secs(60))) // Enable TCP keepalive\n                                                              // Add user-agent?\n                                                              // .user_agent(format!(\"gemini-proxy/{}\", env!(\"CARGO_PKG_VERSION\")))\n        };\n\n        // 1. Create the base client (no proxy) - this MUST succeed\n        let base_client_result = configure_builder(Client::builder()).build();\n        let base_client = match base_client_result {\n            Ok(client) =\u003e client,\n            Err(e) =\u003e {\n                // Structured error for base client failure - this is fatal\n                error!(error = ?e, \"Failed to build base HTTP client (no proxy). This is required. Exiting.\");\n                // Map error explicitly, including None proxy context\n                return Err(AppError::HttpClientBuildError {\n                    source: e,\n                    proxy_url: None,\n                });\n            }\n        };\n        http_clients.insert(None, Arc::new(base_client));\n        info!(client.type = \"base\", \"Base HTTP client (no proxy) created successfully.\");\n\n        // 2. Collect unique proxy URLs from the configuration\n        let unique_proxy_urls: HashSet\u003cString\u003e = config\n            .groups\n            .iter()\n            .filter_map(|g| g.proxy_url.as_ref()) // Get Option\u003c\u0026String\u003e\n            .filter(|url_str| !url_str.trim().is_empty()) // Filter out empty strings\n            .cloned() // Clone the String\n            .collect();\n        debug!(\n            proxy.count = unique_proxy_urls.len(),\n            ?unique_proxy_urls,\n            \"Found unique proxy URLs for client creation\"\n        );\n\n        // 3. Create clients for each unique proxy URL\n        for proxy_url_str in unique_proxy_urls {\n            // Create a span for each proxy client creation attempt\n            let proxy_span = tracing::info_span!(\"create_proxy_client\", proxy.url = %proxy_url_str);\n            let client_result: Result\u003cClient\u003e = async {\n                 // Parse URL first, map error to specific ProxyConfigErrorKind\n                 let parsed_proxy_url = Url::parse(\u0026proxy_url_str).map_err(|e| {\n                     // Structured error log for URL parsing\n                     error!(error = %e, \"Failed to parse proxy URL string.\");\n                     AppError::ProxyConfigError(ProxyConfigErrorData {\n                         url: proxy_url_str.clone(),\n                         kind: ProxyConfigErrorKind::UrlParse(e),\n                     })\n                 })?;\n\n                let scheme = parsed_proxy_url.scheme().to_lowercase();\n                debug!(proxy.scheme = %scheme, \"Parsed proxy scheme\");\n\n                 // Create proxy object, map errors to specific ProxyConfigErrorKind\n                 let proxy = match scheme.as_str() {\n                     \"http\" =\u003e Proxy::http(\u0026proxy_url_str).map_err(|e| {\n                         // Log error detail\n                         error!(error = %e, proxy.scheme = %scheme, \"Invalid HTTP proxy definition\");\n                         AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                         })\n                     }),\n                     \"https\" =\u003e Proxy::https(\u0026proxy_url_str).map_err(|e| {\n                          // Log error detail\n                          error!(error = %e, proxy.scheme = %scheme, \"Invalid HTTPS proxy definition\");\n                          AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                         })\n                     }),\n                     \"socks5\" =\u003e Proxy::all(\u0026proxy_url_str).map_err(|e| {\n                          // Log error detail\n                          error!(error = %e, proxy.scheme = %scheme, \"Invalid SOCKS5 proxy definition\");\n                          AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                         })\n                     }),\n                     _ =\u003e {\n                          // Log unsupported scheme error\n                          error!(proxy.scheme = %scheme, \"Unsupported proxy scheme\");\n                          Err(AppError::ProxyConfigError(ProxyConfigErrorData {\n                             url: proxy_url_str.clone(),\n                             kind: ProxyConfigErrorKind::UnsupportedScheme(scheme.to_string()),\n                         }))\n                     },\n                 }?;\n                 debug!(\"Proxy object created successfully\");\n\n                 // Build the client with the proxy\n                 configure_builder(Client::builder())\n                    .proxy(proxy)\n                    .build()\n                     // Map build error with proxy context\n                     .map_err(|e| {\n                         // Structured error log for client build failure\n                         error!(proxy.scheme = %scheme, error = ?e, \"Failed to build reqwest client for proxy.\");\n                         AppError::HttpClientBuildError { source: e, proxy_url: Some(proxy_url_str.clone()) }\n                     })\n            }.instrument(proxy_span).await; // Instrument the async block\n\n            // Handle the result of client creation\n            match client_result {\n                Ok(proxy_client) =\u003e {\n                    // Structured success log\n                    info!(proxy.url = %proxy_url_str, \"HTTP client created successfully for proxy.\");\n                    http_clients.insert(Some(proxy_url_str.clone()), Arc::new(proxy_client));\n                }\n                Err(e) =\u003e {\n                    // Log errors based on their type, ensuring proxy_url is included\n                    match e {\n                        AppError::ProxyConfigError(_) =\u003e {\n                            // Already logged within the async block, re-log as critical error for AppState\n                            error!(proxy.url = %proxy_url_str, error = ?e, \"Critical proxy configuration error. Aborting AppState creation.\");\n                            return Err(e); // Fail fast on config errors\n                        }\n                        AppError::HttpClientBuildError {\n                            ref source,\n                            proxy_url: Some(ref url),\n                        } =\u003e {\n                            // Match specific error\n                            // Already logged within the async block, re-log as warning for skipping\n                            warn!(proxy.url = %url, error = ?source, \"Skipping client creation for this proxy due to build error. Groups using this proxy might fail.\");\n                            // Log and continue for build errors\n                        }\n                        _ =\u003e {\n                            // Catch-all for unexpected errors during creation for this proxy\n                            error!(proxy.url = %proxy_url_str, error = ?e, \"Unexpected error during proxy client creation. Aborting AppState creation.\");\n                            return Err(e); // Fail on other unexpected errors\n                        }\n                    }\n                }\n            }\n        }\n\n        // Log final client count\n        info!(\n            client.count = http_clients.len(),\n            \"Finished initializing HTTP clients.\"\n        );\n\n        Ok(Self {\n            key_manager: Arc::new(RwLock::new(key_manager)),\n            http_clients: Arc::new(RwLock::new(http_clients)),\n            start_time: Instant::now(),\n            config: Arc::new(RwLock::new(config.clone())),\n            system_info: SystemInfoCollector::new(),\n            config_path: config_path.to_path_buf(),\n        })\n    }\n/// Reloads the `KeyManager` from the current configuration within `AppState`.\n    /// Reloads the `KeyManager` and `http_clients` from the current configuration.\n    /// This allows for hot-reloading of API keys and proxy configurations without restarting the server.\n    ///\n    /// # Errors\n    ///\n    /// Returns `Err` if any part of the state reconstruction fails.\n    #[instrument(level = \"info\", skip(self))]\n    pub async fn reload_state_from_config(\u0026self) -\u003e Result\u003c()\u003e {\n        info!(\"Attempting to reload full application state (KeyManager, HttpClients) from configuration...\");\n        let config_guard = self.config.read().await;\n    \n        // --- Create new KeyManager ---\n        let new_key_manager = KeyManager::new(\u0026config_guard, \u0026self.config_path).await;\n    \n        // --- Create new HttpClients (logic identical to AppState::new) ---\n        let mut new_http_clients = HashMap::new();\n        let total_key_count: usize = config_guard.groups.iter().flat_map(|g| \u0026g.api_keys).filter(|k| !k.trim().is_empty()).count().max(10);\n    \n        let configure_builder = |builder: ClientBuilder| -\u003e ClientBuilder {\n            builder\n                .connect_timeout(Duration::from_secs(10))\n                .timeout(Duration::from_secs(300))\n                .pool_idle_timeout(Duration::from_secs(90))\n                .pool_max_idle_per_host(total_key_count)\n                .tcp_keepalive(Some(Duration::from_secs(60)))\n        };\n    \n        let base_client = configure_builder(Client::builder()).build().map_err(|e| {\n            error!(error = ?e, \"Failed to build base HTTP client during reload. This is a critical error.\");\n            AppError::HttpClientBuildError { source: e, proxy_url: None }\n        })?;\n        new_http_clients.insert(None, Arc::new(base_client));\n    \n        let unique_proxy_urls: HashSet\u003cString\u003e = config_guard.groups.iter().filter_map(|g| g.proxy_url.as_ref()).filter(|url_str| !url_str.trim().is_empty()).cloned().collect();\n    \n        for proxy_url_str in unique_proxy_urls {\n            let proxy_span = tracing::info_span!(\"create_proxy_client_reload\", proxy.url = %proxy_url_str);\n            let client_result: Result\u003cClient\u003e = async {\n                let parsed_proxy_url = Url::parse(\u0026proxy_url_str).map_err(|e| {\n                    AppError::ProxyConfigError(ProxyConfigErrorData {\n                        url: proxy_url_str.clone(),\n                        kind: ProxyConfigErrorKind::UrlParse(e),\n                    })\n                })?;\n                let scheme = parsed_proxy_url.scheme().to_lowercase();\n                let proxy = match scheme.as_str() {\n                    \"http\" =\u003e Proxy::http(\u0026proxy_url_str),\n                    \"https\" =\u003e Proxy::https(\u0026proxy_url_str),\n                    \"socks5\" =\u003e Proxy::all(\u0026proxy_url_str),\n                    _ =\u003e return Err(AppError::ProxyConfigError(ProxyConfigErrorData {\n                        url: proxy_url_str.clone(),\n                        kind: ProxyConfigErrorKind::UnsupportedScheme(scheme),\n                    })),\n                }.map_err(|e| AppError::ProxyConfigError(ProxyConfigErrorData {\n                    url: proxy_url_str.clone(),\n                    kind: ProxyConfigErrorKind::InvalidDefinition(e.to_string()),\n                }))?;\n    \n                configure_builder(Client::builder())\n                    .proxy(proxy)\n                    .build()\n                    .map_err(|e| AppError::HttpClientBuildError {\n                        source: e,\n                        proxy_url: Some(proxy_url_str.clone()),\n                    })\n            }.instrument(proxy_span).await;\n    \n            match client_result {\n                Ok(proxy_client) =\u003e {\n                    info!(proxy.url = %proxy_url_str, \"HTTP client recreated successfully during reload.\");\n                    new_http_clients.insert(Some(proxy_url_str.clone()), Arc::new(proxy_client));\n                }\n                Err(e) =\u003e {\n                    warn!(proxy.url = %proxy_url_str, error = ?e, \"Failed to recreate client for proxy during reload. Groups using this proxy may fail.\");\n                }\n            }\n        }\n    \n        drop(config_guard);\n    \n        *self.key_manager.write().await = new_key_manager;\n        *self.http_clients.write().await = new_http_clients;\n    \n        info!(\"Application state (KeyManager, HttpClients) reloaded successfully.\");\n        Ok(())\n    }\n\n    /// Returns a reference to the appropriate HTTP client.\n    ///\n    /// # Errors\n    ///\n    /// Returns an `AppError::Internal` if the requested client (identified by the `proxy_url` Option)\n    /// was not found in the pre-built client map. This indicates a logic error, as all required\n    /// clients should have been initialized at startup.\n    #[instrument(level = \"debug\", skip(self), fields(proxy.url = ?proxy_url))]\n    pub async fn get_client(\u0026self, proxy_url: Option\u003c\u0026str\u003e) -\u003e Result\u003cArc\u003cClient\u003e\u003e {\n        let clients_guard = self.http_clients.read().await;\n        let key = proxy_url.map(String::from);\n        \n        clients_guard.get(\u0026key).cloned().ok_or_else(|| {\n            let msg = proxy_url.map_or_else(\n                || \"Requested base HTTP client (None proxy) was unexpectedly missing.\".to_string(),\n                |p_url| format!(\"Requested HTTP client for proxy '{p_url}' was not found/initialized in AppState.\"),\n            );\n            error!(proxy.url = ?proxy_url, error.message = %msg, \"HTTP client lookup failed\");\n            AppError::Internal(msg)\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::config::{KeyGroup, ServerConfig};\n    use crate::error::ProxyConfigErrorKind; // Import the kind enum for tests\n    use std::fs::File;\n    use tempfile::tempdir;\n    use tracing::warn; // Import warn for logging in tests specifically\n\n    const DEFAULT_TARGET_URL_STR: \u0026str = \"https://generativelanguage.googleapis.com\";\n\n    fn create_test_state_config(groups: Vec\u003cKeyGroup\u003e) -\u003e AppConfig {\n        AppConfig {\n            server: ServerConfig {\n                port: 8080,\n                top_p: None,\n                admin_token: None,\n            },\n            groups,\n            rate_limit_behavior: Default::default(),\n            internal_retries: 2,\n            temporary_block_minutes: 5,\n        }\n    }\n\n    fn create_dummy_config_path(dir: \u0026tempfile::TempDir) -\u003e std::path::PathBuf {\n        let file_path = dir.path().join(\"dummy_config.yaml\");\n        File::create(\u0026file_path).expect(\"Failed to create dummy config file\");\n        file_path\n    }\n\n        #[tokio::test]\n        async fn test_appstate_new_no_proxies() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![KeyGroup {\n            name: \"g1\".to_string(),\n            api_keys: vec![\"key1\".to_string()],\n            proxy_url: None,\n            target_url: DEFAULT_TARGET_URL_STR.to_string(),\n            top_p: None,\n        }];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        assert!(state_result.is_ok());\n        let state = state_result.unwrap();\n        let clients_guard = state.http_clients.read().await;\n        assert_eq!(clients_guard.len(), 1);\n        assert!(clients_guard.contains_key(\u0026None)); // Base client only\n        drop(clients_guard);\n\n        assert!(state.get_client(None).await.is_ok());\n        assert!(state\n            .get_client(Some(\"http://nonexistent.proxy\"))\n            .await\n            .is_err());\n    }\n    #[tokio::test]\n    async fn test_appstate_new_with_valid_proxies() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        // Mock server or use potentially invalid ports to test resilience\n        let http_proxy_url = \"http://127.0.0.1:34567\"; // Use a likely free port\n        let socks_proxy_url = \"socks5://127.0.0.1:34568\"; // Use a likely free port\n\n        let groups = vec![\n            KeyGroup {\n                name: \"g_http\".to_string(),\n                api_keys: vec![\"key_http\".to_string()],\n                proxy_url: Some(http_proxy_url.to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g_socks\".to_string(),\n                api_keys: vec![\"key_socks\".to_string()],\n                proxy_url: Some(socks_proxy_url.to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                // Same HTTP proxy, should reuse client map entry\n                name: \"g_http_dup\".to_string(),\n                api_keys: vec![\"key_http2\".to_string()],\n                proxy_url: Some(http_proxy_url.to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            KeyGroup {\n                name: \"g_no_proxy\".to_string(),\n                api_keys: vec![\"key_none\".to_string()],\n                proxy_url: None,\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n        ];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        // AppState::new should succeed even if proxy servers aren't actually running\n        assert!(\n            state_result.is_ok(),\n            \"AppState::new failed unexpectedly: {:?}\",\n            state_result.err()\n        );\n        let state = state_result.unwrap();\n        let clients_guard = state.http_clients.read().await;\n\n        assert!(clients_guard.contains_key(\u0026None)); // Base client must exist\n\n        let http_key = Some(http_proxy_url.to_string());\n        let socks_key = Some(socks_proxy_url.to_string());\n\n        let http_created = clients_guard.contains_key(\u0026http_key);\n        let socks_created = clients_guard.contains_key(\u0026socks_key);\n\n        // We expect all clients to be created successfully if URLs are valid syntactically\n        assert!(http_created, \"HTTP proxy client was not created\");\n        assert!(socks_created, \"SOCKS5 proxy client was not created\");\n        assert_eq!(\n            clients_guard.len(),\n            3,\n            \"Expected Base + HTTP + SOCKS clients\"\n        ); // 1 base + 2 unique proxies\n        drop(clients_guard);\n\n        // Verify get_client behavior\n        assert!(\n            state.get_client(http_key.as_deref()).await.is_ok(),\n            \"get_client failed for created HTTP proxy\"\n        );\n        assert!(\n            state.get_client(socks_key.as_deref()).await.is_ok(),\n            \"get_client failed for created SOCKS5 proxy\"\n        );\n        assert!(state.get_client(None).await.is_ok()); // Check base client retrieval\n        assert!(state.get_client(Some(\"http://other.proxy\")).await.is_err()); // Check non-existent proxy\n    }\n\n    #[tokio::test]\n    async fn test_appstate_new_returns_err_on_invalid_url_syntax() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![KeyGroup {\n            name: \"g_invalid_url\".to_string(),\n            api_keys: vec![\"key_invalid\".to_string()],\n            proxy_url: Some(\"::not a proxy url::\".to_string()), // Invalid syntax\n            target_url: DEFAULT_TARGET_URL_STR.to_string(),\n            top_p: None,\n        }];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        assert!(\n            state_result.is_err(),\n            \"AppState::new should return Err for invalid proxy URL syntax\"\n        );\n        // Check for the correct error variant and kind\n        assert!(\n            matches!(state_result.as_ref().err().unwrap(), AppError::ProxyConfigError(data) if matches!(data.kind, ProxyConfigErrorKind::UrlParse(_))),\n            \"Expected ProxyConfigError with UrlParse kind\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_appstate_new_returns_err_on_unsupported_scheme() {\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![KeyGroup {\n            name: \"g_unsupported\".to_string(),\n            api_keys: vec![\"key_unsupported\".to_string()],\n            proxy_url: Some(\"ftp://unsupported.proxy\".to_string()), // Unsupported scheme\n            target_url: DEFAULT_TARGET_URL_STR.to_string(),\n            top_p: None,\n        }];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        assert!(\n            state_result.is_err(),\n            \"AppState::new should return Err for unsupported proxy scheme\"\n        );\n        // Check for the correct error variant and kind\n        assert!(\n            matches!(state_result.as_ref().err().unwrap(), AppError::ProxyConfigError(data) if matches!(data.kind, ProxyConfigErrorKind::UnsupportedScheme(_))),\n            \"Expected ProxyConfigError with UnsupportedScheme kind\"\n        );\n    }\n\n    // Test where Client::build() itself might fail (less common, requires specific setup or invalid proxy def)\n    // This test might be flaky depending on environment/reqwest version behavior\n    #[tokio::test]\n    async fn test_appstate_new_skips_client_on_build_error() {\n        // This test simulates a reqwest build failure for one proxy,\n        // but AppState creation should still succeed with other valid clients.\n        // We use a syntactically valid but likely non-functional SOCKS5 URL.\n        let dir = tempdir().unwrap();\n        let dummy_path = create_dummy_config_path(\u0026dir);\n\n        let groups = vec![\n            KeyGroup {\n                // Valid HTTP\n                name: \"g_http_ok\".to_string(),\n                api_keys: vec![\"k1\".to_string()],\n                proxy_url: Some(\"http://127.0.0.1:34569\".to_string()), // Likely free port\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n            // Use a socks URL that might cause build issues or is hard to resolve\n            KeyGroup {\n                name: \"g_socks_fail_build\".to_string(),\n                api_keys: vec![\"k2\".to_string()],\n                // Provide a URL that might fail build if socks feature isn't compiled correctly or has issues\n                proxy_url: Some(\"socks5://invalid-host-that-causes-build-error:1080\".to_string()),\n                target_url: DEFAULT_TARGET_URL_STR.to_string(),\n                top_p: None,\n            },\n        ];\n        let config = create_test_state_config(groups);\n        let state_result = AppState::new(\u0026config, \u0026dummy_path).await;\n\n        // Check the result: AppState::new should either succeed (skipping the build error)\n        // or return a ProxyConfigError if the test URL caused a definition error.\n        match state_result {\n            Ok(state) =\u003e {\n                let clients_guard = state.http_clients.read().await;\n                assert!(clients_guard.contains_key(\u0026None)); // Base client\n                let http_key = Some(\"http://127.0.0.1:34569\".to_string());\n                let socks_key = Some(\"socks5://invalid-host-that-causes-build-error:1080\".to_string());\n                let http_created = clients_guard.contains_key(\u0026http_key);\n                let socks_created = clients_guard.contains_key(\u0026socks_key);\n                assert!(http_created, \"Valid HTTP client should have been created\");\n                \n                let expected_clients = 1 + (if http_created { 1 } else { 0 }) + (if socks_created { 1 } else { 0 });\n                assert_eq!(clients_guard.len(), expected_clients, \"Unexpected number of clients created\");\n                drop(clients_guard);\n\n                assert!(state.get_client(http_key.as_deref()).await.is_ok());\n                if socks_created {\n                    assert!(state.get_client(socks_key.as_deref()).await.is_ok());\n                    warn!(\"SOCKS client build succeeded unexpectedly in test - test might not cover build failure path\");\n                } else {\n                    assert!(state.get_client(socks_key.as_deref()).await.is_err());\n                }\n            }\n            Err(AppError::ProxyConfigError(data)) =\u003e {\n                // If the \"invalid\" URL actually caused a config error (likely InvalidDefinition), this is an acceptable outcome.\n                warn!(error=?data, \"Test URL caused ProxyConfigError instead of HttpClientBuildError. Treating as acceptable test outcome.\");\n                assert_eq!(data.url, \"socks5://invalid-host-that-causes-build-error:1080\");\n            }\n            Err(e) =\u003e {\n                // Any other error type is unexpected and should fail the test\n                panic!(\"AppState::new failed with unexpected error type: {:?}\", e);\n            }\n        }\n\n\n    }\n} // end tests module\n","traces":[{"line":38,"address":[10390992,10391010],"length":1,"stats":{"Line":20},"fn_name":null},{"line":39,"address":[5574467,5573941,5627807,5573792,5627673],"length":1,"stats":{"Line":12},"fn_name":null},{"line":40,"address":[11725238,11723258,11725358,11723821],"length":1,"stats":{"Line":12},"fn_name":null},{"line":41,"address":[5576226],"length":1,"stats":{"Line":4},"fn_name":null},{"line":44,"address":[11724896,11724775],"length":1,"stats":{"Line":8},"fn_name":null},{"line":47,"address":[5603984,5603997],"length":1,"stats":{"Line":8},"fn_name":"{closure#0}"},{"line":48,"address":[11739760,11739774],"length":1,"stats":{"Line":8},"fn_name":"{closure#1}"},{"line":51,"address":[11694397,11694980,11746425,11746559],"length":1,"stats":{"Line":8},"fn_name":null},{"line":57,"address":[11752848,11753496,11725592,11753525],"length":1,"stats":{"Line":8},"fn_name":"{closure#2}"},{"line":58,"address":[5604550,5604664,5604123,5604378,5604256,5604500],"length":1,"stats":{"Line":24},"fn_name":null},{"line":59,"address":[11722270,11722881,11722371],"length":1,"stats":{"Line":8},"fn_name":null},{"line":60,"address":[11740157,11740526,11740056],"length":1,"stats":{"Line":8},"fn_name":null},{"line":61,"address":[11754284,11754178,11754507],"length":1,"stats":{"Line":8},"fn_name":null},{"line":62,"address":[5604544,5604572],"length":1,"stats":{"Line":8},"fn_name":null},{"line":63,"address":[11740456,11740333,11740485],"length":1,"stats":{"Line":8},"fn_name":null},{"line":69,"address":[5578908,5577133],"length":1,"stats":{"Line":8},"fn_name":null},{"line":70,"address":[11728497],"length":1,"stats":{"Line":4},"fn_name":null},{"line":71,"address":[11727596],"length":1,"stats":{"Line":4},"fn_name":null},{"line":72,"address":[5579050],"length":1,"stats":{"Line":0},"fn_name":null},{"line":74,"address":[11734998,11778719,11778585,11728541,11734363],"length":1,"stats":{"Line":0},"fn_name":null},{"line":76,"address":[11703200],"length":1,"stats":{"Line":0},"fn_name":null},{"line":77,"address":[11733862],"length":1,"stats":{"Line":0},"fn_name":null},{"line":78,"address":[11703182],"length":1,"stats":{"Line":0},"fn_name":null},{"line":82,"address":[11702610,11696998,11696931],"length":1,"stats":{"Line":4},"fn_name":null},{"line":83,"address":[11765215,11765081,11715356,11714797],"length":1,"stats":{"Line":8},"fn_name":null},{"line":86,"address":[5579824,5581601],"length":1,"stats":{"Line":8},"fn_name":null},{"line":89,"address":[11740601,11740576],"length":1,"stats":{"Line":8},"fn_name":"{closure#3}"},{"line":90,"address":[5604864,5604878],"length":1,"stats":{"Line":2},"fn_name":"{closure#4}"},{"line":93,"address":[11731962,11779711,11731385,11731302,11733741,11732893,11779577],"length":1,"stats":{"Line":12},"fn_name":null},{"line":94,"address":[11733683,11732835],"length":1,"stats":{"Line":0},"fn_name":null},{"line":100,"address":[11720235,11720202,11731865,11717857],"length":1,"stats":{"Line":16},"fn_name":null},{"line":102,"address":[11750408,11749247,11745945],"length":1,"stats":{"Line":2},"fn_name":null},{"line":103,"address":[5613542,5605082,5604928,5600683,5587446,5605104,5601094,5600563,5604997,5610955],"length":1,"stats":{"Line":6},"fn_name":"{async_block#5}"},{"line":105,"address":[11731719,11723271,11732545,11723444,11731760,11723136],"length":1,"stats":{"Line":5},"fn_name":"{closure#0}"},{"line":107,"address":[11750494,11749452,11766207,11766073,11750211],"length":1,"stats":{"Line":2},"fn_name":null},{"line":108,"address":[11763375],"length":1,"stats":{"Line":1},"fn_name":null},{"line":109,"address":[11750308],"length":1,"stats":{"Line":1},"fn_name":null},{"line":110,"address":[5614474],"length":1,"stats":{"Line":1},"fn_name":null},{"line":114,"address":[11741428,11741345],"length":1,"stats":{"Line":2},"fn_name":null},{"line":115,"address":[11723859,11748905,11749039,11723783,11724372],"length":1,"stats":{"Line":3},"fn_name":null},{"line":118,"address":[11724339,11729351,11729073,11726186,11729259],"length":1,"stats":{"Line":5},"fn_name":null},{"line":119,"address":[11765844,11768417,11757953,11757872,11765376,11760872,11768411],"length":1,"stats":{"Line":3},"fn_name":"{closure#1}"},{"line":121,"address":[11767065,11767199,11751990,11751846,11751502,11751423],"length":1,"stats":{"Line":0},"fn_name":null},{"line":122,"address":[11767275],"length":1,"stats":{"Line":0},"fn_name":null},{"line":123,"address":[11765960],"length":1,"stats":{"Line":0},"fn_name":null},{"line":124,"address":[11768116,11768195],"length":1,"stats":{"Line":0},"fn_name":null},{"line":127,"address":[11726263,11736768,11739803,11726377,11729157,11739809,11726329,11737236],"length":1,"stats":{"Line":2},"fn_name":"{closure#2}"},{"line":129,"address":[11749897,11736815,11737382,11736894,11737238,11750031],"length":1,"stats":{"Line":0},"fn_name":null},{"line":130,"address":[11771307],"length":1,"stats":{"Line":0},"fn_name":null},{"line":131,"address":[11768040],"length":1,"stats":{"Line":0},"fn_name":null},{"line":132,"address":[11771251,11771172],"length":1,"stats":{"Line":0},"fn_name":null},{"line":135,"address":[11758081,11758115,11760773,11774529,11771488,11771956,11758015,11774523],"length":1,"stats":{"Line":4},"fn_name":"{closure#3}"},{"line":137,"address":[11770982,11770638,11781215,11770559,11771126,11781081],"length":1,"stats":{"Line":0},"fn_name":null},{"line":138,"address":[11773387],"length":1,"stats":{"Line":0},"fn_name":null},{"line":139,"address":[11758072],"length":1,"stats":{"Line":0},"fn_name":null},{"line":140,"address":[11774307,11774228],"length":1,"stats":{"Line":0},"fn_name":null},{"line":145,"address":[11782687,11782553,11758087,11758155,11758667],"length":1,"stats":{"Line":3},"fn_name":null},{"line":146,"address":[5610749],"length":1,"stats":{"Line":1},"fn_name":null},{"line":147,"address":[5608831],"length":1,"stats":{"Line":1},"fn_name":null},{"line":148,"address":[11759454,11759525],"length":1,"stats":{"Line":2},"fn_name":null},{"line":152,"address":[5611317,5611914,5633129,5633263,5611393],"length":1,"stats":{"Line":3},"fn_name":null},{"line":155,"address":[11760720,11762212,11762053,11762135],"length":1,"stats":{"Line":4},"fn_name":null},{"line":156,"address":[11762087],"length":1,"stats":{"Line":1},"fn_name":null},{"line":159,"address":[5624640,5627580,5613338,5627574,5625121],"length":1,"stats":{"Line":1},"fn_name":"{closure#4}"},{"line":161,"address":[5633625,5625123,5624687,5625291,5624779,5633759],"length":1,"stats":{"Line":0},"fn_name":null},{"line":162,"address":[5625237,5627397],"length":1,"stats":{"Line":0},"fn_name":null},{"line":164,"address":[11719118,11705163,11723811,11731605,11705402,11723704,11731551,11691615,11719178,11726135,11705129,11731673,11718650,11729512],"length":1,"stats":{"Line":8},"fn_name":null},{"line":167,"address":[11705479],"length":1,"stats":{"Line":1},"fn_name":null},{"line":168,"address":[11737328],"length":1,"stats":{"Line":1},"fn_name":null},{"line":170,"address":[11770041,11723428,11770175,11723961,11723352],"length":1,"stats":{"Line":3},"fn_name":null},{"line":171,"address":[11708353,11706236,11708184,11708074],"length":1,"stats":{"Line":1},"fn_name":null},{"line":173,"address":[11723184],"length":1,"stats":{"Line":1},"fn_name":null},{"line":175,"address":[5590546,5587688],"length":1,"stats":{"Line":1},"fn_name":null},{"line":178,"address":[11709118,11708438,11753007,11752873,11708560],"length":1,"stats":{"Line":3},"fn_name":null},{"line":179,"address":[11709032],"length":1,"stats":{"Line":1},"fn_name":null},{"line":181,"address":[11743037],"length":1,"stats":{"Line":0},"fn_name":null},{"line":187,"address":[11753503,11711941,11711405,11753369],"length":1,"stats":{"Line":0},"fn_name":null},{"line":192,"address":[11753999,11708407,11753865,11719748,11719190],"length":1,"stats":{"Line":0},"fn_name":null},{"line":193,"address":[11719662],"length":1,"stats":{"Line":0},"fn_name":null},{"line":201,"address":[11747531,11786025,11745988,11746592,11786159,11748149],"length":1,"stats":{"Line":8},"fn_name":null},{"line":202,"address":[11747107,11746489],"length":1,"stats":{"Line":0},"fn_name":null},{"line":206,"address":[5599272],"length":1,"stats":{"Line":4},"fn_name":null},{"line":207,"address":[11716708,11714831],"length":1,"stats":{"Line":8},"fn_name":null},{"line":208,"address":[11734561,11734415],"length":1,"stats":{"Line":8},"fn_name":null},{"line":209,"address":[11734604],"length":1,"stats":{"Line":4},"fn_name":null},{"line":210,"address":[11734704],"length":1,"stats":{"Line":4},"fn_name":null},{"line":211,"address":[11734811],"length":1,"stats":{"Line":4},"fn_name":null},{"line":212,"address":[11747898],"length":1,"stats":{"Line":4},"fn_name":null},{"line":223,"address":[10779880,10779872],"length":1,"stats":{"Line":5},"fn_name":null},{"line":224,"address":[11757488,11780345,11780479,11757703,11758223],"length":1,"stats":{"Line":3},"fn_name":null},{"line":225,"address":[5639245,5641405,5639871,5641286],"length":1,"stats":{"Line":2},"fn_name":null},{"line":228,"address":[11833275],"length":1,"stats":{"Line":3},"fn_name":null},{"line":231,"address":[11792279],"length":1,"stats":{"Line":1},"fn_name":null},{"line":232,"address":[11791392,11804752,11804720,11804766,11804733,11791497],"length":1,"stats":{"Line":6},"fn_name":"{closure#0}"},{"line":234,"address":[11804816,11805493,11805464,11791729],"length":1,"stats":{"Line":2},"fn_name":"{closure#2}"},{"line":235,"address":[11806380,11805835,11805968,11806266,11806090,11806212],"length":1,"stats":{"Line":6},"fn_name":null},{"line":236,"address":[11805537,11805027,11804926],"length":1,"stats":{"Line":2},"fn_name":null},{"line":237,"address":[5656134,5655773,5655672],"length":1,"stats":{"Line":2},"fn_name":null},{"line":238,"address":[5655794,5655896,5656115],"length":1,"stats":{"Line":2},"fn_name":null},{"line":239,"address":[5655904,5655932],"length":1,"stats":{"Line":2},"fn_name":null},{"line":240,"address":[11774789,11774637,11774760],"length":1,"stats":{"Line":2},"fn_name":null},{"line":243,"address":[11806544,11808895,11806996,11793084,11808901,11792849,11792730],"length":1,"stats":{"Line":2},"fn_name":"{closure#3}"},{"line":244,"address":[11811529,11806239,11805678,11811663,11806022,11805599],"length":1,"stats":{"Line":0},"fn_name":null},{"line":245,"address":[11775464],"length":1,"stats":{"Line":0},"fn_name":null},{"line":247,"address":[5643688,5643174,5643088],"length":1,"stats":{"Line":1},"fn_name":null},{"line":249,"address":[11779433,11794976,11794990,11794928,11794953],"length":1,"stats":{"Line":3},"fn_name":"{closure#4}"},{"line":251,"address":[5643613,5649875,5643653],"length":1,"stats":{"Line":3},"fn_name":null},{"line":252,"address":[11768495,11768888,11770049],"length":1,"stats":{"Line":0},"fn_name":null},{"line":253,"address":[11809187,11809209,11809094,11811203,11809040,11794237,11801571,11811141,11801667,11802114],"length":1,"stats":{"Line":0},"fn_name":"{async_block#6}"},{"line":254,"address":[5660816,5660770,5658896,5659061,5658753],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":255,"address":[11811301],"length":1,"stats":{"Line":0},"fn_name":null},{"line":256,"address":[11779603],"length":1,"stats":{"Line":0},"fn_name":null},{"line":257,"address":[11810316],"length":1,"stats":{"Line":0},"fn_name":null},{"line":260,"address":[11795690,11795769],"length":1,"stats":{"Line":0},"fn_name":null},{"line":261,"address":[11810494,11811147,11809883,11809804,11810613,11810463],"length":1,"stats":{"Line":0},"fn_name":null},{"line":262,"address":[11778828,11778235,11778301],"length":1,"stats":{"Line":0},"fn_name":null},{"line":263,"address":[11809065,11809514,11809026,11808966],"length":1,"stats":{"Line":0},"fn_name":null},{"line":264,"address":[11796450,11796018,11796078,11796114],"length":1,"stats":{"Line":0},"fn_name":null},{"line":265,"address":[11796259],"length":1,"stats":{"Line":0},"fn_name":null},{"line":266,"address":[11778420],"length":1,"stats":{"Line":0},"fn_name":null},{"line":267,"address":[11796147],"length":1,"stats":{"Line":0},"fn_name":null},{"line":269,"address":[11811612,11811727,11810452,11811733,11811408],"length":1,"stats":{"Line":0},"fn_name":"{closure#1}"},{"line":270,"address":[5661018],"length":1,"stats":{"Line":0},"fn_name":null},{"line":271,"address":[11779898,11779832],"length":1,"stats":{"Line":0},"fn_name":null},{"line":274,"address":[5660576,5660418,5660493,5660308],"length":1,"stats":{"Line":0},"fn_name":null},{"line":275,"address":[11779205],"length":1,"stats":{"Line":0},"fn_name":null},{"line":277,"address":[11811934,11810981,11811940,11811880,11811760],"length":1,"stats":{"Line":0},"fn_name":"{closure#2}"},{"line":278,"address":[11811783],"length":1,"stats":{"Line":0},"fn_name":null},{"line":279,"address":[11780186,11780124],"length":1,"stats":{"Line":0},"fn_name":null},{"line":281,"address":[11833301],"length":1,"stats":{"Line":0},"fn_name":null},{"line":283,"address":[11762714],"length":1,"stats":{"Line":0},"fn_name":null},{"line":284,"address":[11780510],"length":1,"stats":{"Line":0},"fn_name":null},{"line":285,"address":[11780534,11799001,11799135,11781143,11780610],"length":1,"stats":{"Line":0},"fn_name":null},{"line":286,"address":[11796223,11795944,11794106,11796054],"length":1,"stats":{"Line":0},"fn_name":null},{"line":288,"address":[11793439],"length":1,"stats":{"Line":0},"fn_name":null},{"line":289,"address":[5647128,5663199,5647625,5644331,5663065],"length":1,"stats":{"Line":0},"fn_name":null},{"line":294,"address":[5649994],"length":1,"stats":{"Line":1},"fn_name":null},{"line":296,"address":[11833899,11833327,11833837],"length":1,"stats":{"Line":1},"fn_name":null},{"line":297,"address":[11864041,11864634,11864696],"length":1,"stats":{"Line":1},"fn_name":null},{"line":299,"address":[11800127,11799993,11790280,11789683],"length":1,"stats":{"Line":2},"fn_name":null},{"line":300,"address":[11804190],"length":1,"stats":{"Line":1},"fn_name":null},{"line":311,"address":[11813730,11813654,11813456,11813503,11816283,11815080],"length":1,"stats":{"Line":16},"fn_name":"{async_fn#0}"},{"line":312,"address":[5667933,5667717,5667835,5667768],"length":1,"stats":{"Line":8},"fn_name":null},{"line":313,"address":[11817707],"length":1,"stats":{"Line":4},"fn_name":null},{"line":315,"address":[11787440,11790299,11787924,11790305,11787092,11787162,11787232],"length":1,"stats":{"Line":13},"fn_name":"{closure#0}"},{"line":316,"address":[11787471],"length":1,"stats":{"Line":1},"fn_name":null},{"line":317,"address":[11790320,11790332],"length":1,"stats":{"Line":0},"fn_name":"{closure#0}"},{"line":318,"address":[5671483,5671456],"length":1,"stats":{"Line":2},"fn_name":"{closure#1}"},{"line":320,"address":[11818614,11821257,11818270,11821391,11818191,11818849],"length":1,"stats":{"Line":3},"fn_name":null},{"line":321,"address":[11818744],"length":1,"stats":{"Line":1},"fn_name":null}],"covered":93,"coverable":150},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","admin_integration_tests.rs"],"content":"// tests/admin_integration_tests.rs\n\nuse axum::{\n    body::Body,\n    http::{header, HeaderMap, Method, Request, StatusCode},\n};\nuse gemini_proxy_key_rotation_rust::{\n    admin::{CsrfTokenResponse, KeysUpdateRequest},\n    config::{AppConfig, KeyGroup},\n    run,\n};\nuse http_body_util::BodyExt;\nuse md5;\nuse serde_json::json;\nuse tempfile::TempDir;\nuse std::sync::Once;\nuse tower::util::ServiceExt;\nuse wiremock::{\n    matchers::{method, path},\n    Mock, MockServer, ResponseTemplate,\n};\nuse tracing_subscriber::{fmt, layer::SubscriberExt, util::SubscriberInitExt, EnvFilter};\n\nstatic TRACING_INIT: Once = Once::new();\n\n/// Initializes the tracing subscriber for tests, ensuring it only runs once.\nfn ensure_tracing_initialized() {\n    TRACING_INIT.call_once(|| {\n        let env_filter = EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\"));\n        let json_layer = fmt::layer()\n            .json()\n            .with_current_span(true)\n            .with_span_list(true);\n        tracing_subscriber::registry()\n            .with(env_filter)\n            .with(json_layer)\n            .init();\n    });\n}\n\n\n// Helper structure to manage the test application state\nstruct TestApp {\n    router: axum::Router,\n    // _state: Arc\u003cAppState\u003e, // Keep state alive\n    _temp_dir: TempDir,   // Keep temp dir alive\n    auth_cookie: Option\u003cString\u003e,\n    csrf_token: Option\u003cString\u003e,\n    csrf_cookie: Option\u003cString\u003e,\n}\n\nimpl TestApp {\n    async fn new(config: AppConfig) -\u003e Self {\n        ensure_tracing_initialized();\n        let temp_dir = tempfile::tempdir().unwrap();\n        // Define paths for config and state files within the temp directory\n        let config_file_path = temp_dir.path().join(\"config.yaml\");\n        let state_file_path = temp_dir.path().join(\"key_states.json\");\n\n        // Save the provided config to a temporary file\n        let config_str = serde_yaml::to_string(\u0026config).unwrap();\n        tokio::fs::write(\u0026config_file_path, \u0026config_str)\n            .await\n            .unwrap();\n        \n        // Also create an empty key_states.json file\n        tokio::fs::write(state_file_path, \"{}\")\n            .await\n            .unwrap();\n\n\n        // The `run` function now returns a router and config, which is ideal for testing.\n        let (router, _config) = run(Some(config_file_path.clone()))\n            .await\n            .expect(\"Failed to create test router\");\n\n        TestApp {\n            router,\n            // _state: state,\n            _temp_dir: temp_dir,\n            auth_cookie: None,\n            csrf_token: None,\n            csrf_cookie: None,\n        }\n    }\n\n    /// Logs in to the application and stores the auth cookie.\n    async fn login(\u0026mut self, token: \u0026str) {\n        let response = self\n            .router\n            .clone()\n            .oneshot(\n                Request::builder()\n                    .method(\"POST\")\n                    .uri(\"/admin/login\")\n                    .header(\"Content-Type\", \"application/json\")\n                    .body(Body::from(format!(r#\"{{\"token\": \"{}\"}}\"#, token)))\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n\n        assert_eq!(response.status(), StatusCode::OK);\n        let cookie = response.headers().get(\"set-cookie\").unwrap().to_str().unwrap();\n        self.auth_cookie = Some(cookie.to_string());\n    }\n\n    /// Gets a CSRF token and stores it.\n    async fn get_csrf_token(\u0026mut self) {\n        let response = self\n            .router\n            .clone()\n            .oneshot(\n                Request::builder()\n                    .uri(\"/admin/csrf-token\")\n                    .header(header::COOKIE, self.auth_cookie.as_ref().unwrap())\n                    .body(Body::empty())\n                    .unwrap(),\n            )\n            .await\n            .unwrap();\n        \n        assert_eq!(response.status(), StatusCode::OK);\n        let csrf_cookie = response.headers().get(\"set-cookie\").unwrap().to_str().unwrap();\n        self.csrf_cookie = Some(csrf_cookie.to_string());\n\n        let body = response.into_body().collect().await.unwrap().to_bytes();\n        let csrf_response: CsrfTokenResponse = serde_json::from_slice(\u0026body).unwrap();\n        self.csrf_token = Some(csrf_response.csrf_token);\n    }\n\n    /// Sends a request with authentication and CSRF headers.\n    async fn authed_request(\n        \u0026self,\n        method: Method,\n        uri: \u0026str,\n        body: Body,\n    ) -\u003e axum::response::Response {\n        let mut headers = HeaderMap::new();\n        headers.insert(\n            header::COOKIE,\n            format!(\n                \"{}; {}\",\n                self.auth_cookie.as_ref().unwrap(),\n                self.csrf_cookie.as_ref().unwrap()\n            )\n            .parse()\n            .unwrap(),\n        );\n        headers.insert(\n            \"x-csrf-token\",\n            self.csrf_token.as_ref().unwrap().parse().unwrap(),\n        );\n        headers.insert(\"Content-Type\", \"application/json\".parse().unwrap());\n\n        self.router\n            .clone()\n            .oneshot(\n                Request::builder()\n                    .method(method)\n                    .uri(uri)\n                    .header(\"Content-Type\", \"application/json\")\n                    .header(header::COOKIE, format!(\"{}; {}\", self.auth_cookie.as_ref().unwrap(), self.csrf_cookie.as_ref().unwrap()))\n                    .header(\"x-csrf-token\", self.csrf_token.as_ref().unwrap())\n                    .body(body)\n                    .unwrap(),\n            )\n            .await\n            .unwrap()\n    }\n}\n\nfn get_default_config() -\u003e AppConfig {\n    let mut config = AppConfig::default();\n    config.server.admin_token = Some(\"secret_admin_token\".to_string());\n    config.groups = vec![KeyGroup {\n        name: \"default\".to_string(),\n        api_keys: vec![\"key1\".to_string()],\n        ..Default::default()\n    }];\n    config\n}\n\n\n#[tokio::test]\nasync fn test_detailed_health_ok() {\n    let config = get_default_config();\n    let app = TestApp::new(config).await;\n\n    let response = app\n        .router\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/health\")\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n\n    assert_eq!(response.status(), StatusCode::OK);\n}\n\n#[tokio::test]\nasync fn test_login_and_get_config_success() {\n    let config = get_default_config();\n    let mut app = TestApp::new(config.clone()).await;\n\n    // 1. Login\n    app.login(\"secret_admin_token\").await;\n    assert!(app.auth_cookie.is_some());\n\n    // 2. Get config (doesn't require CSRF)\n    let response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    assert_eq!(response.status(), StatusCode::OK);\n    let body = response.into_body().collect().await.unwrap().to_bytes();\n    let received_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n    \n    // Just check one field to confirm it's the right config\n    assert_eq!(received_config.server.admin_token, config.server.admin_token);\n}\n\n\n#[tokio::test]\nasync fn test_add_keys_unauthorized() {\n    let config = get_default_config();\n    let app = TestApp::new(config).await;\n\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"new_key\".to_string()],\n    }).unwrap());\n\n    let response = app\n        .router\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/admin/keys\")\n                .header(\"Content-Type\", \"application/json\")\n                .body(body)\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    // Unauthorized because no auth cookie/token\n    // It's a CSRF failure, which results in FORBIDDEN\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n#[tokio::test]\nasync fn test_add_keys_no_csrf() {\n    let config = get_default_config();\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"new_key\".to_string()],\n    }).unwrap());\n\n    let response = app\n        .router\n        .oneshot(\n            Request::builder()\n                .method(\"POST\")\n                .uri(\"/admin/keys\")\n                .header(\"Content-Type\", \"application/json\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(body)\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    // Forbidden because no CSRF token in header\n    assert_eq!(response.status(), StatusCode::FORBIDDEN);\n}\n\n\n#[tokio::test]\nasync fn test_add_keys_success() {\n    let config = get_default_config();\n    let mut app = TestApp::new(config).await;\n    \n    // 1. Login and get CSRF token\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 2. Prepare and send request\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"new_key_1\".to_string(), \"new_key_2\".to_string()],\n    }).unwrap());\n\n    let response = app.authed_request(Method::POST, \"/admin/keys\", body).await;\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // 3. Verify the change by getting the config again\n    let get_config_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    let body = get_config_response\n        .into_body()\n        .collect()\n        .await\n        .unwrap()\n        .to_bytes();\n    let updated_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n    \n    let default_group = updated_config.groups.iter().find(|g| g.name == \"default\").unwrap();\n    assert_eq!(default_group.api_keys.len(), 3); // key1, new_key_1, new_key_2\n    assert!(default_group.api_keys.contains(\u0026\"key1\".to_string()));\n    assert!(default_group.api_keys.contains(\u0026\"new_key_1\".to_string()));\n}\n\n#[tokio::test]\nasync fn test_verify_key_success() {\n    // 1. Setup Wiremock\n    let mock_server = MockServer::start().await;\n    Mock::given(method(\"POST\"))\n        .and(path(\"/v1beta/models/gemini-pro:generateContent\"))\n        .respond_with(ResponseTemplate::new(200).set_body_json(json!({\n            \"candidates\": [{\n                \"content\": {\n                    \"parts\": [{\"text\": \"OK\"}],\n                    \"role\": \"model\"\n                }\n            }]\n        })))\n        .mount(\u0026mock_server)\n        .await;\n\n    // 2. Setup TestApp with a key group pointing to the mock server\n    let mut config = get_default_config();\n    config.groups[0].target_url = mock_server.uri(); // Point to mock server\n    let api_key_to_verify = config.groups[0].api_keys[0].clone();\n    let key_id = format!(\"{:x}\", md5::compute(api_key_to_verify.as_bytes()));\n\n\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 3. Make the request to verify the key\n    let response = app\n        .authed_request(\n            Method::POST,\n            \u0026format!(\"/admin/keys/{}/verify\", key_id),\n            Body::empty(),\n        )\n        .await;\n\n    // 4. Assert the response\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // Assert that the mock server received exactly one request,\n    // which confirms our handler called the verification logic.\n    mock_server.verify().await;\n}\n#[tokio::test]\nasync fn test_reset_key_success() {\n    // 1. Setup Wiremock to return a rate-limit error\n    let mock_server = MockServer::start().await;\n    Mock::given(method(\"POST\"))\n        .and(path(\"/v1beta/models/gemini-pro:generateContent\"))\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit exceeded\"))\n        .mount(\u0026mock_server)\n        .await;\n\n    // 2. Setup TestApp and get key info\n    let mut config = get_default_config();\n    config.groups[0].target_url = mock_server.uri();\n    let api_key_to_test = config.groups[0].api_keys[0].clone();\n    let key_id = format!(\"{:x}\", md5::compute(api_key_to_test.as_bytes()));\n\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 3. Call verify_key to get the key rate-limited\n    let verify_response = app\n        .authed_request(\n            Method::POST,\n            \u0026format!(\"/admin/keys/{}/verify\", key_id),\n            Body::empty(),\n        )\n        .await;\n    assert_eq!(verify_response.status(), StatusCode::OK);\n    mock_server.verify().await; // Ensure the mock was called\n\n    // 4. Verify the key is now limited\n    let list_keys_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/keys\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    let body_bytes = list_keys_response.into_body().collect().await.unwrap().to_bytes();\n    let keys: Vec\u003cserde_json::Value\u003e = serde_json::from_slice(\u0026body_bytes).unwrap();\n    assert_eq!(keys[0][\"id\"], key_id);\n    assert_eq!(keys[0][\"status\"], \"invalid\"); // Note: 429 is currently treated as invalid, not limited. This is ok for the test.\n\n    // 5. Call reset_key to reset its status\n    let reset_response = app\n        .authed_request(\n            Method::POST,\n            \u0026format!(\"/admin/keys/{}/reset\", key_id),\n            Body::empty(),\n        )\n        .await;\n    assert_eq!(reset_response.status(), StatusCode::OK);\n\n    // 6. Verify the key is available again\n    let list_keys_response_after_reset = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/keys\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    let body_bytes_after_reset = list_keys_response_after_reset.into_body().collect().await.unwrap().to_bytes();\n    let keys_after_reset: Vec\u003cserde_json::Value\u003e = serde_json::from_slice(\u0026body_bytes_after_reset).unwrap();\n    assert_eq!(keys_after_reset[0][\"id\"], key_id);\n    assert_eq!(keys_after_reset[0][\"status\"], \"available\");\n}\n#[tokio::test]\nasync fn test_delete_keys_success() {\n    // 1. Setup app with a config containing multiple keys\n    let mut config = get_default_config();\n    config.groups[0].api_keys.push(\"key_to_delete\".to_string());\n    let mut app = TestApp::new(config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 2. Send request to delete one of the keys\n    let body = Body::from(serde_json::to_string(\u0026KeysUpdateRequest {\n        group_name: \"default\".to_string(),\n        api_keys: vec![\"key_to_delete\".to_string()],\n    }).unwrap());\n\n    let response = app.authed_request(Method::DELETE, \"/admin/keys\", body).await;\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // 3. Verify the change by getting the config again\n    let get_config_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n    \n    let body = get_config_response.into_body().collect().await.unwrap().to_bytes();\n    let updated_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n    \n    let default_group = updated_config.groups.iter().find(|g| g.name == \"default\").unwrap();\n    assert_eq!(default_group.api_keys.len(), 1);\n    assert!(default_group.api_keys.contains(\u0026\"key1\".to_string()));\n    assert!(!default_group.api_keys.contains(\u0026\"key_to_delete\".to_string()));\n}\n\n#[tokio::test]\nasync fn test_update_config_success() {\n    // 1. Setup app with initial config\n    let initial_config = get_default_config();\n    let mut app = TestApp::new(initial_config).await;\n    app.login(\"secret_admin_token\").await;\n    app.get_csrf_token().await;\n\n    // 2. Create a new, modified config\n    let mut new_config = get_default_config();\n    new_config.server.port = 9999; // Change a server setting\n    new_config.groups[0].name = \"renamed_group\".to_string(); // Change a group setting\n    new_config.groups[0].api_keys.push(\"new_key_in_updated_config\".to_string());\n\n    // 3. Send request to update the config\n    let body = Body::from(serde_json::to_string(\u0026new_config).unwrap());\n    let response = app.authed_request(Method::PUT, \"/admin/config\", body).await;\n    assert_eq!(response.status(), StatusCode::OK);\n\n    // 4. Verify the change by getting the config again\n    let get_config_response = app\n        .router\n        .clone()\n        .oneshot(\n            Request::builder()\n                .uri(\"/admin/config\")\n                .header(header::COOKIE, app.auth_cookie.as_ref().unwrap())\n                .body(Body::empty())\n                .unwrap(),\n        )\n        .await\n        .unwrap();\n\n    let body = get_config_response.into_body().collect().await.unwrap().to_bytes();\n    let updated_config: AppConfig = serde_json::from_slice(\u0026body).unwrap();\n\n    // Assert that the fetched config matches the new config\n    assert_eq!(updated_config.server.port, 9999);\n    assert_eq!(updated_config.groups.len(), 1);\n    assert_eq!(updated_config.groups[0].name, \"renamed_group\");\n    assert_eq!(updated_config.groups[0].api_keys.len(), 2);\n    assert!(updated_config.groups[0].api_keys.contains(\u0026\"new_key_in_updated_config\".to_string()));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","integration_tests.rs"],"content":"// tests/integration_tests.rs\n\nuse axum::{\n    // body::Bytes as _, // Removed unused import placeholder\n    extract::{Request, State},\n    http::{/* header, */ Method, StatusCode, Uri}, // Removed unused header\n    response::Response,\n};\nuse gemini_proxy_key_rotation_rust::{\n    config::{AppConfig, KeyGroup, ServerConfig},\n    handler, // Import the handler module\n    // key_manager::FlattenedKeyInfo, // Removed unused import\n    // proxy,\n    state::AppState,\n};\nuse std::{fs::File, path::PathBuf, sync::Arc};\nuse tempfile::tempdir;\nuse wiremock::{\n    matchers::{method, path, path_regex, query_param}, // Use path and query_param\n    Mock,\n    MockServer,\n    ResponseTemplate,\n};\n\n// Helper function to create a basic AppConfig for testing\nfn create_test_config(groups: Vec\u003cKeyGroup\u003e, server_port: u16) -\u003e AppConfig {\n    AppConfig {\n        server: ServerConfig {\n            port: server_port,\n            top_p: None,\n            admin_token: Some(\"test_token\".to_string()),\n        },\n        groups,\n        rate_limit_behavior: Default::default(),\n        internal_retries: 3,\n        temporary_block_minutes: 1,\n    }\n}\n\n// Helper to create a dummy config file path within a temp dir\nfn create_dummy_config_path_for_test(dir: \u0026tempfile::TempDir) -\u003e PathBuf {\n    let file_path = dir.path().join(\"dummy_config_for_test.yaml\");\n    // Create the file, but content doesn't strictly matter for these handler tests\n    File::create(\u0026file_path).expect(\"Failed to create dummy config file\");\n    file_path\n}\n\n// Helper to make a request to the proxy handler\nasync fn call_proxy_handler(\n    state: Arc\u003cAppState\u003e,\n    method: Method,\n    path: \u0026str,\n    body: axum::body::Body,\n) -\u003e Response {\n    let uri: Uri = format!(\"http://test-proxy.com{}\", path) // Base URL doesn't matter here\n        .parse()\n        .expect(\"Failed to parse test URI for handler\");\n    let request = Request::builder()\n        .method(method)\n        .uri(uri)\n        .body(body) // Use empty body for GET/POST tests for simplicity\n        .unwrap();\n\n    // Call the actual handler function\n    handler::proxy_handler(State(state), request)\n        .await\n        .expect(\"Proxy handler returned an error\") // Unwrap the Result\u003cResponse, AppError\u003e\n}\n\n#[tokio::test]\nasync fn test_forward_request_openai_compat_success_no_proxy() {\n    // This test now implicitly tests the handler as well for the success path.\n    // We can keep it or refactor it slightly to use call_proxy_handler.\n    // Let's keep it for now as it tests proxy::forward_request logic well.\n\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"test-key-123\";\n    let test_path = \"/v1/models\";\n    let expected_path = \"/v1beta/openai/models\";\n    // let _expected_bearer = format!(\"Bearer {}\", test_api_key); // Unused now\n\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key)) // Match key in query param\n        // Removed header matchers\n        .respond_with(\n            ResponseTemplate::new(200).set_body_string(\"{\\\"object\\\": \\\"list\\\", \\\"data\\\": []}\"),\n        )\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"test-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9999);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    ); // Wrap in Arc\n\n    // 3. Call handler directly\n    let response =\n        call_proxy_handler(app_state, Method::GET, test_path, axum::body::Body::empty()).await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200)\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read response body\");\n    let body_str = String::from_utf8(body_bytes.to_vec()).expect(\"Body not UTF-8\");\n    assert!(body_str.contains(\"list\"), \"Response body mismatch\");\n}\n\n#[tokio::test]\nasync fn test_handler_retries_on_429_and_succeeds() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let key1 = \"key-limited\";\n    let key2 = \"key-working\";\n    let test_path = \"/v1/generateContent\";\n    let expected_path = \"/v1beta/openai/generateContent\";\n\n    // Mock for the first key (key1) - returns 429\n    Mock::given(method(\"POST\")) // Assuming POST for generateContent\n        .and(path(expected_path))\n        .and(query_param(\"key\", key1)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit exceeded\"))\n        .mount(\u0026server)\n        .await;\n\n    // Mock for the second key (key2) - returns 200\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key2)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(200).set_body_string(\"{\\\"candidates\\\": []}\")) // Example success response\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    // Key order matters for the round-robin\n    let test_group = KeyGroup {\n        name: \"retry-group\".to_string(),\n        api_keys: vec![key1.to_string(), key2.to_string()], // key1 will be tried first\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9998); // Different port just in case\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    // We expect the handler to try key1, get 429, mark it, try key2, get 200, and return 200.\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) after retry\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read success response body\");\n    let body_str = String::from_utf8(body_bytes.to_vec()).expect(\"Success body not UTF-8\");\n    assert!(\n        body_str.contains(\"candidates\"),\n        \"Success response body mismatch\"\n    );\n\n    // TODO: Optionally, check the persisted state file to ensure key1 is marked as limited.\n    // This requires reading the state file (`key_states.json`) from the temp_dir.\n}\n\n#[tokio::test]\nasync fn test_handler_returns_last_429_on_exhaustion() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let key1 = \"key-exhausted-1\";\n    let key2 = \"key-exhausted-2\";\n    let test_path = \"/v1/models\"; // Using GET for simplicity here\n    let expected_path = \"/v1beta/openai/models\";\n\n    // Mock for the first key (key1) - returns 429\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key1)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit 1\"))\n        .mount(\u0026server)\n        .await;\n\n    // Mock for the second key (key2) - also returns 429\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key2)) // Match key in query param\n        // Removed header matcher\n        .respond_with(ResponseTemplate::new(429).set_body_string(\"Rate limit 2\")) // Different body to check which 429 is returned\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"exhaust-group\".to_string(),\n        api_keys: vec![key1.to_string(), key2.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9997);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    // We expect the handler to try key1 (429), try key2 (429), run out of keys, and return the *last* 429 response.\n    let response =\n        call_proxy_handler(app_state, Method::GET, test_path, axum::body::Body::empty()).await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::TOO_MANY_REQUESTS,\n        \"Expected status 429 when all keys are exhausted\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read 429 response body\");\n    let body_str = String::from_utf8(body_bytes.to_vec()).expect(\"429 body not UTF-8\");\n    // Check it returned the body from the *second* 429 response\n    assert!(\n        body_str.contains(\"Rate limit 2\"),\n        \"Expected body from the last 429 response, got: {}\",\n        body_str\n    );\n}\n\n\n\n#[tokio::test]\nasync fn test_handler_group_round_robin() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_path = \"/v1/models\";\n    let expected_path = \"/v1beta/openai/models\";\n\n    let g1_key1 = \"g1-key-1\";\n    let g1_key2 = \"g1-key-2\";\n    let g2_key1 = \"g2-key-1\"; // Single key in this group\n    let g3_key1 = \"g3-key-1\";\n\n    // Mock successful responses for all keys initially\n    for key in [g1_key1, g1_key2, g2_key1, g3_key1] {\n        Mock::given(method(\"GET\"))\n            .and(path_regex(format!(\"^{}.*\", expected_path))) // Match any path starting with test_path\n            .and(query_param(\"key\", key))\n            .respond_with(ResponseTemplate::new(200).set_body_string(format!(\"{{\\\"key_used\\\": \\\"{}\\\"}}\", key)))\n            .mount(\u0026server)\n            .await;\n    }\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let groups = vec![\n        KeyGroup {\n            name: \"group1\".to_string(),\n            api_keys: vec![g1_key1.to_string(), g1_key2.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        },\n        KeyGroup {\n            name: \"group2\".to_string(),\n            api_keys: vec![g2_key1.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        },\n        KeyGroup {\n            name: \"group3\".to_string(),\n            api_keys: vec![g3_key1.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        },\n    ];\n    let config = create_test_config(groups, 9996);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // Helper to extract key from response body\n    async fn get_key_from_response(response: Response) -\u003e String {\n        let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n            .await\n            .expect(\"Failed to read response body\");\n        let body_json: serde_json::Value = serde_json::from_slice(\u0026body_bytes).expect(\"Invalid JSON\");\n        body_json[\"key_used\"].as_str().unwrap().to_string()\n    }\n\n    // 3. Call handler multiple times and check key rotation\n    // Expected sequence: g1k1, g2k1, g3k1, g1k2, g2k1, g3k1, g1k1, ...\n\n    let res1 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=1\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res1.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res1).await, g1_key1);\n\n    let res2 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=2\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res2.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res2).await, g2_key1);\n\n    let res3 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=3\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res3.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res3).await, g3_key1);\n\n    let res4 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=4\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res4.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res4).await, g1_key2); // Next key in group1\n\n    let res5 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=5\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res5.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res5).await, g2_key1); // Back to group2 (only one key)\n\n    let res6 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=6\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res6.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res6).await, g3_key1); // Back to group3 (only one key)\n\n    let res7 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=7\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res7.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res7).await, g1_key1); // Back to start of group1\n\n    // 4. Test skipping a rate-limited group\n    // Reset mocks and set g2_key1 to return 429, others to 200\n    server.reset().await;\n    Mock::given(method(\"GET\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", g2_key1))\n        .respond_with(ResponseTemplate::new(429))\n        .mount(\u0026server)\n        .await;\n    // Remount mocks for other keys to return 200\n    for key in [g1_key1, g1_key2, g3_key1] { // Exclude g2_key1\n        Mock::given(method(\"GET\"))\n            .and(path(expected_path))\n            .and(query_param(\"key\", key))\n            .respond_with(ResponseTemplate::new(200).set_body_string(format!(\"{{\\\"key_used\\\": \\\"{}\\\"}}\", key)))\n            .mount(\u0026server)\n            .await;\n    }\n\n    // Make a request - should hit g2k1, get 429, mark key, retry\n    // Expected sequence now: g3k1 (skips g2), g1k2 (skips g2), ...\n\n    // Current state: next should be group2 (index 1) according to previous calls\n    // Try g2k1 -\u003e 429 -\u003e mark g2k1 limited -\u003e continue search\n    // Try group3 (index 2) -\u003e g3k1 -\u003e OK\n    let res_skip1 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=8\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res_skip1.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res_skip1).await, g3_key1); // Expect g3_key1 because g2 is skipped\n\n    // Current state: next should be group0 (index 0)\n    // Try g1k2 -\u003e OK\n    let res_skip2 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=9\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res_skip2.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res_skip2).await, g1_key2);\n\n    // Current state: next should be group1 (index 1)\n    // Try g2k1 -\u003e still 429 -\u003e continue search\n    // Try group3 (index 2) -\u003e g3k1 -\u003e OK\n    let res_skip3 = call_proxy_handler(Arc::clone(\u0026app_state), Method::GET, \u0026format!(\"{}?req=10\", test_path), axum::body::Body::empty()).await;\n    assert_eq!(res_skip3.status(), StatusCode::OK);\n    assert_eq!(get_key_from_response(res_skip3).await, g3_key1);\n}\n\n// TODO: Add more tests from the plan:\n// - Test with POST /v1/chat/completions and body forwarding (similar structure, just change method and add body to request/mocks)\n// - Test error scenarios (e.g., mock server returning 500) -\u003e Handler should return the corresponding error response immediately\n// - Test persistence logic explicitly by reading/writing state file.\n// - Test SOCKS5 proxy scenario (more complex setup needed)\n\n#[tokio::test]\nasync fn test_openai_top_p_injection_correctly() {\n    // Goal: Verify that top_p is injected at the top level for OpenAI compatibility.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"openai-top-p-key\";\n    let test_path = \"/v1/chat/completions\";\n    let expected_path = \"/v1beta/openai/chat/completions\";\n    let top_p_value = 0.88f32;\n\n    // Mock to verify the body modification\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key))\n        .and(move |req: \u0026wiremock::Request| {\n            // Custom matcher to inspect the body for a top-level \"top_p\"\n            if let Ok(body_json) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026req.body) {\n                if let Some(top_p) = body_json.get(\"top_p\") {\n                    return top_p.as_f64().map_or(false, |v| (v as f32 - top_p_value).abs() \u003c f32::EPSILON);\n                }\n            }\n            false\n        })\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"id\": \"chatcmpl-123\", \"object\": \"chat.completion\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    \n    // Create a new AppConfig with top_p at the server level for this test\n    let mut config = create_test_config(vec![\n        KeyGroup {\n            name: \"openai-top-p-group\".to_string(),\n            api_keys: vec![test_api_key.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None, // Group level top_p is not used for this path\n        }\n    ], 9993);\n    config.server.top_p = Some(top_p_value); // Set top_p at the server level\n\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with a standard OpenAI body\n    let original_body = serde_json::json!({\n        \"model\": \"gpt-4\",\n        \"messages\": [{\"role\": \"user\", \"content\": \"Hello!\"}]\n    });\n    let body_bytes = serde_json::to_vec(\u0026original_body).unwrap();\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::from(body_bytes),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) with top_p injected for openai compat\"\n    );\n}\n\n#[tokio::test]\nasync fn test_health_detailed_maps_to_models_endpoint() {\n    // Goal: Verify that /health/detailed calls the upstream /v1beta/models endpoint.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"health-check-key\";\n    let models_path = \"/v1beta/models\";\n    let mock_response_body = serde_json::json!({ \"data\": [\"model1\"] });\n\n    // Mock for the upstream models endpoint\n    Mock::given(method(\"GET\"))\n        .and(path(models_path))\n        .and(query_param(\"key\", test_api_key))\n        .respond_with(ResponseTemplate::new(200).set_body_json(\u0026mock_response_body))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"health-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9992);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler for the /health/detailed path\n    let response = call_proxy_handler(\n        app_state,\n        Method::GET,\n        \"/health/detailed\",\n        axum::body::Body::empty(),\n    ).await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) for /health/detailed\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .expect(\"Failed to read response body\");\n    let body_json: serde_json::Value = serde_json::from_slice(\u0026body_bytes).expect(\"Invalid JSON response\");\n    assert_eq!(body_json, mock_response_body, \"Response body from /health/detailed did not match expected models list\");\n}\n\n#[tokio::test]\nasync fn test_content_length_is_updated_after_top_p_injection() {\n    // Goal: Verify Content-Length is recalculated after body modification.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"content-length-key\";\n    let test_path = \"/v1/chat/completions\";\n    let expected_path = \"/v1beta/openai/chat/completions\";\n    let top_p_value = 0.88f32;\n\n    // The original body without top_p\n    let original_body = serde_json::json!({\n        \"model\": \"gpt-4\",\n        \"messages\": [{\"role\": \"user\", \"content\": \"Hello!\"}]\n    });\n\n    // The expected body *after* injection\n    let mut expected_body_json = original_body.clone();\n    expected_body_json[\"top_p\"] = serde_json::json!(top_p_value);\n    let expected_body_bytes = serde_json::to_vec(\u0026expected_body_json).unwrap();\n    let expected_content_length = expected_body_bytes.len().to_string();\n\n    // Mock to verify the body and the Content-Length header\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key))\n        .and(move |req: \u0026wiremock::Request| {\n            // Check Content-Length header first\n            let has_correct_content_length = req\n                .headers\n                .get(\"Content-Length\")\n                .map_or(false, |val| val.to_str().unwrap() == expected_content_length);\n\n            if !has_correct_content_length {\n                return false;\n            }\n\n            // Check body content\n            if let Ok(body_json) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026req.body) {\n                if let Some(top_p) = body_json.get(\"top_p\") {\n                    return top_p.as_f64().map_or(false, |v| (v as f32 - top_p_value).abs() \u003c f32::EPSILON);\n                }\n            }\n            false\n        })\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"id\": \"chatcmpl-456\", \"object\": \"chat.completion\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    \n    let mut config = create_test_config(vec![\n        KeyGroup {\n            name: \"content-length-group\".to_string(),\n            api_keys: vec![test_api_key.to_string()],\n            target_url: server.uri(),\n            proxy_url: None,\n            top_p: None,\n        }\n    ], 9991);\n    config.server.top_p = Some(top_p_value);\n\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    let body_bytes = serde_json::to_vec(\u0026original_body).unwrap();\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::from(body_bytes),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) with correct content-length\"\n    );\n}\n\n#[tokio::test]\nasync fn test_top_p_client_precedence() {\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"client-precedence-key\";\n    let test_path = \"/v1/models:generateContent\";\n    let expected_path = \"/v1beta/openai/models:generateContent\";\n    let server_top_p = 0.5; // Server-side config\n    let client_top_p = 0.99; // Client-side value, should win\n\n    // Mock to verify that the client's top_p is what arrives\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", test_api_key))\n        .and(move |req: \u0026wiremock::Request| {\n            // Custom matcher to inspect the body\n            if let Ok(body_json) = serde_json::from_slice::\u003cserde_json::Value\u003e(\u0026req.body) {\n                if let Some(config) = body_json.get(\"generationConfig\") {\n                    if let Some(top_p) = config.get(\"topP\") {\n                        // Check that the value is the one from the client\n                        return top_p.as_f64().map_or(false, |v| (v - client_top_p as f64).abs() \u003c f64::EPSILON);\n                    }\n                }\n            }\n            false\n        })\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"candidates\": [] })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"client-precedence-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: Some(server_top_p), // Set a server-side value\n    };\n    let config = create_test_config(vec![test_group], 9994);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with a body that already contains topP\n    let original_body = serde_json::json!({\n        \"contents\": [{\"role\": \"user\", \"parts\": [{\"text\": \"Hello\"}]}],\n        \"generationConfig\": {\n            \"temperature\": 0.7,\n            \"topP\": client_top_p // Client provides topP\n        }\n    });\n    let body_bytes = serde_json::to_vec(\u0026original_body).unwrap();\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        test_path,\n        axum::body::Body::from(body_bytes),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) when client top_p takes precedence\"\n    );\n}\n\n#[tokio::test]\nasync fn test_url_translation_for_v1_path() {\n    // Goal: Verify that a request to a `/v1/...` path is translated to `/v1beta/openai/...`\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"translation-key-v1\";\n    let incoming_path = \"/v1/chat/completions\";\n    let expected_translated_path = \"/v1beta/openai/chat/completions\";\n\n    // Mock to expect the *translated* path\n    Mock::given(method(\"POST\"))\n        .and(path(expected_translated_path))\n        .and(query_param(\"key\", test_api_key))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"status\": \"ok\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"translation-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9990);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with the original `/v1/...` path\n    let response = call_proxy_handler(\n        app_state,\n        Method::POST,\n        incoming_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) for translated v1 path\"\n    );\n    // The mock server implicitly verifies that the path was translated correctly.\n    // If the request had gone to the original path, the mock would not have matched,\n    // and wiremock would have returned a 404, failing the test.\n}\n\n#[tokio::test]\nasync fn test_url_translation_for_non_v1_path() {\n    // Goal: Verify that a request to a path NOT starting with `/v1/` is NOT translated.\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let test_api_key = \"translation-key-non-v1\";\n    let incoming_path = \"/health\"; // A non-v1 path\n\n    // Mock to expect the *original* path, unchanged\n    Mock::given(method(\"GET\"))\n        .and(path(incoming_path))\n        .and(query_param(\"key\", test_api_key))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({ \"status\": \"healthy\" })))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"non-translation-group\".to_string(),\n        api_keys: vec![test_api_key.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9989);\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler with the non-v1 path\n    let response = call_proxy_handler(\n        app_state,\n        Method::GET,\n        incoming_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) for non-v1 path\"\n    );\n    let body_bytes = axum::body::to_bytes(response.into_body(), usize::MAX)\n        .await\n        .unwrap();\n    let body_str = String::from_utf8(body_bytes.to_vec()).unwrap();\n    assert!(body_str.contains(\"healthy\"));\n}\n\n#[tokio::test]\nasync fn test_handler_retries_on_400_and_succeeds() {\n    // This test verifies that if a key returns a 400 Bad Request,\n    // the handler marks it as invalid and successfully retries with the next key.\n\n    // 1. Setup Mock Server\n    let server = MockServer::start().await;\n    let key1_invalid = \"key-invalid-400\";\n    let key2_valid = \"key-valid-200\";\n    let test_path = \"/v1/chat/completions\";\n    let expected_path = \"/v1beta/openai/chat/completions\";\n\n    // Mock for the first key (key1_invalid) - returns 400\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key1_invalid))\n        .respond_with(ResponseTemplate::new(400).set_body_string(\"Invalid API key\"))\n        .mount(\u0026server)\n        .await;\n\n    // Mock for the second key (key2_valid) - returns 200\n    Mock::given(method(\"POST\"))\n        .and(path(expected_path))\n        .and(query_param(\"key\", key2_valid))\n        .respond_with(ResponseTemplate::new(200).set_body_string(\"{\\\"candidates\\\": []}\"))\n        .mount(\u0026server)\n        .await;\n\n    // 2. Setup Config and State\n    let temp_dir = tempdir().expect(\"Failed to create temp dir\");\n    let dummy_config_path = create_dummy_config_path_for_test(\u0026temp_dir);\n    let test_group = KeyGroup {\n        name: \"retry-400-group\".to_string(),\n        api_keys: vec![key1_invalid.to_string(), key2_valid.to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    let config = create_test_config(vec![test_group], 9996); // Different port\n    let app_state = Arc::new(\n        AppState::new(\u0026config, \u0026dummy_config_path)\n            .await\n            .expect(\"AppState failed\"),\n    );\n\n    // 3. Call handler\n    let response = call_proxy_handler(\n        app_state.clone(), // Clone for the call\n        Method::POST,\n        test_path,\n        axum::body::Body::empty(),\n    )\n    .await;\n\n    // 4. Assertions\n    assert_eq!(\n        response.status(),\n        StatusCode::OK,\n        \"Expected status OK (200) after retry on 400\"\n    );\n    // Verify that the first key is now marked as invalid\n    let is_invalid = app_state.key_manager.read().await.is_key_invalid(key1_invalid);\n    assert!(\n        is_invalid,\n        \"Expected the first key to be marked as invalid after a 400 response\"\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","main_integration_tests.rs"],"content":"use gemini_proxy_key_rotation_rust::{error::AppError, run};\nuse std::fs::File;\nuse std::io::Write;\nuse tempfile::tempdir;\n\n#[tokio::test]\nasync fn test_run_successful_startup() {\n    let temp_dir = tempdir().expect(\"Failed to create temp directory\");\n    let config_path = temp_dir.path().join(\"config.yaml\");\n\n    let mut temp_config = File::create(\u0026config_path).expect(\"Failed to create temp config file\");\n    let config_content = r#\"\nserver:\n  port: 8080\n  admin_token: \"test_token\"\ngroups:\n  - name: \"default\"\n    api_keys: [\"key1\"]\n\"#;\n    temp_config\n        .write_all(config_content.as_bytes())\n        .expect(\"Failed to write to temp config\");\n\n    // This test now verifies that `run` can successfully initialize the application\n    // state and router when provided with a valid configuration.\n    // It no longer tests the `main` function directly, as `main` is not part of the\n    // library's public API and testing it requires fragile workarounds.\n    let result = run(Some(config_path)).await;\n\n    assert!(result.is_ok(), \"run() should succeed with a valid config\");\n}\n\n#[tokio::test]\nasync fn test_run_fails_with_invalid_config() {\n    let temp_dir = tempdir().expect(\"Failed to create temp directory\");\n    let config_path = temp_dir.path().join(\"config.yaml\");\n\n    let mut temp_config = File::create(\u0026config_path).expect(\"Failed to create temp config file\");\n    // Invalid structure (port is a string)\n    let config_content = r#\"\nserver:\n  port: \"not-a-number\"\n  admin_token: \"test_token\"\ngroups: []\n\"#;\n    temp_config\n        .write_all(config_content.as_bytes())\n        .expect(\"Failed to write to temp config\");\n\n    let result = run(Some(config_path)).await;\n\n    assert!(matches!(result, Err(AppError::Config(_))));\n}\n\n#[tokio::test]\nasync fn test_run_fails_without_config_file() {\n    let temp_dir = tempdir().expect(\"Failed to create temp directory\");\n\n    // Set CONFIG_PATH to a non-existent file in our temp directory\n    let config_path = temp_dir.path().join(\"non_existent_config.yaml\");\n\n    let result = run(Some(config_path)).await;\n\n    // Expect a config error because the file is required if the path is set,\n    // and default values are not sufficient to run.\n    assert!(matches!(result, Err(AppError::Config(_))));\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","stranmor","Documents","project","main","Gemini Proxy Key Rotation","tests","system_integration_tests.rs"],"content":"// tests/system_integration_tests.rs\n\nuse axum::http::{Method, StatusCode};\nuse gemini_proxy_key_rotation_rust::{\n    config::{AppConfig, KeyGroup, ServerConfig},\n    handler,\n    state::AppState,\n};\nuse futures::future;\nuse std::{\n    fs::File,\n    sync::Arc,\n};\nuse tempfile::tempdir;\nuse wiremock::{\n    matchers::{method, path},\n    Mock, MockServer, ResponseTemplate,\n};\n\nasync fn create_test_system() -\u003e (Arc\u003cAppState\u003e, MockServer, tempfile::TempDir) {\n    let server = MockServer::start().await;\n    let temp_dir = tempdir().unwrap();\n    let config_path = temp_dir.path().join(\"config.yaml\");\n    File::create(\u0026config_path).unwrap();\n    \n    let test_group = KeyGroup {\n        name: \"test-group\".to_string(),\n        api_keys: vec![\"test-key-1\".to_string(), \"test-key-2\".to_string()],\n        target_url: server.uri(),\n        proxy_url: None,\n        top_p: None,\n    };\n    \n    let config = AppConfig {\n        server: ServerConfig {\n            port: 8080,\n            top_p: None,\n            admin_token: Some(\"test_token\".to_string()),\n        },\n        groups: vec![test_group],\n        rate_limit_behavior: Default::default(),\n        internal_retries: 3,\n        temporary_block_minutes: 1,\n    };\n    \n    let app_state = Arc::new(AppState::new(\u0026config, \u0026config_path).await.unwrap());\n    \n    (app_state, server, temp_dir)\n}\n\n\n#[tokio::test]\nasync fn test_metrics_collection() {\n    let (app_state, server, _temp_dir) = create_test_system().await;\n    \n    // Mock a successful request\n    Mock::given(method(\"GET\"))\n        .and(path(\"/v1beta/openai/models\"))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({\"data\": []})))\n        .mount(\u0026server)\n        .await;\n    \n    // Make a request to generate metrics\n    let request = axum::extract::Request::builder()\n        .method(Method::GET)\n        .uri(\"/v1/models\")\n        .body(axum::body::Body::empty())\n        .unwrap();\n    \n    let _response = handler::proxy_handler(\n        axum::extract::State(app_state.clone()),\n        request,\n    ).await.unwrap();\n    \n    // Metrics should be recorded (this is more of a smoke test)\n    // In a real scenario, you'd check the actual metrics values\n    // but that requires more complex setup with the metrics registry\n}\n\n#[tokio::test]\nasync fn test_error_handling_and_recovery() {\n    let (app_state, server, _temp_dir) = create_test_system().await;\n    \n    // Mock server error followed by success\n    Mock::given(method(\"GET\"))\n        .and(path(\"/v1beta/openai/models\"))\n        .respond_with(ResponseTemplate::new(500).set_body_string(\"Internal Server Error\"))\n        .expect(6) // Expect 3 internal retries for each of the 2 keys\n        .mount(\u0026server)\n        .await;\n    \n    let request = axum::extract::Request::builder()\n        .method(Method::GET)\n        .uri(\"/v1/models\")\n        .body(axum::body::Body::empty())\n        .unwrap();\n    \n    let response = handler::proxy_handler(\n        axum::extract::State(app_state.clone()),\n        request,\n    ).await.unwrap();\n    \n    // Should return the error response\n    assert_eq!(response.status(), StatusCode::INTERNAL_SERVER_ERROR);\n}\n\n#[tokio::test]\nasync fn test_concurrent_requests() {\n    let (app_state, server, _temp_dir) = create_test_system().await;\n    \n    // Mock responses for concurrent requests\n    Mock::given(method(\"GET\"))\n        .and(path(\"/v1beta/openai/models\"))\n        .respond_with(ResponseTemplate::new(200).set_body_json(serde_json::json!({\"data\": []})))\n        .expect(10)\n        .mount(\u0026server)\n        .await;\n    \n    // Create multiple concurrent requests\n    let mut handles = Vec::new();\n    \n    for i in 0..10 {\n        let app_state_clone = app_state.clone();\n        let handle = tokio::spawn(async move {\n            let request = axum::extract::Request::builder()\n                .method(Method::GET)\n                .uri(format!(\"/v1/models?req={}\", i))\n                .body(axum::body::Body::empty())\n                .unwrap();\n            \n            handler::proxy_handler(\n                axum::extract::State(app_state_clone),\n                request,\n            ).await\n        });\n        handles.push(handle);\n    }\n    \n    // Wait for all requests to complete\n    let results = future::join_all(handles).await;\n    \n    // All requests should succeed\n    for result in results {\n        let response = result.unwrap().unwrap();\n        assert_eq!(response.status(), StatusCode::OK);\n    }\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>