<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Proxy Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Basic styling for demonstration purposes */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; }
        .header { background-color: #fff; padding: 1rem 2rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; margin: 0; }
        .header nav a { text-decoration: none; color: #007bff; font-weight: 500; }
        .container { max-width: 1200px; margin: 2rem auto; display: grid; grid-gap: 1.5rem; padding: 0 1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); grid-gap: 1.5rem; }
        .card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1.5rem; }
        .card h2 { margin-top: 0; font-size: 1.25rem; border-bottom: 1px solid #eee; padding-bottom: 0.75rem; margin-bottom: 1rem; }
        .loading { text-align: center; color: #888; }
        .error { text-align: center; color: #d9534f; }
        .info { text-align: center; color: #5bc0de; }
        .metric { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .metric-label { font-weight: 500; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-healthy { background-color: #5cb85c; }
        .status-error { background-color: #d9534f; }
        .card-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1rem; }
        .refresh-btn, .toggle-refresh-btn { background: #f8f9fa; border: 1px solid #ccc; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer; }
        .toggle-refresh-btn { margin-left: 0.5rem; }
    </style>
</head>
<body>
    <header class="header">
        <h1>üöÄ Gemini Proxy Dashboard</h1>
        <nav>
            <a href="/admin/keys-page">Key Management</a>
        </nav>
    </header>

    <main class="container">
        <div class="grid">
            <section class="card" aria-labelledby="system-status-heading">
                <h2 id="system-status-heading">System Status</h2>
                <div id="system-status" class="loading" aria-live="polite">Loading...</div>
            </section>

            <!-- SYSINFO_PLACEHOLDER -->

            <section class="card" aria-labelledby="request-metrics-heading">
                <h2 id="request-metrics-heading">Request Metrics</h2>
                <div id="request-metrics" class="loading" aria-live="polite">Loading...</div>
            </section>
        </div>

        <section class="card" aria-labelledby="model-stats-heading">
            <h2 id="model-stats-heading">Model-Specific Key Blocking</h2>
            <div id="model-stats" class="loading" aria-live="polite">Loading...</div>
        </section>

        <section class="card" aria-labelledby="keys-status-heading">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="keys-status-heading" style="margin: 0; border: none;">API Keys Status</h2>
                <div class="card-controls">
                    <button class="refresh-btn" id="manual-refresh-btn">Refresh</button>
                    <button class="toggle-refresh-btn" id="toggle-refresh-btn" title="Toggle auto-refresh">‚è∏Ô∏è</button>
                </div>
            </div>
            <div id="keys-status" class="loading" aria-live="polite">Loading...</div>
        </section>
    </main>

    <script>
        class DashboardManager {
            constructor() {
                this.refreshInterval = null;
                this.csrfToken = null;
                this.isAutoRefreshEnabled = true;
                this.lastRefreshTime = null;
                this.refreshIntervalMs = 30000;
                this.statusUpdateIntervalMs = 5000;

                this.init();
            }

            async init() {
                try {
                    await this.getCsrfToken();
                    this.setupEventListeners();
                    await this.refreshAllData();
                    this.setupAutoRefresh();
                } catch (error) {
                    console.error('Dashboard initialization failed:', error);
                    this.showError('system-status', 'Failed to initialize dashboard');
                }
            }

            async getCsrfToken() {
                try {
                    const response = await fetch('/admin/csrf-token');
                    if (!response.ok) throw new Error('Could not fetch CSRF token');
                    const data = await response.json();
                    this.csrfToken = data.csrf_token;
                } catch (error) {
                    console.error('CSRF token fetch failed:', error);
                    throw error;
                }
            }

            async fetchWithAuth(endpoint, options = {}) {
                const headers = { ...options.headers };
                if (options.method === 'POST' && this.csrfToken) {
                    headers['X-CSRF-Token'] = this.csrfToken;
                }

                try {
                    const response = await fetch(endpoint, { ...options, headers });
                    if (response.status === 401) {
                        await this.handleUnauthorized();
                        throw new Error('Unauthorized');
                    }
                    if (response.status === 403) {
                        await this.getCsrfToken();
                        throw new Error('CSRF Token Expired');
                    }
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                    }
                    const contentType = response.headers.get("content-type");
                    return contentType?.includes("application/json") ? response.json() : null;
                } catch (error) {
                    console.error(`Fetch error for ${endpoint}:`, error);
                    throw error;
                }
            }
            
            async fetchData(endpoint) {
                try {
                    const response = await fetch(endpoint);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Failed to fetch ${endpoint}:`, error);
                    throw error;
                }
            }

            setupEventListeners() {
                document.getElementById('manual-refresh-btn').addEventListener('click', () => this.refreshAllData());
                document.getElementById('toggle-refresh-btn').addEventListener('click', () => this.toggleAutoRefresh());
            }

            async refreshAllData() {
                this.lastRefreshTime = Date.now();
                const refreshPromises = [
                    this.renderSystemStatus(),
                    this.renderRequestMetrics(),
                    this.renderModelStats(),
                    this.renderKeysStatus(),
                ];
                await Promise.all(refreshPromises);
                this.updateRefreshStatus();
            }

            setupAutoRefresh() {
                if (this.refreshInterval) clearInterval(this.refreshInterval);
                this.refreshInterval = setInterval(() => {
                    if (this.isAutoRefreshEnabled) {
                        this.refreshAllData();
                    }
                }, this.refreshIntervalMs);
            }

            toggleAutoRefresh() {
                this.isAutoRefreshEnabled = !this.isAutoRefreshEnabled;
                this.updateRefreshStatus();
            }
            
            updateRefreshStatus() {
                const toggleBtn = document.getElementById('toggle-refresh-btn');
                const manualBtn = document.getElementById('manual-refresh-btn');
                if (this.isAutoRefreshEnabled) {
                    toggleBtn.textContent = '‚è∏Ô∏è';
                    toggleBtn.title = 'Pause Auto-Refresh';
                    manualBtn.textContent = `Auto-Refresh: ON`;
                } else {
                    toggleBtn.textContent = '‚ñ∂Ô∏è';
                    toggleBtn.title = 'Resume Auto-Refresh';
                    manualBtn.textContent = `Auto-Refresh: OFF`;
                }
            }

            renderTemplate(containerId, content) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = content;
                    container.classList.remove('loading');
                }
            }

            showError(containerId, message) {
                this.renderTemplate(containerId, `<div class="error">${message}</div>`);
            }

            async renderSystemStatus() {
                try {
                    const data = await this.fetchData('/admin/status');
                    const statusClass = data.status === 'healthy' ? 'status-healthy' : 'status-error';
                    const content = `
                        <div class="metric">
                            <span class="metric-label"><span class="status-indicator ${statusClass}"></span>Status</span>
                            <span class="metric-value">${data.status}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Uptime</span>
                            <span class="metric-value">${this.formatUptime(data.uptime_seconds)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Version</span>
                            <span class="metric-value">${data.version}</span>
                        </div>
                    `;
                    this.renderTemplate('system-status', content);
                } catch (error) {
                    this.showError('system-status', `Failed to load system status: ${error.message}`);
                }
            }

            async renderRequestMetrics() {
                 try {
                    const data = await this.fetchData('/admin/request-metrics');
                    const keyStatus = data.key_status;
                    const totalKeys = keyStatus.total_keys;
                    const activePercentage = totalKeys > 0 ? Math.round((keyStatus.active_keys / totalKeys) * 100) : 0;
                    // ... content generation for request metrics
                    const content = `<div>...</div>`; // Placeholder for brevity
                    this.renderTemplate('request-metrics', content);
                } catch (error) {
                    this.showError('request-metrics', `Failed to load request metrics: ${error.message}`);
                }
            }

            async renderModelStats() {
                try {
                    const data = await this.fetchData('/admin/model-stats');
                    if (!data.models || data.models.length === 0) {
                        this.renderTemplate('model-stats', '<div class="info">No model-specific blocks found</div>');
                        return;
                    }
                    const content = `<div>...</div>`; // Placeholder for brevity
                    this.renderTemplate('model-stats', content);
                } catch (error) {
                    this.showError('model-stats', `Failed to load model stats: ${error.message}`);
                }
            }

            async renderKeysStatus() {
                try {
                    const keys = await this.fetchData('/admin/keys');
                    if (keys.length === 0) {
                        this.renderTemplate('keys-status', '<div class="info">No API keys found</div>');
                        return;
                    }
                    
                    const fragment = document.createDocumentFragment();
                    const keyList = document.createElement('div');
                    keyList.className = 'key-list';
                    
                    // Group keys logic...
                    // Loop and create key items...
                    
                    fragment.appendChild(keyList);
                    const container = document.getElementById('keys-status');
                    container.innerHTML = '';
                    container.appendChild(fragment);
                    container.classList.remove('loading');

                } catch (error) {
                    this.showError('keys-status', `Failed to load API keys: ${error.message}`);
                }
            }

            formatUptime(seconds) {
                const d = Math.floor(seconds / (3600*24));
                const h = Math.floor(seconds % (3600*24) / 3600);
                const m = Math.floor(seconds % 3600 / 60);
                return `${d}d ${h}h ${m}m`;
            }

            // ... other helper methods like handleUnauthorized, formatTimeUntil, etc.
        }

        document.addEventListener('DOMContentLoaded', () => {
            new DashboardManager();
        });
    </script>
</body>
</html>